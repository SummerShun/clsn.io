---
title: Kubernetes V1.15 二进制部署集群
author: 惨绿少年
type: post
date: 2019-08-16T09:15:43+00:00
url: /clsn/lx1517.html
Baidusubmit:
  - 1
categories:
  - Linux运维
  - 云计算
  - 安全
  - 虚拟化

---
<div id="log-box">
  <div id="catalog">
    <ul id="catalog-ul">
      <li>
        <i class="be be-arrowright"></i> <a href="#title-0" title="3.1.1 设置关闭防火墙及SELINUX">3.1.1 设置关闭防火墙及SELINUX</a>
      </li>
      <li>
        <i class="be be-arrowright"></i> <a href="#title-1" title="3.1.2 关闭swap">3.1.2 关闭swap</a>
      </li>
      <li>
        <i class="be be-arrowright"></i> <a href="#title-2" title="3.1.3 设置Docker所需参数">3.1.3 设置Docker所需参数</a>
      </li>
      <li>
        <i class="be be-arrowright"></i> <a href="#title-3" title="3.1.4 安装 Docker">3.1.4 安装 Docker</a>
      </li>
      <li>
        <i class="be be-arrowright"></i> <a href="#title-4" title="3.1.5 创建相关目录">3.1.5 创建相关目录</a>
      </li>
      <li>
        <i class="be be-arrowright"></i> <a href="#title-5" title="3.1.6 SSH 互信配置">3.1.6 SSH 互信配置</a>
      </li>
      <li>
        <i class="be be-arrowright"></i> <a href="#title-6" title="3.1.7 添加 PATH 变量">3.1.7 添加 PATH 变量</a>
      </li>
      <li>
        <i class="be be-arrowright"></i> <a href="#title-7" title="3.2.1 安装及配置CFSSL">3.2.1 安装及配置CFSSL</a>
      </li>
      <li>
        <i class="be be-arrowright"></i> <a href="#title-8" title="3.2.2 创建 ETCD 相关证书">3.2.2 创建 ETCD 相关证书</a>
      </li>
      <li>
        <i class="be be-arrowright"></i> <a href="#title-9" title="3.2.3 创建 Kubernetes 相关证书">3.2.3 创建 Kubernetes 相关证书</a>
      </li>
      <li>
        <i class="be be-arrowright"></i> <a href="#title-10" title="3.3.1 配置软件包">3.3.1 配置软件包</a>
      </li>
      <li>
        <i class="be be-arrowright"></i> <a href="#title-11" title="3.3.2 编辑etcd配置文件">3.3.2 编辑etcd配置文件</a>
      </li>
      <li>
        <i class="be be-arrowright"></i> <a href="#title-12" title="3.3.3 创建 etcd的 systemd unit 文件">3.3.3 创建 etcd的 systemd unit 文件</a>
      </li>
      <li>
        <i class="be be-arrowright"></i> <a href="#title-13" title="3.3.4 配置证书文件">3.3.4 配置证书文件</a>
      </li>
      <li>
        <i class="be be-arrowright"></i> <a href="#title-14" title="3.3.5 配置文件拷贝到 节点1、节点2">3.3.5 配置文件拷贝到 节点1、节点2</a>
      </li>
      <li>
        <i class="be be-arrowright"></i> <a href="#title-15" title="3.3.6 启动ETCD服务">3.3.6 启动ETCD服务</a>
      </li>
      <li>
        <i class="be be-arrowright"></i> <a href="#title-16" title="3.3.7 检查服务是否正常">3.3.7 检查服务是否正常</a>
      </li>
      <li>
        <i class="be be-arrowright"></i> <a href="#title-17" title="3.4.1 向 etcd 写入集群 Pod 网段信息">3.4.1 向 etcd 写入集群 Pod 网段信息</a>
      </li>
      <li>
        <i class="be be-arrowright"></i> <a href="#title-18" title="3.4.2 部署 flannel">3.4.2 部署 flannel</a>
      </li>
      <li>
        <i class="be be-arrowright"></i> <a href="#title-19" title="3.5.3 配置flannel">3.5.3 配置flannel</a>
      </li>
      <li>
        <i class="be be-arrowright"></i> <a href="#title-20" title="3.5.4 创建 flanneld 的 systemd unit 文件">3.5.4 创建 flanneld 的 systemd unit 文件</a>
      </li>
      <li>
        <i class="be be-arrowright"></i> <a href="#title-21" title="3.5.5 配置Docker启动指定子网段">3.5.5 配置Docker启动指定子网段</a>
      </li>
      <li>
        <i class="be be-arrowright"></i> <a href="#title-22" title="3.5.6 将flanneld systemd unit 文件到所有节点">3.5.6 将flanneld systemd unit 文件到所有节点</a>
      </li>
      <li>
        <i class="be be-arrowright"></i> <a href="#title-23" title="3.5.7 验证fannel网络配置">3.5.7 验证fannel网络配置</a>
      </li>
      <li>
        <i class="be be-arrowright"></i> <a href="#title-24" title="3.5.1  配置 master 节点文件">3.5.1 配置 master 节点文件</a>
      </li>
      <li>
        <i class="be be-arrowright"></i> <a href="#title-25" title="3.5.2 配置 kubernetes相关证书">3.5.2 配置 kubernetes相关证书</a>
      </li>
      <li>
        <i class="be be-arrowright"></i> <a href="#title-26" title="3.5.3 部署 kube-apiserver 组件">3.5.3 部署 kube-apiserver 组件</a>
      </li>
      <li>
        <i class="be be-arrowright"></i> <a href="#title-27" title="3.5.4 部署kube-scheduler">3.5.4 部署kube-scheduler</a>
      </li>
      <li>
        <i class="be be-arrowright"></i> <a href="#title-28" title="3.5.5 部署kube-controller-manager">3.5.5 部署kube-controller-manager</a>
      </li>
      <li>
        <i class="be be-arrowright"></i> <a href="#title-29" title="3.5.6 查看master集群状态">3.5.6 查看master集群状态</a>
      </li>
      <li>
        <i class="be be-arrowright"></i> <a href="#title-30" title="3.6.1 部署 kubelet 组件">3.6.1 部署 kubelet 组件</a>
      </li>
      <li>
        <i class="be be-arrowright"></i> <a href="#title-31" title="3.6.2 创建kubelet 参数配置文件拷贝到所有 nodes节点">3.6.2 创建kubelet 参数配置文件拷贝到所有 nodes节点</a>
      </li>
      <li>
        <i class="be be-arrowright"></i> <a href="#title-32" title="3.6.3 启动kubelet服务">3.6.3 启动kubelet服务</a>
      </li>
      <li>
        <i class="be be-arrowright"></i> <a href="#title-33" title="3.6.4 approve kubelet CSR 请求">3.6.4 approve kubelet CSR 请求</a>
      </li>
      <li>
        <i class="be be-arrowright"></i> <a href="#title-34" title="3.6.5 查看集群状态">3.6.5 查看集群状态</a>
      </li>
      <li>
        <i class="be be-arrowright"></i> <a href="#title-35" title="3.7.1 创建kube-proxy配置文件">3.7.1 创建kube-proxy配置文件</a>
      </li>
      <li>
        <i class="be be-arrowright"></i> <a href="#title-36" title="3.7.2 创建kube-proxy systemd unit 文件">3.7.2 创建kube-proxy systemd unit 文件</a>
      </li>
      <li>
        <i class="be be-arrowright"></i> <a href="#title-37" title="3.7.3 启动kube-proxy服务">3.7.3 启动kube-proxy服务</a>
      </li>
      <li>
        <i class="be be-arrowright"></i> <a href="#title-38" title="3.7.4 检查服务运行状态">3.7.4 检查服务运行状态</a>
      </li>
    </ul>
    
    <span class="log-zd"><span class="log-close"><a title="隐藏目录"><i class="be be-cross"></i><strong>目录</strong></a></span></span>
  </div>
</div>

<a name="Nysvw"></a>

## <span id="1">1. 架构篇</span>

<a name="vIyyH"></a>

### <span id="11_kubernetes">1.1 kubernetes 架构说明</span>

<img data-original="https://cdn.nlark.com/yuque/0/2019/png/206952/1564577511433-970dda8f-915b-4ba3-bde6-bd562fc445b0.png" src="/wp-content/themes/clsn-003/img/blank.gif" alt="Kubernetes V1.15 二进制部署集群" alt="图片.png" />  
<a name="T47ku"></a>

### <span id="12_Flannel">1.2 Flannel网络架构图</span>

<img data-original="https://cdn.nlark.com/yuque/0/2019/png/206952/1564577532575-5d725f80-102a-48b2-a453-c6be0d1e6cb5.png#align=left&display=inline&height=630&name=%E5%9B%BE%E7%89%87.png&originHeight=630&originWidth=1004&size=96777&status=done&width=1004" src="/wp-content/themes/clsn-003/img/blank.gif" alt="Kubernetes V1.15 二进制部署集群" alt="图片.png" /> 

> [集群功能各模块功能描述：][1]  
> **Master节点：**  
> Master节点上面主要由四个模块组成，APIServer，schedule,controller-manager,etcd  
> APIServer: APIServer负责对外提供RESTful的kubernetes API的服务，它是系统管理指令的统一接口，任何对资源的增删该查都要交给APIServer处理后再交给etcd，如图，kubectl(kubernetes提供的客户端工具，该工具内部是对kubernetes API的调用）是直接和APIServer交互的。  
> schedule: schedule负责调度Pod到合适的Node上，如果把scheduler看成一个黑匣子，那么它的输入是pod和由多个Node组成的列表，输出是Pod和一个Node的绑定。 kubernetes目前提供了调度算法，同样也保留了接口。用户根据自己的需求定义自己的调度算法。  
> controller manager: 如果APIServer做的是前台的工作的话，那么controller manager就是负责后台的。每一个资源都对应一个控制器。而control manager就是负责管理这些控制器的，比如我们通过APIServer创建了一个Pod，当这个Pod创建成功后，APIServer的任务就算完成了。  
> etcd：etcd是一个高可用的键值存储系统，kubernetes使用它来存储各个资源的状态，从而实现了Restful的API。
> 
> **Node节点：**  
> 每个Node节点主要由三个模板组成：kublet, kube-proxy  
> kube-proxy: 该模块实现了kubernetes中的服务发现和反向代理功能。kube-proxy支持TCP和UDP连接转发，默认基Round Robin算法将客户端流量转发到与service对应的一组后端pod。服务发现方面，kube-proxy使用etcd的watch机制监控集群中service和endpoint对象数据的动态变化，并且维护一个service到endpoint的映射关系，从而保证了后端pod的IP变化不会对访问者造成影响，另外，kube-proxy还支持session affinity。  
> kublet：kublet是Master在每个Node节点上面的agent，是Node节点上面最重要的模块，它负责维护和管理该Node上的所有容器，但是如果容器不是通过kubernetes创建的，它并不会管理。本质上，它负责使Pod的运行状态与期望的状态一致。 

<a name="agfT7"></a>

### <span id="13_Kubernetes">1.3 Kubernetes工作流程</span>

<img data-original="https://cdn.nlark.com/yuque/0/2019/png/206952/1564577632607-a9896412-556e-4db0-93d4-e4233a4ea938.png#align=left&display=inline&height=591&name=%E5%9B%BE%E7%89%87.png&originHeight=591&originWidth=949&size=121090&status=done&width=949" src="/wp-content/themes/clsn-003/img/blank.gif" alt="Kubernetes V1.15 二进制部署集群" alt="图片.png" /> 

> 
<a name="UgTIp"></a>

## <span id="2">2. 环境说明</span>

<a name="O4su0"></a>

### <span id="21">2.1 部署节点说明</span>

|  主机名  |       IP        |   用途   |                          部署软件                          |
|:-----:|:---------------:|:------:|:------------------------------------------------------:|
| k8s-1 | 192.168.123.211 | master | apiserver,scheduler,controller-manager  
etcd,flanneld |
| k8s-2 | 192.168.123.212 |  node  |           kubelet,kube-proxy  
etcd,flanneld           |
| k8s-3 | 192.168.123.213 |  node  |           kubelet,kube-proxy  
etcd,flanneld           |

<a name="1X399"></a>

### <span id="22">2.2 操作系统环境</span>

<pre><code class="language-bash line-numbers"># 三台机器相同
[root@k8s-1 /root] master
# uname  -r
3.10.0-957.el7.x86_64

[root@k8s-1 /root] master
# cat  /etc/redhat-release
CentOS Linux release 7.6.1810 (Core)

[root@k8s-1 /root] master
# sestatus
SELinux status:                 disabled
</code></pre>

<a name="47N0T"></a>

### <span id="23">2.3 软件包版本</span>

|                 软件包                  |                                               下载地址                                               |
|:------------------------------------:|:------------------------------------------------------------------------------------------------:|
|  kubernetes-node-linux-amd64.tar.gz  |                  <https://dl.k8s.io/v1.15.1/kubernetes-node-linux-amd64.tar.gz>                  |
| kubernetes-server-linux-amd64.tar.gz |                 <https://dl.k8s.io/v1.15.1/kubernetes-server-linux-amd64.tar.gz>                 |
|  flannel-v0.11.0-linux-amd64.tar.gz  | <https://github.com/coreos/flannel/releases/download/v0.11.0/flannel-v0.11.0-linux-amd64.tar.gz> |
|   etcd-v3.3.10-linux-amd64.tar.gz    |   <https://github.com/etcd-io/etcd/releases/download/v3.3.10/etcd-v3.3.10-linux-amd64.tar.gz>    |

<a name="cKTBl"></a>

## <span id="3_Kubernetes">3. Kubernetes 安装及配置</span>

<a name="1hrdK"></a>

### <span id="31">3.1 初始化环境</span>

<a name="SyIDx"></a>

<span class="directory"></span>

#### <span id="311_SELINUX">3.1.1 设置关闭防火墙及SELINUX</span> {#title-0}

<pre><code class="language-bash line-numbers">systemctl stop firewalld && systemctl disable firewalld
setenforce 0
vi /etc/selinux/config
SELINUX=disabled
</code></pre>

<a name="KyB6H"></a>

<span class="directory"></span>

#### <span id="312_swap">3.1.2 关闭swap</span> {#title-1}

<pre><code class="language-bash line-numbers">swapoff -a && sysctl -w vm.swappiness=0
sed -i '/ swap / s/^\(.*\)$/#\1/g' /etc/fstab
</code></pre>

<a name="1XMMe"></a>

<span class="directory"></span>

#### <span id="313_Docker">3.1.3 设置Docker所需参数</span> {#title-2}

<pre><code class="language-bash line-numbers">cat &gt; /etc/sysctl.d/kubernetes.conf &lt;&lt;EOF
net.ipv4.ip_forward=1
net.ipv4.tcp_tw_recycle=0
vm.swappiness=0
vm.overcommit_memory=1
vm.panic_on_oom=0
fs.inotify.max_user_watches=89100
fs.file-max=52706963
fs.nr_open=52706963
net.ipv6.conf.all.disable_ipv6=1
EOF
sysctl -p  /etc/sysctl.d/kubernetes.conf 
</code></pre>

<a name="kT4nA"></a>

<span class="directory"></span>

#### <span id="314_Docker">3.1.4 安装 Docker</span> {#title-3}

<pre><code class="language-bash line-numbers"># 配置yum源
cd  /etc/yum.repo.d/
wget https://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo
yum clean all ;yum  repolist -y

# 安装docker ，版本 18.06.2
yum  install  docker-ce-18.06.2.ce-3.el7 -y

# 启动
systemctl start docker && systemctl enable docker
</code></pre>

<a name="yBjuQ"></a>

<span class="directory"></span>

#### <span id="315">3.1.5 创建相关目录</span> {#title-4}

<pre><code class="language-bash line-numbers"># 创建安装包存储目录
mkdir  /data/{install,ssl_config} -p
mkdir /data/ssl_config/{etcd,kubernetes}  -p

# 创建安装目录
mkdir /cloud/k8s/etcd/{bin,cfg,ssl} -p
mkdir /cloud/k8s/kubernetes/{bin,cfg,ssl} -p
</code></pre>

<a name="ZI75c"></a>

<span class="directory"></span>

#### <span id="316_SSH">3.1.6 SSH 互信配置</span> {#title-5}

<pre><code class="line-numbers">ssh-keygen
ssh-copy-id  k8s-1
ssh-copy-id  k8s-2
ssh-copy-id  k8s-3
</code></pre>

<a name="BPehy"></a>

<span class="directory"></span>

#### <span id="317_PATH">3.1.7 添加 PATH 变量</span> {#title-6}

<pre><code class="language-bash line-numbers">vi /etc/profile
export PATH=$PATH:/cloud/k8s/etcd/bin/:/cloud/k8s/kubernetes/bin/
</code></pre>

<a name="LyLYH"></a>

### <span id="32_ssl">3.2 创建ssl证书</span>

<a name="oSwhT"></a>

<span class="directory"></span>

#### <span id="321_CFSSL">3.2.1 安装及配置CFSSL</span> {#title-7}

<pre><code class="language-bash line-numbers">wget https://pkg.cfssl.org/R1.2/cfssl_linux-amd64
wget https://pkg.cfssl.org/R1.2/cfssljson_linux-amd64
wget https://pkg.cfssl.org/R1.2/cfssl-certinfo_linux-amd64
chmod +x cfssl_linux-amd64 cfssljson_linux-amd64 cfssl-certinfo_linux-amd64
mv cfssl_linux-amd64 /usr/local/bin/cfssl
mv cfssljson_linux-amd64 /usr/local/bin/cfssljson
mv cfssl-certinfo_linux-amd64 /usr/bin/cfssl-certinfo
</code></pre>

<a name="tKNzX"></a>

<span class="directory"></span>

#### <span id="322_ETCD">3.2.2 创建 ETCD 相关证书</span> {#title-8}

以下操作均在/data/ssl_config/etcd/目录中  
**etcd证书ca配置**

<pre><code class="language-bash line-numbers">cd /data/ssl_config/etcd/

cat &lt;&lt; EOF | tee ca-config.json
{
  "signing": {
    "default": {
      "expiry": "87600h"
    },
    "profiles": {
      "www": {
         "expiry": "87600h",
         "usages": [
            "signing",
            "key encipherment",
            "server auth",
            "client auth"
        ]
      }
    }
  }
}
EOF
</code></pre>

**创建 ETCD CA 配置文件**

<pre><code class="language-bash line-numbers">cat &lt;&lt; EOF | tee ca-csr.json
{
    "CN": "etcd CA",
    "key": {
        "algo": "rsa",
        "size": 2048
    },
    "names": [
        {
            "C": "CN",
            "L": "Beijing",
            "ST": "Beijing"
        }
    ]
}
EOF
</code></pre>

**创建 ETCD Server 证书**

<pre><code class="language-bash line-numbers">cat &lt;&lt; EOF | tee server-csr.json
{
    "CN": "etcd",
    "hosts": [
    "k8s-3",
    "k8s-2",
    "k8s-1",
    "192.168.123.211",
    "192.168.123.212",
    "192.168.123.213"
    ],
    "key": {
        "algo": "rsa",
        "size": 2048
    },
    "names": [
        {
            "C": "CN",
            "L": "Beijing",
            "ST": "Beijing"
        }
    ]
}
EOF
</code></pre>

生成 ETCD CA 证书和私钥

<pre><code class="language-bash line-numbers">cd /data/ssl_config/etcd/
# 生成ca证书
cfssl gencert -initca ca-csr.json | cfssljson -bare ca -
# 生成server证书
cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=www server-csr.json | cfssljson -bare server
</code></pre>

<a name="btxAS"></a>

<span class="directory"></span>

#### <span id="323_Kubernetes">3.2.3 创建 Kubernetes 相关证书</span> {#title-9}

以下操作均在/data/ssl_config/kubernetes/目录中  
**kubernetes 证书ca配置**

<pre><code class="language-bash line-numbers">cd /data/ssl_config/kubernetes/
cat &lt;&lt; EOF | tee ca-config.json
{
  "signing": {
    "default": {
      "expiry": "87600h"
    },
    "profiles": {
      "kubernetes": {
         "expiry": "87600h",
         "usages": [
            "signing",
            "key encipherment",
            "server auth",
            "client auth"
        ]
      }
    }
  }
}
EOF
</code></pre>

创建ca证书配置

<pre><code class="language-bash line-numbers">cat &lt;&lt; EOF | tee ca-csr.json
{
    "CN": "kubernetes",
    "key": {
        "algo": "rsa",
        "size": 2048
    },
    "names": [
        {
            "C": "CN",
            "L": "Beijing",
            "ST": "Beijing",
            "O": "k8s",
            "OU": "System"
        }
    ]
}
EOF
</code></pre>

生成API_SERVER证书

<pre><code class="language-bash line-numbers">cat &lt;&lt; EOF | tee server-csr.json
{
    "CN": "kubernetes",
    "hosts": [
      "10.0.0.1",
      "127.0.0.1",
      "192.168.123.211",
      "k8s-1",
      "kubernetes",
      "kubernetes.default",
      "kubernetes.default.svc",
      "kubernetes.default.svc.cluster",
      "kubernetes.default.svc.cluster.local"
    ],
    "key": {
        "algo": "rsa",
        "size": 2048
    },
    "names": [
        {
            "C": "CN",
            "L": "Beijing",
            "ST": "Beijing",
            "O": "k8s",
            "OU": "System"
        }
    ]
}
EOF
</code></pre>

创建 Kubernetes Proxy 证书

<pre><code class="language-bash line-numbers">cat &lt;&lt; EOF | tee kube-proxy-csr.json
{
  "CN": "system:kube-proxy",
  "hosts": [],
  "key": {
    "algo": "rsa",
    "size": 2048
  },
  "names": [
    {
      "C": "CN",
      "L": "Beijing",
      "ST": "Beijing",
      "O": "k8s",
      "OU": "System"
    }
  ]
}
EOF
</code></pre>

生成 \*\*kubernetes \*\* CA 证书和私钥

<pre><code class="language-bash line-numbers"># 生成ca证书
cfssl gencert -initca ca-csr.json | cfssljson -bare ca -
# 生成 api-server 证书
cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=kubernetes server-csr.json | cfssljson -bare server
# 生成 kube-proxy 证书
cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=kubernetes kube-proxy-csr.json | cfssljson -bare kube-proxy 
</code></pre>

<a name="YhaVS"></a>

### <span id="33_etcd">3.3 部署etcd</span>

<a name="hwD5H"></a>

<span class="directory"></span>

#### <span id="331">3.3.1 配置软件包</span> {#title-10}

<pre><code class="language-bash line-numbers">cd /data/install/
tar -xvf etcd-v3.3.10-linux-amd64.tar.gz
cd etcd-v3.3.10-linux-amd64/
cp etcd etcdctl /cloud/k8s/etcd/bin/
</code></pre>

<a name="wqRdw"></a>

<span class="directory"></span>

#### <span id="332_etcd">3.3.2 编辑etcd配置文件</span> {#title-11}

<pre><code class="language-bash line-numbers">vim /cloud/k8s/etcd/cfg/etcd
#[Member]
ETCD_NAME="etcd01"
ETCD_DATA_DIR="/var/lib/etcd/default.etcd"
ETCD_LISTEN_PEER_URLS="https://192.168.123.211:2380"
ETCD_LISTEN_CLIENT_URLS="https://192.168.123.211:2379"

#[Clustering]
ETCD_INITIAL_ADVERTISE_PEER_URLS="https://192.168.123.211:2380"
ETCD_ADVERTISE_CLIENT_URLS="https://192.168.123.211:2379"
ETCD_INITIAL_CLUSTER="etcd01=https://192.168.123.211:2380,etcd02=https://192.168.123.212:2380,etcd03=https://192.168.123.213:2380"
ETCD_INITIAL_CLUSTER_TOKEN="etcd-cluster"
ETCD_INITIAL_CLUSTER_STATE="new"
</code></pre>

<a name="gcfzP"></a>

<span class="directory"></span>

#### <span id="333_etcd_systemd_unit">3.3.3 创建 etcd的 systemd unit 文件</span> {#title-12}

<pre><code class="language-bash line-numbers">vim /usr/lib/systemd/system/etcd.service
[Unit]
Description=Etcd Server
After=network.target
After=network-online.target
Wants=network-online.target

[Service]
Type=notify
EnvironmentFile=/cloud/k8s/etcd/cfg/etcd
ExecStart=/cloud/k8s/etcd/bin/etcd \
--name=${ETCD_NAME} \
--data-dir=${ETCD_DATA_DIR} \
--listen-peer-urls=${ETCD_LISTEN_PEER_URLS} \
--listen-client-urls=${ETCD_LISTEN_CLIENT_URLS},http://127.0.0.1:2379 \
--advertise-client-urls=${ETCD_ADVERTISE_CLIENT_URLS} \
--initial-advertise-peer-urls=${ETCD_INITIAL_ADVERTISE_PEER_URLS} \
--initial-cluster=${ETCD_INITIAL_CLUSTER} \
--initial-cluster-token=${ETCD_INITIAL_CLUSTER_TOKEN} \
--initial-cluster-state=new \
--cert-file=/cloud/k8s/etcd/ssl/server.pem \
--key-file=/cloud/k8s/etcd/ssl/server-key.pem \
--peer-cert-file=/cloud/k8s/etcd/ssl/server.pem \
--peer-key-file=/cloud/k8s/etcd/ssl/server-key.pem \
--trusted-ca-file=/cloud/k8s/etcd/ssl/ca.pem \
--peer-trusted-ca-file=/cloud/k8s/etcd/ssl/ca.pem
Restart=on-failure
LimitNOFILE=65536

[Install]
WantedBy=multi-user.target
</code></pre>

<a name="6MJei"></a>

<span class="directory"></span>

#### <span id="334">3.3.4 配置证书文件</span> {#title-13}

<pre><code class="language-bash line-numbers">cd /data/ssl_config/etcd/
cp ca*pem server*pem /cloud/k8s/etcd/ssl
</code></pre>

<a name="ii5gV"></a>

<span class="directory"></span>

#### <span id="335_12">3.3.5 配置文件拷贝到 节点1、节点2</span> {#title-14}

<pre><code class="language-bash line-numbers">cd /cloud/k8s/ 
scp -r etcd k8s-2:/cloud/k8s/
scp -r etcd k8s-3:/cloud/k8s/
scp /usr/lib/systemd/system/etcd.service  k8s-2:/usr/lib/systemd/system/etcd.service
scp /usr/lib/systemd/system/etcd.service  k8s-3:/usr/lib/systemd/system/etcd.service
</code></pre>

修改另外两台机器配置文件

<pre><code class="language-bash line-numbers">### k8s-2 
cat  /cloud/k8s/etcd/cfg/etcd
#[Member]
ETCD_NAME="etcd02"
ETCD_DATA_DIR="/var/lib/etcd/default.etcd"
ETCD_LISTEN_PEER_URLS="https://192.168.123.212:2380"
ETCD_LISTEN_CLIENT_URLS="https://192.168.123.212:2379"

#[Clustering]
ETCD_INITIAL_ADVERTISE_PEER_URLS="https://192.168.123.212:2380"
ETCD_ADVERTISE_CLIENT_URLS="https://192.168.123.212:2379"
ETCD_INITIAL_CLUSTER="etcd01=https://192.168.123.211:2380,etcd02=https://192.168.123.212:2380,etcd03=https://192.168.123.213:2380"
ETCD_INITIAL_CLUSTER_TOKEN="etcd-cluster"
ETCD_INITIAL_CLUSTER_STATE="new"

### k8s-3 
cat  /cloud/k8s/etcd/cfg/etcd
#[Member]
ETCD_NAME="etcd03"
ETCD_DATA_DIR="/var/lib/etcd/default.etcd"
ETCD_LISTEN_PEER_URLS="https://192.168.123.213:2380"
ETCD_LISTEN_CLIENT_URLS="https://192.168.123.213:2379"

#[Clustering]
ETCD_INITIAL_ADVERTISE_PEER_URLS="https://192.168.123.213:2380"
ETCD_ADVERTISE_CLIENT_URLS="https://192.168.123.213:2379"
ETCD_INITIAL_CLUSTER="etcd01=https://192.168.123.211:2380,etcd02=https://192.168.123.212:2380,etcd03=https://192.168.123.213:2380"
ETCD_INITIAL_CLUSTER_TOKEN="etcd-cluster"
ETCD_INITIAL_CLUSTER_STATE="new"
</code></pre>

另外两台机器配置完成后，启动etcd服务，三台都需启动。  
<a name="D109O"></a>

<span class="directory"></span>

#### <span id="336_ETCD">3.3.6 启动ETCD服务</span> {#title-15}

<pre><code class="language-bash line-numbers">systemctl daemon-reload
systemctl enable etcd
systemctl start etcd
#启动ETCD集群同时启动二个节点，单节点是无法正常启动的。
</code></pre>

<a name="2w6W4"></a>

<span class="directory"></span>

#### <span id="337">3.3.7 检查服务是否正常</span> {#title-16}

<pre><code class="language-bash line-numbers">[root@k8s-1 /cloud/k8s/etcd/bin] master
# etcdctl --ca-file=/cloud/k8s/etcd/ssl/ca.pem --cert-file=/cloud/k8s/etcd/ssl/server.pem --key-file=/cloud/k8s/etcd/ssl/server-key.pem --endpoints="https://192.168.123.211:2379,https://192.168.123.212:2379,https://192.168.123.213:2379"  cluster-health
member 4c6bfb873a73368c is healthy: got healthy result from https://192.168.123.213:2379
member 622f71dbd55b34ce is healthy: got healthy result from https://192.168.123.211:2379
member f14004aa5403b07d is healthy: got healthy result from https://192.168.123.212:2379
cluster is healthy
</code></pre>

<a name="AGqD3"></a>

### <span id="34_Flannel">3.4 部署Flannel网络</span>

<a name="76kS4"></a>

<span class="directory"></span>

#### <span id="341_etcd_Pod">3.4.1 向 etcd 写入集群 Pod 网段信息</span> {#title-17}

<pre><code class="language-bash line-numbers"> cd /cloud/k8s/etcd/bin
 etcdctl --ca-file=ca.pem --cert-file=server.pem --key-file=server-key.pem \
 --endpoints="https://192.168.123.211:2379,https://192.168.123.212:2379,https://192.168.123.213:2379" \
 set /coreos.com/network/config  \
 '{ "Network": "172.18.0.0/16", "Backend": {"Type": "vxlan"}}'
</code></pre>

>     写入的 Pod 网段 ${CLUSTER_CIDR} 必须是 /16 段地址，必须与 kube-controller-manager 的 --cluster-cidr 参数值一致；
>     

<a name="5JuoG"></a>

<span class="directory"></span>

#### <span id="342_flannel">3.4.2 部署 flannel</span> {#title-18}

<pre><code class="language-bash line-numbers"> cd /data/install/
 tar xf  flannel-v0.11.0-linux-amd64.tar.gz
 mv flanneld mk-docker-opts.sh /cloud/k8s/kubernetes/bin/
</code></pre>

<a name="Y4xKV"></a>

<span class="directory"></span>

#### <span id="353_flannel">3.5.3 配置flannel</span> {#title-19}

<pre><code class="language-bash line-numbers">vim  /cloud/k8s/kubernetes/cfg/flanneld
FLANNEL_OPTIONS="--etcd-endpoints=https://192.168.123.211:2379,https://192.168.123.212:2379,https://192.168.123.213:2379 -etcd-cafile=/cloud/k8s/etcd/ssl/ca.pem -etcd-certfile=/cloud/k8s/etcd/ssl/server.pem -etcd-keyfile=/cloud/k8s/etcd/ssl/server-key.pem"
</code></pre>

<a name="rGEU5"></a>

<span class="directory"></span>

#### <span id="354_flanneld_systemd_unit">3.5.4 创建 flanneld 的 systemd unit 文件</span> {#title-20}

<pre><code class="language-bash line-numbers">vim /usr/lib/systemd/system/flanneld.service
[Unit]
Description=Flanneld overlay address etcd agent
After=network-online.target network.target
Before=docker.service

[Service]
Type=notify
EnvironmentFile=/cloud/k8s/kubernetes/cfg/flanneld
ExecStart=/cloud/k8s/kubernetes/bin/flanneld --ip-masq $FLANNEL_OPTIONS
ExecStartPost=/cloud/k8s/kubernetes/bin/mk-docker-opts.sh -k DOCKER_NETWORK_OPTIONS -d /run/flannel/subnet.env
Restart=on-failure

[Install]
WantedBy=multi-user.target
</code></pre>

>     mk-docker-opts.sh 脚本将分配给 flanneld 的 Pod 子网网段信息写入 /run/flannel/docker 文件，后续 docker 启动时 使用这个文件中的环境变量配置 docker0 网桥；
>     
> 
> flanneld 使用系统缺省路由所在的接口与其它节点通信，对于有多个网络接口（如内网和公网）的节点，可以用 -iface 参数指定通信接口，如上面的 eth0 接口;  
> flanneld 运行时需要 root 权限； 

<a name="PZVKL"></a>

<span class="directory"></span>

#### <span id="355_Docker">3.5.5 配置Docker启动指定子网段</span> {#title-21}

<pre><code class="language-bash line-numbers">vim /usr/lib/systemd/system/docker.service
[Unit]
Description=Docker Application Container Engine
Documentation=https://docs.docker.com
After=network-online.target firewalld.service
Wants=network-online.target

[Service]
Type=notify
EnvironmentFile=/run/flannel/subnet.env
ExecStart=/usr/bin/dockerd  $DOCKER_NETWORK_OPTIONS
ExecReload=/bin/kill -s HUP $MAINPID
LimitNOFILE=infinity
LimitNPROC=infinity
LimitCORE=infinity
TimeoutStartSec=0
Delegate=yes
KillMode=process
Restart=on-failure
StartLimitBurst=3
StartLimitInterval=60s

[Install]
WantedBy=multi-user.target
</code></pre>

<a name="YYHBC"></a>

<span class="directory"></span>

#### <span id="356_flanneld_systemd_unit">3.5.6 将flanneld systemd unit 文件到所有节点</span> {#title-22}

<pre><code class="language-bash line-numbers">cd /cloud/k8s/
scp -r kubernetes k8s-2:/cloud/k8s/
scp -r kubernetes k8s-3:/cloud/k8s/
scp /cloud/k8s/kubernetes/cfg/flanneld  k8s-2:/cloud/k8s/kubernetes/cfg/flanneld
scp /cloud/k8s/kubernetes/cfg/flanneld  k8s-3:/cloud/k8s/kubernetes/cfg/flanneld
scp /usr/lib/systemd/system/docker.service    k8s-2:/usr/lib/systemd/system/docker.service 
scp /usr/lib/systemd/system/docker.service    k8s-3:/usr/lib/systemd/system/docker.service
scp /usr/lib/systemd/system/flanneld.service  k8s-2:/usr/lib/systemd/system/flanneld.service 
scp /usr/lib/systemd/system/flanneld.service  k8s-3:/usr/lib/systemd/system/flanneld.service 

# 启动服务(每台节点都操作)
systemctl daemon-reload
systemctl start flanneld
systemctl enable flanneld
systemctl restart docker
</code></pre>

<a name="bQGmu"></a>

<span class="directory"></span>

#### <span id="357_fannel">3.5.7 验证fannel网络配置</span> {#title-23}

<pre><code class="language-bash line-numbers">[root@k8s-1 /data/install] master
# ip a
1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
    inet 127.0.0.1/8 scope host lo
       valid_lft forever preferred_lft forever
2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc mq state UP group default qlen 1000
    link/ether 00:0c:29:33:de:53 brd ff:ff:ff:ff:ff:ff
    inet 192.168.123.211/24 brd 192.168.123.255 scope global noprefixroute eth0
       valid_lft forever preferred_lft forever
3: flannel.1: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1450 qdisc noqueue state UNKNOWN group default
    link/ether 1a:6f:5a:0b:c7:18 brd ff:ff:ff:ff:ff:ff
    inet 172.18.30.0/32 scope global flannel.1
       valid_lft forever preferred_lft forever
4: docker0: &lt;NO-CARRIER,BROADCAST,MULTICAST,UP&gt; mtu 1500 qdisc noqueue state DOWN group default
    link/ether 02:42:5c:d0:df:e6 brd ff:ff:ff:ff:ff:ff
    inet 172.18.30.1/24 brd 172.18.30.255 scope global docker0
       valid_lft forever preferred_lft forever
</code></pre>

<a name="jy9VQ"></a>

### <span id="35_master">3.5 部署 master 节点</span>

> kubernetes master 节点运行如下组件：  
> kube-apiserver  
> kube-scheduler  
> kube-controller-manager  
> kube-scheduler 和 kube-controller-manager 可以以集群模式运行，通过 leader 选举产生一个工作进程，其它进程处于阻塞模式。 

<a name="qVk4Z"></a>

<span class="directory"></span>

#### <span id="351__master">3.5.1 配置 master 节点文件</span> {#title-24}

<pre><code class="language-bash line-numbers"> cd /data/install/
 tar xf kubernetes-server-linux-amd64.tar.gz 
 cd kubernetes/server/bin/
 cp kube-scheduler kube-apiserver kube-controller-manager kubectl /cloud/k8s/kubernetes/bin/
</code></pre>

<a name="A91WA"></a>

<span class="directory"></span>

#### <span id="352_kubernetes">3.5.2 配置 kubernetes相关证书</span> {#title-25}

<pre><code class="language-bash line-numbers">cd /data/ssl_config/kubernetes/
cp *pem /cloud/k8s/kubernetes/ssl/
</code></pre>

<a name="y1N1U"></a>

<span class="directory"></span>

#### <span id="353_kube-apiserver">3.5.3 部署 kube-apiserver 组件</span> {#title-26}

**创建 TLS Bootstrapping Token**

<pre><code class="language-bash line-numbers"># head -c 16 /dev/urandom | od -An -t x | tr -d ' '
449bbeb0ea7e50f321087a123a509a19

# vim /cloud/k8s/kubernetes/cfg/token.csv
449bbeb0ea7e50f321087a123a509a19,kubelet-bootstrap,10001,"system:kubelet-bootstrap"
</code></pre>

**创建apiserver配置文件**

<pre><code class="language-bash line-numbers">vim /cloud/k8s/kubernetes/cfg/kube-apiserver
KUBE_APISERVER_OPTS="--logtostderr=true \
--v=4 \
--etcd-servers=https://192.168.123.211:2379,https://192.168.123.212:2379,https://192.168.123.213:2379 \
--bind-address=192.168.123.211 \
--secure-port=6443 \
--advertise-address=192.168.123.211 \
--allow-privileged=true \
--service-cluster-ip-range=10.0.0.0/24 \
--enable-admission-plugins=NamespaceLifecycle,LimitRanger,SecurityContextDeny,ServiceAccount,ResourceQuota,NodeRestriction \
--authorization-mode=RBAC,Node \
--enable-bootstrap-token-auth \
--token-auth-file=/cloud/k8s/kubernetes/cfg/token.csv \
--service-node-port-range=30000-50000 \
--tls-cert-file=/cloud/k8s/kubernetes/ssl/server.pem  \
--tls-private-key-file=/cloud/k8s/kubernetes/ssl/server-key.pem \
--client-ca-file=/cloud/k8s/kubernetes/ssl/ca.pem \
--service-account-key-file=/cloud/k8s/kubernetes/ssl/ca-key.pem \
--etcd-cafile=/cloud/k8s/etcd/ssl/ca.pem \
--etcd-certfile=/cloud/k8s/etcd/ssl/server.pem \
--etcd-keyfile=/cloud/k8s/etcd/ssl/server-key.pem"
</code></pre>

**创建 kube-apiserver systemd unit 文件**

<pre><code class="language-bash line-numbers">vim  /usr/lib/systemd/system/kube-apiserver.service
[Unit]
Description=Kubernetes API Server
Documentation=https://github.com/kubernetes/kubernetes

[Service]
EnvironmentFile=/cloud/k8s/kubernetes/cfg/kube-apiserver
ExecStart=/cloud/k8s/kubernetes/bin/kube-apiserver $KUBE_APISERVER_OPTS
Restart=on-failure

[Install]
WantedBy=multi-user.target
</code></pre>

**启动服务**

<pre><code class="language-bash line-numbers">systemctl daemon-reload
systemctl enable kube-apiserver
systemctl restart kube-apiserver
</code></pre>

**查看apiserver是否运行**

<pre><code class="language-bash line-numbers">[root@k8s-1 /data/ssl_config/kubernetes] master
# ps -ef |grep kube-apiserver
root      5475     1  2 7月30 ?       01:57:41 /cloud/k8s/kubernetes/bin/kube-apiserver --logtostderr=true --v=4 --etcd-servers=https://192.168.123.211:2379,https://192.168.123.212:2379,https://192.168.123.213:2379 --bind-address=192.168.123.211 --secure-port=6443 --advertise-address=192.168.123.211 --allow-privileged=true --service-cluster-ip-range=10.0.0.0/24 --enable-admission-plugins=NamespaceLifecycle,LimitRanger,SecurityContextDeny,ServiceAccount,ResourceQuota,NodeRestriction --authorization-mode=RBAC,Node --enable-bootstrap-token-auth --token-auth-file=/cloud/k8s/kubernetes/cfg/token.csv --service-node-port-range=30000-50000 --tls-cert-file=/cloud/k8s/kubernetes/ssl/server.pem --tls-private-key-file=/cloud/k8s/kubernetes/ssl/server-key.pem --client-ca-file=/cloud/k8s/kubernetes/ssl/ca.pem --service-account-key-file=/cloud/k8s/kubernetes/ssl/ca-key.pem --etcd-cafile=/cloud/k8s/etcd/ssl/ca.pem --etcd-certfile=/cloud/k8s/etcd/ssl/server.pem --etcd-keyfile=/cloud/k8s/etcd/ssl/server-key.pem
root      6886  2930  0 19:49 pts/0    00:00:00 grep --color=auto kube-apiserver
</code></pre>

<a name="n314u"></a>

<span class="directory"></span>

#### <span id="354_kube-scheduler">3.5.4 部署kube-scheduler</span> {#title-27}

**创建kube-scheduler配置文件**

<pre><code class="language-bash line-numbers">vim  /cloud/k8s/kubernetes/cfg/kube-scheduler
KUBE_SCHEDULER_OPTS="--logtostderr=true --v=4 --master=127.0.0.1:8080 --leader-elect"
</code></pre>

>     --address：在 127.0.0.1:10251 端口接收 http /metrics 请求；kube-scheduler 目前还不支持接收 https 请求；
>     
> 
> --kubeconfig：指定 kubeconfig 文件路径，kube-scheduler 使用它连接和验证 kube-apiserver；  
> --leader-elect=true：集群运行模式，启用选举功能；被选为 leader 的节点负责处理工作，其它节点为阻塞状态； 

**创建kube-scheduler systemd unit 文件**

<pre><code class="language-bash line-numbers">vim /usr/lib/systemd/system/kube-scheduler.service
[Unit]
Description=Kubernetes Scheduler
Documentation=https://github.com/kubernetes/kubernetes

[Service]
EnvironmentFile=/cloud/k8s/kubernetes/cfg/kube-scheduler
ExecStart=/cloud/k8s/kubernetes/bin/kube-scheduler $KUBE_SCHEDULER_OPTS
Restart=on-failure

[Install]
WantedBy=multi-user.target
</code></pre>

**启动kube-scheduler服务**

<pre><code class="language-bash line-numbers">systemctl daemon-reload 
systemctl enable kube-scheduler.service  
systemctl restart kube-scheduler.service 
</code></pre>

**查看kube-scheduler是否运行**

<pre><code class="language-bash line-numbers">[root@k8s-1 /data/ssl_config/kubernetes] master
#  ps -ef |grep kube-scheduler
root      7269  2930  0 19:54 pts/0    00:00:00 grep --color=auto kube-scheduler
root     13970     1  0 8月02 ?       00:01:21 /cloud/k8s/kubernetes/bin/kube-scheduler --logtostderr=true --v=4 --master=127.0.0.1:8080 --leader-elect

[root@k8s-1 /data/ssl_config/kubernetes] master
# systemctl status kube-scheduler
● kube-scheduler.service - Kubernetes Scheduler
   Loaded: loaded (/usr/lib/systemd/system/kube-scheduler.service; enabled; vendor preset: disabled)
   Active: active (running) since 五 2019-08-02 18:33:11 CST; 1 day 1h ago
     Docs: https://github.com/kubernetes/kubernetes
 Main PID: 13970 (kube-scheduler)
    Tasks: 10
   Memory: 19.1M
   CGroup: /system.slice/kube-scheduler.service
           └─13970 /cloud/k8s/kubernetes/bin/kube-scheduler --logtostderr=tru...

8月 03 19:46:52 k8s-1 kube-scheduler[13970]: I0803 19:46:52.580662   13970 ...d
8月 03 19:47:03 k8s-1 kube-scheduler[13970]: I0803 19:47:03.578985   13970 ...d
8月 03 19:47:03 k8s-1 kube-scheduler[13970]: I0803 19:47:03.583437   13970 ...d
8月 03 19:48:31 k8s-1 kube-scheduler[13970]: I0803 19:48:31.637472   13970 ...d
8月 03 19:48:48 k8s-1 kube-scheduler[13970]: I0803 19:48:48.617124   13970 ...d
8月 03 19:50:00 k8s-1 kube-scheduler[13970]: I0803 19:50:00.589103   13970 ...d
8月 03 19:50:18 k8s-1 kube-scheduler[13970]: I0803 19:50:18.616574   13970 ...d
8月 03 19:52:15 k8s-1 kube-scheduler[13970]: I0803 19:52:15.629976   13970 ...d
8月 03 19:52:45 k8s-1 kube-scheduler[13970]: I0803 19:52:45.580103   13970 ...d
8月 03 19:53:56 k8s-1 kube-scheduler[13970]: I0803 19:53:56.601687   13970 ...d
Hint: Some lines were ellipsized, use -l to show in full.
</code></pre>

<a name="lItbl"></a>

<span class="directory"></span>

#### <span id="355_kube-controller-manager">3.5.5 部署kube-controller-manager</span> {#title-28}

**创建kube-controller-manager配置文件**

<pre><code class="language-bash line-numbers">vim  /cloud/k8s/kubernetes/cfg/kube-controller-manager
KUBE_CONTROLLER_MANAGER_OPTS="--logtostderr=true \
--v=4 \
--master=127.0.0.1:8080 \
--leader-elect=true \
--address=127.0.0.1 \
--service-cluster-ip-range=10.0.0.0/24 \
--cluster-name=kubernetes \
--cluster-signing-cert-file=/cloud/k8s/kubernetes/ssl/ca.pem \
--cluster-signing-key-file=/cloud/k8s/kubernetes/ssl/ca-key.pem  \
--root-ca-file=/cloud/k8s/kubernetes/ssl/ca.pem \
--service-account-private-key-file=/cloud/k8s/kubernetes/ssl/ca-key.pem"
</code></pre>

**创建kube-controller-manager systemd unit 文件**

<pre><code class="language-bash line-numbers">vim  /usr/lib/systemd/system/kube-controller-manager.service
[Unit]
Description=Kubernetes Controller Manager
Documentation=https://github.com/kubernetes/kubernetes

[Service]
EnvironmentFile=/cloud/k8s/kubernetes/cfg/kube-controller-manager
ExecStart=/cloud/k8s/kubernetes/bin/kube-controller-manager $KUBE_CONTROLLER_MANAGER_OPTS
Restart=on-failure

[Install]
WantedBy=multi-user.target
</code></pre>

**启动服务**

<pre><code class="language-bash line-numbers">systemctl daemon-reload
systemctl enable kube-controller-manager
systemctl restart kube-controller-manager
</code></pre>

**查看kube-controller-manager是否运行**

<pre><code class="language-bash line-numbers">[root@k8s-1 /data/ssl_config/kubernetes] master
# ps -ef |grep kube-controller-manager
root      7759  2930  0 19:59 pts/0    00:00:00 grep --color=auto kube-controller-manager
root     13972     1  0 8月02 ?       00:10:56 /cloud/k8s/kubernetes/bin/kube-controller-manager --logtostderr=true --v=4 --master=127.0.0.1:8080 --leader-elect=true --address=127.0.0.1 --service-cluster-ip-range=10.0.0.0/24 --cluster-name=kubernetes --cluster-signing-cert-file=/cloud/k8s/kubernetes/ssl/ca.pem --cluster-signing-key-file=/cloud/k8s/kubernetes/ssl/ca-key.pem --root-ca-file=/cloud/k8s/kubernetes/ssl/ca.pem --service-account-private-key-file=/cloud/k8s/kubernetes/ssl/ca-key.pem

[root@k8s-1 /data/ssl_config/kubernetes] master
#  systemctl status kube-controller-manager
● kube-controller-manager.service - Kubernetes Controller Manager
   Loaded: loaded (/usr/lib/systemd/system/kube-controller-manager.service; enabled; vendor preset: disabled)
   Active: active (running) since 五 2019-08-02 18:33:13 CST; 1 day 1h ago
     Docs: https://github.com/kubernetes/kubernetes
 Main PID: 13972 (kube-controller)
    Tasks: 10
   Memory: 51.9M
   CGroup: /system.slice/kube-controller-manager.service
           └─13972 /cloud/k8s/kubernetes/bin/kube-controller-manager --logtos...

8月 03 19:59:48 k8s-1 kube-controller-manager[13972]: I0803 19:59:48.522342 ...
8月 03 19:59:48 k8s-1 kube-controller-manager[13972]: I0803 19:59:48.526381 ...
8月 03 19:59:50 k8s-1 kube-controller-manager[13972]: I0803 19:59:50.211112 ...
8月 03 19:59:50 k8s-1 kube-controller-manager[13972]: I0803 19:59:50.455555 ...
8月 03 19:59:50 k8s-1 kube-controller-manager[13972]: I0803 19:59:50.738397 ...
8月 03 19:59:50 k8s-1 kube-controller-manager[13972]: I0803 19:59:50.767332 ...
8月 03 19:59:51 k8s-1 kube-controller-manager[13972]: I0803 19:59:51.502835 ...
8月 03 19:59:53 k8s-1 kube-controller-manager[13972]: I0803 19:59:53.567923 ...
8月 03 19:59:53 k8s-1 kube-controller-manager[13972]: I0803 19:59:53.567955 ...
8月 03 19:59:54 k8s-1 kube-controller-manager[13972]: I0803 19:59:54.321341 ...
Hint: Some lines were ellipsized, use -l to show in full.
</code></pre>

<a name="bd17q"></a>

<span class="directory"></span>

#### <span id="356_master">3.5.6 查看master集群状态</span> {#title-29}

<pre><code class="language-bash line-numbers">[root@k8s-1 /root] master
# kubectl get cs,nodes
NAME                                 STATUS    MESSAGE             ERROR
componentstatus/controller-manager   Healthy   ok
componentstatus/scheduler            Healthy   ok
componentstatus/etcd-2               Healthy   {"health":"true"}
componentstatus/etcd-1               Healthy   {"health":"true"}
componentstatus/etcd-0               Healthy   {"health":"true"}
</code></pre>

<a name="v6nJy"></a>

### <span id="36_node">3.6 部署node 节点</span>

> kubernetes work 节点运行如下组件：  
> docker  
> kubelet  
> kube-proxy 

<a name="psQXf"></a>

<span class="directory"></span>

#### <span id="361_kubelet">3.6.1 部署 kubelet 组件</span> {#title-30}

>     kublet 运行在每个 worker 节点上，接收 kube-apiserver 发送的请求，管理 Pod 容器，执行交互式命令，如exec、run、logs 等;
>     
> 
> kublet 启动时自动向 kube-apiserver 注册节点信息，内置的 cadvisor 统计和监控节点的资源使用情况;  
> 为确保安全，本文档只开启接收 https 请求的安全端口，对请求进行认证和授权，拒绝未授权的访问(如apiserver、heapster)。 

**配置node节点**

<pre><code class="language-bash line-numbers">cd /data/install/kubernetes/server/bin/
scp kubelet kube-proxy k8s-2:/cloud/k8s/kubernetes/bin/
scp kubelet kube-proxy k8s-3:/cloud/k8s/kubernetes/bin/
</code></pre>

**创建 kubelet bootstrap.kubeconfig 文件**

<pre><code class="language-bash line-numbers"> cd /data/ssl_config/kubernetes/
vim environment.sh
# 创建kubelet bootstrapping kubeconfig
BOOTSTRAP_TOKEN=449bbeb0ea7e50f321087a123a509a19
KUBE_APISERVER="https://192.168.123.211:6443"
# 设置集群参数
kubectl config set-cluster kubernetes \
  --certificate-authority=./ca.pem \
  --embed-certs=true \
  --server=${KUBE_APISERVER} \
  --kubeconfig=bootstrap.kubeconfig

# 设置客户端认证参数
kubectl config set-credentials kubelet-bootstrap \
  --token=${BOOTSTRAP_TOKEN} \
  --kubeconfig=bootstrap.kubeconfig

# 设置上下文参数
kubectl config set-context default \
  --cluster=kubernetes \
  --user=kubelet-bootstrap \
  --kubeconfig=bootstrap.kubeconfig

# 设置默认上下文
kubectl config use-context default --kubeconfig=bootstrap.kubeconfig
</code></pre>

> 通过 `bash  environment.sh`获取 bootstrap.kubeconfig 配置文件。 

**创建 kubelet.kubeconfig 文件**

<pre><code class="language-bash line-numbers">vim envkubelet.kubeconfig.sh
# 创建kubelet bootstrapping kubeconfig
BOOTSTRAP_TOKEN=449bbeb0ea7e50f321087a123a509a19
KUBE_APISERVER="https://192.168.123.211:6443"

# 设置集群参数
kubectl config set-cluster kubernetes \
  --certificate-authority=./ca.pem \
  --embed-certs=true \
  --server=${KUBE_APISERVER} \
  --kubeconfig=kubelet.kubeconfig

# 设置客户端认证参数
kubectl config set-credentials kubelet \
  --token=${BOOTSTRAP_TOKEN} \
  --kubeconfig=kubelet.kubeconfig

# 设置上下文参数
kubectl config set-context default \
  --cluster=kubernetes \
  --user=kubelet \
  --kubeconfig=kubelet.kubeconfig

# 设置默认上下文
kubectl config use-context default --kubeconfig=kubelet.kubeconfig
</code></pre>

**创建kube-proxy kubeconfig文件**

<pre><code class="language-bash line-numbers">vim  env_proxy.sh
# 创建kube-proxy kubeconfig文件

BOOTSTRAP_TOKEN=449bbeb0ea7e50f321087a123a509a19
KUBE_APISERVER="https://192.168.123.211:6443"

kubectl config set-cluster kubernetes \
  --certificate-authority=./ca.pem \
  --embed-certs=true \
  --server=${KUBE_APISERVER} \
  --kubeconfig=kube-proxy.kubeconfig

kubectl config set-credentials kube-proxy \
  --client-certificate=./kube-proxy.pem \
  --client-key=./kube-proxy-key.pem \
  --embed-certs=true \
  --kubeconfig=kube-proxy.kubeconfig

kubectl config set-context default \
  --cluster=kubernetes \
  --user=kube-proxy \
  --kubeconfig=kube-proxy.kubeconfig

kubectl config use-context default --kubeconfig=kube-proxy.kubeconfig
</code></pre>

将bootstrap kubeconfig kube-proxy.kubeconfig 文件拷贝到所有 nodes节点

<pre><code class="language-bash line-numbers">scp -rp bootstrap.kubeconfig kube-proxy.kubeconfig k8s-2:/cloud/k8s/kubernetes/cfg/
scp -rp bootstrap.kubeconfig kube-proxy.kubeconfig k8s-3:/cloud/k8s/kubernetes/cfg/
</code></pre>

<a name="8lXKd"></a>

<span class="directory"></span>

#### <span id="362_kubelet_nodes">3.6.2 创建kubelet 参数配置文件拷贝到所有 nodes节点</span> {#title-31}

**创建 kubelet 参数配置模板文件**

<pre><code class="language-bash line-numbers">[root@k8s-2 /root] node
# cat /cloud/k8s/kubernetes/cfg/kubelet.config
kind: KubeletConfiguration
apiVersion: kubelet.config.k8s.io/v1beta1
address: 192.168.123.212
port: 10250
readOnlyPort: 10255
cgroupDriver: cgroupfs
clusterDomain: cluster.local.
failSwapOn: false
authentication:
  anonymous:
    enabled: true
</code></pre>

**创建kubelet配置文件**

<pre><code class="language-bash line-numbers">vim  /cloud/k8s/kubernetes/cfg/kubelet
KUBELET_OPTS="--logtostderr=true \
--v=4 \
--hostname-override=k8s-2 \
--kubeconfig=/cloud/k8s/kubernetes/cfg/kubelet.kubeconfig \
--bootstrap-kubeconfig=/cloud/k8s/kubernetes/cfg/bootstrap.kubeconfig \
--config=/cloud/k8s/kubernetes/cfg/kubelet.config \
--cert-dir=/cloud/k8s/kubernetes/ssl \
--pod-infra-container-image=registry.cn-hangzhou.aliyuncs.com/google-containers/pause-amd64:3.0"
</code></pre>

**创建kubelet systemd unit 文件**

<pre><code class="language-bash line-numbers"> vim /usr/lib/systemd/system/kubelet.service
[Unit]
Description=Kubernetes Kubelet
After=docker.service
Requires=docker.service

[Service]
EnvironmentFile=/cloud/k8s/kubernetes/cfg/kubelet
ExecStart=/cloud/k8s/kubernetes/bin/kubelet $KUBELET_OPTS
Restart=on-failure
KillMode=process

[Install]
WantedBy=multi-user.target
</code></pre>

**将kubelet-bootstrap用户绑定到系统集群角色**

<pre><code class="language-bash line-numbers">kubectl create clusterrolebinding kubelet-bootstrap \
  --clusterrole=system:node-bootstrapper \
  --user=kubelet-bootstrap
</code></pre>

<a name="xN1Wr"></a>

<span class="directory"></span>

#### <span id="363_kubelet">3.6.3 启动kubelet服务</span> {#title-32}

<pre><code class="language-bash line-numbers">systemctl daemon-reload
systemctl enable kubelet
systemctl restart kubelet
</code></pre>

<a name="fB8C0"></a>

<span class="directory"></span>

#### <span id="364_approve_kubelet_CSR">3.6.4 approve kubelet CSR 请求</span> {#title-33}

<pre><code class="language-bash line-numbers">kubectl get csr
kubectl certificate approve $NAME 
kubectl get csr
csr 状态变为 Approved,Issued 即可
</code></pre>

>   * Requesting User：请求 CSR 的用户，kube-apiserver 对它进行认证和授权；
>   * Subject：请求签名的证书信息；
>   * 证书的 CN 是 system:node:kube-node2， Organization 是 system:nodes，kube-apiserver 的 Node 授权模式会授予该证书的相关权限；

<a name="614St"></a>

<span class="directory"></span>

#### <span id="365">3.6.5 查看集群状态</span> {#title-34}

<pre><code class="language-bash line-numbers">[root@k8s-1 /root] master
# kubectl  get  nodes,cs
NAME         STATUS   ROLES   AGE     VERSION
node/k8s-2   Ready    node    3d22h   v1.15.1
node/k8s-3   Ready    node    3d22h   v1.15.1

NAME                                 STATUS    MESSAGE             ERROR
componentstatus/scheduler            Healthy   ok
componentstatus/controller-manager   Healthy   ok
componentstatus/etcd-0               Healthy   {"health":"true"}
componentstatus/etcd-2               Healthy   {"health":"true"}
componentstatus/etcd-1               Healthy   {"health":"true"}
</code></pre>

<a name="LJxcV"></a>

### <span id="37_node_kube-proxy">3.7 部署 node kube-proxy 组件</span>

> kube-proxy 运行在所有 node节点上，它监听 apiserver 中 service 和 Endpoint 的变化情况，创建路由规则来进行服务负载均衡。 

<a name="OQ3TZ"></a>

<span class="directory"></span>

#### <span id="371_kube-proxy">3.7.1 创建kube-proxy配置文件</span> {#title-35}

<pre><code class="language-bash line-numbers">vim  /cloud/k8s/kubernetes/cfg/kube-proxy
KUBE_PROXY_OPTS="--logtostderr=true \
--v=4 \
--hostname-override=k8s-2 \
--cluster-cidr=10.0.0.0/24 \
--kubeconfig=/cloud/k8s/kubernetes/cfg/kube-proxy.kubeconfig"
</code></pre>

<a name="SBiQa"></a>

<span class="directory"></span>

#### <span id="372_kube-proxy_systemd_unit">3.7.2 创建kube-proxy systemd unit 文件</span> {#title-36}

<pre><code class="language-bash line-numbers">vim /usr/lib/systemd/system/kube-proxy.service
[Unit]
Description=Kubernetes Proxy
After=network.target

[Service]
EnvironmentFile=/cloud/k8s/kubernetes/cfg/kube-proxy
ExecStart=/cloud/k8s/kubernetes/bin/kube-proxy $KUBE_PROXY_OPTS
Restart=on-failure

[Install]
WantedBy=multi-user.target
</code></pre>

<a name="7Tzpi"></a>

<span class="directory"></span>

#### <span id="373_kube-proxy">3.7.3 启动kube-proxy服务</span> {#title-37}

<pre><code class="language-bash line-numbers">systemctl daemon-reload
systemctl enable kube-proxy
systemctl restart kube-proxy
</code></pre>

<a name="ZVmi2"></a>

<span class="directory"></span>

#### <span id="374">3.7.4 检查服务运行状态</span> {#title-38}

<pre><code class="language-bash line-numbers">[root@k8s-2 /root] node
#  systemctl status kube-proxy
● kube-proxy.service - Kubernetes Proxy
   Loaded: loaded (/usr/lib/systemd/system/kube-proxy.service; enabled; vendor preset: disabled)
   Active: active (running) since 二 2019-07-30 22:30:04 CST; 3 days ago
 Main PID: 5764 (kube-proxy)
    Tasks: 0
   Memory: 11.8M
   CGroup: /system.slice/kube-proxy.service
           ‣ 5764 /cloud/k8s/kubernetes/bin/kube-proxy --logtostderr=true --v...

8月 03 20:51:33 k8s-2 kube-proxy[5764]: I0803 20:51:33.736946    5764 iptab...]
8月 03 20:51:33 k8s-2 kube-proxy[5764]: I0803 20:51:33.740738    5764 healt..."
8月 03 20:51:33 k8s-2 kube-proxy[5764]: I0803 20:51:33.740762    5764 proxi...s
8月 03 20:51:33 k8s-2 kube-proxy[5764]: I0803 20:51:33.740780    5764 bound...s
8月 03 20:51:34 k8s-2 kube-proxy[5764]: I0803 20:51:34.018700    5764 confi...e
8月 03 20:51:34 k8s-2 kube-proxy[5764]: I0803 20:51:34.028396    5764 confi...e
8月 03 20:51:36 k8s-2 kube-proxy[5764]: I0803 20:51:36.035812    5764 confi...e
8月 03 20:51:36 k8s-2 kube-proxy[5764]: I0803 20:51:36.046563    5764 confi...e
8月 03 20:51:38 k8s-2 kube-proxy[5764]: I0803 20:51:38.045395    5764 confi...e
8月 03 20:51:38 k8s-2 kube-proxy[5764]: I0803 20:51:38.061197    5764 confi...e
Hint: Some lines were ellipsized, use -l to show in full.
</code></pre>

至此 kubernetes 1.15 版本简单部署完成~  
[未完待续]

<div id="toc_container" class="toc_white have_bullets">
  <ul class="toc_list">
    <li>
      <a href="#1">1. 架构篇</a><ul>
        <li>
          <a href="#11_kubernetes">1.1 kubernetes 架构说明</a>
        </li>
        <li>
          <a href="#12_Flannel">1.2 Flannel网络架构图</a>
        </li>
        <li>
          <a href="#13_Kubernetes">1.3 Kubernetes工作流程</a>
        </li>
      </ul>
    </li>
    
    <li>
      <a href="#2">2. 环境说明</a><ul>
        <li>
          <a href="#21">2.1 部署节点说明</a>
        </li>
        <li>
          <a href="#22">2.2 操作系统环境</a>
        </li>
        <li>
          <a href="#23">2.3 软件包版本</a>
        </li>
      </ul>
    </li>
    
    <li>
      <a href="#3_Kubernetes">3. Kubernetes 安装及配置</a><ul>
        <li>
          <a href="#31">3.1 初始化环境</a><ul>
            <li>
              <a href="#311_SELINUX">3.1.1 设置关闭防火墙及SELINUX</a>
            </li>
            <li>
              <a href="#312_swap">3.1.2 关闭swap</a>
            </li>
            <li>
              <a href="#313_Docker">3.1.3 设置Docker所需参数</a>
            </li>
            <li>
              <a href="#314_Docker">3.1.4 安装 Docker</a>
            </li>
            <li>
              <a href="#315">3.1.5 创建相关目录</a>
            </li>
            <li>
              <a href="#316_SSH">3.1.6 SSH 互信配置</a>
            </li>
            <li>
              <a href="#317_PATH">3.1.7 添加 PATH 变量</a>
            </li>
          </ul>
        </li>
        
        <li>
          <a href="#32_ssl">3.2 创建ssl证书</a><ul>
            <li>
              <a href="#321_CFSSL">3.2.1 安装及配置CFSSL</a>
            </li>
            <li>
              <a href="#322_ETCD">3.2.2 创建 ETCD 相关证书</a>
            </li>
            <li>
              <a href="#323_Kubernetes">3.2.3 创建 Kubernetes 相关证书</a>
            </li>
          </ul>
        </li>
        
        <li>
          <a href="#33_etcd">3.3 部署etcd</a><ul>
            <li>
              <a href="#331">3.3.1 配置软件包</a>
            </li>
            <li>
              <a href="#332_etcd">3.3.2 编辑etcd配置文件</a>
            </li>
            <li>
              <a href="#333_etcd_systemd_unit">3.3.3 创建 etcd的 systemd unit 文件</a>
            </li>
            <li>
              <a href="#334">3.3.4 配置证书文件</a>
            </li>
            <li>
              <a href="#335_12">3.3.5 配置文件拷贝到 节点1、节点2</a>
            </li>
            <li>
              <a href="#336_ETCD">3.3.6 启动ETCD服务</a>
            </li>
            <li>
              <a href="#337">3.3.7 检查服务是否正常</a>
            </li>
          </ul>
        </li>
        
        <li>
          <a href="#34_Flannel">3.4 部署Flannel网络</a><ul>
            <li>
              <a href="#341_etcd_Pod">3.4.1 向 etcd 写入集群 Pod 网段信息</a>
            </li>
            <li>
              <a href="#342_flannel">3.4.2 部署 flannel</a>
            </li>
            <li>
              <a href="#353_flannel">3.5.3 配置flannel</a>
            </li>
            <li>
              <a href="#354_flanneld_systemd_unit">3.5.4 创建 flanneld 的 systemd unit 文件</a>
            </li>
            <li>
              <a href="#355_Docker">3.5.5 配置Docker启动指定子网段</a>
            </li>
            <li>
              <a href="#356_flanneld_systemd_unit">3.5.6 将flanneld systemd unit 文件到所有节点</a>
            </li>
            <li>
              <a href="#357_fannel">3.5.7 验证fannel网络配置</a>
            </li>
          </ul>
        </li>
        
        <li>
          <a href="#35_master">3.5 部署 master 节点</a><ul>
            <li>
              <a href="#351__master">3.5.1 配置 master 节点文件</a>
            </li>
            <li>
              <a href="#352_kubernetes">3.5.2 配置 kubernetes相关证书</a>
            </li>
            <li>
              <a href="#353_kube-apiserver">3.5.3 部署 kube-apiserver 组件</a>
            </li>
            <li>
              <a href="#354_kube-scheduler">3.5.4 部署kube-scheduler</a>
            </li>
            <li>
              <a href="#355_kube-controller-manager">3.5.5 部署kube-controller-manager</a>
            </li>
            <li>
              <a href="#356_master">3.5.6 查看master集群状态</a>
            </li>
          </ul>
        </li>
        
        <li>
          <a href="#36_node">3.6 部署node 节点</a><ul>
            <li>
              <a href="#361_kubelet">3.6.1 部署 kubelet 组件</a>
            </li>
            <li>
              <a href="#362_kubelet_nodes">3.6.2 创建kubelet 参数配置文件拷贝到所有 nodes节点</a>
            </li>
            <li>
              <a href="#363_kubelet">3.6.3 启动kubelet服务</a>
            </li>
            <li>
              <a href="#364_approve_kubelet_CSR">3.6.4 approve kubelet CSR 请求</a>
            </li>
            <li>
              <a href="#365">3.6.5 查看集群状态</a>
            </li>
          </ul>
        </li>
        
        <li>
          <a href="#37_node_kube-proxy">3.7 部署 node kube-proxy 组件</a><ul>
            <li>
              <a href="#371_kube-proxy">3.7.1 创建kube-proxy配置文件</a>
            </li>
            <li>
              <a href="#372_kube-proxy_systemd_unit">3.7.2 创建kube-proxy systemd unit 文件</a>
            </li>
            <li>
              <a href="#373_kube-proxy">3.7.3 启动kube-proxy服务</a>
            </li>
            <li>
              <a href="#374">3.7.4 检查服务运行状态</a>
            </li>
          </ul>
        </li>
      </ul>
    </li>
  </ul>
</div>

 [1]: https://blog.51cto.com/10880347/2326146