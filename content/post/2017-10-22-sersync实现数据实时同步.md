---
title: sersync实现数据实时同步
author: 惨绿少年
type: post
date: 2017-10-21T17:26:00+00:00
url: /clsn/lx906.html
Baidusubmit:
  - 1
views:
  - 117
specs_zan:
  - 1
categories:
  - Linux运维
  - 存储
  - 玩转Linux
  - 运维基本功

---
## <span id="11_sersync">1.1 <span style="font-family: '微软雅黑',sans-serif;">第一个里程碑：安装</span>sersync<span style="font-family: '微软雅黑',sans-serif;">软件</span></span>

### <span id="111">1.1.1 <span style="font-family: '微软雅黑',sans-serif;">将软件上传到服务器当中并解压</span></span>

1<span style="font-family: '微软雅黑',sans-serif;">、上传软件到服务器上</span> rz -E

<span style="font-family: '微软雅黑',sans-serif;">为了便于管理上传位置统一设置为</span> <span style="font-size: 10.5pt;">/server/tools</span> <span style="font-family: '微软雅黑',sans-serif;">中</span>

2<span style="font-family: '微软雅黑',sans-serif;">、解压软件包</span>

<div class="cnblogs_code">
  <pre><span style="color: #000000;">[root@backup sersync_installdir_64bit]# tree
.
└── sersync
    ├── bin
    │   └── sersync
    ├── conf
    │   └── confxml.xml
    └── logs</span></pre>
</div>

### <span id="112">1.1.2 <span style="font-family: '微软雅黑',sans-serif;">二进制包安装方法</span></span>

<p style="margin-left: 7.1pt;">
  <span style="font-family: '微软雅黑',sans-serif;">二进制包安装软件方法（绿色软件安装方法）：</span>
</p>

<p style="margin-left: 7.1pt;">
  &nbsp;<span style="font-family: '微软雅黑',sans-serif; courier new"4courier new"; background: lime;">直接解压就可以使用</span>
</p>

<div class="cnblogs_code">
  <pre>[root@nfs01 sersync_installdir_64bit]# <span style="color: #0000ff;">mv</span> sersync/ /usr/local/<span style="color: #000000;">
[root@nfs01 tools]# tree </span>/usr/local/sersync/
  /usr/local/sersync/<span style="color: #000000;">
  ├── bin
  │   └── sersync
  ├── conf
  │   └── confxml.xml
  └── logs
  
  </span><span style="color: #800080;">3</span> directories, <span style="color: #800080;">2</span> files</pre>
</div>

## <span id="12_sersync">1.2 <span style="font-family: '微软雅黑',sans-serif;">第二个里程碑：编写</span>sersync<span style="font-family: '微软雅黑',sans-serif;">配置文件</span></span>

### <span id="121">1.2.1 <span style="font-family: '微软雅黑',sans-serif;">常见的语法格式</span></span>

<div style="border: solid windowtext 2.0pt; padding: 1.0pt 4.0pt 1.0pt 4.0pt; background: #F2F2F2;">
  <p style="text-indent: 26.25pt; background-image: initial; background-position: initial; background-size: initial; background-repeat: initial; background-attachment: initial; background-origin: initial; background-clip: initial;">
    rsync <span style="font-family: '微软雅黑',sans-serif;">配置文件编写：</span>ini<span style="font-family: '微软雅黑',sans-serif;">语法</span>
  </p>
  
  <p style="text-indent: 26.25pt; background-image: initial; background-position: initial; background-size: initial; background-repeat: initial; background-attachment: initial; background-origin: initial; background-clip: initial;">
    sersync<span style="font-family: '微软雅黑',sans-serif;">配置文件编写：</span>xml<span style="font-family: '微软雅黑',sans-serif;">语法</span>
  </p>
  
  <p style="text-indent: 26.25pt; background-image: initial; background-position: initial; background-size: initial; background-repeat: initial; background-attachment: initial; background-origin: initial; background-clip: initial;">
    ansible<span style="font-family: '微软雅黑',sans-serif;">配置文件编写</span>:yml <span style="font-family: '微软雅黑',sans-serif;">语法</span>
  </p>
</div>

### <span id="122">1.2.2 <span style="font-family: '微软雅黑',sans-serif;">修改配置文件</span></span>

<span style="font-family: '微软雅黑',sans-serif;">编写前备份</span>

<div class="cnblogs_code">
  <pre><span style="color: #000000;">[root@backup conf]# ll
total </span><span style="color: #800080;">4</span>
-rw-r--r-- <span style="color: #800080;">1</span> root root <span style="color: #800080;">2214</span> Oct <span style="color: #800080;">26</span>  <span style="color: #800080;">2011</span><span style="color: #000000;"> confxml.xml
[root@backup conf]# </span><span style="color: #0000ff;">cp</span> confxml.xml{,.bak}</pre>
</div>

6-11<span style="font-family: '微软雅黑',sans-serif;">行表示排除同步的数据，等价于</span> --exclude <span style="font-family: '微软雅黑',sans-serif;">功能，表示排除</span>

<div class="cnblogs_code">
  <pre><span style="color: #0000ff;">&lt;</span><span style="color: #800000;">filter </span><span style="color: #ff0000;">start</span><span style="color: #0000ff;">="false"</span><span style="color: #0000ff;">></span>
        <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">exclude </span><span style="color: #ff0000;">expression</span><span style="color: #0000ff;">="(.*)\.svn"</span><span style="color: #0000ff;">>&lt;/</span><span style="color: #800000;">exclude</span><span style="color: #0000ff;">></span>
        <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">exclude </span><span style="color: #ff0000;">expression</span><span style="color: #0000ff;">="(.*)\.gz"</span><span style="color: #0000ff;">>&lt;/</span><span style="color: #800000;">exclude</span><span style="color: #0000ff;">></span>
        <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">exclude </span><span style="color: #ff0000;">expression</span><span style="color: #0000ff;">="^info/*"</span><span style="color: #0000ff;">>&lt;/</span><span style="color: #800000;">exclude</span><span style="color: #0000ff;">></span>
         <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">exclude </span><span style="color: #ff0000;">expression</span><span style="color: #0000ff;">="^static/*"</span><span style="color: #0000ff;">>&lt;/</span><span style="color: #800000;">exclude</span><span style="color: #0000ff;">></span>
<span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">filter</span><span style="color: #0000ff;">></span></pre>
</div>

12-21<span style="font-family: '微软雅黑',sans-serif;">行是利用</span>inotify<span style="font-family: '微软雅黑',sans-serif;">的功能监控指定的事件，等价与</span> -e create<span style="font-family: '微软雅黑',sans-serif;">，</span>delete<span style="font-family: '微软雅黑',sans-serif;">&hellip;&hellip;</span> <span style="font-family: '微软雅黑',sans-serif;">表示指定监控事件信息</span>

<div class="cnblogs_code">
  <pre> <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">inotify</span><span style="color: #0000ff;">></span>
     <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">delete </span><span style="color: #ff0000;">start</span><span style="color: #0000ff;">="true"</span><span style="color: #0000ff;">/></span>
     <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">createFolder </span><span style="color: #ff0000;">start</span><span style="color: #0000ff;">="true"</span><span style="color: #0000ff;">/></span>
     <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">createFile </span><span style="color: #ff0000;">start</span><span style="color: #0000ff;">="false"</span><span style="color: #0000ff;">/></span>
     <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">closeWrite </span><span style="color: #ff0000;">start</span><span style="color: #0000ff;">="true"</span><span style="color: #0000ff;">/></span>
     <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">moveFrom </span><span style="color: #ff0000;">start</span><span style="color: #0000ff;">="true"</span><span style="color: #0000ff;">/></span>
     <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">moveTo </span><span style="color: #ff0000;">start</span><span style="color: #0000ff;">="true"</span><span style="color: #0000ff;">/></span>
     <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">attrib </span><span style="color: #ff0000;">start</span><span style="color: #0000ff;">="false"</span><span style="color: #0000ff;">/></span>
     <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">modify </span><span style="color: #ff0000;">start</span><span style="color: #0000ff;">="false"</span><span style="color: #0000ff;">/></span>
 <span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">inotify</span><span style="color: #0000ff;">></span></pre>
</div>

24-28<span style="font-family: '微软雅黑',sans-serif;">行：推送到哪里</span> name=<span style="font-family: '微软雅黑',sans-serif;">模块</span> <span style="font-family: '微软雅黑',sans-serif;">是</span>rsync<span style="font-family: '微软雅黑',sans-serif;">服务器的地址</span>

<div class="cnblogs_code">
  <pre> <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">localpath </span><span style="color: #ff0000;">watch</span><span style="color: #0000ff;">="/data"</span><span style="color: #0000ff;">></span><span style="color: #000000;"> #监控那个目录
     </span><span style="color: #0000ff;">&lt;</span><span style="color: #800000;">remote </span><span style="color: #ff0000;">ip</span><span style="color: #0000ff;">="172.16.1.41"</span><span style="color: #ff0000;"> name</span><span style="color: #0000ff;">="backup"</span><span style="color: #0000ff;">/></span>
     <span style="color: #008000;"><!--</span><span style="color: #008000;"><remote ip="192.168.8.39" name="tongbu"/></span><span style="color: #008000;">--></span>
     

<span style="color: #008000;"><!--</span><span style="color: #008000;"><remote ip="192.168.8.40" name="tongbu"/></span><span style="color: #008000;">--></span>
 

<span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">localpath</span><span style="color: #0000ff;">></span></pre>
</div>

29-35<span style="font-family: '微软雅黑',sans-serif;">行</span> <span style="font-family: '微软雅黑',sans-serif;">定义</span>rsync<span style="font-family: '微软雅黑',sans-serif;">推送时的参数信息。</span>

**<span style="font-family: '微软雅黑',sans-serif; courier new"4courier new";color: red;">注意：不要有单词拼写错误</span>** **<span style="font-family: '微软雅黑',sans-serif; courier new"4courier new";color: red;">（</span><span style="color: red;">true</span>****<span style="font-family: '微软雅黑',sans-serif; courier new"4courier new";color: red;">），否则程序不能正常启动，卡死</span>**

<div class="cnblogs_code">
  <pre><span style="color: #0000ff;">&lt;</span><span style="color: #800000;">rsync</span><span style="color: #0000ff;">></span>
    <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">commonParams </span><span style="color: #ff0000;">params</span><span style="color: #0000ff;">="-az"</span><span style="color: #0000ff;">/></span>
    <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">auth </span><span style="color: #ff0000;">start</span><span style="color: #0000ff;">="true"</span><span style="color: #ff0000;"> users</span><span style="color: #0000ff;">="rsync_backup"</span><span style="color: #ff0000;"> passwordfile</span><span style="color: #0000ff;">="/etc/rsync.password"</span><span style="color: #0000ff;">/></span>
    <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">userDefinedPort </span><span style="color: #ff0000;">start</span><span style="color: #0000ff;">="false"</span><span style="color: #ff0000;"> port</span><span style="color: #0000ff;">="874"</span><span style="color: #0000ff;">/></span><span style="color: #008000;"><!--</span><span style="color: #008000;"> port=874 </span><span style="color: #008000;">--></span>
    

<span style="color: #0000ff;">&lt;</span><span style="color: #800000;">timeout </span><span style="color: #ff0000;">start</span><span style="color: #0000ff;">="false"</span><span style="color: #ff0000;"> time</span><span style="color: #0000ff;">="100"</span><span style="color: #0000ff;">/></span><span style="color: #008000;"><!--</span><span style="color: #008000;"> timeout=100 </span><span style="color: #008000;">--></span>
    

<span style="color: #0000ff;">&lt;</span><span style="color: #800000;">ssh </span><span style="color: #ff0000;">start</span><span style="color: #0000ff;">="false"</span><span style="color: #0000ff;">/></span>
<span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">rsync</span><span style="color: #0000ff;">></span></pre>
</div>

**<span style="font-family: '微软雅黑',sans-serif;">配置文件最终内容：</span>**

&nbsp;

<div class="cnblogs_code" onclick="cnblogs_code_show('ee17e7d9-096c-46eb-ae44-f9495fa11f01')">
  <img id="code_img_closed_ee17e7d9-096c-46eb-ae44-f9495fa11f01" class="code_img_closed" src="https://clsn.io/wp-content/uploads/2018/03/ContractedBlock-17.gif" alt="sersync实现数据实时同步" alt="" /><img id="code_img_opened_ee17e7d9-096c-46eb-ae44-f9495fa11f01" class="code_img_opened" style="display: none;" onclick="cnblogs_code_hide('ee17e7d9-096c-46eb-ae44-f9495fa11f01',event)" data-original="https://clsn.io/wp-content/uploads/2018/03/ExpandedBlockStart-17.gif" src="/wp-content/themes/clsn-003/img/blank.gif" alt="sersync实现数据实时同步" alt="" /></p> 
  
  <div id="cnblogs_code_open_ee17e7d9-096c-46eb-ae44-f9495fa11f01" class="cnblogs_code_hide">
    <pre><span style="color: #008080;"> 1</span> <span style="color: #000000;">[root@nfs01 tools]# cat /usr/local/sersync/conf/confxml.xml 
</span><span style="color: #008080;"> 2</span>  <span style="color: #0000ff;"><?</span>

<span style="color: #ff00ff;">xml version="1.0" encoding="ISO-8859-1"</span><span style="color: #0000ff;">?></span>
<span style="color: #008080;"> 3</span>  <span style="color: #0000ff;"><</span><span style="color: #800000;">head </span><span style="color: #ff0000;">version</span><span style="color: #0000ff;">="2.5"</span><span style="color: #0000ff;">></span>
<span style="color: #008080;"> 4</span>     <span style="color: #0000ff;"><</span><span style="color: #800000;">host </span><span style="color: #ff0000;">hostip</span><span style="color: #0000ff;">="localhost"</span><span style="color: #ff0000;"> port</span><span style="color: #0000ff;">="8008"</span><span style="color: #0000ff;">></</span><span style="color: #800000;">host</span><span style="color: #0000ff;">></span>
<span style="color: #008080;"> 5</span>     <span style="color: #0000ff;"><</span><span style="color: #800000;">debug </span><span style="color: #ff0000;">start</span><span style="color: #0000ff;">="false"</span><span style="color: #0000ff;">/></span>
<span style="color: #008080;"> 6</span>     <span style="color: #0000ff;"><</span><span style="color: #800000;">fileSystem </span><span style="color: #ff0000;">xfs</span><span style="color: #0000ff;">="false"</span><span style="color: #0000ff;">/></span>
<span style="color: #008080;"> 7</span>     <span style="color: #0000ff;"><</span><span style="color: #800000;">filter </span><span style="color: #ff0000;">start</span><span style="color: #0000ff;">="false"</span><span style="color: #0000ff;">></span>
<span style="color: #008080;"> 8</span>     <span style="color: #0000ff;"><</span><span style="color: #800000;">exclude </span><span style="color: #ff0000;">expression</span><span style="color: #0000ff;">="(.*)\.svn"</span><span style="color: #0000ff;">></</span><span style="color: #800000;">exclude</span><span style="color: #0000ff;">></span>
<span style="color: #008080;"> 9</span>     <span style="color: #0000ff;"><</span><span style="color: #800000;">exclude </span><span style="color: #ff0000;">expression</span><span style="color: #0000ff;">="(.*)\.gz"</span><span style="color: #0000ff;">></</span><span style="color: #800000;">exclude</span><span style="color: #0000ff;">></span>
<span style="color: #008080;">10</span>     <span style="color: #0000ff;"><</span><span style="color: #800000;">exclude </span><span style="color: #ff0000;">expression</span><span style="color: #0000ff;">="^info/*"</span><span style="color: #0000ff;">></</span><span style="color: #800000;">exclude</span><span style="color: #0000ff;">></span>
<span style="color: #008080;">11</span>     <span style="color: #0000ff;"><</span><span style="color: #800000;">exclude </span><span style="color: #ff0000;">expression</span><span style="color: #0000ff;">="^static/*"</span><span style="color: #0000ff;">></</span><span style="color: #800000;">exclude</span><span style="color: #0000ff;">></span>
<span style="color: #008080;">12</span>     <span style="color: #0000ff;"></</span><span style="color: #800000;">filter</span><span style="color: #0000ff;">></span>
<span style="color: #008080;">13</span>     <span style="color: #0000ff;"><</span><span style="color: #800000;">inotify</span><span style="color: #0000ff;">></span>
<span style="color: #008080;">14</span>     <span style="color: #0000ff;"><</span><span style="color: #800000;">delete </span><span style="color: #ff0000;">start</span><span style="color: #0000ff;">="true"</span><span style="color: #0000ff;">/></span>
<span style="color: #008080;">15</span>     <span style="color: #0000ff;"><</span><span style="color: #800000;">createFolder </span><span style="color: #ff0000;">start</span><span style="color: #0000ff;">="true"</span><span style="color: #0000ff;">/></span>
<span style="color: #008080;">16</span>     <span style="color: #0000ff;"><</span><span style="color: #800000;">createFile </span><span style="color: #ff0000;">start</span><span style="color: #0000ff;">="false"</span><span style="color: #0000ff;">/></span>
<span style="color: #008080;">17</span>     <span style="color: #0000ff;"><</span><span style="color: #800000;">closeWrite </span><span style="color: #ff0000;">start</span><span style="color: #0000ff;">="true"</span><span style="color: #0000ff;">/></span>
<span style="color: #008080;">18</span>     <span style="color: #0000ff;"><</span><span style="color: #800000;">moveFrom </span><span style="color: #ff0000;">start</span><span style="color: #0000ff;">="true"</span><span style="color: #0000ff;">/></span>
<span style="color: #008080;">19</span>     <span style="color: #0000ff;"><</span><span style="color: #800000;">moveTo </span><span style="color: #ff0000;">start</span><span style="color: #0000ff;">="true"</span><span style="color: #0000ff;">/></span>
<span style="color: #008080;">20</span>     <span style="color: #0000ff;"><</span><span style="color: #800000;">attrib </span><span style="color: #ff0000;">start</span><span style="color: #0000ff;">="false"</span><span style="color: #0000ff;">/></span>
<span style="color: #008080;">21</span>     <span style="color: #0000ff;"><</span><span style="color: #800000;">modify </span><span style="color: #ff0000;">start</span><span style="color: #0000ff;">="false"</span><span style="color: #0000ff;">/></span>
<span style="color: #008080;">22</span>     <span style="color: #0000ff;"></</span><span style="color: #800000;">inotify</span><span style="color: #0000ff;">></span>
<span style="color: #008080;">23</span> 
<span style="color: #008080;">24</span>     <span style="color: #0000ff;"><</span><span style="color: #800000;">sersync</span><span style="color: #0000ff;">></span>
<span style="color: #008080;">25</span>     <span style="color: #0000ff;"><</span><span style="color: #800000;">localpath </span><span style="color: #ff0000;">watch</span><span style="color: #0000ff;">="/data"</span><span style="color: #0000ff;">></span>
<span style="color: #008080;">26</span>         <span style="color: #0000ff;"><</span><span style="color: #800000;">remote </span><span style="color: #ff0000;">ip</span><span style="color: #0000ff;">="172.16.1.41"</span><span style="color: #ff0000;"> name</span><span style="color: #0000ff;">="nfsbackup"</span><span style="color: #0000ff;">/></span>
<span style="color: #008080;">27</span>         <span style="color: #008000;"><!--</span><span style="color: #008000;"><remote ip="192.168.8.39" name="tongbu"/></span><span style="color: #008000;">--></span>


<span style="color: #008080;">28</span>         <span style="color: #008000;"><!--</span><span style="color: #008000;"><remote ip="192.168.8.40" name="tongbu"/></span><span style="color: #008000;">--></span>


<span style="color: #008080;">29</span>     <span style="color: #0000ff;"></</span><span style="color: #800000;">localpath</span><span style="color: #0000ff;">></span>
<span style="color: #008080;">30</span>     <span style="color: #0000ff;"><</span><span style="color: #800000;">rsync</span><span style="color: #0000ff;">></span>
<span style="color: #008080;">31</span>         <span style="color: #0000ff;"><</span><span style="color: #800000;">commonParams </span><span style="color: #ff0000;">params</span><span style="color: #0000ff;">="-az"</span><span style="color: #0000ff;">/></span>
<span style="color: #008080;">32</span>         <span style="color: #0000ff;"><</span><span style="color: #800000;">auth </span><span style="color: #ff0000;">start</span><span style="color: #0000ff;">="true"</span><span style="color: #ff0000;"> users</span><span style="color: #0000ff;">="rsync_backup"</span><span style="color: #ff0000;"> passwordfile</span><span style="color: #0000ff;">="/etc/rsync.password"</span><span style="color: #0000ff;">/></span>
<span style="color: #008080;">33</span>         <span style="color: #0000ff;"><</span><span style="color: #800000;">userDefinedPort </span><span style="color: #ff0000;">start</span><span style="color: #0000ff;">="false"</span><span style="color: #ff0000;"> port</span><span style="color: #0000ff;">="874"</span><span style="color: #0000ff;">/></span><span style="color: #008000;"><!--</span><span style="color: #008000;"> port=874 </span><span style="color: #008000;">--></span>


<span style="color: #008080;">34</span>         <span style="color: #0000ff;"><</span><span style="color: #800000;">timeout </span><span style="color: #ff0000;">start</span><span style="color: #0000ff;">="false"</span><span style="color: #ff0000;"> time</span><span style="color: #0000ff;">="100"</span><span style="color: #0000ff;">/></span><span style="color: #008000;"><!--</span><span style="color: #008000;"> timeout=100 </span><span style="color: #008000;">--></span>


<span style="color: #008080;">35</span>         <span style="color: #0000ff;"><</span><span style="color: #800000;">ssh </span><span style="color: #ff0000;">start</span><span style="color: #0000ff;">="false"</span><span style="color: #0000ff;">/></span>
<span style="color: #008080;">36</span>     <span style="color: #0000ff;"></</span><span style="color: #800000;">rsync</span><span style="color: #0000ff;">></span>
<span style="color: #008080;">37</span>     <span style="color: #0000ff;"><</span><span style="color: #800000;">failLog </span><span style="color: #ff0000;">path</span><span style="color: #0000ff;">="/tmp/rsync_fail_log.sh"</span><span style="color: #ff0000;"> timeToExecute</span><span style="color: #0000ff;">="60"</span><span style="color: #0000ff;">/></span><span style="color: #008000;"><!--</span><span style="color: #008000;">default every 60mins execute once</span><span style="color: #008000;">--></span>


<span style="color: #008080;">38</span>     <span style="color: #0000ff;"><</span><span style="color: #800000;">crontab </span><span style="color: #ff0000;">start</span><span style="color: #0000ff;">="false"</span><span style="color: #ff0000;"> schedule</span><span style="color: #0000ff;">="600"</span><span style="color: #0000ff;">></span><span style="color: #008000;"><!--</span><span style="color: #008000;">600mins</span><span style="color: #008000;">--></span>


<span style="color: #008080;">39</span>         <span style="color: #0000ff;"><</span><span style="color: #800000;">crontabfilter </span><span style="color: #ff0000;">start</span><span style="color: #0000ff;">="false"</span><span style="color: #0000ff;">></span>
<span style="color: #008080;">40</span>         <span style="color: #0000ff;"><</span><span style="color: #800000;">exclude </span><span style="color: #ff0000;">expression</span><span style="color: #0000ff;">="*.php"</span><span style="color: #0000ff;">></</span><span style="color: #800000;">exclude</span><span style="color: #0000ff;">></span>
<span style="color: #008080;">41</span>         <span style="color: #0000ff;"><</span><span style="color: #800000;">exclude </span><span style="color: #ff0000;">expression</span><span style="color: #0000ff;">="info/*"</span><span style="color: #0000ff;">></</span><span style="color: #800000;">exclude</span><span style="color: #0000ff;">></span>
<span style="color: #008080;">42</span>         <span style="color: #0000ff;"></</span><span style="color: #800000;">crontabfilter</span><span style="color: #0000ff;">></span>
<span style="color: #008080;">43</span>     <span style="color: #0000ff;"></</span><span style="color: #800000;">crontab</span><span style="color: #0000ff;">></span>
<span style="color: #008080;">44</span>     <span style="color: #0000ff;"><</span><span style="color: #800000;">plugin </span><span style="color: #ff0000;">start</span><span style="color: #0000ff;">="false"</span><span style="color: #ff0000;"> name</span><span style="color: #0000ff;">="command"</span><span style="color: #0000ff;">/></span>
<span style="color: #008080;">45</span>     <span style="color: #0000ff;"></</span><span style="color: #800000;">sersync</span><span style="color: #0000ff;">></span>
<span style="color: #008080;">46</span> 
<span style="color: #008080;">47</span>     <span style="color: #0000ff;"><</span><span style="color: #800000;">plugin </span><span style="color: #ff0000;">name</span><span style="color: #0000ff;">="command"</span><span style="color: #0000ff;">></span>
<span style="color: #008080;">48</span>     <span style="color: #0000ff;"><</span><span style="color: #800000;">param </span><span style="color: #ff0000;">prefix</span><span style="color: #0000ff;">="/bin/sh"</span><span style="color: #ff0000;"> suffix</span><span style="color: #0000ff;">=""</span><span style="color: #ff0000;"> ignoreError</span><span style="color: #0000ff;">="true"</span><span style="color: #0000ff;">/></span>    <span style="color: #008000;"><!--</span><span style="color: #008000;">prefix /opt/tongbu/mmm.sh suffix</span><span style="color: #008000;">--></span>


<span style="color: #008080;">49</span>     <span style="color: #0000ff;"><</span><span style="color: #800000;">filter </span><span style="color: #ff0000;">start</span><span style="color: #0000ff;">="false"</span><span style="color: #0000ff;">></span>
<span style="color: #008080;">50</span>         <span style="color: #0000ff;"><</span><span style="color: #800000;">include </span><span style="color: #ff0000;">expression</span><span style="color: #0000ff;">="(.*)\.php"</span><span style="color: #0000ff;">/></span>
<span style="color: #008080;">51</span>         <span style="color: #0000ff;"><</span><span style="color: #800000;">include </span><span style="color: #ff0000;">expression</span><span style="color: #0000ff;">="(.*)\.sh"</span><span style="color: #0000ff;">/></span>
<span style="color: #008080;">52</span>     <span style="color: #0000ff;"></</span><span style="color: #800000;">filter</span><span style="color: #0000ff;">></span>
<span style="color: #008080;">53</span>     <span style="color: #0000ff;"></</span><span style="color: #800000;">plugin</span><span style="color: #0000ff;">></span>
<span style="color: #008080;">54</span> 
<span style="color: #008080;">55</span>     <span style="color: #0000ff;"><</span><span style="color: #800000;">plugin </span><span style="color: #ff0000;">name</span><span style="color: #0000ff;">="socket"</span><span style="color: #0000ff;">></span>
<span style="color: #008080;">56</span>     <span style="color: #0000ff;"><</span><span style="color: #800000;">localpath </span><span style="color: #ff0000;">watch</span><span style="color: #0000ff;">="/opt/tongbu"</span><span style="color: #0000ff;">></span>
<span style="color: #008080;">57</span>         <span style="color: #0000ff;"><</span><span style="color: #800000;">deshost </span><span style="color: #ff0000;">ip</span><span style="color: #0000ff;">="192.168.138.20"</span><span style="color: #ff0000;"> port</span><span style="color: #0000ff;">="8009"</span><span style="color: #0000ff;">/></span>
<span style="color: #008080;">58</span>     <span style="color: #0000ff;"></</span><span style="color: #800000;">localpath</span><span style="color: #0000ff;">></span>
<span style="color: #008080;">59</span>     <span style="color: #0000ff;"></</span><span style="color: #800000;">plugin</span><span style="color: #0000ff;">></span>
<span style="color: #008080;">60</span>     <span style="color: #0000ff;"><</span><span style="color: #800000;">plugin </span><span style="color: #ff0000;">name</span><span style="color: #0000ff;">="refreshCDN"</span><span style="color: #0000ff;">></span>
<span style="color: #008080;">61</span>     <span style="color: #0000ff;"><</span><span style="color: #800000;">localpath </span><span style="color: #ff0000;">watch</span><span style="color: #0000ff;">="/data0/htdocs/cms.xoyo.com/site/"</span><span style="color: #0000ff;">></span>
<span style="color: #008080;">62</span>         <span style="color: #0000ff;"><</span><span style="color: #800000;">cdninfo </span><span style="color: #ff0000;">domainname</span><span style="color: #0000ff;">="ccms.chinacache.com"</span><span style="color: #ff0000;"> port</span><span style="color: #0000ff;">="80"</span><span style="color: #ff0000;"> username</span><span style="color: #0000ff;">="xxxx"</span><span style="color: #ff0000;"> passwd</span><span style="color: #0000ff;">="xxxx"</span><span style="color: #0000ff;">/></span>
<span style="color: #008080;">63</span>         <span style="color: #0000ff;"><</span><span style="color: #800000;">sendurl </span><span style="color: #ff0000;">base</span><span style="color: #0000ff;">="http://pic.xoyo.com/cms"</span><span style="color: #0000ff;">/></span>
<span style="color: #008080;">64</span>         <span style="color: #0000ff;"><</span><span style="color: #800000;">regexurl </span><span style="color: #ff0000;">regex</span><span style="color: #0000ff;">="false"</span><span style="color: #ff0000;"> match</span><span style="color: #0000ff;">="cms.xoyo.com/site([/a-zA-Z0-9]*).xoyo.com/images"</span><span style="color: #0000ff;">/></span>
<span style="color: #008080;">65</span>     <span style="color: #0000ff;"></</span><span style="color: #800000;">localpath</span><span style="color: #0000ff;">></span>
<span style="color: #008080;">66</span>     <span style="color: #0000ff;"></</span><span style="color: #800000;">plugin</span><span style="color: #0000ff;">></span>
<span style="color: #008080;">67</span> <span style="color: #0000ff;"></</span><span style="color: #800000;">head</span><span style="color: #0000ff;">></span></pre>
</div>


<p>
  <span class="cnblogs_code_collapse">View Code&nbsp;<strong>配置文件最终内容</strong></span></div>
  
  
  <p>
    &nbsp;
  </p>
  
  
  <h2>
    <span id="13_sersync">1.3 <span style="font-family: '微软雅黑',sans-serif;">第三里程碑：</span> <span style="font-family: '微软雅黑',sans-serif;">启动</span>sersync</span>
  </h2>
  
  
  <h3>
    <span id="131">1.3.1 <span style="font-family: '微软雅黑',sans-serif;">修改文件的权限（可执行）</span></span>
  </h3>
  
  
  <p>
    <span style="font-family: '微软雅黑',sans-serif;">首先让程序让文件有执行权限</span>
  </p>
  
  
  <div class="cnblogs_code">
    <pre>[root@nfs01 bin]# <span style="color: #0000ff;">chmod</span> a+<span style="color: #000000;">x sersync 
[root@nfs01 bin]# ll
total </span><span style="color: #800080;">1768</span>
-rwxr-xr-x <span style="color: #800080;">1</span> root root <span style="color: #800080;">1810128</span> Oct <span style="color: #800080;">26</span>  <span style="color: #800080;">2011</span> sersync</pre>
    
  </div>
  
  
  <h3>
    <span id="132">1.3.2 <span style="font-family: '微软雅黑',sans-serif;">查看软件的帮助信息</span></span>
  </h3>
  
  
  <div class="cnblogs_code">
    <pre>[root@nfs01 bin]# ./sersync -<span style="color: #000000;">h
set the system param
execute：</span><span style="color: #0000ff;">echo</span> <span style="color: #800080;">50000000</span> > /proc/sys/fs/inotify/<span style="color: #000000;">max_user_watches
execute：</span><span style="color: #0000ff;">echo</span> <span style="color: #800080;">327679</span> > /proc/sys/fs/inotify/<span style="color: #000000;">max_queued_events
parse the command param
_______________________________________________________
重要参数</span>-<span style="color: #000000;">d:启用守护进程模式
重要参数</span>-<span style="color: #000000;">r:在监控前，将监控目录与远程主机用rsync命令推送一遍
    参数</span>-<span style="color: #000000;">n: 指定开启守护线程的数量，默认为10个
重要参数</span>-<span style="color: #000000;">o:指定配置文件，默认使用confxml.xml文件
    参数</span>-m:单独启用其他模块，使用 -<span style="color: #000000;">m refreshCDN 开启刷新CDN模块
    参数</span>-m:单独启用其他模块，使用 -<span style="color: #000000;">m socket 开启socket模块
    参数</span>-m:单独启用其他模块，使用 -<span style="color: #000000;">m http 开启http模块
不加</span>-<span style="color: #000000;">m参数，则默认执行同步程序
________________________________________________________________</span></pre>
    
  </div>
  
  
  <h3>
    <span id="133_bin">1.3.3 <span style="font-family: '微软雅黑',sans-serif;">在程序的</span>bin<span style="font-family: '微软雅黑',sans-serif;">目录下启动程序</span></span>
  </h3>
  
  
  <div class="cnblogs_code">
    <pre>./sersync -dro /usr/local/sersync/conf/confxml.xml</pre>
    
  </div>
  
  
  <h3>
    <span id="134">1.3.4 <span style="font-family: '微软雅黑',sans-serif;">启动方法二</span></span>
  </h3>
  
  
  <p style="margin-left: 7.1pt;">
    <span style="font-family: '微软雅黑',sans-serif;">将</span>/usr/local/sersync/bin/<span style="font-family: '微软雅黑',sans-serif;">程序的</span>bin<span style="font-family: '微软雅黑',sans-serif;">目录添加到</span>PATH<span style="font-family: '微软雅黑',sans-serif;">中</span>
  </p>
  
  
  <div class="cnblogs_code">
    <pre>export PATH=/usr/local/sbin:/usr/local/bin:/sbin:/bin:/usr/sbin:/usr/bin:/root/bin:/usr/local/sersync/bin/</pre>
    
  </div>
  
  
  <p>
    <span style="font-family: '微软雅黑',sans-serif;">然后</span>sersync<span style="font-family: '微软雅黑',sans-serif;">命令就能直接使用</span>
  </p>
  
  
  <div class="cnblogs_code">
    <pre>[root@nfs01 scripts]# sersync -dro /usr/local/sersync/conf/<span style="color: #000000;">confxml.xml 
set the system param
execute：</span><span style="color: #0000ff;">echo</span> <span style="color: #800080;">50000000</span> > /proc/sys/fs/inotify/<span style="color: #000000;">max_user_watches
execute：</span><span style="color: #0000ff;">echo</span> <span style="color: #800080;">327679</span> > /proc/sys/fs/inotify/<span style="color: #000000;">max_queued_events
parse the command param
option: </span>-<span style="color: #000000;">d     run as a daemon
option: </span>-<span style="color: #000000;">r     rsync all the local files to the remote servers before the sersync work
option: </span>-o     config xml name：  /usr/local/sersync/conf/<span style="color: #000000;">confxml.xml
daemon thread num: </span><span style="color: #800080;">10</span><span style="color: #000000;">
parse xml config </span><span style="color: #0000ff;">file</span><span style="color: #000000;">
host ip : localhost    host port: </span><span style="color: #800080;">8008</span><span style="color: #000000;">
daemon start，sersync run behind the console 
use rsync password</span>-<span style="color: #0000ff;">file</span><span style="color: #000000;"> :
user is    rsync_backup
passwordfile is     </span>/etc/<span style="color: #000000;">rsync.password
config xml parse success
please set </span>/etc/rsyncd.conf max connections=<span style="color: #800080;"></span><span style="color: #000000;"> Manually
sersync working thread </span><span style="color: #800080;">12</span>  = <span style="color: #800080;">1</span>(primary thread) + <span style="color: #800080;">1</span>(fail retry thread) + <span style="color: #800080;">10</span><span style="color: #000000;">(daemon sub threads) 
Max threads numbers is: </span><span style="color: #800080;">22</span> = <span style="color: #800080;">12</span>(Thread pool nums) + <span style="color: #800080;">10</span><span style="color: #000000;">(Sub threads)
please according your cpu ，use </span>-<span style="color: #000000;">n param to adjust the cpu rate
</span>------------------------------------------<span style="color: #000000;">
rsync the directory recursivly to the remote servers once
working please </span><span style="color: #0000ff;">wait</span><span style="color: #000000;">...
execute command: cd </span>/data && rsync -az -R --delete ./ rsync_backup@<span style="color: #800080;">172.16</span>.<span style="color: #800080;">1.41</span>::nfsbackup --password-<span style="color: #0000ff;">file</span>=/etc/rsync.password >/dev/<span style="color: #0000ff;">null</span> <span style="color: #800080;">2</span>>&<span style="color: #800080;">1</span><span style="color: #000000;"> 
run the sersync: 
watch path is: </span>/data</pre>
    
  </div>
  
  
  <h2>
    <span id="14_Inotify_sersync">1.4 Inotify<span style="font-family: '微软雅黑',sans-serif;">与</span> sersync<span style="font-family: '微软雅黑',sans-serif;">总结对比</span></span>
  </h2>
  
  
  <h3>
    <span id="141_Inotify">1.4.1 Inotify<span style="font-family: '微软雅黑',sans-serif;">实时并发：</span></span>
  </h3>
  
  
  <p>
    <span style="font-family: '微软雅黑',sans-serif;">　　结论：经过测试，每秒</span>200<span style="font-family: '微软雅黑',sans-serif;">文件并发，数据同步几乎无延迟（小于</span>1<span style="font-family: '微软雅黑',sans-serif;">秒）</span>
  </p>
  
  
  <h3>
    <span id="142_inotify">1.4.2 inotify <span style="font-family: '微软雅黑',sans-serif;">优点：</span></span>
  </h3>
  
  
  <p>
    　　1<span style="font-family: '微软雅黑',sans-serif;">）监控文件系统事件变化，通过同步工具实现实时数据同步。</span>
  </p>
  
  
  <h3>
    <span id="143_inotify">1.4.3 inotify <span style="font-family: '微软雅黑',sans-serif;">缺点</span></span>
  </h3>
  
  
  <p>
    　　1<span style="font-family: '微软雅黑',sans-serif;">）并发如果大于</span>200<span style="font-family: '微软雅黑',sans-serif;">个文件（</span>10-100k<span style="font-family: '微软雅黑',sans-serif;">），同步就会有延迟</span>
  </p>
  
  
  <p>
    　　2<span style="font-family: '微软雅黑',sans-serif;">）我们前面写的脚本，每次都是全部推送一次，但确实是增量的。也可以只同步变化的文件，不变化的不理。</span>
  </p>
  
  
  <p>
    　　3<span style="font-family: '微软雅黑',sans-serif;">）监控到事件后，调用</span>rsync<span style="font-family: '微软雅黑',sans-serif;">同步是单进程的，而</span>sersync<span style="font-family: '微软雅黑',sans-serif;">为多进程同步。既然有了</span>inotify-tools<span style="font-family: '微软雅黑',sans-serif;">，为什么还要开发</span>sersync<span style="font-family: '微软雅黑',sans-serif;">？</span>
  </p>
  
  
  <h3>
    <span id="144_serysyncinotifyrsync">1.4.4 serysync<span style="font-family: '微软雅黑',sans-serif;">功能多：（</span>inotify+rsync<span style="font-family: '微软雅黑',sans-serif;">命令）</span></span>
  </h3>
  
  
  <p>
    　　1<span style="font-family: '微软雅黑',sans-serif;">）支持通过配置文件管理</span>
  </p>
  
  
  <p>
    　　2<span style="font-family: '微软雅黑',sans-serif;">）真正的守护进程</span>socket
  </p>
  
  
  <p>
    　　3<span style="font-family: '微软雅黑',sans-serif;">）可以对失败文件定时重传（定时任务功能）</span>
  </p>
  
  
  <p>
    　　4<span style="font-family: '微软雅黑',sans-serif;">）第三方的</span>HTTP<span style="font-family: '微软雅黑',sans-serif;">接口（例如：更新</span>cdn<span style="font-family: '微软雅黑',sans-serif;">缓存）</span>
  </p>
  
  
  <p>
    　　5<span style="font-family: '微软雅黑',sans-serif;">）默认多进程</span>rsync<span style="font-family: '微软雅黑',sans-serif;">同步</span>
  </p>
  
  
  <h3>
    <span id="145">1.4.5 <span style="font-family: '微软雅黑',sans-serif;">高并发数据实时同步方案小结：</span></span>
  </h3>
  
  
  <p>
    　　1<span style="font-family: '微软雅黑',sans-serif;">）</span>inotify<span style="font-family: '微软雅黑',sans-serif;">（</span>sersync<span style="font-family: '微软雅黑',sans-serif;">）</span>+ rsync<span style="font-family: '微软雅黑',sans-serif;">，是文件级别的。</span>
  </p>
  
  
  <p>
    　　2<span style="font-family: '微软雅黑',sans-serif;">）</span>drbd<span style="font-family: '微软雅黑',sans-serif;">文件系统级别，文件系统级别，基于</span>block<span style="font-family: '微软雅黑',sans-serif;">块同步，缺点：备节点数据不可用</span>
  </p>
  
  
  <p>
    　　3<span style="font-family: '微软雅黑',sans-serif;">）第三方软件的同步功能：</span>mysql<span style="font-family: '微软雅黑',sans-serif;">同步（主从复制），</span>oracle<span style="font-family: '微软雅黑',sans-serif;">，</span>mongodb
  </p>
  
  
  <p>
    　　4<span style="font-family: '微软雅黑',sans-serif;">）程序双写，直接写两台服务器。</span>
  </p>
  
  
  <p>
    　　5<span style="font-family: '微软雅黑',sans-serif;">）利用产品业务逻辑解决（读写分离，备份读不到，读主）</span>
  </p>
  
  
  <p style="text-align: center;">
    <span style="font-family: '微软雅黑',sans-serif;"><img data-original="https://clsn.io/wp-content/uploads/2018/03/1190037-20171211133050009-1874384718.png" src="/wp-content/themes/clsn-003/img/blank.gif" alt="sersync实现数据实时同步" alt="" /></span>
  </p>
  
  
  
  <h2>
    <span id="21_man">2.1 man命令的级别</span>
  </h2>
  
  
  <p>
    <span style="background-color: #ffcc00;">centos6</span>
  </p>
  
  
  <div class="cnblogs_code">
    <pre>[root@nfs01 ~]# <span style="color: #0000ff;">man</span> <span style="color: #0000ff;">man</span><span style="color: #000000;">
       The standard sections of the manual include:

       </span><span style="color: #800080;">1</span><span style="color: #000000;">      User Commands                                 #用户命令

       </span><span style="color: #800080;">2</span><span style="color: #000000;">      System Calls                                  #系统调用

       </span><span style="color: #800080;">3</span><span style="color: #000000;">      C Library Functions                          # &Ccedil;库函数
 
       </span><span style="color: #800080;">4</span><span style="color: #000000;">      Devices and Special Files                   #设备和特殊文件

       </span><span style="color: #800080;">5</span><span style="color: #000000;">      File Formats and Conventions                #文件格式和约定

       </span><span style="color: #800080;">6</span><span style="color: #000000;">      Games et. Al.                                  #游戏等。

       </span><span style="color: #800080;">7</span><span style="color: #000000;">      Miscellanea                                     #杂记

       </span><span style="color: #800080;">8</span><span style="color: #000000;">      System Administration tools and Daemons   #系统管理工具和程序

       Distributions  customize  the  manual section to their specifics,
       </span><span style="color: #0000ff;">which</span> often include additional sections.</pre>
    
  </div>
  
  
  <p>
    <span style="background-color: #ffcc00;">centos7</span>
  </p>
  
  
  <div class="cnblogs_code">
    <pre>[root@clsn tuichu]# <span style="color: #0000ff;">man</span> ~
<span style="color: #800080;">1</span><span style="color: #000000;">   Executable programs or shell commands
</span><span style="color: #800080;">2</span><span style="color: #000000;">   System calls (functions provided by the kernel)
</span><span style="color: #800080;">3</span><span style="color: #000000;">   Library calls (functions within program libraries)
</span><span style="color: #800080;">4</span>   Special files (usually found <span style="color: #0000ff;">in</span> /<span style="color: #000000;">dev)
</span><span style="color: #800080;">5</span>   File formats and conventions eg /etc/<span style="color: #0000ff;">passwd</span>
<span style="color: #800080;">6</span><span style="color: #000000;">   Games
</span><span style="color: #800080;">7</span><span style="color: #000000;">   Miscellaneous  (including  macro  packages  and conventions), e.g.
    </span><span style="color: #0000ff;">man</span>(<span style="color: #800080;">7</span>), groff(<span style="color: #800080;">7</span><span style="color: #000000;">)
</span><span style="color: #800080;">8</span>   System administration commands (usually only <span style="color: #0000ff;">for</span><span style="color: #000000;"> root)
</span><span style="color: #800080;">9</span>   Kernel routines [Non standard]</pre>
    
  </div>
  
  
  <p>
    &nbsp;
  </p>
  
  
  <div id="toc_container" class="toc_white have_bullets">
    <ul class="toc_list">
      <li>
        <a href="#11_sersync">1.1 第一个里程碑：安装sersync软件</a><ul>
          <li>
            <a href="#111">1.1.1 将软件上传到服务器当中并解压</a>
          </li>
          <li>
            <a href="#112">1.1.2 二进制包安装方法</a>
          </li>
        </ul>
      </li>
      
      <li>
        <a href="#12_sersync">1.2 第二个里程碑：编写sersync配置文件</a><ul>
          <li>
            <a href="#121">1.2.1 常见的语法格式</a>
          </li>
          <li>
            <a href="#122">1.2.2 修改配置文件</a>
          </li>
        </ul>
      </li>
      
      <li>
        <a href="#13_sersync">1.3 第三里程碑： 启动sersync</a><ul>
          <li>
            <a href="#131">1.3.1 修改文件的权限（可执行）</a>
          </li>
          <li>
            <a href="#132">1.3.2 查看软件的帮助信息</a>
          </li>
          <li>
            <a href="#133_bin">1.3.3 在程序的bin目录下启动程序</a>
          </li>
          <li>
            <a href="#134">1.3.4 启动方法二</a>
          </li>
        </ul>
      </li>
      
      <li>
        <a href="#14_Inotify_sersync">1.4 Inotify与 sersync总结对比</a><ul>
          <li>
            <a href="#141_Inotify">1.4.1 Inotify实时并发：</a>
          </li>
          <li>
            <a href="#142_inotify">1.4.2 inotify 优点：</a>
          </li>
          <li>
            <a href="#143_inotify">1.4.3 inotify 缺点</a>
          </li>
          <li>
            <a href="#144_serysyncinotifyrsync">1.4.4 serysync功能多：（inotify+rsync命令）</a>
          </li>
          <li>
            <a href="#145">1.4.5 高并发数据实时同步方案小结：</a>
          </li>
        </ul>
      </li>
      
      <li>
        <a href="#21_man">2.1 man命令的级别</a>
      </li>
    </ul>
  </div>