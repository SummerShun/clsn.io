---
title: ansible服务部署与使用
author: 惨绿少年
type: post
date: 2017-10-26T23:59:00+00:00
url: /clsn/lx895.html
Baidusubmit:
  - 1
views:
  - 226
specs_zan:
  - 1
zm_like:
  - 1
categories:
  - Linux运维
  - 玩转Linux
  - 自动化
  - 运维基本功

---
<div id="log-box">
  <div id="catalog">
    <ul id="catalog-ul">
      <li>
        <i class="be be-arrowright"></i> <a href="#title-0" title="1.2.3.1&nbsp; 编写脚本shift">1.2.3.1&nbsp; 编写脚本shift</a>
      </li>
    </ul>
    
    <span class="log-zd"><span class="log-close"><a title="隐藏目录"><i class="be be-cross"></i><strong>目录</strong></a></span></span>
  </div>
</div>

# <span id="1_sshkeyansible">第1章 ssh+key实现基于密钥连接（ansible使用前提）</span>

**说明：**

**&nbsp;&nbsp; ansible****其功能实现基于SSH****远程连接服务**

**&nbsp;&nbsp;** **使用ansible****需要首先实现ssh****密钥连接**

## <span id="11_ssh_key">1.1 部署ssh key</span>

### <span id="111">1.1.1 第一个里程碑： 创建密钥对</span>

<div class="cnblogs_code">
  <pre><span style="color: #0000ff;">ssh-keygen</span>
-<span style="color: #000000;">t 指定密钥类型  rsa1 dsa（常用） ecdsa
语法：
SYNOPSIS
     </span><span style="color: #0000ff;">ssh-keygen</span> [-q] [-b bits] -t type [-N new_passphrase] [-<span style="color: #000000;">C comment]
                [</span>-<span style="color: #000000;">f output_keyfile]
     </span><span style="color: #0000ff;">ssh-keygen</span> -p [-P old_passphrase] [-N new_passphrase] [-<span style="color: #000000;">f keyfile]
     </span><span style="color: #0000ff;">ssh-keygen</span> -i [-<span style="color: #000000;">f input_keyfile]
     </span><span style="color: #0000ff;">ssh-keygen</span> -e [-<span style="color: #000000;">f input_keyfile]
     </span><span style="color: #0000ff;">ssh-keygen</span> -y [-<span style="color: #000000;">f input_keyfile]
     </span><span style="color: #0000ff;">ssh-keygen</span> -c [-P passphrase] [-C comment] [-<span style="color: #000000;">f keyfile]
     </span><span style="color: #0000ff;">ssh-keygen</span> -l [-<span style="color: #000000;">f input_keyfile]
     </span><span style="color: #0000ff;">ssh-keygen</span> -B [-<span style="color: #000000;">f input_keyfile]
     </span><span style="color: #0000ff;">ssh-keygen</span> -<span style="color: #000000;">D pkcs11
     </span><span style="color: #0000ff;">ssh-keygen</span> -F <span style="color: #0000ff;">hostname</span> [-f known_hosts_file] [-<span style="color: #000000;">l]
     </span><span style="color: #0000ff;">ssh-keygen</span> -H [-<span style="color: #000000;">f known_hosts_file]
     </span><span style="color: #0000ff;">ssh-keygen</span> -R <span style="color: #0000ff;">hostname</span> [-<span style="color: #000000;">f known_hosts_file]
     </span><span style="color: #0000ff;">ssh-keygen</span> -r <span style="color: #0000ff;">hostname</span> [-f input_keyfile] [-<span style="color: #000000;">g]
     </span><span style="color: #0000ff;">ssh-keygen</span> -G output_file [-v] [-b bits] [-M memory] [-<span style="color: #000000;">S start_point]
     </span><span style="color: #0000ff;">ssh-keygen</span> -T output_file -f input_file [-v] [-<span style="color: #000000;">a num_trials]
                [</span>-<span style="color: #000000;">W generator]
     </span><span style="color: #0000ff;">ssh-keygen</span> [-n] [-<span style="color: #000000;">D smartcard]
     </span><span style="color: #0000ff;">ssh-keygen</span> -s ca_key -I certificate_identity [-h] [-<span style="color: #000000;">Z principals]
                [</span>-O option] [-V validity_interval] [-z serial_number] <span style="color: #0000ff;">file</span><span style="color: #000000;"> ...
     </span><span style="color: #0000ff;">ssh-keygen</span> -L [-f input_keyfile]</pre>
</div>

**创建密钥的过程**

<div>
  <div class="cnblogs_code">
    <pre>[root@m01 ~]# <span style="color: #0000ff;">ssh-keygen</span> -<span style="color: #000000;">t dsa
Generating public</span>/<span style="color: #000000;">private dsa key pair.
Enter </span><span style="color: #0000ff;">file</span> <span style="color: #0000ff;">in</span> <span style="color: #0000ff;">which</span> to save the key (/root/.<span style="color: #0000ff;">ssh</span>/<span style="color: #000000;">id_dsa):  #私钥创建后保存的路径
Created directory </span><span style="color: #800000;">'</span><span style="color: #800000;">/root/.ssh</span><span style="color: #800000;">'</span><span style="color: #000000;">.
Enter passphrase (empty </span><span style="color: #0000ff;">for</span><span style="color: #000000;"> no passphrase):             #私钥需不需进行加密，设置密码
Enter same passphrase again:   #私钥需不需进行加密，再次输入密码确认
Your identification has been saved </span><span style="color: #0000ff;">in</span> /root/.<span style="color: #0000ff;">ssh</span>/<span style="color: #000000;">id_dsa.
Your public key has been saved </span><span style="color: #0000ff;">in</span> /root/.<span style="color: #0000ff;">ssh</span>/<span style="color: #000000;">id_dsa.pub.
The key fingerprint is:
</span><span style="color: #800080;">31</span>:4a:4f:9f:<span style="color: #800080;">97</span>:b0:b6:ca:4c:<span style="color: #800080;">53</span>:<span style="color: #800080;">78</span>:<span style="color: #800080;">70</span>:<span style="color: #800080;">89</span>:<span style="color: #800080;">83</span>:5f:<span style="color: #800080;">16</span><span style="color: #000000;"> root@m01
The key</span><span style="color: #800000;">'</span><span style="color: #800000;">s randomart image is:</span>
+--[ DSA <span style="color: #800080;">1024</span>]----+
|          E      |
|       . . o     |
|      o B *      |
|     . = @ + .   |
|      . S B o    |
|         + o     |
|        o .      |
|       + o       |
|        +        |
+-----------------+</pre>
  </div>
</div>

创建出来的文件：

<div>
  <div class="cnblogs_code">
    <pre>[root@m01 ~]# ll /root/.<span style="color: #0000ff;">ssh</span>/<span style="color: #000000;">
total </span><span style="color: #800080;">8</span>
-rw------- <span style="color: #800080;">1</span> root root <span style="color: #800080;">668</span> Oct <span style="color: #800080;">17</span> <span style="color: #800080;">18</span>:<span style="color: #800080;">55</span><span style="color: #000000;"> id_dsa       #创建出来的私钥
</span>-rw-r--r-- <span style="color: #800080;">1</span> root root <span style="color: #800080;">598</span> Oct <span style="color: #800080;">17</span> <span style="color: #800080;">18</span>:<span style="color: #800080;">55</span> id_dsa.pub  #创建出来的公钥</pre>
  </div>
</div>

### <span id="112">1.1.2 第二个里程碑： 分发公钥文件</span>

<div>
  <div class="cnblogs_code">
    <pre>[root@m01 ~]# <span style="color: #0000ff;">man</span> <span style="color: #0000ff;">ssh</span>-copy-<span style="color: #0000ff;">id</span>
<span style="color: #0000ff;">ssh</span>-copy-<span style="color: #0000ff;">id</span>  -  <span style="color: #0000ff;">install</span>  your  public  key <span style="color: #0000ff;">in</span> a remote machine&rsquo;s autho-rized_keys</pre>
  </div>
</div>

注意：密钥分发命令属于openssh-clients软件包

<div>
  <div class="cnblogs_code">
    <pre>[root@nfs01 ~]# rpm -qf `<span style="color: #0000ff;">which</span> <span style="color: #0000ff;">ssh</span>-copy-<span style="color: #0000ff;">id</span><span style="color: #000000;">`
openssh</span>-clients-<span style="color: #800080;">5</span>.3p1-<span style="color: #800080;">122</span>.el6.x86_64</pre>
  </div>
</div>

**语法格式**

<div>
  <div class="cnblogs_code">
    <pre><span style="color: #0000ff;">ssh</span>-copy-<span style="color: #0000ff;">id</span> [-<span style="color: #000000;">i [identity_file]] [user@]machine
</span>-<span style="color: #000000;">i       指定要分发的公钥文件以及路径信息
[user@] 以什么用户身份进行分发
machine 将公钥分发到哪台主机上，远程主机IP地址

[root@m01 </span>~]# <span style="color: #0000ff;">ssh</span>-copy-<span style="color: #0000ff;">id</span>  -i /root/.<span style="color: #0000ff;">ssh</span>/id_dsa.pub  root@<span style="color: #800080;">172.16</span>.<span style="color: #800080;">1.41</span><span style="color: #000000;">
The authenticity of host </span><span style="color: #800000;">'</span><span style="color: #800000;">172.16.1.41 (172.16.1.41)</span><span style="color: #800000;">'</span> can<span style="color: #800000;">'</span><span style="color: #800000;">t be established.</span>
RSA key fingerprint is d3:<span style="color: #800080;">41</span>:bb:0d:<span style="color: #800080;">43</span>:<span style="color: #800080;">88</span>:da:a3:2c:e8:<span style="color: #800080;">36</span>:<span style="color: #800080;">91</span>:<span style="color: #800080;">11</span><span style="color: #000000;">:c9:e4:9c.
Are you sure you want to continue connecting (yes</span>/no)?<span style="color: #000000;"> yes
Warning: Permanently added </span><span style="color: #800000;">'</span><span style="color: #800000;">172.16.1.41</span><span style="color: #800000;">'</span><span style="color: #000000;"> (RSA) to the list of known hosts.
root@</span><span style="color: #800080;">172.16</span>.<span style="color: #800080;">1.41</span><span style="color: #800000;">'</span><span style="color: #800000;">s password:</span>
Now try logging into the machine, with <span style="color: #800000;">"</span><span style="color: #800000;">ssh 'root@172.16.1.41'</span><span style="color: #800000;">"</span>, and check <span style="color: #0000ff;">in</span><span style="color: #000000;">

  .</span><span style="color: #0000ff;">ssh</span>/<span style="color: #000000;">authorized_keys

to </span><span style="color: #0000ff;">make</span> sure we haven<span style="color: #800000;">'</span><span style="color: #800000;">t added extra keys that you weren</span><span style="color: #800000;">'</span>t expecting.&nbsp;</pre>
  </div>
</div>

### <span id="113">1.1.3 第三个里程碑： 基于密钥登陆测试</span>

<div>
  <div class="cnblogs_code">
    <pre>[root@m01 ~]# <span style="color: #0000ff;">ssh</span> <span style="color: #800080;">172.16</span>.<span style="color: #800080;">1.41</span><span style="color: #000000;">
Last </span><span style="color: #0000ff;">login</span>: Tue Oct <span style="color: #800080;">17</span> <span style="color: #800080;">18</span>:<span style="color: #800080;">38</span>:<span style="color: #800080;">47</span> <span style="color: #800080;">2017</span> from <span style="color: #800080;">10.0</span>.<span style="color: #800080;">0.1</span><span style="color: #000000;">
[root@backup </span>~]#</pre>
  </div>
</div>

&nbsp;&nbsp; 基于密钥登陆方式成功&uarr;

<div>
  <div class="cnblogs_code">
    <pre>[root@m01 ~]# <span style="color: #0000ff;">ssh</span> root@<span style="color: #800080;">172.16</span>.<span style="color: #800080;">1.41</span> <span style="color: #800000;">"</span><span style="color: #800000;">hostname -i</span><span style="color: #800000;">"</span>
<span style="color: #800080;">172.16</span>.<span style="color: #800080;">1.41</span></pre>
  </div>
</div>

不用的登陆到远程主机直接执行命令，返回输出结果&uarr;

**说明：**

<div>
  <p class="a3">
    <strong>管理主机一旦创建好秘钥对文件，给多个主机分发公钥时，公钥文件相同</strong>
  </p>
</div>

### <span id="114_ssh">1.1.4 ssh服务分发公钥实质执行过程</span>

<div>
  <p class="a3">
    ①.&nbsp;管理服务器<strong>创建</strong>私钥和公钥（<strong>密钥对</strong>）
  </p>
  
  <p class="a3">
    ②.&nbsp;将<strong>公钥文件远程传送复制到被管理服务器</strong>相应用户~/.ssh/id_dsa.pub下，并修改.ssh目录权限为700
  </p>
  
  <p class="a3">
    ③.&nbsp;修改公钥文件<strong>文件名称为</strong><strong>authorized_keys</strong>，授权权限为600
  </p>
  
  <p class="a3">
    ④.&nbsp;利用ssh服务配置文件的配置参数，进行<strong>识别公钥文件</strong>authorized_keys
  </p>
  
  <p class="a3">
    ⑤.&nbsp;进而<strong>实现基于密钥远程登录</strong>服务器（免密码登录/非交互方式登录）
  </p>
</div>

## <span id="12_22">1.2 默认端口号不是22，如何分发公钥</span>

### <span id="121_ssh-copy-id">1.2.1 查询ssh-copy-id命令可以得知这是个脚本文件</span>

<div>
  <div class="cnblogs_code">
    <pre>[root@m01 ~]# <span style="color: #0000ff;">file</span> `<span style="color: #0000ff;">which</span> <span style="color: #0000ff;">ssh</span>-copy-<span style="color: #0000ff;">id</span><span style="color: #000000;"> `
</span>/usr/bin/<span style="color: #0000ff;">ssh</span>-copy-<span style="color: #0000ff;">id</span>: POSIX shell script text executable</pre>
  </div>
</div>

看看脚本内容发现传输方式

<div>
  <div class="cnblogs_code">
    <pre>[root@m01 ~]# <span style="color: #0000ff;">cat</span> `<span style="color: #0000ff;">which</span> <span style="color: #0000ff;">ssh</span>-copy-<span style="color: #0000ff;">id</span>`|<span style="color: #0000ff;">grep</span> <span style="color: #0000ff;">ssh</span>
<span style="color: #0000ff;">ssh</span> $<span style="color: #800080;">1</span> <span style="color: #800000;">"</span><span style="color: #800000;">exec sh -c 'cd; umask 077; test -d .ssh || mkdir .ssh ; cat >> .ssh/authorized_keys && (test -x /sbin/restorecon && /sbin/restorecon .ssh .ssh/authorized_keys >/dev/null 2>&1 || true)'</span><span style="color: #800000;">"</span> || exit <span style="color: #800080;">1</span></pre>
  </div>
</div>

说明：

&nbsp;&nbsp; 1、切换用户到家目录下，临时设置umask值

&nbsp;&nbsp; 2、判断客户端相应用户中有没有.ssh目录，如果没有.ssh 目录就进行创建

3、将管理端公钥文件内容添加到客户端~./ssh/authorized\_keys, 默认authorized\_keys文件不存在，需要创建，文件权限600

### <span id="122_22">1.2.2 实现非22端口的分发</span>

方法一： 修改脚本内容

<div>
  <div class="cnblogs_code">
    <pre><span style="color: #0000ff;">ssh</span> -p52113 $<span style="color: #800080;">1</span> <span style="color: #800000;">"</span><span style="color: #800000;">exec sh -c 'cd; umask 077; test -d .ssh || mkdir .ssh ; cat >> .ssh/authorized_keys && (test -x /sbin/restorecon && /sbin/restorecon .ssh .ssh/authorized_keys >/dev/null 2>&1 || true)'</span><span style="color: #800000;">"</span> || exit <span style="color: #800080;">1</span></pre>
  </div>
</div>

说明：根据命令脚本，修改$1传参信息，从而实现根据ssh不同端口传送公钥文件

方法二：将传入的参数上添加上端口信息**(****推荐)**

<div>
  <div class="cnblogs_code">
    <pre>[root@m01 scripts]# <span style="color: #0000ff;">ssh</span>-copy-<span style="color: #0000ff;">id</span> -i /root/.<span style="color: #0000ff;">ssh</span>/id_dsa.pub <span style="color: #800000;">"</span><span style="color: #800000;">-p 52113 znix@172.16.1.250</span><span style="color: #800000;">"</span><span style="color: #000000;">
Now try logging into the machine, with </span><span style="color: #800000;">"</span><span style="color: #800000;">ssh '-p 52113 znix@172.16.1.250'</span><span style="color: #800000;">"</span>, and check <span style="color: #0000ff;">in</span><span style="color: #000000;">:
 
  .</span><span style="color: #0000ff;">ssh</span>/<span style="color: #000000;">authorized_keys

to </span><span style="color: #0000ff;">make</span> sure we haven<span style="color: #800000;">'</span><span style="color: #800000;">t added extra keys that you weren</span><span style="color: #800000;">'</span>t expecting.</pre>
  </div>
</div>

### <span id="123_usrbinssh-copy-id_1">1.2.3 关于 /usr/bin/ssh-copy-id 脚本中 $1的说明</span>

<span class="directory"></span>

#### <span id="1231nbsp_shift">1.2.3.1&nbsp; 编写脚本shift</span> {#title-0}

<div>
  <div class="cnblogs_code">
    <pre>[root@m01 scripts]# <span style="color: #0000ff;">cat</span> <span style="color: #0000ff;">shift</span>.<span style="color: #0000ff;">sh</span><span style="color: #000000;">
#</span>!/bin/<span style="color: #000000;">bash

</span><span style="color: #0000ff;">until</span> [ $# -eq <span style="color: #800080;"></span><span style="color: #000000;"> ]
</span><span style="color: #0000ff;">do</span>
<span style="color: #0000ff;">echo</span> $*
<span style="color: #0000ff;">shift</span>
<span style="color: #0000ff;">done</span></pre>
  </div>
  
  <p>
    测试
  </p>
  
  <div class="cnblogs_code">
    <pre>[root@m01 scripts]# <span style="color: #0000ff;">sh</span> <span style="color: #0000ff;">shift</span>.<span style="color: #0000ff;">sh</span> <span style="color: #800080;">1</span> <span style="color: #800080;">2</span> <span style="color: #800080;">3</span> <span style="color: #800080;">4</span> <span style="color: #800080;">5</span> <span style="color: #800080;">6</span>
<span style="color: #800080;">1</span> <span style="color: #800080;">2</span> <span style="color: #800080;">3</span> <span style="color: #800080;">4</span> <span style="color: #800080;">5</span> <span style="color: #800080;">6</span>
<span style="color: #800080;">2</span> <span style="color: #800080;">3</span> <span style="color: #800080;">4</span> <span style="color: #800080;">5</span> <span style="color: #800080;">6</span>
<span style="color: #800080;">3</span> <span style="color: #800080;">4</span> <span style="color: #800080;">5</span> <span style="color: #800080;">6</span>
<span style="color: #800080;">4</span> <span style="color: #800080;">5</span> <span style="color: #800080;">6</span>
<span style="color: #800080;">5</span> <span style="color: #800080;">6</span>
<span style="color: #800080;">6</span></pre>
  </div>
</div>

说明：

<div>
  <p class="a3">
    shift命令用于对参数的移动(左移)，通常用于在不知道传入参数个数的情况下依次遍历每个参数然后进行相应处理（常见于Linux中各种程序的启动脚本）。
  </p>
</div>

<div>
  <div class="cnblogs_Highlighter">
    <pre class="brush:bash;gutter:true;">ssh-copy-id -i /root/.ssh/id_dsa.pub "-p 52113 znix@172.16.1.250"</pre>
  </div>
</div>

由于/usr/bin/ssh-copy-id 脚本中前面使用了两个shift 所有原本该为$3的参数变为了$1.

<div>
  <div class="cnblogs_code">
    <pre><span style="color: #0000ff;">if</span> [ <span style="color: #800000;">"</span><span style="color: #800000;">-i</span><span style="color: #800000;">"</span> = <span style="color: #800000;">"</span><span style="color: #800000;">$1</span><span style="color: #800000;">"</span> ]; <span style="color: #0000ff;">then</span>
  <span style="color: #0000ff;">shift</span><span style="color: #000000;">
  # check </span><span style="color: #0000ff;">if</span> we have <span style="color: #800080;">2</span> parameters left, <span style="color: #0000ff;">if</span> so the first is the new ID <span style="color: #0000ff;">file</span>
  <span style="color: #0000ff;">if</span> [ -n <span style="color: #800000;">"</span><span style="color: #800000;">$2</span><span style="color: #800000;">"</span> ]; <span style="color: #0000ff;">then</span>
    <span style="color: #0000ff;">if</span> <span style="color: #0000ff;">expr</span> <span style="color: #800000;">"</span><span style="color: #800000;">$1</span><span style="color: #800000;">"</span> : <span style="color: #800000;">"</span><span style="color: #800000;">.*\.pub</span><span style="color: #800000;">"</span> > /dev/<span style="color: #0000ff;">null</span> ; <span style="color: #0000ff;">then</span><span style="color: #000000;">
      ID_FILE</span>=<span style="color: #800000;">"</span><span style="color: #800000;">$1</span><span style="color: #800000;">"</span>
    <span style="color: #0000ff;">else</span><span style="color: #000000;">
      ID_FILE</span>=<span style="color: #800000;">"</span><span style="color: #800000;">$1.pub</span><span style="color: #800000;">"</span>
    <span style="color: #0000ff;">fi</span>
    <span style="color: #0000ff;">shift</span>         # and this should leave $<span style="color: #800080;">1</span><span style="color: #000000;"> as the target name
  </span><span style="color: #0000ff;">fi</span>
<span style="color: #0000ff;">else</span></pre>
  </div>
</div>

## <span id="13">1.3 实现自动分发公钥，远程管理多台主机</span>

### <span id="131_shell">1.3.1 【预备知识】shell中三种循环</span>

<div class="cnblogs_code">
  <pre>#<span style="color: #0000ff;">for</span><span style="color: #000000;"> 循环

</span><span style="color: #0000ff;">for</span> n <span style="color: #0000ff;">in</span> (<span style="color: #800080;">1</span>..<span style="color: #800080;">100</span><span style="color: #000000;">)
</span><span style="color: #0000ff;">do</span><span style="color: #000000;">
      xxx
</span><span style="color: #0000ff;">done</span><span style="color: #000000;">

#while循环:循环条件为真时，一直循环；为假时，停止循环

</span><span style="color: #0000ff;">while</span><span style="color: #000000;"> [ture]
</span><span style="color: #0000ff;">do</span><span style="color: #000000;">
      xxx
</span><span style="color: #0000ff;">done</span><span style="color: #000000;">

#</span><span style="color: #0000ff;">until</span><span style="color: #000000;"> 循环: 循环条件为假时，一直循环；为真时，停止循环

</span><span style="color: #0000ff;">until</span><span style="color: #000000;"> [ture]
</span><span style="color: #0000ff;">do</span><span style="color: #000000;">
   xxx
</span><span style="color: #0000ff;">done</span></pre>
</div>

<div>
  &nbsp;
</div>

### <span id="132">1.3.2 实现自动分发公钥，远程管理多台主机的阻碍因素？</span>

<div>
  <p class="a3">
    01.创建秘钥对需要进行交互
  </p>
  
  <p class="a3">
    　　a.需要确认秘钥保存路径
  </p>
  
  <p class="a3">
    　　b.需要确认密码信息
  </p>
  
  <p class="a3">
    02.分发公钥时需要进行交互
  </p>
  
  <p class="a3">
    　　a.需要进行确认yes|no
  </p>
  
  <p class="a3">
    　　b.第一次分发公钥需要进行密码认证
  </p>
</div>

### <span id="133">1.3.3 解决阻碍因素</span>

1.自动保存路径，并且不密码

<div>
  <div class="cnblogs_code">
    <pre><span style="color: #0000ff;">ssh-keygen</span> -t rsa -f ~/.<span style="color: #0000ff;">ssh</span>/id_rsa -N <span style="color: #800000;">""</span> -q</pre>
  </div>
</div>

**参数说明：**

<div>
  <div class="cnblogs_Highlighter">
    <pre class="brush:bash;gutter:true;">-f filename     Specifies the filename of the key file.
                  指定密钥文件保存的路径信息（免交互）

-P passphrase       Provides the (old) passphrase.
                    提供一个密码信息

-N new_passphrase      Provides the new passphrase.
      -P -N        都是免交互方式指定密码信息

-q 安静的    不输出信息，减少信息输出</pre>
  </div>
</div>

2.解决分发公钥时需要进行的交互

<div>
  <div class="cnblogs_code">
    <pre>sshpass -p123456 <span style="color: #0000ff;">ssh</span>-copy-<span style="color: #0000ff;">id</span> -i ~/.<span style="color: #0000ff;">ssh</span>/id_rsa.pub <span style="color: #800000;">"</span><span style="color: #800000;"> root@172.16.1.$ip  -o StrictHostKeyChecking=no </span><span style="color: #800000;">"</span></pre>
  </div>
</div>

**参数说明：**

<div>
  <div class="cnblogs_Highlighter">
    <pre class="brush:bash;gutter:true;">-o   option   选择 （man 手册中可以查到有很多选项）
StrictHostKeyChecking=no 对询问的回应（不进行对密钥检查）</pre>
  </div>
</div>

要实现免密码，需要一款软件 sshpass &nbsp;该软件就是为ssh提供密码使用的

<div>
  <div class="cnblogs_code">
    <pre>[root@m01 ~]# <span style="color: #0000ff;">yum</span> <span style="color: #0000ff;">install</span>  sshpass  -y</pre>
  </div>
</div>

**注意：密码与 -p****之间不能有空格**

### <span id="134">1.3.4 最终批量分发脚本内容</span>

<div>
  <div class="cnblogs_code">
    <pre>[root@m01 scripts]# vim <span style="color: #0000ff;">ssh</span>-key.<span style="color: #0000ff;">sh</span><span style="color: #000000;"> 
#</span>!/bin/<span style="color: #000000;">bash
. </span>/etc/rc.d/init.d/<span style="color: #000000;">functions

# 创建密钥
\</span><span style="color: #0000ff;">rm</span> ~/.<span style="color: #0000ff;">ssh</span>/id_rsa* -<span style="color: #000000;">f
</span><span style="color: #0000ff;">ssh-keygen</span> -t rsa -f ~/.<span style="color: #0000ff;">ssh</span>/id_rsa -N <span style="color: #800000;">""</span> -<span style="color: #000000;">q
# 分发公钥
</span><span style="color: #0000ff;">for</span> ip <span style="color: #0000ff;">in</span> <span style="color: #800080;">31</span> <span style="color: #800080;">41</span> <span style="color: #800080;">8</span>
<span style="color: #0000ff;">do</span><span style="color: #000000;">
sshpass </span>-p123456 <span style="color: #0000ff;">ssh</span>-copy-<span style="color: #0000ff;">id</span> -i ~/.<span style="color: #0000ff;">ssh</span>/id_rsa.pub <span style="color: #800000;">"</span><span style="color: #800000;"> root@172.16.1.$ip  -o StrictHostKeyChecking=no </span><span style="color: #800000;">"</span> &>/dev/<span style="color: #0000ff;">null</span>
<span style="color: #0000ff;">if</span> [ $? -eq <span style="color: #800080;"></span> ];<span style="color: #0000ff;">then</span><span style="color: #000000;">
action  </span><span style="color: #800000;">"</span><span style="color: #800000;">fenfa 172.16.1.$ip</span><span style="color: #800000;">"</span>  /bin/<span style="color: #0000ff;">true</span>
<span style="color: #0000ff;">else</span><span style="color: #000000;">
action  </span><span style="color: #800000;">"</span><span style="color: #800000;">fenfa 172.16.1.$ip</span><span style="color: #800000;">"</span>  /bin/<span style="color: #0000ff;">false</span>
<span style="color: #0000ff;">fi</span>
<span style="color: #0000ff;">echo</span> <span style="color: #800000;">""</span>
<span style="color: #0000ff;">done</span></pre>
  </div>
</div>

脚本执行效果：

<div>
  <div class="cnblogs_code">
    <pre>[root@m01 scripts]# <span style="color: #0000ff;">sh</span> <span style="color: #0000ff;">ssh</span>-key.<span style="color: #0000ff;">sh</span><span style="color: #000000;">
fenfa </span><span style="color: #800080;">172.16</span>.<span style="color: #800080;">1.31</span><span style="color: #000000;">                                          [  OK  ]
fenfa </span><span style="color: #800080;">172.16</span>.<span style="color: #800080;">1.41</span><span style="color: #000000;">                                          [  OK  ]
fenfa </span><span style="color: #800080;">172.16</span>.<span style="color: #800080;">1.8</span>                                           [  OK  ]</pre>
  </div>
</div>

说明：

&nbsp;&nbsp; 脚本中引用 **. /etc/rc.d/init.d/functions** 函数，可以显示执行结果的判断。

&nbsp;&nbsp; 使用if语句进行判断，action 执行相应的动作。true/false

### <span id="135">1.3.5 实现基于密钥的批量管理脚本</span>

<div>
  <div class="cnblogs_code">
    <pre>[root@m01 scripts]# vim piliang_guanli.<span style="color: #0000ff;">sh</span><span style="color: #000000;"> 
#</span>!/bin/<span style="color: #000000;">bash
CMD</span>=$<span style="color: #800080;">1</span>

<span style="color: #0000ff;">for</span> ip <span style="color: #0000ff;">in</span> <span style="color: #800080;">8</span> <span style="color: #800080;">31</span> <span style="color: #800080;">41</span>
<span style="color: #0000ff;">do</span>
<span style="color: #0000ff;">echo</span> ========host <span style="color: #800080;">172.16</span>.<span style="color: #800080;">1</span>.$ip=======
<span style="color: #0000ff;">ssh</span> root@<span style="color: #800080;">172.16</span>.<span style="color: #800080;">1</span>.$ip <span style="color: #800000;">"</span><span style="color: #800000;">$CMD</span><span style="color: #800000;">"</span>
<span style="color: #0000ff;">echo</span> ============END===============
<span style="color: #0000ff;">echo</span> <span style="color: #800000;">""</span>
<span style="color: #0000ff;">done</span></pre>
  </div>
</div>

脚本执行效果：

<div>
  <div class="cnblogs_code">
    <pre>[root@m01 scripts]# <span style="color: #0000ff;">sh</span> piliang_guanli.<span style="color: #0000ff;">sh</span>  <span style="color: #0000ff;">date</span>
======<span style="color: #800080;">172.16</span>.<span style="color: #800080;">1.8</span>======<span style="color: #000000;">
Thu Oct </span><span style="color: #800080;">19</span> <span style="color: #800080;">16</span>:<span style="color: #800080;">25</span>:<span style="color: #800080;">08</span> CST <span style="color: #800080;">2017</span>
=========END=============


======<span style="color: #800080;">172.16</span>.<span style="color: #800080;">1.31</span>======<span style="color: #000000;">
Thu Oct </span><span style="color: #800080;">19</span> <span style="color: #800080;">16</span>:<span style="color: #800080;">25</span>:<span style="color: #800080;">08</span> CST <span style="color: #800080;">2017</span>
=========END=============

 
======<span style="color: #800080;">172.16</span>.<span style="color: #800080;">1.41</span>======<span style="color: #000000;">
Thu Oct </span><span style="color: #800080;">19</span> <span style="color: #800080;">16</span>:<span style="color: #800080;">25</span>:<span style="color: #800080;">08</span> CST <span style="color: #800080;">2017</span>
=========END=============</pre>
  </div>
</div>

**基于密钥登陆方式，分发的公钥文件会识别用户信息，所以能够实现免密码批量管理。**

# <span id="2_ansible">第2章 ansible软件介绍</span>

  * python 语言是运维人员必须会的语言
  * ansible 是一个基于python 开发的自动化运维工具
  * 其功能实现基于ssh远程连接服务
  * ansible 可以实现批量系统配置，批量软件部署，批量文件拷贝，批量运行命令等功能

<div>
  <p class="a3">
    除了ansible之外，还有<strong>saltstack </strong>等批量管理软件
  </p>
</div>

## <span id="21">2.1 自动化批量管理方式说明</span>

### <span id="211_sshkey">2.1.1 ssh+key方式的说明</span>

&nbsp; 　　免密码登录验证是单向的，方向从私钥（钥匙） >==> 公钥（锁）

&nbsp; 　　SSH免密码登录基于用户的，最好不要跨不同的用户

&nbsp; 　　SSH连接慢解决；即修改sshd_config配罝文件参数信息

&nbsp; 　　批量分发1000台初始都需要输入一次密码，并且第一次连接要确认（expect/sshpass)

<div>
  <p class="a3">
    &nbsp; 　　expect批量管理服务器参考 http://oldboy.blog.51cto.com/2561410/1206238
  </p>
</div>

### <span id="212">2.1.2 企业级生产场景批量管理-自动化管理方案</span>

①.最简单/最常用/最强大的选择是**ssh key+shell**/pssh方案，一般中小型企业会用（50-100台以下规模企业）

&nbsp;&nbsp; 　　a.利用ssh key执行命令，并将命令放在脚本里面

&nbsp;&nbsp;　　 b.利用ssh key执行命令，将命令放在脚本里面，并加上相应循环语句或判断语句

②.sina cfengine/puppet较早的批量管理工具；现在基本上没有企业用

③.门户级别比较流行的，puppet批量管理工具（复杂/笨重）

④.saltstack批量管理工具；特点：简单，功能强大（配罝复杂>\---赶集网/小米/一些CDN公司 批量管理路线：ssh key-->cfengine-->puppet-->saltstack/ansible

　　PS:使用ansible软件的前提是ssh key公钥分发充成

### <span id="213">2.1.3 如何完成成集群规模架构一键自动化实现（步骤说明）</span>

①.1台服务器先配置好（kickstart,cobbler无人值守安装）。高级实现云计算（按需分配，动态调整）（openstack,kvm)

②.linux基本优化，包括ssh服务（可以自动化实现）。

　　创建密钥信息（自动化免交互创建）

<div>
  <div class="cnblogs_code">
    <pre><span style="color: #0000ff;">ssh-keygen</span> -t dsa -P <span style="color: #800000;">""</span> -f ~/.<span style="color: #0000ff;">ssh</span>/id_dsa >/dev/<span style="color: #0000ff;">null</span> <span style="color: #800080;">2</span>>&<span style="color: #800080;">1</span></pre>
  </div>
</div>

　　进行批量分发密钥（**sshpass**,expect自动化实现）

⑤.ansible软件安装（可以自动化实现）

⑥.网络服务自动化安装（ansible实现）

(搭建yum仓库，定制rpm包）

## <span id="22_ansible">2.2 ansible软件特点概述</span>

l 不需要单独安装客户端（no agents），基于系统自带的sshd服务，sshd就相当于ansible的客户端

l 不需要服务端（no sever）

l 需要依靠大量的模块实现批量管理

l 配置文件 /etc/ansible/ansible.cfg (前期不用配置)

<div>
  <p class="a3">
    <strong>ansible</strong><strong>软件相关参考链接信息</strong>
  </p>
  
  <p class="a3">
    http://docs.ansible.com/ansible/intro_installation.html
  </p>
  
  <p class="a3">
    http://www.ansible.com.cn/
  </p>
  
  <p class="a3">
    http://docs.ansible.com/modules_by_category.html
  </p>
  
  <p class="a3">
    http://www.ansible.cn/docs/
  </p>
</div>

### <span id="221_ansible">2.2.1 ansible软件中查看模块相关信息方法</span>

<div>
  <div class="cnblogs_code">
    <pre>[root@m01 ~]# ansible-doc -<span style="color: #000000;">l
列出所有模块信息

[root@m01 </span>~]# ansible-doc -<span style="color: #000000;">s cron 
参看指定模块的帮助</span></pre>
  </div>
</div>

## <span id="23_ansible">2.3 部署ansible软件</span>

### <span id="231_sshkey">2.3.1 第一个里里程碑：部署ssh+key免密码登录方式</span>

[参见第一章内容][1]

### <span id="232_ansible">2.3.2 第二个里程碑：被管理端安装ansible相关管理软件</span>

<div>
  <div class="cnblogs_code">
    <pre>[root@m01 ~]# <span style="color: #0000ff;">yum</span> <span style="color: #0000ff;">install</span> libselinux-python -y</pre>
  </div>
</div>

&nbsp;&nbsp; 该软件是用来对selinux进行设置的，确保即使服务器selinux服务开启，依旧能够通过ansible 软件管理。

### <span id="233_ansiblehosts">2.3.3 第三个里程碑：管理端安装ansible软件，配置hosts文件</span>

<div>
  <div class="cnblogs_code">
    <pre>[root@m01 ~]# <span style="color: #0000ff;">yum</span> <span style="color: #0000ff;">install</span> ansible -y</pre>
  </div>
</div>

软件安装完成，进行修改ansible下的hosts文件，**注意文件的路径**

<div>
  <div class="cnblogs_code">
    <pre>[root@m01 ~]# vim /etc/ansible/<span style="color: #000000;">hosts
[clsn]
</span><span style="color: #800080;">172.16</span>.<span style="color: #800080;">1.31</span>
<span style="color: #800080;">172.16</span>.<span style="color: #800080;">1.41</span>
<span style="color: #800080;">172.16</span>.<span style="color: #800080;">1.8</span></pre>
  </div>
</div>

**文件信息说明：**

1.中括号中的名字代表组名

2.主机(hosts)部分可以使用域名、主机名、IP地址表示；一般此类配置中多使用IP地址；

3．组名下的主机地址就是ansible可以管理的地址

**至此ansible** **服务就部署完成** **&uarr;**

## <span id="24_ansible">2.4 查看ansible软件相关信息</span>

### <span id="241_ansible">2.4.1 ansible实践部署地址规划</span>

<table style="height: 258px; width: 616px;" border="1" cellspacing="0" cellpadding="0">
  <tr>
    <td valign="top" width="174">
      <p align="center">
        <span style="font-size: 14px; color: #000000; background-color: #00ccff;"><strong>服务器名称</strong></span>
      </p>
    </td>
    
    <td valign="top" width="174">
      <p align="center">
        <span style="font-size: 14px; color: #000000; background-color: #00ccff;"><strong>网卡eth0</strong></span>
      </p>
    </td>
    
    <td valign="top" width="174">
      <p align="center">
        <span style="font-size: 14px; color: #000000; background-color: #00ccff;"><strong>网卡eth1</strong></span>
      </p>
    </td>
    
    <td valign="top" width="174">
      <p align="center">
        <span style="font-size: 14px; color: #000000; background-color: #00ccff;"><strong>用途说明</strong></span>
      </p>
    </td>
  </tr>
  
  <tr>
    <td valign="top" width="174">
      <p>
        <span style="font-size: 13px;">m01</span>
      </p>
    </td>
    
    <td valign="top" width="174">
      <p>
        <span style="font-size: 13px;">10.0.0.61</span>
      </p>
    </td>
    
    <td valign="top" width="174">
      <p>
        <span style="font-size: 13px;">172.16.1.61</span>
      </p>
    </td>
    
    <td valign="top" width="174">
      <p>
        <span style="font-size: 13px;">批量管理服务器</span>
      </p>
    </td>
  </tr>
  
  <tr>
    <td valign="top" width="174">
      <p>
        <span style="font-size: 13px;">nfs01</span>
      </p>
    </td>
    
    <td valign="top" width="174">
      <p>
        <span style="font-size: 13px;">10.0.0.31</span>
      </p>
    </td>
    
    <td valign="top" width="174">
      <p>
        <span style="font-size: 13px;">172.16.1.31</span>
      </p>
    </td>
    
    <td valign="top" width="174">
      <p>
        <span style="font-size: 13px;">nfs共享储存服务器</span>
      </p>
    </td>
  </tr>
  
  <tr>
    <td valign="top" width="174">
      <p>
        <span style="font-size: 13px;">backup</span>
      </p>
    </td>
    
    <td valign="top" width="174">
      <p>
        <span style="font-size: 13px;">10.0.0.41</span>
      </p>
    </td>
    
    <td valign="top" width="174">
      <p>
        <span style="font-size: 13px;">172.16.1.41</span>
      </p>
    </td>
    
    <td valign="top" width="174">
      <p>
        <span style="font-size: 13px;">rsync备份服务器</span>
      </p>
    </td>
  </tr>
  
  <tr>
    <td valign="top" width="174">
      <p>
        <span style="font-size: 13px;">web01</span>
      </p>
    </td>
    
    <td valign="top" width="174">
      <p>
        <span style="font-size: 13px;">10.0.0.8</span>
      </p>
    </td>
    
    <td valign="top" width="174">
      <p>
        <span style="font-size: 13px;">172.16.1.8</span>
      </p>
    </td>
    
    <td valign="top" width="174">
      <p>
        <span style="font-size: 13px;">web服务器</span>
      </p>
    </td>
  </tr>
  
  <tr>
    <td colspan="4" valign="top" width="697">
      <p>
        <span style="font-size: 13px;">说明：无特殊情况，子网掩码为255.255.255.0</span>
      </p>
    </td>
  </tr>
</table>

### <span id="242_ansible">2.4.2 ansible软件的版本信息</span>

<div>
  <div class="cnblogs_code">
    <pre>[root@m01 ~]# ansible --<span style="color: #000000;">version
ansible </span><span style="color: #800080;">2.3</span>.<span style="color: #800080;">2.0</span><span style="color: #000000;">
  config </span><span style="color: #0000ff;">file</span> = /etc/ansible/<span style="color: #000000;">ansible.cfg
  configured module search path </span>= Default <span style="color: #0000ff;">w</span>/<span style="color: #000000;">o overrides
  python version </span>= <span style="color: #800080;">2.6</span>.<span style="color: #800080;">6</span> (r266:<span style="color: #800080;">84292</span>, Aug <span style="color: #800080;">18</span> <span style="color: #800080;">2016</span>, <span style="color: #800080;">15</span>:<span style="color: #800080;">13</span>:<span style="color: #800080;">37</span>) [GCC <span style="color: #800080;">4.4</span>.<span style="color: #800080;">7</span> <span style="color: #800080;">20120313</span> (Red Hat <span style="color: #800080;">4.4</span>.<span style="color: #800080;">7</span>-<span style="color: #800080;">17</span>)]</pre>
  </div>
</div>

### <span id="243">2.4.3 软件目前主要会用到的文件</span>

<div>
  <div class="cnblogs_code">
    <pre>[root@m01 ~]# rpm -<span style="color: #000000;">ql ansible
</span>/etc/ansible/<span style="color: #000000;">hosts            #定义anisble软件可以管理的主机信息
</span>/usr/bin/<span style="color: #000000;">ansible              #ansible执行命令
</span>/usr/bin/ansible-playboot   # ansible执行剧本命令</pre>
  </div>
</div>

### <span id="244_etcansible">2.4.4 /etc/ansible下的文件</span>

<div>
  <div class="cnblogs_code">
    <pre><span style="color: #000000;">[root@m01 ansible]# ll
total </span><span style="color: #800080;">28</span>
-rw-r--r-- <span style="color: #800080;">1</span> root root <span style="color: #800080;">18066</span> Sep  <span style="color: #800080;">6</span> <span style="color: #800080;">06</span>:<span style="color: #800080;">38</span><span style="color: #000000;"> ansible.cfg  #ansible配置文件
</span>-rw-r--r-- <span style="color: #800080;">1</span> root root  <span style="color: #800080;">1016</span> Sep  <span style="color: #800080;">6</span> <span style="color: #800080;">06</span>:<span style="color: #800080;">38</span><span style="color: #000000;"> hosts       #定义ansible可以管理的主机信息
drwxr</span>-xr-x <span style="color: #800080;">2</span> root root  <span style="color: #800080;">4096</span> Sep  <span style="color: #800080;">6</span> <span style="color: #800080;">06</span>:<span style="color: #800080;">38</span> roles   #主要在自动化的时候部署多台主机时使用</pre>
  </div>
</div>

## <span id="25_ansible">2.5 ansible软件的使用/参数</span>

### <span id="251_ansible">2.5.1 ansible远程批量执行命令</span>

**语法：**

<div>
  <div class="cnblogs_Highlighter">
    <pre class="brush:bash;gutter:true;">    ansible clsn -a "uptime"

   ansible clsn -m command -a "uptime"

   ansible 定义的组/单个ip/域名/all  -m command -a "uptime"</pre>
  </div>
  
  <p class="ac">
    <strong>说明：</strong>-m 指定使用的模块
  </p>
  
  <p class="ac">
    &nbsp;&nbsp; &nbsp;&nbsp;&nbsp;-a 指定使用模块中相应的命令参数
  </p>
  
  <p class="ac">
    &nbsp;&nbsp; &nbsp; &nbsp;命令参数只能是基本命令，并不支持管道操作
  </p>
  
  <p class="ac">
    &nbsp;&nbsp;&nbsp;&nbsp;&nbsp; all &nbsp;&nbsp;为hosts文件中的组全部管理
  </p>
</div>

<p style="text-align: center;">
  &nbsp;<img data-original="https://clsn.io/wp-content/uploads/2018/03/1190037-20171027153653242-314383760.png" src="/wp-content/themes/clsn-003/img/blank.gif" alt="ansible服务部署与使用" alt="" />
</p>

<p class="a9" align="center">
  图2-1 ansible命令语法格式示意图
</p>

### <span id="252_ansible">2.5.2 未分发公钥如何实现远程管理主机及指定ansible端口信息</span>

配置hosts文件时配置上密码

<div>
  <div class="cnblogs_code">
    <pre>vim /etc/ansible/<span style="color: #000000;">hosts

[clsn]
</span><span style="color: #800080;">172.16</span>.<span style="color: #800080;">1.31</span>:<span style="color: #800080;">52113</span>  ansible_ssh_user=root ansible_ssh_pass=<span style="color: #800080;">123456</span>
<span style="color: #800080;">172.16</span>.<span style="color: #800080;">1.41</span>
<span style="color: #800080;">172.16</span>.<span style="color: #800080;">1.8</span></pre>
  </div>
  
  <p class="ac">
    IP:端口 用户 密码
  </p>
  
  <div class="cnblogs_Highlighter">
    <pre class="brush:bash;gutter:true;">[znix]
www.znix.top:52113 ansible_ssh_user=znix</pre>
  </div>
  
  <p class="ac">
    指定端口 用户名
  </p>
</div>

&nbsp; &nbsp;测试修改端口后的结果 使用ping 模块

<div>
  <div class="cnblogs_code">
    <pre>[root@m01 ~]# ansible znix -m <span style="color: #0000ff;">ping</span><span style="color: #000000;">
www.znix.top </span>| SUCCESS =><span style="color: #000000;"> {
    </span><span style="color: #800000;">"</span><span style="color: #800000;">changed</span><span style="color: #800000;">"</span>: <span style="color: #0000ff;">false</span><span style="color: #000000;">,
    </span><span style="color: #800000;">"</span><span style="color: #800000;">ping</span><span style="color: #800000;">"</span>: <span style="color: #800000;">"</span><span style="color: #800000;">pong</span><span style="color: #800000;">"</span><span style="color: #000000;">
}</span></pre>
  </div>
</div>

## <span id="26_ansible">2.6 ansible软件常用参数表</span>

<table border="1" cellspacing="0" cellpadding="0">
  <tr>
    <td valign="top" width="170">
      <p align="center">
        <span style="font-size: 15px;"><strong>命令参数</strong></span>
      </p>
    </td>
    
    <td valign="top" width="527">
      <p align="center">
        <span style="font-size: 15px;"><strong>参数说明</strong></span>
      </p>
    </td>
  </tr>
  
  <tr>
    <td width="170">
      <p>
        <span style="font-size: 13px;">-m&nbsp; MODULE_NAME</span>
      </p>
    </td>
    
    <td width="527">
      <p>
        <span style="font-size: 13px;">-module-name=MODULE_NAME</span>
      </p>
      
      <p>
        <span style="font-size: 13px;">module name to execute (default=command)</span>
      </p>
      
      <p>
        <span style="font-size: 13px;">相应名称的模块被执行（默认模块为command ); </span>
      </p>
      
      <p>
        <span style="font-size: 13px;">-m后边是模块的名宇</span>
      </p>
    </td>
  </tr>
  
  <tr>
    <td width="170">
      <p>
        <span style="font-size: 13px;">-a MODULE_ARGS</span>
      </p>
    </td>
    
    <td width="527">
      <p>
        <span style="font-size: 13px;">-args=MODULE_ARGS</span>
      </p>
      
      <p>
        <span style="font-size: 13px;">module arguments</span>
      </p>
      
      <p>
        <span style="font-size: 13px;">模块参数信息</span>
      </p>
      
      <p>
        <span style="font-size: 13px;">-a后面是要执行的命令；也可以写个ip ,针对台机器来执行命令</span>
      </p>
    </td>
  </tr>
  
  <tr>
    <td width="170">
      <p>
        <span style="font-size: 13px;">-C, -checks</span>
      </p>
    </td>
    
    <td width="527">
      <p>
        <span style="font-size: 13px;">don't make any changes, instead, try to predict some of the changes that may</span>
      </p>
      
      <p>
        <span style="font-size: 13px;">occurs</span>
      </p>
      
      <p>
        <span style="font-size: 13px;">不做任何改变；反而，只是尝试预言些可能出现的改变</span>
      </p>
    </td>
  </tr>
  
  <tr>
    <td width="170">
      <p>
        <span style="font-size: 13px;">-syntax-checks</span>
      </p>
    </td>
    
    <td width="527">
      <p>
        <span style="font-size: 13px;">perform a syntax check on the playbook, but do not execute ii*></span>
      </p>
      
      <p>
        <span style="font-size: 13px;">执行语法检查在剧本上，但是并不执行剧本</span>
      </p>
    </td>
  </tr>
</table>

### <span id="261_ansible">2.6.1 ansible命令执行结果色彩说明：</span>

<div>
  <p class="a3">
    　　绿色：表示没有发生任何改变
  </p>
  
  <p class="a3">
    　　红色：执行命令操作出现异常
  </p>
  
  <p class="a3">
    　　黄色：执行命令后，对受控主机产生影响，发生了配置改变
  </p>
</div>

# <span id="3_ansible">第3章 ansible中的模块说明</span>

## <span id="31_ping">3.1 ping 模块：测试连通性</span>

<div>
  <div class="cnblogs_code">
    <pre>[root@m01 ~]# ansible all -m <span style="color: #0000ff;">ping</span> 
<span style="color: #800080;">172.16</span>.<span style="color: #800080;">1.8</span> | SUCCESS =><span style="color: #000000;"> {
    </span><span style="color: #800000;">"</span><span style="color: #800000;">changed</span><span style="color: #800000;">"</span>: <span style="color: #0000ff;">false</span><span style="color: #000000;">, 
    </span><span style="color: #800000;">"</span><span style="color: #800000;">ping</span><span style="color: #800000;">"</span>: <span style="color: #800000;">"</span><span style="color: #800000;">pong</span><span style="color: #800000;">"</span><span style="color: #000000;">
}
</span><span style="color: #800080;">172.16</span>.<span style="color: #800080;">1.41</span> | SUCCESS =><span style="color: #000000;"> {
    </span><span style="color: #800000;">"</span><span style="color: #800000;">changed</span><span style="color: #800000;">"</span>: <span style="color: #0000ff;">false</span><span style="color: #000000;">, 
    </span><span style="color: #800000;">"</span><span style="color: #800000;">ping</span><span style="color: #800000;">"</span>: <span style="color: #800000;">"</span><span style="color: #800000;">pong</span><span style="color: #800000;">"</span><span style="color: #000000;">
}
</span><span style="color: #800080;">172.16</span>.<span style="color: #800080;">1.31</span> | SUCCESS =><span style="color: #000000;"> {
    </span><span style="color: #800000;">"</span><span style="color: #800000;">changed</span><span style="color: #800000;">"</span>: <span style="color: #0000ff;">false</span><span style="color: #000000;">, 
    </span><span style="color: #800000;">"</span><span style="color: #800000;">ping</span><span style="color: #800000;">"</span>: <span style="color: #800000;">"</span><span style="color: #800000;">pong</span><span style="color: #800000;">"</span><span style="color: #000000;">
}</span></pre>
  </div>
</div>

&nbsp;&nbsp; 连接正常返回 pong 通过帮助信息可以获得 &darr;

<div>
  <p class="a3">
    通过 ansible-doc -v ping 可以获得该模块的说明
  </p>
  
  <p class="a3">
    ansible-doc -s file&nbsp;&nbsp; 参看模块的具体信息
  </p>
  
  <div class="cnblogs_code">
    <pre>[root@m01 ~]# ansible-doc -v <span style="color: #0000ff;">ping</span><span style="color: #000000;">
Using </span>/etc/ansible/ansible.cfg as config <span style="color: #0000ff;">file</span>
> PING    (/usr/lib/python2.<span style="color: #800080;">6</span>/site-packages/ansible/modules/system/<span style="color: #0000ff;">ping</span><span style="color: #000000;">.py)

  A trivial test module, this module always returns `pong</span><span style="color: #800000;">'</span><span style="color: #800000;"> on successful contact. It does not make sense in playbooks, but it is useful from `/usr/bin/ansible</span><span style="color: #800000;">'</span> to verify the ability to <span style="color: #0000ff;">login</span> and that a usable  python is configured. This is NOT ICMP <span style="color: #0000ff;">ping</span>, this is just a trivial test module.</pre>
  </div>
</div>

## <span id="32_command">3.2 command 模块 默认模块</span>

### <span id="321_command">3.2.1 command命令常用参数说明</span>

<table border="1" cellspacing="0" cellpadding="0">
  <tr>
    <td valign="top" width="160">
      <p align="center">
        <span style="font-size: 15px; font-family: 'Microsoft YaHei';"><strong>参数</strong></span>
      </p>
    </td>
    
    <td valign="top" width="537">
      <p align="center">
        <span style="font-size: 15px; font-family: 'Microsoft YaHei';"><strong>参数说明</strong></span>
      </p>
    </td>
  </tr>
  
  <tr>
    <td width="160">
      <p>
        <span style="font-size: 13px;">chdir</span>
      </p>
    </td>
    
    <td valign="top" width="537">
      <p>
        <span style="font-size: 13px;">在执行命令之前，通过cd命令进入到指定目录中</span>
      </p>
      
      <p>
        <span style="font-size: 13px;"># ansible clsn -m command -a "chdir=/tmp ls"</span>
      </p>
    </td>
  </tr>
  
  <tr>
    <td width="160">
      <p>
        <span style="font-size: 13px;">create</span>
      </p>
    </td>
    
    <td valign="top" width="537">
      <p align="center">
        <span style="font-size: 13px;">定义一个文件是否存在，如果不存在运行相应命令；如果存在跳过此步骤</span>
      </p>
    </td>
  </tr>
  
  <tr>
    <td valign="top" width="160">
      <p>
        <span style="font-size: 13px;">executable</span>
      </p>
    </td>
    
    <td valign="top" width="537">
      <p>
        <span style="font-size: 13px;">改变shell使用command进行执行，并且执行时要使用绝对路径</span>
      </p>
    </td>
  </tr>
  
  <tr>
    <td valign="top" width="160">
      <p>
        <span style="font-size: 13px;">free_form</span>
      </p>
    </td>
    
    <td valign="top" width="537">
      <p>
        <span style="font-size: 13px;">命令模块采用自由形式命令运行；即可以输入任意linux命令</span>
      </p>
    </td>
  </tr>
  
  <tr>
    <td valign="top" width="160">
      <p>
        <span style="font-size: 13px;">removes</span>
      </p>
    </td>
    
    <td valign="top" width="537">
      <p>
        <span style="font-size: 13px;">定义一个文件是否存在，如果存在运行相应命令；如果不存在跳过此步骤</span>
      </p>
    </td>
  </tr>
  
  <tr>
    <td valign="top" width="160">
      <p>
        <span style="font-size: 13px;">warn</span>
      </p>
      
      <p>
        <span style="font-size: 13px;">(added in 1.8)</span>
      </p>
    </td>
    
    <td valign="top" width="537">
      <p>
        <span style="font-size: 13px;">如果ansible配置文件中定义了命令警告，如果参数设置了no/false，将不会警告此行命令</span>
      </p>
    </td>
  </tr>
</table>

不指定模块的时候默认使用的模块就是command&nbsp; &darr;

<div>
  <div class="cnblogs_code">
    <pre>[root@m01 ~]# ansible all -a <span style="color: #800000;">"</span><span style="color: #800000;">date</span><span style="color: #800000;">"</span>
<span style="color: #800080;">172.16</span>.<span style="color: #800080;">1.41</span> | SUCCESS | rc=<span style="color: #800080;"></span> >><span style="color: #000000;">
Thu Oct </span><span style="color: #800080;">19</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">12</span>:<span style="color: #800080;">15</span> CST <span style="color: #800080;">2017</span>

<span style="color: #800080;">172.16</span>.<span style="color: #800080;">1.31</span> | SUCCESS | rc=<span style="color: #800080;"></span> >><span style="color: #000000;">
Thu Oct </span><span style="color: #800080;">19</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">12</span>:<span style="color: #800080;">15</span> CST <span style="color: #800080;">2017</span>

<span style="color: #800080;">172.16</span>.<span style="color: #800080;">1.8</span> | SUCCESS | rc=<span style="color: #800080;"></span> >><span style="color: #000000;">
Thu Oct </span><span style="color: #800080;">19</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">12</span>:<span style="color: #800080;">15</span> CST <span style="color: #800080;">2017</span></pre>
  </div>
</div>

使用ansible自带模块执行命令 如果要用 > < | & ' ' 使用shell模块

<div>
  <div class="cnblogs_code">
    <pre>[root@m01 ~]# ansible all -m command -a <span style="color: #800000;">"</span><span style="color: #800000;">date</span><span style="color: #800000;">"</span>
<span style="color: #800080;">172.16</span>.<span style="color: #800080;">1.8</span> | SUCCESS | rc=<span style="color: #800080;"></span> >><span style="color: #000000;">
Thu Oct </span><span style="color: #800080;">19</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">12</span>:<span style="color: #800080;">27</span> CST <span style="color: #800080;">2017</span>

<span style="color: #800080;">172.16</span>.<span style="color: #800080;">1.31</span> | SUCCESS | rc=<span style="color: #800080;"></span> >><span style="color: #000000;">
Thu Oct </span><span style="color: #800080;">19</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">12</span>:<span style="color: #800080;">28</span> CST <span style="color: #800080;">2017</span>

<span style="color: #800080;">172.16</span>.<span style="color: #800080;">1.41</span> | SUCCESS | rc=<span style="color: #800080;"></span> >><span style="color: #000000;">
Thu Oct </span><span style="color: #800080;">19</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">12</span>:<span style="color: #800080;">27</span> CST <span style="color: #800080;">2017</span></pre>
  </div>
</div>

chdir参数的使用：

<div>
  <div class="cnblogs_code">
    <pre>[root@m01 ~]# ansible clsn -m command -a <span style="color: #800000;">"</span><span style="color: #800000;">chdir=/tmp pwd</span><span style="color: #800000;">"</span>
<span style="color: #800080;">172.16</span>.<span style="color: #800080;">1.31</span> | SUCCESS | rc=<span style="color: #800080;"></span> >>
/<span style="color: #000000;">tmp

</span><span style="color: #800080;">172.16</span>.<span style="color: #800080;">1.8</span> | SUCCESS | rc=<span style="color: #800080;"></span> >>
/<span style="color: #000000;">tmp

</span><span style="color: #800080;">172.16</span>.<span style="color: #800080;">1.41</span> | SUCCESS | rc=<span style="color: #800080;"></span> >>
/tmp</pre>
  </div>
</div>

creates 文件是否存在，不存在就执行命令

<div>
  <div class="cnblogs_code">
    <pre>[root@m01 ~]# ansible clsn -m command -a <span style="color: #800000;">"</span><span style="color: #800000;">creates=/etc/hosts date</span><span style="color: #800000;">"</span>
<span style="color: #800080;">172.16</span>.<span style="color: #800080;">1.31</span> | SUCCESS | rc=<span style="color: #800080;"></span> >><span style="color: #000000;">
skipped, since </span>/etc/hosts exists</pre>
  </div>
</div>

removes 文件是否存在，不存在就不执行命令，

<div>
  <div class="cnblogs_code">
    <pre>[root@m01 ~]# ansible clsn -m command -a <span style="color: #800000;">"</span><span style="color: #800000;">removes=/etc/hosts date</span><span style="color: #800000;">"</span>
<span style="color: #800080;">172.16</span>.<span style="color: #800080;">1.31</span> | SUCCESS | rc=<span style="color: #800080;"></span> >><span style="color: #000000;">
Fri Oct </span><span style="color: #800080;">20</span> <span style="color: #800080;">13</span>:<span style="color: #800080;">32</span>:<span style="color: #800080;">40</span> CST <span style="color: #800080;">2017</span></pre>
  </div>
</div>

## <span id="33_shell">3.3 shell模块 <span style="text-decoration: underline;">万能模块</span></span>

执行linux命令时可以用

远程节点执行命令

&nbsp;&nbsp; **说明：** shell 模块在远程执行脚本时，远程主机上一定要有相应的脚本

<div>
  <div class="cnblogs_code">
    <pre>[root@m01 ~]# ansible clsn -m shell -a <span style="color: #800000;">"</span><span style="color: #800000;">/bin/sh /server/scripts/ssh-key.sh</span><span style="color: #800000;">"</span>
<span style="color: #800080;">172.16</span>.<span style="color: #800080;">1.31</span> | SUCCESS | rc=<span style="color: #800080;"></span> >><span style="color: #000000;">
fenfa </span><span style="color: #800080;">172.16</span>.<span style="color: #800080;">1.31</span><span style="color: #000000;"> [  OK  ]

fenfa </span><span style="color: #800080;">172.16</span>.<span style="color: #800080;">1.41</span><span style="color: #000000;"> [  OK  ]

fenfa </span><span style="color: #800080;">172.16</span>.<span style="color: #800080;">1.8</span> [  OK  ]</pre>
  </div>
</div>

## <span id="34_script">3.4 script 模块 执行脚本模块</span>

在本地执行脚本时，将脚本中的内容传输到远程节点上运行

<div>
  <div class="cnblogs_code">
    <pre>[root@m01 ~]# ansible all -m script -a <span style="color: #800000;">"</span><span style="color: #800000;">/server/scripts/free.sh</span><span style="color: #800000;">"</span>
<span style="color: #800080;">172.16</span>.<span style="color: #800080;">1.8</span> | SUCCESS =><span style="color: #000000;"> {
    </span><span style="color: #800000;">"</span><span style="color: #800000;">changed</span><span style="color: #800000;">"</span>: <span style="color: #0000ff;">true</span><span style="color: #000000;">,
    </span><span style="color: #800000;">"</span><span style="color: #800000;">rc</span><span style="color: #800000;">"</span>: <span style="color: #800080;"></span><span style="color: #000000;">,
    </span><span style="color: #800000;">"</span><span style="color: #800000;">stderr</span><span style="color: #800000;">"</span>: <span style="color: #800000;">"</span><span style="color: #800000;">Shared connection to 172.16.1.8 closed.\r\n</span><span style="color: #800000;">"</span><span style="color: #000000;">,
    </span><span style="color: #800000;">"</span><span style="color: #800000;">stdout</span><span style="color: #800000;">"</span>: <span style="color: #800000;">"</span><span style="color: #800000;">             total       used       free     shared    buffers     cached\r\nMem:          474M       377M        97M       532K        54M       202M\r\n-/+ buffers/cache:       120M       354M\r\nSwap:         767M         0B       767M\r\n</span><span style="color: #800000;">"</span><span style="color: #000000;">,
    </span><span style="color: #800000;">"</span><span style="color: #800000;">stdout_lines</span><span style="color: #800000;">"</span><span style="color: #000000;">: [
        </span><span style="color: #800000;">"</span><span style="color: #800000;">             total       used       free     shared    buffers     cached</span><span style="color: #800000;">"</span><span style="color: #000000;">,
        </span><span style="color: #800000;">"</span><span style="color: #800000;">Mem:          474M       377M        97M       532K        54M       202M</span><span style="color: #800000;">"</span><span style="color: #000000;">,
        </span><span style="color: #800000;">"</span><span style="color: #800000;">-/+ buffers/cache:       120M       354M</span><span style="color: #800000;">"</span><span style="color: #000000;">,
        </span><span style="color: #800000;">"</span><span style="color: #800000;">Swap:         767M         0B       767M</span><span style="color: #800000;">"</span><span style="color: #000000;">
    ]
}</span></pre>
  </div>
</div>

**说明：**

<div>
  <p class="a3">
    使用scripts模块，不用将脚本传输到远程节点，脚本本身不用进行授权，即可利用script模块执行。直接执行脚本即可，不需要使用sh
  </p>
</div>

## <span id="35_copy">3.5 copy模块 把本地文件发送到远端</span>

### <span id="351_copy">3.5.1 copy模块常用参数</span>

<table border="1" cellspacing="0" cellpadding="0">
  <tr>
    <td width="160">
      <p align="center">
        <span style="font-size: 15px;"><strong>选项参数</strong></span>
      </p>
    </td>
    
    <td width="537">
      <p align="center">
        <span style="font-size: 15px;"><strong>选项说明</strong></span>
      </p>
    </td>
  </tr>
  
  <tr>
    <td width="160">
      <p>
        <span style="font-size: 13px;">backup(重要参数）</span>
      </p>
    </td>
    
    <td width="537">
      <p>
        <span style="font-size: 13px;">在覆盖远端服务器文件之前，将远端服务器源文件备份，备份文件包含时间信息。有两个选项：yes|no</span>
      </p>
    </td>
  </tr>
  
  <tr>
    <td width="160">
      <p>
        <span style="font-size: 13px;">content</span>
      </p>
    </td>
    
    <td width="537">
      <p>
        <span style="font-size: 13px;">用于替代"src&rdquo;,可以直接设定指定文件的值</span>
      </p>
    </td>
  </tr>
  
  <tr>
    <td width="160">
      <p>
        <span style="font-size: 13px;">dest</span>
      </p>
    </td>
    
    <td width="537">
      <p>
        <span style="font-size: 13px;">必选项。要将源文件复制到的远程主机的绝对路径，如果源文件是一个目录，那么该路径也必须是个目录</span>
      </p>
    </td>
  </tr>
  
  <tr>
    <td width="160">
      <p>
        <span style="font-size: 13px;">directory_mode</span>
      </p>
    </td>
    
    <td width="537">
      <p>
        <span style="font-size: 13px;">递归设定目录的权限，默认为系统默认权限</span>
      </p>
    </td>
  </tr>
  
  <tr>
    <td width="160">
      <p>
        <span style="font-size: 13px;">forces</span>
      </p>
    </td>
    
    <td width="537">
      <p>
        <span style="font-size: 13px;">如果目标主机包含该文件，但内容不同，如果设置为yes,则强制覆盖。</span>
      </p>
      
      <p>
        <span style="font-size: 13px;">如果为no,则只有当目标主机的目标位置不存在该文件时，才复制。默认为yes。<strong>别名：</strong><strong>thirsty</strong></span>
      </p>
    </td>
  </tr>
  
  <tr>
    <td width="160">
      <p>
        <span style="font-size: 13px;">others</span>
      </p>
    </td>
    
    <td width="537">
      <p>
        <span style="font-size: 13px;">所有的file模块里的选项都可以在这里使用</span>
      </p>
    </td>
  </tr>
  
  <tr>
    <td width="160">
      <p>
        <span style="font-size: 13px;">src</span>
      </p>
    </td>
    
    <td width="537">
      <p>
        <span style="font-size: 13px;">被复制到远程主机的本地文件，可以是绝对路径，也可以是相对路径。如果路径是一个目录，它将递归复制。在这种情况下，如果路径使用"/"来结尾，则只复制目录里的内容，如果没有使用"/"来结尾，则包含目录在内的整个内容全部复制，类似于rsync。</span>
      </p>
    </td>
  </tr>
  
  <tr>
    <td valign="top" width="160">
      <p>
        <span style="font-size: 13px;">mode</span>
      </p>
    </td>
    
    <td valign="top" width="537">
      <p>
        <span style="font-size: 13px;">定义文件或目录的权限；注意：是4位</span>
      </p>
    </td>
  </tr>
  
  <tr>
    <td valign="top" width="160">
      <p>
        <span style="font-size: 13px;">owner</span>
      </p>
    </td>
    
    <td valign="top" width="537">
      <p>
        <span style="font-size: 13px;">修改属主</span>
      </p>
    </td>
  </tr>
  
  <tr>
    <td valign="top" width="160">
      <p>
        <span style="font-size: 13px;">group</span>
      </p>
    </td>
    
    <td valign="top" width="537">
      <p>
        <span style="font-size: 13px;">修改属组</span>
      </p>
    </td>
  </tr>
</table>

说明： src和content不能同时使用

### <span id="352_copy">3.5.2 copy常用命令参数测试</span>

使用copy 模块，将/etc/hosts 文件 传输到各个服务器送，权限修改为0600 属主属组为clsn

<div>
  <div class="cnblogs_code">
    <pre>[root@m01 ~]# ansible clsn -m copy -a <span style="color: #800000;">"</span><span style="color: #800000;">src=/etc/hosts dest=/tmp/ mode=0600 owner=clsn group=clsn </span><span style="color: #800000;">"</span>
<span style="color: #800080;">172.16</span>.<span style="color: #800080;">1.8</span> | SUCCESS =><span style="color: #000000;"> {
    </span><span style="color: #800000;">"</span><span style="color: #800000;">changed</span><span style="color: #800000;">"</span>: <span style="color: #0000ff;">true</span><span style="color: #000000;">,
    </span><span style="color: #800000;">"</span><span style="color: #800000;">checksum</span><span style="color: #800000;">"</span>: <span style="color: #800000;">"</span><span style="color: #800000;">b3c1ab140a1265cd7f6de9175a962988d93c629b</span><span style="color: #800000;">"</span><span style="color: #000000;">,
    </span><span style="color: #800000;">"</span><span style="color: #800000;">dest</span><span style="color: #800000;">"</span>: <span style="color: #800000;">"</span><span style="color: #800000;">/tmp/hosts</span><span style="color: #800000;">"</span><span style="color: #000000;">,
    </span><span style="color: #800000;">"</span><span style="color: #800000;">gid</span><span style="color: #800000;">"</span>: <span style="color: #800080;">500</span><span style="color: #000000;">,
    </span><span style="color: #800000;">"</span><span style="color: #800000;">group</span><span style="color: #800000;">"</span>: <span style="color: #800000;">"</span><span style="color: #800000;">clsn</span><span style="color: #800000;">"</span><span style="color: #000000;">,
    </span><span style="color: #800000;">"</span><span style="color: #800000;">md5sum</span><span style="color: #800000;">"</span>: <span style="color: #800000;">"</span><span style="color: #800000;">8c2b120b4742a806dcfdc8cfff6b6308</span><span style="color: #800000;">"</span><span style="color: #000000;">,
    </span><span style="color: #800000;">"</span><span style="color: #800000;">mode</span><span style="color: #800000;">"</span>: <span style="color: #800000;">"</span><span style="color: #800000;">0600</span><span style="color: #800000;">"</span><span style="color: #000000;">,
    </span><span style="color: #800000;">"</span><span style="color: #800000;">owner</span><span style="color: #800000;">"</span>: <span style="color: #800000;">"</span><span style="color: #800000;">clsn</span><span style="color: #800000;">"</span><span style="color: #000000;">,
    </span><span style="color: #800000;">"</span><span style="color: #800000;">size</span><span style="color: #800000;">"</span>: <span style="color: #800080;">357</span><span style="color: #000000;">,
    </span><span style="color: #800000;">"</span><span style="color: #800000;">src</span><span style="color: #800000;">"</span>: <span style="color: #800000;">"</span><span style="color: #800000;">/root/.ansible/tmp/ansible-tmp-1508410846.63-224022812989166/source</span><span style="color: #800000;">"</span><span style="color: #000000;">,
    </span><span style="color: #800000;">"</span><span style="color: #800000;">state</span><span style="color: #800000;">"</span>: <span style="color: #800000;">"</span><span style="color: #800000;">file</span><span style="color: #800000;">"</span><span style="color: #000000;">,
    </span><span style="color: #800000;">"</span><span style="color: #800000;">uid</span><span style="color: #800000;">"</span>: <span style="color: #800080;">500</span><span style="color: #000000;">
}<br />&hellip;&hellip;</span></pre>
  </div>
</div>

检查结果

<div>
  <div class="cnblogs_code">
    <pre>[root@m01 ~]# ansible all -m shell -a <span style="color: #800000;">"</span><span style="color: #800000;">ls -l /tmp/hosts</span><span style="color: #800000;">"</span>
<span style="color: #800080;">172.16</span>.<span style="color: #800080;">1.31</span> | SUCCESS | rc=<span style="color: #800080;"></span> >>
-rw------- <span style="color: #800080;">1</span> clsn clsn <span style="color: #800080;">357</span> Oct <span style="color: #800080;">19</span> <span style="color: #800080;">19</span>:<span style="color: #800080;">00</span> /tmp/<span style="color: #000000;">hosts

</span><span style="color: #800080;">172.16</span>.<span style="color: #800080;">1.41</span> | SUCCESS | rc=<span style="color: #800080;"></span> >>
-rw------- <span style="color: #800080;">1</span> clsn clsn <span style="color: #800080;">357</span> Oct <span style="color: #800080;">11</span> <span style="color: #800080;">15</span>:<span style="color: #800080;">12</span> /tmp/<span style="color: #000000;">hosts

</span><span style="color: #800080;">172.16</span>.<span style="color: #800080;">1.8</span> | SUCCESS | rc=<span style="color: #800080;"></span> >>
-rw------- <span style="color: #800080;">1</span> clsn clsn <span style="color: #800080;">357</span> Oct <span style="color: #800080;">19</span> <span style="color: #800080;">19</span>:<span style="color: #800080;">00</span> /tmp/hosts</pre>
  </div>
</div>

移动远程主机上的文件 remote_src=true 参数

<div>
  <div class="cnblogs_code">
    <pre>[root@m01 ~]# ansible clsn -m copy -a <span style="color: #800000;">"</span><span style="color: #800000;"> src=/server/scripts/ssh-key.sh  dest=/tmp/ remote_src=true</span><span style="color: #800000;">"</span>
<span style="color: #800080;">172.16</span>.<span style="color: #800080;">1.41</span> | SUCCESS =><span style="color: #000000;"> {
    </span><span style="color: #800000;">"</span><span style="color: #800000;">changed</span><span style="color: #800000;">"</span>: <span style="color: #0000ff;">true</span><span style="color: #000000;">,
    </span><span style="color: #800000;">"</span><span style="color: #800000;">checksum</span><span style="color: #800000;">"</span>: <span style="color: #800000;">"</span><span style="color: #800000;">d27bd683bd37e15992d2493b50c9410e0f667c9c</span><span style="color: #800000;">"</span><span style="color: #000000;">,
    </span><span style="color: #800000;">"</span><span style="color: #800000;">dest</span><span style="color: #800000;">"</span>: <span style="color: #800000;">"</span><span style="color: #800000;">/tmp/ssh-key.sh</span><span style="color: #800000;">"</span><span style="color: #000000;">,
    </span><span style="color: #800000;">"</span><span style="color: #800000;">gid</span><span style="color: #800000;">"</span>: <span style="color: #800080;"></span><span style="color: #000000;">,
    </span><span style="color: #800000;">"</span><span style="color: #800000;">group</span><span style="color: #800000;">"</span>: <span style="color: #800000;">"</span><span style="color: #800000;">root</span><span style="color: #800000;">"</span><span style="color: #000000;">,
    </span><span style="color: #800000;">"</span><span style="color: #800000;">md5sum</span><span style="color: #800000;">"</span>: <span style="color: #800000;">"</span><span style="color: #800000;">dc88a3a419e3657bae7d3ef31925cbde</span><span style="color: #800000;">"</span><span style="color: #000000;">,
    </span><span style="color: #800000;">"</span><span style="color: #800000;">mode</span><span style="color: #800000;">"</span>: <span style="color: #800000;">"</span><span style="color: #800000;">0644</span><span style="color: #800000;">"</span><span style="color: #000000;">,
    </span><span style="color: #800000;">"</span><span style="color: #800000;">owner</span><span style="color: #800000;">"</span>: <span style="color: #800000;">"</span><span style="color: #800000;">root</span><span style="color: #800000;">"</span><span style="color: #000000;">,
    </span><span style="color: #800000;">"</span><span style="color: #800000;">size</span><span style="color: #800000;">"</span>: <span style="color: #800080;">397</span><span style="color: #000000;">,
    </span><span style="color: #800000;">"</span><span style="color: #800000;">src</span><span style="color: #800000;">"</span>: <span style="color: #800000;">"</span><span style="color: #800000;">/server/scripts/ssh-key.sh</span><span style="color: #800000;">"</span><span style="color: #000000;">,
    </span><span style="color: #800000;">"</span><span style="color: #800000;">state</span><span style="color: #800000;">"</span>: <span style="color: #800000;">"</span><span style="color: #800000;">file</span><span style="color: #800000;">"</span><span style="color: #000000;">,
    </span><span style="color: #800000;">"</span><span style="color: #800000;">uid</span><span style="color: #800000;">"</span>: <span style="color: #800080;"></span><span style="color: #000000;">
}</span></pre>
  </div>
</div>

定义文件中的内容 **content=clsnedu.com** 默认没有换行

<div>
  <div class="cnblogs_code">
    <pre>[root@m01 ~]# ansible clsn -m copy -a <span style="color: #800000;">"</span><span style="color: #800000;">content=clsnedu.com dest=/tmp/clsn666.txt</span><span style="color: #800000;">"</span>
<span style="color: #800080;">172.16</span>.<span style="color: #800080;">1.8</span> | SUCCESS =><span style="color: #000000;"> {
    </span><span style="color: #800000;">"</span><span style="color: #800000;">changed</span><span style="color: #800000;">"</span>: <span style="color: #0000ff;">true</span><span style="color: #000000;">,
    </span><span style="color: #800000;">"</span><span style="color: #800000;">checksum</span><span style="color: #800000;">"</span>: <span style="color: #800000;">"</span><span style="color: #800000;">291694840cd9f9c464263ea9b13421d8e74b7d00</span><span style="color: #800000;">"</span><span style="color: #000000;">,
    </span><span style="color: #800000;">"</span><span style="color: #800000;">dest</span><span style="color: #800000;">"</span>: <span style="color: #800000;">"</span><span style="color: #800000;">/tmp/clsn666.txt</span><span style="color: #800000;">"</span><span style="color: #000000;">,
    </span><span style="color: #800000;">"</span><span style="color: #800000;">gid</span><span style="color: #800000;">"</span>: <span style="color: #800080;"></span><span style="color: #000000;">,
    </span><span style="color: #800000;">"</span><span style="color: #800000;">group</span><span style="color: #800000;">"</span>: <span style="color: #800000;">"</span><span style="color: #800000;">root</span><span style="color: #800000;">"</span><span style="color: #000000;">,
    </span><span style="color: #800000;">"</span><span style="color: #800000;">md5sum</span><span style="color: #800000;">"</span>: <span style="color: #800000;">"</span><span style="color: #800000;">0a6bb40847793839366d0ac014616d69</span><span style="color: #800000;">"</span><span style="color: #000000;">,
    </span><span style="color: #800000;">"</span><span style="color: #800000;">mode</span><span style="color: #800000;">"</span>: <span style="color: #800000;">"</span><span style="color: #800000;">0644</span><span style="color: #800000;">"</span><span style="color: #000000;">,
    </span><span style="color: #800000;">"</span><span style="color: #800000;">owner</span><span style="color: #800000;">"</span>: <span style="color: #800000;">"</span><span style="color: #800000;">root</span><span style="color: #800000;">"</span><span style="color: #000000;">,
    </span><span style="color: #800000;">"</span><span style="color: #800000;">size</span><span style="color: #800000;">"</span>: <span style="color: #800080;">13</span><span style="color: #000000;">,
    </span><span style="color: #800000;">"</span><span style="color: #800000;">src</span><span style="color: #800000;">"</span>: <span style="color: #800000;">"</span><span style="color: #800000;">/root/.ansible/tmp/ansible-tmp-1508466752.1-24733562369639/source</span><span style="color: #800000;">"</span><span style="color: #000000;">,
    </span><span style="color: #800000;">"</span><span style="color: #800000;">state</span><span style="color: #800000;">"</span>: <span style="color: #800000;">"</span><span style="color: #800000;">file</span><span style="color: #800000;">"</span><span style="color: #000000;">,
    </span><span style="color: #800000;">"</span><span style="color: #800000;">uid</span><span style="color: #800000;">"</span>: <span style="color: #800080;"></span><span style="color: #000000;">
}</span></pre>
  </div>
</div>

## <span id="36_file">3.6 file模块 设置文件属性</span>

### <span id="361_file">3.6.1 file模块常用参数</span>

<table border="1" cellspacing="0" cellpadding="0">
  <tr>
    <td width="170">
      <p align="center">
        <span style="font-size: 15px;"><strong>参数</strong></span>
      </p>
    </td>
    
    <td colspan="2" width="527">
      <p align="center">
        <span style="font-size: 15px;"><strong>参数说明</strong></span>
      </p>
    </td>
  </tr>
  
  <tr>
    <td width="170">
      <p>
        <span style="font-size: 13px;">owner</span>
      </p>
    </td>
    
    <td colspan="2" width="527">
      <p>
        <span style="font-size: 13px;">设置复制传输后的数据属主信息</span>
      </p>
    </td>
  </tr>
  
  <tr>
    <td width="170">
      <p>
        <span style="font-size: 13px;">group</span>
      </p>
    </td>
    
    <td colspan="2" width="527">
      <p>
        <span style="font-size: 13px;">设置复制传输后的数据属组信息</span>
      </p>
    </td>
  </tr>
  
  <tr>
    <td width="170">
      <p>
        <span style="font-size: 13px;">mode </span>
      </p>
    </td>
    
    <td colspan="2" width="527">
      <p>
        <span style="font-size: 13px;">设置文件数据权限信息</span>
      </p>
    </td>
  </tr>
  
  <tr>
    <td width="170">
      <p>
        <span style="font-size: 13px;">dest </span>
      </p>
    </td>
    
    <td colspan="2" width="527">
      <p>
        <span style="font-size: 13px;">要创建的文件或目录命令，以及路径信息</span>
      </p>
    </td>
  </tr>
  
  <tr>
    <td width="170">
      <p>
        <span style="font-size: 13px;">src</span>
      </p>
    </td>
    
    <td colspan="2" width="527">
      <p>
        <span style="font-size: 13px;">指定要创建软链接的文件信息</span>
      </p>
    </td>
  </tr>
  
  <tr>
    <td rowspan="7" width="170">
      <p>
        <span style="font-size: 13px;">state </span>
      </p>
    </td>
    
    <td colspan="2" width="527">
      <p>
        <span style="font-size: 13px;"><strong>state</strong><strong>参数信息</strong></span>
      </p>
    </td>
  </tr>
  
  <tr>
    <td width="161">
      <p>
        <span style="font-size: 13px;">directory</span>
      </p>
    </td>
    
    <td width="367">
      <p>
        <span style="font-size: 13px;">创建目录</span>
      </p>
    </td>
  </tr>
  
  <tr>
    <td width="161">
      <p>
        <span style="font-size: 13px;">file</span>
      </p>
    </td>
    
    <td width="367">
      <p>
        <span style="font-size: 13px;">创建文件</span>
      </p>
    </td>
  </tr>
  
  <tr>
    <td width="161">
      <p>
        <span style="font-size: 13px;">link</span>
      </p>
    </td>
    
    <td width="367">
      <p>
        <span style="font-size: 13px;">创建软链接</span>
      </p>
    </td>
  </tr>
  
  <tr>
    <td width="161">
      <p>
        <span style="font-size: 13px;">hard</span>
      </p>
    </td>
    
    <td width="367">
      <p>
        <span style="font-size: 13px;">创建出硬链接</span>
      </p>
    </td>
  </tr>
  
  <tr>
    <td width="161">
      <p>
        <span style="font-size: 13px;">absent</span>
      </p>
    </td>
    
    <td width="367">
      <p>
        <span style="font-size: 13px;">目录将被递归删除以及文件，而链接将被取消链接</span>
      </p>
    </td>
  </tr>
  
  <tr>
    <td width="161">
      <p>
        <span style="font-size: 13px;">touch</span>
      </p>
    </td>
    
    <td width="367">
      <p>
        <span style="font-size: 13px;">创建文件；如果路径不存在将创建一个空文件</span>
      </p>
    </td>
  </tr>
</table>

**注意：重命名和创建多级目录不能同时实现**

### <span id="362">3.6.2 常用参数测试</span>

创建目录

<div>
  <div class="cnblogs_code">
    <pre>[root@m01 ~]# ansible clsn -m <span style="color: #0000ff;">file</span> -a <span style="color: #800000;">"</span><span style="color: #800000;">dest=/tmp/clsn_dir state=directory</span><span style="color: #800000;">"</span>
<span style="color: #800080;">172.16</span>.<span style="color: #800080;">1.41</span> | SUCCESS =><span style="color: #000000;"> {
    </span><span style="color: #800000;">"</span><span style="color: #800000;">changed</span><span style="color: #800000;">"</span>: <span style="color: #0000ff;">true</span><span style="color: #000000;">,
    </span><span style="color: #800000;">"</span><span style="color: #800000;">gid</span><span style="color: #800000;">"</span>: <span style="color: #800080;"></span><span style="color: #000000;">,
    </span><span style="color: #800000;">"</span><span style="color: #800000;">group</span><span style="color: #800000;">"</span>: <span style="color: #800000;">"</span><span style="color: #800000;">root</span><span style="color: #800000;">"</span><span style="color: #000000;">,
    </span><span style="color: #800000;">"</span><span style="color: #800000;">mode</span><span style="color: #800000;">"</span>: <span style="color: #800000;">"</span><span style="color: #800000;">0755</span><span style="color: #800000;">"</span><span style="color: #000000;">,
    </span><span style="color: #800000;">"</span><span style="color: #800000;">owner</span><span style="color: #800000;">"</span>: <span style="color: #800000;">"</span><span style="color: #800000;">root</span><span style="color: #800000;">"</span><span style="color: #000000;">,
    </span><span style="color: #800000;">"</span><span style="color: #800000;">path</span><span style="color: #800000;">"</span>: <span style="color: #800000;">"</span><span style="color: #800000;">/tmp/clsn_dir</span><span style="color: #800000;">"</span><span style="color: #000000;">,
    </span><span style="color: #800000;">"</span><span style="color: #800000;">size</span><span style="color: #800000;">"</span>: <span style="color: #800080;">4096</span><span style="color: #000000;">,
    </span><span style="color: #800000;">"</span><span style="color: #800000;">state</span><span style="color: #800000;">"</span>: <span style="color: #800000;">"</span><span style="color: #800000;">directory</span><span style="color: #800000;">"</span><span style="color: #000000;">,
    </span><span style="color: #800000;">"</span><span style="color: #800000;">uid</span><span style="color: #800000;">"</span>: <span style="color: #800080;"></span><span style="color: #000000;">
}</span></pre>
  </div>
</div>

创建文件

<div>
  <div class="cnblogs_code">
    <pre>[root@m01 ~]# ansible clsn -m <span style="color: #0000ff;">file</span> -a <span style="color: #800000;">"</span><span style="color: #800000;">dest=/tmp/clsn_file state=touch</span><span style="color: #800000;">"</span>
<span style="color: #800080;">172.16</span>.<span style="color: #800080;">1.8</span> | SUCCESS =><span style="color: #000000;"> {
    </span><span style="color: #800000;">"</span><span style="color: #800000;">changed</span><span style="color: #800000;">"</span>: <span style="color: #0000ff;">true</span><span style="color: #000000;">,
    </span><span style="color: #800000;">"</span><span style="color: #800000;">dest</span><span style="color: #800000;">"</span>: <span style="color: #800000;">"</span><span style="color: #800000;">/tmp/clsn_file</span><span style="color: #800000;">"</span><span style="color: #000000;">,
    </span><span style="color: #800000;">"</span><span style="color: #800000;">gid</span><span style="color: #800000;">"</span>: <span style="color: #800080;"></span><span style="color: #000000;">,
    </span><span style="color: #800000;">"</span><span style="color: #800000;">group</span><span style="color: #800000;">"</span>: <span style="color: #800000;">"</span><span style="color: #800000;">root</span><span style="color: #800000;">"</span><span style="color: #000000;">,
    </span><span style="color: #800000;">"</span><span style="color: #800000;">mode</span><span style="color: #800000;">"</span>: <span style="color: #800000;">"</span><span style="color: #800000;">0644</span><span style="color: #800000;">"</span><span style="color: #000000;">,
    </span><span style="color: #800000;">"</span><span style="color: #800000;">owner</span><span style="color: #800000;">"</span>: <span style="color: #800000;">"</span><span style="color: #800000;">root</span><span style="color: #800000;">"</span><span style="color: #000000;">,
    </span><span style="color: #800000;">"</span><span style="color: #800000;">size</span><span style="color: #800000;">"</span>: <span style="color: #800080;"></span><span style="color: #000000;">,
    </span><span style="color: #800000;">"</span><span style="color: #800000;">state</span><span style="color: #800000;">"</span>: <span style="color: #800000;">"</span><span style="color: #800000;">file</span><span style="color: #800000;">"</span><span style="color: #000000;">,
    </span><span style="color: #800000;">"</span><span style="color: #800000;">uid</span><span style="color: #800000;">"</span>: <span style="color: #800080;"></span><span style="color: #000000;">
} </span></pre>
  </div>
</div>

创建软连接

<div>
  <div class="cnblogs_code">
    <pre>[root@m01 ~]# ansible clsn -m <span style="color: #0000ff;">file</span> -a <span style="color: #800000;">"</span><span style="color: #800000;">src=/tmp/clsn_file dest=/tmp/clsn_file_link state=link</span><span style="color: #800000;">"</span>
<span style="color: #800080;">172.16</span>.<span style="color: #800080;">1.41</span> | SUCCESS =><span style="color: #000000;"> {
    </span><span style="color: #800000;">"</span><span style="color: #800000;">changed</span><span style="color: #800000;">"</span>: <span style="color: #0000ff;">true</span><span style="color: #000000;">,
    </span><span style="color: #800000;">"</span><span style="color: #800000;">dest</span><span style="color: #800000;">"</span>: <span style="color: #800000;">"</span><span style="color: #800000;">/tmp/clsn_file_link</span><span style="color: #800000;">"</span><span style="color: #000000;">,
    </span><span style="color: #800000;">"</span><span style="color: #800000;">gid</span><span style="color: #800000;">"</span>: <span style="color: #800080;"></span><span style="color: #000000;">,
    </span><span style="color: #800000;">"</span><span style="color: #800000;">group</span><span style="color: #800000;">"</span>: <span style="color: #800000;">"</span><span style="color: #800000;">root</span><span style="color: #800000;">"</span><span style="color: #000000;">,
    </span><span style="color: #800000;">"</span><span style="color: #800000;">mode</span><span style="color: #800000;">"</span>: <span style="color: #800000;">"</span><span style="color: #800000;">0777</span><span style="color: #800000;">"</span><span style="color: #000000;">,
    </span><span style="color: #800000;">"</span><span style="color: #800000;">owner</span><span style="color: #800000;">"</span>: <span style="color: #800000;">"</span><span style="color: #800000;">root</span><span style="color: #800000;">"</span><span style="color: #000000;">,
    </span><span style="color: #800000;">"</span><span style="color: #800000;">size</span><span style="color: #800000;">"</span>: <span style="color: #800080;">16</span><span style="color: #000000;">,
    </span><span style="color: #800000;">"</span><span style="color: #800000;">src</span><span style="color: #800000;">"</span>: <span style="color: #800000;">"</span><span style="color: #800000;">/tmp/clsn_file</span><span style="color: #800000;">"</span><span style="color: #000000;">,
    </span><span style="color: #800000;">"</span><span style="color: #800000;">state</span><span style="color: #800000;">"</span>: <span style="color: #800000;">"</span><span style="color: #800000;">link</span><span style="color: #800000;">"</span><span style="color: #000000;">,
    </span><span style="color: #800000;">"</span><span style="color: #800000;">uid</span><span style="color: #800000;">"</span>: <span style="color: #800080;"></span><span style="color: #000000;">
}</span></pre>
  </div>
</div>

删除目录文件信息

<div>
  <div class="cnblogs_code">
    <pre>[root@m01 ~]# ansible clsn -m <span style="color: #0000ff;">file</span> -a <span style="color: #800000;">"</span><span style="color: #800000;">dest=/tmp/clsn_dir state=absent</span><span style="color: #800000;">"</span>
<span style="color: #800080;">172.16</span>.<span style="color: #800080;">1.41</span> | SUCCESS =><span style="color: #000000;"> {
    </span><span style="color: #800000;">"</span><span style="color: #800000;">changed</span><span style="color: #800000;">"</span>: <span style="color: #0000ff;">true</span><span style="color: #000000;">,
    </span><span style="color: #800000;">"</span><span style="color: #800000;">path</span><span style="color: #800000;">"</span>: <span style="color: #800000;">"</span><span style="color: #800000;">/tmp/clsn_dir</span><span style="color: #800000;">"</span><span style="color: #000000;">,
    </span><span style="color: #800000;">"</span><span style="color: #800000;">state</span><span style="color: #800000;">"</span>: <span style="color: #800000;">"</span><span style="color: #800000;">absent</span><span style="color: #800000;">"</span><span style="color: #000000;">

[root@m01 </span>~]# ansible clsn -m <span style="color: #0000ff;">file</span> -a <span style="color: #800000;">"</span><span style="color: #800000;">dest=/tmp/clsn_file state=absent</span><span style="color: #800000;">"</span>
<span style="color: #800080;">172.16</span>.<span style="color: #800080;">1.31</span> | SUCCESS =><span style="color: #000000;"> {
    </span><span style="color: #800000;">"</span><span style="color: #800000;">changed</span><span style="color: #800000;">"</span>: <span style="color: #0000ff;">true</span><span style="color: #000000;">,
    </span><span style="color: #800000;">"</span><span style="color: #800000;">path</span><span style="color: #800000;">"</span>: <span style="color: #800000;">"</span><span style="color: #800000;">/tmp/clsn_file</span><span style="color: #800000;">"</span><span style="color: #000000;">,
    </span><span style="color: #800000;">"</span><span style="color: #800000;">state</span><span style="color: #800000;">"</span>: <span style="color: #800000;">"</span><span style="color: #800000;">absent</span><span style="color: #800000;">"</span></pre>
  </div>
</div>

创建多级目录

<div>
  <div class="cnblogs_code">
    <pre>[root@m01 ~]# ansible clsn -m copy -a <span style="color: #800000;">"</span><span style="color: #800000;">src=/etc/hosts dest=/tmp/01/0/0/0/0/0/0/0/</span><span style="color: #800000;">"</span>
<span style="color: #800080;">172.16</span>.<span style="color: #800080;">1.31</span> | SUCCESS =><span style="color: #000000;"> {
    </span><span style="color: #800000;">"</span><span style="color: #800000;">changed</span><span style="color: #800000;">"</span>: <span style="color: #0000ff;">true</span><span style="color: #000000;">,
    </span><span style="color: #800000;">"</span><span style="color: #800000;">checksum</span><span style="color: #800000;">"</span>: <span style="color: #800000;">"</span><span style="color: #800000;">b3c1ab140a1265cd7f6de9175a962988d93c629b</span><span style="color: #800000;">"</span><span style="color: #000000;">,
    </span><span style="color: #800000;">"</span><span style="color: #800000;">dest</span><span style="color: #800000;">"</span>: <span style="color: #800000;">"</span><span style="color: #800000;">/tmp/01/0/0/0/0/0/0/0/hosts</span><span style="color: #800000;">"</span><span style="color: #000000;">,
    </span><span style="color: #800000;">"</span><span style="color: #800000;">gid</span><span style="color: #800000;">"</span>: <span style="color: #800080;"></span><span style="color: #000000;">,
    </span><span style="color: #800000;">"</span><span style="color: #800000;">group</span><span style="color: #800000;">"</span>: <span style="color: #800000;">"</span><span style="color: #800000;">root</span><span style="color: #800000;">"</span><span style="color: #000000;">,
    </span><span style="color: #800000;">"</span><span style="color: #800000;">md5sum</span><span style="color: #800000;">"</span>: <span style="color: #800000;">"</span><span style="color: #800000;">8c2b120b4742a806dcfdc8cfff6b6308</span><span style="color: #800000;">"</span><span style="color: #000000;">,
    </span><span style="color: #800000;">"</span><span style="color: #800000;">mode</span><span style="color: #800000;">"</span>: <span style="color: #800000;">"</span><span style="color: #800000;">0644</span><span style="color: #800000;">"</span><span style="color: #000000;">,
    </span><span style="color: #800000;">"</span><span style="color: #800000;">owner</span><span style="color: #800000;">"</span>: <span style="color: #800000;">"</span><span style="color: #800000;">root</span><span style="color: #800000;">"</span><span style="color: #000000;">,
    </span><span style="color: #800000;">"</span><span style="color: #800000;">size</span><span style="color: #800000;">"</span>: <span style="color: #800080;">357</span><span style="color: #000000;">,
    </span><span style="color: #800000;">"</span><span style="color: #800000;">src</span><span style="color: #800000;">"</span>: <span style="color: #800000;">"</span><span style="color: #800000;">/root/.ansible/tmp/ansible-tmp-1508466973.39-99676412390473/source</span><span style="color: #800000;">"</span><span style="color: #000000;">,
    </span><span style="color: #800000;">"</span><span style="color: #800000;">state</span><span style="color: #800000;">"</span>: <span style="color: #800000;">"</span><span style="color: #800000;">file</span><span style="color: #800000;">"</span><span style="color: #000000;">,
    </span><span style="color: #800000;">"</span><span style="color: #800000;">uid</span><span style="color: #800000;">"</span>: <span style="color: #800080;"></span><span style="color: #000000;">
}</span></pre>
  </div>
</div>

**注意：重命名和创建多级目录不能同时实现**

## <span id="37_fetch_nbsp">3.7 fetch 模块&nbsp; 拉取文件</span>

### <span id="371_fetch">3.7.1 fetch常用参数说明</span>

<table border="1" cellspacing="0" cellpadding="0">
  <tr>
    <td width="160">
      <p align="center">
        <span style="font-size: 15px;"><strong>参数</strong></span>
      </p>
    </td>
    
    <td width="537">
      <p align="center">
        <span style="font-size: 15px;"><strong>参数说明</strong></span>
      </p>
    </td>
  </tr>
  
  <tr>
    <td width="160">
      <p>
        <span style="font-size: 13px;">dest</span>
      </p>
    </td>
    
    <td width="537">
      <p>
        <span style="font-size: 13px;">将远程主机拉取过来的文件保存在本地的路径信息</span>
      </p>
    </td>
  </tr>
  
  <tr>
    <td width="160">
      <p>
        <span style="font-size: 13px;">src </span>
      </p>
    </td>
    
    <td width="537">
      <p>
        <span style="font-size: 13px;">指定从远程主机要拉取的文件信息，只能拉取文件</span>
      </p>
    </td>
  </tr>
  
  <tr>
    <td width="160">
      <p>
        <span style="font-size: 13px;">flat</span>
      </p>
    </td>
    
    <td width="537">
      <p>
        <span style="font-size: 13px;">默认设置为no，如果设置为yes，将不显示172.16.1.8/etc/信息</span>
      </p>
    </td>
  </tr>
</table>

### <span id="372">3.7.2 常用参数实例</span>

从远程拉取出来文件

<div>
  <div class="cnblogs_code">
    <pre>[root@m01 <span style="color: #0000ff;">cp</span>]# ansible clsn -m fetch -a <span style="color: #800000;">"</span><span style="color: #800000;">dest=/tmp/backup src=/etc/hosts</span><span style="color: #800000;">"</span>
<span style="color: #800080;">172.16</span>.<span style="color: #800080;">1.8</span> | SUCCESS =><span style="color: #000000;"> {
    </span><span style="color: #800000;">"</span><span style="color: #800000;">changed</span><span style="color: #800000;">"</span>: <span style="color: #0000ff;">true</span><span style="color: #000000;">,
    </span><span style="color: #800000;">"</span><span style="color: #800000;">checksum</span><span style="color: #800000;">"</span>: <span style="color: #800000;">"</span><span style="color: #800000;">b3c1ab140a1265cd7f6de9175a962988d93c629b</span><span style="color: #800000;">"</span><span style="color: #000000;">,
    </span><span style="color: #800000;">"</span><span style="color: #800000;">dest</span><span style="color: #800000;">"</span>: <span style="color: #800000;">"</span><span style="color: #800000;">/tmp/backup/172.16.1.8/etc/hosts</span><span style="color: #800000;">"</span><span style="color: #000000;">,
    </span><span style="color: #800000;">"</span><span style="color: #800000;">md5sum</span><span style="color: #800000;">"</span>: <span style="color: #800000;">"</span><span style="color: #800000;">8c2b120b4742a806dcfdc8cfff6b6308</span><span style="color: #800000;">"</span><span style="color: #000000;">,
    </span><span style="color: #800000;">"</span><span style="color: #800000;">remote_checksum</span><span style="color: #800000;">"</span>: <span style="color: #800000;">"</span><span style="color: #800000;">b3c1ab140a1265cd7f6de9175a962988d93c629b</span><span style="color: #800000;">"</span><span style="color: #000000;">,
    </span><span style="color: #800000;">"</span><span style="color: #800000;">remote_md5sum</span><span style="color: #800000;">"</span>: <span style="color: #0000ff;">null</span><span style="color: #000000;">
}

[root@m01 </span><span style="color: #0000ff;">cp</span>]# tree /tmp/backup/
/tmp/backup/<span style="color: #000000;">
├── </span><span style="color: #800080;">172.16</span>.<span style="color: #800080;">1.31</span><span style="color: #000000;">
│   └── etc
│       └── hosts
├── </span><span style="color: #800080;">172.16</span>.<span style="color: #800080;">1.41</span><span style="color: #000000;">
│   └── etc
│       └── hosts
└── </span><span style="color: #800080;">172.16</span>.<span style="color: #800080;">1.8</span><span style="color: #000000;">
    └── etc
        └── hosts</span></pre>
  </div>
</div>

&nbsp;&nbsp; flat 参数，拉去的时候不创建目录**（同名文件会覆盖）**

<div>
  <div class="cnblogs_code">
    <pre>[root@m01 tmp]# ansible clsn -m fetch -a <span style="color: #800000;">"</span><span style="color: #800000;">dest=/tmp/backup/ src=/etc/hosts flat=yes</span><span style="color: #800000;">"</span>
<span style="color: #800080;">172.16</span>.<span style="color: #800080;">1.8</span> | SUCCESS =><span style="color: #000000;"> {
    </span><span style="color: #800000;">"</span><span style="color: #800000;">changed</span><span style="color: #800000;">"</span>: <span style="color: #0000ff;">false</span><span style="color: #000000;">,
    </span><span style="color: #800000;">"</span><span style="color: #800000;">checksum</span><span style="color: #800000;">"</span>: <span style="color: #800000;">"</span><span style="color: #800000;">b3c1ab140a1265cd7f6de9175a962988d93c629b</span><span style="color: #800000;">"</span><span style="color: #000000;">,
    </span><span style="color: #800000;">"</span><span style="color: #800000;">dest</span><span style="color: #800000;">"</span>: <span style="color: #800000;">"</span><span style="color: #800000;">/tmp/backup/hosts</span><span style="color: #800000;">"</span><span style="color: #000000;">,
    </span><span style="color: #800000;">"</span><span style="color: #800000;">file</span><span style="color: #800000;">"</span>: <span style="color: #800000;">"</span><span style="color: #800000;">/etc/hosts</span><span style="color: #800000;">"</span><span style="color: #000000;">,
    </span><span style="color: #800000;">"</span><span style="color: #800000;">md5sum</span><span style="color: #800000;">"</span>: <span style="color: #800000;">"</span><span style="color: #800000;">8c2b120b4742a806dcfdc8cfff6b6308</span><span style="color: #800000;">"</span></pre>
  </div>
</div>

## <span id="38_mount">3.8 mount模块 配置挂载点模块</span>

### <span id="381_mount">3.8.1 mount模块常用参数</span>

<table border="1" cellspacing="0" cellpadding="0">
  <tr>
    <td width="236">
      <p align="center">
        <span style="font-size: 15px;"><strong>参数</strong></span>
      </p>
    </td>
    
    <td colspan="2" width="461">
      <p align="center">
        <span style="font-size: 15px;"><strong>参数说明</strong></span>
      </p>
    </td>
  </tr>
  
  <tr>
    <td width="236">
      <p>
        <span style="font-size: 13px;">fstype</span>
      </p>
    </td>
    
    <td colspan="2" width="461">
      <p>
        <span style="font-size: 13px;">指定挂载文件类型 -t nfs == fstype=nfs</span>
      </p>
    </td>
  </tr>
  
  <tr>
    <td width="236">
      <p>
        <span style="font-size: 13px;">opts&nbsp; </span>
      </p>
    </td>
    
    <td colspan="2" width="461">
      <p>
        <span style="font-size: 13px;">设定挂载的参数选项信息 -o ro&nbsp; == opts=ro</span>
      </p>
    </td>
  </tr>
  
  <tr>
    <td width="236">
      <p>
        <span style="font-size: 13px;">path&nbsp; </span>
      </p>
    </td>
    
    <td colspan="2" width="461">
      <p>
        <span style="font-size: 13px;">挂载点路径&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; path=/mnt</span>
      </p>
    </td>
  </tr>
  
  <tr>
    <td width="236">
      <p>
        <span style="font-size: 13px;">src&nbsp;&nbsp; </span>
      </p>
    </td>
    
    <td colspan="2" width="461">
      <p>
        <span style="font-size: 13px;">要被挂载的目录信息&nbsp; src=172.16.1.31:/data</span>
      </p>
    </td>
  </tr>
  
  <tr>
    <td rowspan="5" width="236">
      <p>
        <span style="font-size: 13px;">state&nbsp; </span>
      </p>
    </td>
    
    <td colspan="2" width="461">
      <p align="center">
        <span style="font-size: 13px;"><strong>state</strong><strong>状态参数</strong></span>
      </p>
    </td>
  </tr>
  
  <tr>
    <td valign="top" width="142">
      <p>
        <span style="font-size: 13px;">unmounted</span>
      </p>
    </td>
    
    <td valign="top" width="319">
      <p>
        <span style="font-size: 13px;">加载/etc/fstab文件 实现卸载</span>
      </p>
    </td>
  </tr>
  
  <tr>
    <td valign="top" width="142">
      <p>
        <span style="font-size: 13px;">absent&nbsp;&nbsp; </span>
      </p>
    </td>
    
    <td valign="top" width="319">
      <p>
        <span style="font-size: 13px;">在fstab文件中删除挂载配置</span>
      </p>
    </td>
  </tr>
  
  <tr>
    <td valign="top" width="142">
      <p>
        <span style="font-size: 13px;">present&nbsp; </span>
      </p>
    </td>
    
    <td valign="top" width="319">
      <p>
        <span style="font-size: 13px;">在fstab文件中添加挂载配置</span>
      </p>
    </td>
  </tr>
  
  <tr>
    <td valign="top" width="142">
      <p>
        <span style="font-size: 13px;">mounted</span>
      </p>
    </td>
    
    <td valign="top" width="319">
      <p>
        <span style="font-size: 13px;">1.将挂载信息添加到/etc/fstab文件中</span>
      </p>
      
      <p>
        <span style="font-size: 13px;">2.加载配置文件挂载</span>
      </p>
    </td>
  </tr>
</table>

### <span id="382_mount">3.8.2 mount参数实例</span>

挂载

<div class="cnblogs_code">
  <pre>[root@m01 tmp]# ansible <span style="color: #800080;">172.16</span>.<span style="color: #800080;">1.8</span> -m <span style="color: #0000ff;">mount</span> -a <span style="color: #800000;">"</span><span style="color: #800000;">fstype=nfs opts=rw path=/mnt/  src=172.16.1.31:/data/ state=mounted</span><span style="color: #800000;">"</span>
<span style="color: #800080;">172.16</span>.<span style="color: #800080;">1.8</span> | SUCCESS =><span style="color: #000000;"> {
    </span><span style="color: #800000;">"</span><span style="color: #800000;">changed</span><span style="color: #800000;">"</span>: <span style="color: #0000ff;">true</span><span style="color: #000000;">,
    </span><span style="color: #800000;">"</span><span style="color: #800000;">dump</span><span style="color: #800000;">"</span>: <span style="color: #800000;">"</span><span style="color: #800000;"></span><span style="color: #800000;">"</span><span style="color: #000000;">,
    </span><span style="color: #800000;">"</span><span style="color: #800000;">fstab</span><span style="color: #800000;">"</span>: <span style="color: #800000;">"</span><span style="color: #800000;">/etc/fstab</span><span style="color: #800000;">"</span><span style="color: #000000;">,
    </span><span style="color: #800000;">"</span><span style="color: #800000;">fstype</span><span style="color: #800000;">"</span>: <span style="color: #800000;">"</span><span style="color: #800000;">nfs</span><span style="color: #800000;">"</span><span style="color: #000000;">,
    </span><span style="color: #800000;">"</span><span style="color: #800000;">name</span><span style="color: #800000;">"</span>: <span style="color: #800000;">"</span><span style="color: #800000;">/mnt/</span><span style="color: #800000;">"</span><span style="color: #000000;">,
    </span><span style="color: #800000;">"</span><span style="color: #800000;">opts</span><span style="color: #800000;">"</span>: <span style="color: #800000;">"</span><span style="color: #800000;">rw</span><span style="color: #800000;">"</span><span style="color: #000000;">,
 </span><span style="color: #800000;">"</span><span style="color: #800000;">passno</span><span style="color: #800000;">"</span>: <span style="color: #800000;">"</span><span style="color: #800000;"></span><span style="color: #800000;">"</span><span style="color: #000000;">,
  </span><span style="color: #800000;">"</span><span style="color: #800000;">src</span><span style="color: #800000;">"</span>: <span style="color: #800000;">"</span><span style="color: #800000;">172.16.1.31:/data/</span><span style="color: #800000;">"</span><span style="color: #000000;">
}</span></pre>
</div>

<div>
  &nbsp;
</div>

卸载

<div>
  <div class="cnblogs_code">
    <pre>[root@m01 tmp]# ansible <span style="color: #800080;">172.16</span>.<span style="color: #800080;">1.8</span> -m <span style="color: #0000ff;">mount</span> -a <span style="color: #800000;">"</span><span style="color: #800000;">fstype=nfs opts=rw path=/mnt/  src=172.16.1.31:/data/ state=unmounted</span><span style="color: #800000;">"</span>
<span style="color: #800080;">172.16</span>.<span style="color: #800080;">1.8</span> | SUCCESS =><span style="color: #000000;"> {
   </span><span style="color: #800000;">"</span><span style="color: #800000;">changed</span><span style="color: #800000;">"</span>: <span style="color: #0000ff;">true</span><span style="color: #000000;">,
    </span><span style="color: #800000;">"</span><span style="color: #800000;">dump</span><span style="color: #800000;">"</span>: <span style="color: #800000;">"</span><span style="color: #800000;"></span><span style="color: #800000;">"</span><span style="color: #000000;">,
    </span><span style="color: #800000;">"</span><span style="color: #800000;">fstab</span><span style="color: #800000;">"</span>: <span style="color: #800000;">"</span><span style="color: #800000;">/etc/fstab</span><span style="color: #800000;">"</span><span style="color: #000000;">,
    </span><span style="color: #800000;">"</span><span style="color: #800000;">fstype</span><span style="color: #800000;">"</span>: <span style="color: #800000;">"</span><span style="color: #800000;">nfs</span><span style="color: #800000;">"</span><span style="color: #000000;">,
    </span><span style="color: #800000;">"</span><span style="color: #800000;">name</span><span style="color: #800000;">"</span>: <span style="color: #800000;">"</span><span style="color: #800000;">/mnt/</span><span style="color: #800000;">"</span><span style="color: #000000;">,
    </span><span style="color: #800000;">"</span><span style="color: #800000;">opts</span><span style="color: #800000;">"</span>: <span style="color: #800000;">"</span><span style="color: #800000;">rw</span><span style="color: #800000;">"</span><span style="color: #000000;">,
    </span><span style="color: #800000;">"</span><span style="color: #800000;">passno</span><span style="color: #800000;">"</span>: <span style="color: #800000;">"</span><span style="color: #800000;"></span><span style="color: #800000;">"</span><span style="color: #000000;">,
    </span><span style="color: #800000;">"</span><span style="color: #800000;">src</span><span style="color: #800000;">"</span>: <span style="color: #800000;">"</span><span style="color: #800000;">172.16.1.31:/data/</span><span style="color: #800000;">"</span><span style="color: #000000;">
}</span></pre>
  </div>
</div>

## <span id="39_cron">3.9 cron模块 定时任务</span>

### <span id="391_cron">3.9.1 cron模块常用参数</span>

<table border="1" cellspacing="0" cellpadding="0">
  <tr>
    <td width="141">
      <p align="center">
        <span style="font-size: 15px;"><strong>参数</strong></span>
      </p>
    </td>
    
    <td colspan="2" width="556">
      <p align="center">
        <span style="font-size: 15px;"><strong>参数说明</strong></span>
      </p>
    </td>
  </tr>
  
  <tr>
    <td width="141">
      <p>
        <span style="font-size: 13px;">minute&nbsp; 分 </span>
      </p>
    </td>
    
    <td colspan="2" width="556">
      <p>
        <span style="font-size: 13px;">Minute when the job should run ( 0-59, *, */2, etc )</span>
      </p>
    </td>
  </tr>
  
  <tr>
    <td width="141">
      <p>
        <span style="font-size: 13px;">hour&nbsp;&nbsp;&nbsp; 时 </span>
      </p>
    </td>
    
    <td colspan="2" width="556">
      <p>
        <span style="font-size: 13px;">Hour when the job should run ( 0-23, *, */2, etc )</span>
      </p>
    </td>
  </tr>
  
  <tr>
    <td width="141">
      <p>
        <span style="font-size: 13px;">day&nbsp;&nbsp;&nbsp;&nbsp; 日 </span>
      </p>
    </td>
    
    <td colspan="2" width="556">
      <p>
        <span style="font-size: 13px;">Day of the month the job should run ( 1-31, *, */2, etc )</span>
      </p>
    </td>
  </tr>
  
  <tr>
    <td width="141">
      <p>
        <span style="font-size: 13px;">month&nbsp;&nbsp; 月 </span>
      </p>
    </td>
    
    <td colspan="2" width="556">
      <p>
        <span style="font-size: 13px;">Month of the year the job should run ( 1-12, *, */2, etc )</span>
      </p>
    </td>
  </tr>
  
  <tr>
    <td width="141">
      <p>
        <span style="font-size: 13px;">weekday 周 </span>
      </p>
    </td>
    
    <td colspan="2" width="556">
      <p>
        <span style="font-size: 13px;">Day of the week that the job should run ( 0-6 for Sunday-Saturday, *, etc )</span>
      </p>
    </td>
  </tr>
  
  <tr>
    <td width="141">
      <p>
        <span style="font-size: 13px;">job&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>
      </p>
    </td>
    
    <td colspan="2" width="556">
      <p>
        <span style="font-size: 13px;">工作 ;要做的事情</span>
      </p>
    </td>
  </tr>
  
  <tr>
    <td width="141">
      <p>
        <span style="font-size: 13px;">name&nbsp;&nbsp;&nbsp;&nbsp; </span>
      </p>
    </td>
    
    <td colspan="2" width="556">
      <p>
        <span style="font-size: 13px;">定义定时任务的描述信息</span>
      </p>
    </td>
  </tr>
  
  <tr>
    <td width="141">
      <p>
        <span style="font-size: 13px;">disabled </span>
      </p>
    </td>
    
    <td colspan="2" width="556">
      <p>
        <span style="font-size: 13px;">注释定时任务</span>
      </p>
    </td>
  </tr>
  
  <tr>
    <td rowspan="4" width="141">
      <p>
        <span style="font-size: 13px;">state&nbsp;&nbsp;&nbsp; </span>
      </p>
    </td>
    
    <td colspan="2" width="556">
      <p align="center">
        <span style="font-size: 13px;"><strong>state </strong><strong>状态参数</strong></span>
      </p>
    </td>
  </tr>
  
  <tr>
    <td valign="top" width="198">
      <p>
        <span style="font-size: 13px;">absent </span>
      </p>
    </td>
    
    <td valign="top" width="357">
      <p>
        <span style="font-size: 13px;">删除定时任务</span>
      </p>
    </td>
  </tr>
  
  <tr>
    <td valign="top" width="198">
      <p>
        <span style="font-size: 13px;">present</span>
      </p>
    </td>
    
    <td valign="top" width="357">
      <p>
        <span style="font-size: 13px;">创建定时任务</span>
      </p>
    </td>
  </tr>
  
  <tr>
    <td colspan="2" width="556">
      <p>
        <span style="font-size: 13px;">默认为present</span>
      </p>
    </td>
  </tr>
</table>

### <span id="392_cron">3.9.2 cron模块参数实践</span>

添加定时任务

<div>
  <div class="cnblogs_code">
    <pre>[root@m01 ~]# ansible clsn -m cron -a <span style="color: #800000;">"</span><span style="color: #800000;">minute=0 hour=0 job='/bin/sh  /server/scripts/hostname.sh &>/dev/null' name=clsn01</span><span style="color: #800000;">"</span>
<span style="color: #800080;">172.16</span>.<span style="color: #800080;">1.8</span> | SUCCESS =><span style="color: #000000;"> {
    </span><span style="color: #800000;">"</span><span style="color: #800000;">changed</span><span style="color: #800000;">"</span>: <span style="color: #0000ff;">true</span><span style="color: #000000;">,
    </span><span style="color: #800000;">"</span><span style="color: #800000;">envs</span><span style="color: #800000;">"</span><span style="color: #000000;">: [],
    </span><span style="color: #800000;">"</span><span style="color: #800000;">jobs</span><span style="color: #800000;">"</span><span style="color: #000000;">: [
     </span><span style="color: #800000;">"</span><span style="color: #800000;">clsn01</span><span style="color: #800000;">"</span><span style="color: #000000;">
    ]
}</span></pre>
  </div>
</div>

删除定时任务

<div>
  <div class="cnblogs_code">
    <pre>[root@m01 ~]# ansible clsn -m cron -a <span style="color: #800000;">"</span><span style="color: #800000;">minute=00 hour=00 job='/bin/sh  /server/scripts/hostname.sh &>/dev/null' name=clsn01 state=absent</span><span style="color: #800000;">"</span>
<span style="color: #800080;">172.16</span>.<span style="color: #800080;">1.8</span> | SUCCESS =><span style="color: #000000;"> {
    </span><span style="color: #800000;">"</span><span style="color: #800000;">changed</span><span style="color: #800000;">"</span>: <span style="color: #0000ff;">true</span><span style="color: #000000;">,
    </span><span style="color: #800000;">"</span><span style="color: #800000;">envs</span><span style="color: #800000;">"</span><span style="color: #000000;">: [],
    </span><span style="color: #800000;">"</span><span style="color: #800000;">jobs</span><span style="color: #800000;">"</span><span style="color: #000000;">: []
}</span></pre>
  </div>
</div>

只用名字就可以删除

<div>
  <div class="cnblogs_code">
    <pre>[root@m01 ~]# ansible clsn -m cron -a <span style="color: #800000;">"</span><span style="color: #800000;">name=clsn01  state=absent</span><span style="color: #800000;">"</span>
<span style="color: #800080;">172.16</span>.<span style="color: #800080;">1.31</span> | SUCCESS =><span style="color: #000000;"> {
    </span><span style="color: #800000;">"</span><span style="color: #800000;">changed</span><span style="color: #800000;">"</span>: <span style="color: #0000ff;">true</span><span style="color: #000000;">,
    </span><span style="color: #800000;">"</span><span style="color: #800000;">envs</span><span style="color: #800000;">"</span><span style="color: #000000;">: [],
    </span><span style="color: #800000;">"</span><span style="color: #800000;">jobs</span><span style="color: #800000;">"</span><span style="color: #000000;">: []
}</span></pre>
  </div>
</div>

注释定时任务

&nbsp;&nbsp; 注意： 注释定时任务的时候必须有job的参数

<div>
  <div class="cnblogs_code">
    <pre>[root@m01 ~]# ansible clsn -m cron -a <span style="color: #800000;">"</span><span style="color: #800000;">name=clsn01 job='/bin/sh  /server/scripts/hostname.sh &>/dev/null'  disabled=yes</span><span style="color: #800000;">"</span>
<span style="color: #800080;">172.16</span>.<span style="color: #800080;">1.31</span> | SUCCESS =><span style="color: #000000;"> {
    </span><span style="color: #800000;">"</span><span style="color: #800000;">changed</span><span style="color: #800000;">"</span>: <span style="color: #0000ff;">true</span><span style="color: #000000;">,
    </span><span style="color: #800000;">"</span><span style="color: #800000;">envs</span><span style="color: #800000;">"</span><span style="color: #000000;">: [],
    </span><span style="color: #800000;">"</span><span style="color: #800000;">jobs</span><span style="color: #800000;">"</span><span style="color: #000000;">: [
    </span><span style="color: #800000;">"</span><span style="color: #800000;">clsn01</span><span style="color: #800000;">"</span><span style="color: #000000;">
    ]
}</span></pre>
  </div>
</div>

取消注释

<div class="cnblogs_code">
  <pre>[root@m01 ~]# ansible clsn -m cron -a <span style="color: #800000;">"</span><span style="color: #800000;">name=clsn01 job='/bin/sh  /server/scripts/hostname.sh &>/dev/null'  disabled=no</span><span style="color: #800000;">"</span>
<span style="color: #800080;">172.16</span>.<span style="color: #800080;">1.41</span> | SUCCESS =><span style="color: #000000;"> {
    </span><span style="color: #800000;">"</span><span style="color: #800000;">changed</span><span style="color: #800000;">"</span>: <span style="color: #0000ff;">true</span><span style="color: #000000;">,
    </span><span style="color: #800000;">"</span><span style="color: #800000;">envs</span><span style="color: #800000;">"</span><span style="color: #000000;">: [],
   </span><span style="color: #800000;">"</span><span style="color: #800000;">jobs</span><span style="color: #800000;">"</span><span style="color: #000000;">: [
       </span><span style="color: #800000;">"</span><span style="color: #800000;">clsn01</span><span style="color: #800000;">"</span><span style="color: #000000;">
    ]
}</span></pre>
</div>

<div>
  <p class="ac">
    <span style="font-size: 1.5em;">3.10 &nbsp;yum 模块</span>
  </p>
</div>

### <span id="3101_yum">3.10.1 yum 模块常用参数</span>

<table border="1" cellspacing="0" cellpadding="0">
  <tr>
    <td valign="top" width="349">
      <p align="center">
        <span style="font-size: 15px;"><strong>参数</strong></span>
      </p>
    </td>
    
    <td valign="top" width="349">
      <p align="center">
        <span style="font-size: 15px;"><strong>参数说明</strong></span>
      </p>
    </td>
  </tr>
  
  <tr>
    <td valign="top" width="349">
      <p>
        <span style="font-size: 13px;">name=<em>name</em>&nbsp;&nbsp;&nbsp;&nbsp; </span>
      </p>
    </td>
    
    <td valign="top" width="349">
      <p>
        <span style="font-size: 13px;">指定安装的软件</span>
      </p>
    </td>
  </tr>
  
  <tr>
    <td valign="top" width="349">
      <p>
        <span style="font-size: 13px;">state=installed</span>
      </p>
    </td>
    
    <td valign="top" width="349">
      <p>
        <span style="font-size: 13px;">安装</span>
      </p>
    </td>
  </tr>
</table>

### <span id="3102_yum">3.10.2 yum模块参数实践</span>

<div>
  <div class="cnblogs_code">
    <pre>[root@m01 ~]# ansible clsn -m <span style="color: #0000ff;">yum</span> -a <span style="color: #800000;">"</span><span style="color: #800000;">name=nmap state=installed  </span><span style="color: #800000;">"</span>
<span style="color: #800080;">172.16</span>.<span style="color: #800080;">1.31</span> | SUCCESS =><span style="color: #000000;"> {
    </span><span style="color: #800000;">"</span><span style="color: #800000;">changed</span><span style="color: #800000;">"</span>: <span style="color: #0000ff;">true</span><span style="color: #000000;">,
    </span><span style="color: #800000;">"</span><span style="color: #800000;">msg</span><span style="color: #800000;">"</span>: <span style="color: #800000;">""</span><span style="color: #000000;">,
    </span><span style="color: #800000;">"</span><span style="color: #800000;">rc</span><span style="color: #800000;">"</span>: <span style="color: #800080;"></span><span style="color: #000000;">,
    </span><span style="color: #800000;">"</span><span style="color: #800000;">results</span><span style="color: #800000;">"</span><span style="color: #000000;">: [
        </span><span style="color: #800000;">"</span><span style="color: #800000;">Loaded plugins: fastestmirror, security\nSetting up Install Process\nLoading mirror speeds from cached hostfile\n * base: mirrors.aliyun.com\n * epel: mirrors.aliyun.com\n * extras: mirrors.aliyun.com\n * updates: mirrors.aliyun.com\nResolving Dependencies\n--> Running transaction check\n---> Package nmap.x86_64 2:5.51-6.el6 will be installed\n--> Finished Dependency Resolution\n\nDependencies Resolved\n\n================================================================================\n Package        Arch             Version                   Repository      Size\n================================================================================\nInstalling:\n nmap           x86_64           2:5.51-6.el6              base           2.8 M\n\nTransaction Summary\n================================================================================\nInstall       1 Package(s)\n\nTotal download size: 2.8 M\nInstalled size: 9.7 M\nDownloading Packages:\nRunning rpm_check_debug\nRunning Transaction Test\nTransaction Test Succeeded\nRunning Transaction\n\r  Installing : 2:nmap-5.51-6.el6.x86_64                                     1/1 \n\r  Verifying  : 2:nmap-5.51-6.el6.x86_64                                     1/1 \n\nInstalled:\n  nmap.x86_64 2:5.51-6.el6                                                      \n\nComplete!\n</span><span style="color: #800000;">"</span><span style="color: #000000;">
    ]
}</span></pre>
  </div>
</div>

## <span id="311_service">3.11 service模块 服务管理</span>

### <span id="3111_service">3.11.1 service模块常用参数说明</span>

<table border="1" cellspacing="0" cellpadding="0">
  <tr>
    <td valign="top" width="236">
      <p align="center">
        <span style="font-size: 15px;"><strong>参数</strong></span>
      </p>
    </td>
    
    <td valign="top" width="461">
      <p align="center">
        <span style="font-size: 15px;"><strong>参数说明</strong></span>
      </p>
    </td>
  </tr>
  
  <tr>
    <td valign="top" width="236">
      <p>
        <span style="font-size: 13px;">name=<em>service name</em></span>
      </p>
    </td>
    
    <td valign="top" width="461">
      <p>
        <span style="font-size: 13px;">服务的名称</span>
      </p>
    </td>
  </tr>
  
  <tr>
    <td valign="top" width="236">
      <p>
        <span style="font-size: 13px;">state=<em>参数</em></span>
      </p>
    </td>
    
    <td valign="top" width="461">
      <p>
        <span style="font-size: 13px;">停止服务 服务状态信息为过去时</span>
      </p>
      
      <p>
        <span style="font-size: 13px;">stared/stoped/restarted/reloaded</span>
      </p>
    </td>
  </tr>
  
  <tr>
    <td valign="top" width="236">
      <p>
        <span style="font-size: 13px;">enabled=yes&nbsp; </span>
      </p>
    </td>
    
    <td valign="top" width="461">
      <p>
        <span style="font-size: 13px;">设置开机自启动</span>
      </p>
    </td>
  </tr>
</table>

**说明** **：service** **管理的服务必须存在在/etc/init.d/****下有****的服务脚本**

### <span id="3112_service">3.11.2 service 模块参数实践</span>

重启定时任务

<div>
  <div class="cnblogs_code">
    <pre>[root@m01 ~]# ansible clsn -m service -a <span style="color: #800000;">"</span><span style="color: #800000;">name=crond state=restarted</span><span style="color: #800000;">"</span>
<span style="color: #800080;">172.16</span>.<span style="color: #800080;">1.8</span> | SUCCESS =><span style="color: #000000;"> {
    </span><span style="color: #800000;">"</span><span style="color: #800000;">changed</span><span style="color: #800000;">"</span>: <span style="color: #0000ff;">true</span><span style="color: #000000;">,
    </span><span style="color: #800000;">"</span><span style="color: #800000;">name</span><span style="color: #800000;">"</span>: <span style="color: #800000;">"</span><span style="color: #800000;">crond</span><span style="color: #800000;">"</span><span style="color: #000000;">,
    </span><span style="color: #800000;">"</span><span style="color: #800000;">state</span><span style="color: #800000;">"</span>: <span style="color: #800000;">"</span><span style="color: #800000;">started</span><span style="color: #800000;">"</span><span style="color: #000000;">
}</span></pre>
  </div>
</div>

## <span id="312_ansible">3.12 ansible中的常用模块</span>

<table border="1" cellspacing="0" cellpadding="0">
  <tr>
    <td width="189">
      <p align="center">
        <span style="font-size: 15px;"><strong>常用模块</strong></span>
      </p>
    </td>
    
    <td width="508">
      <p align="center">
        <span style="font-size: 15px;"><strong>模块说明</strong></span>
      </p>
    </td>
  </tr>
  
  <tr>
    <td width="189">
      <p>
        <span style="font-size: 13px;">command &nbsp;(重要模块)</span>
      </p>
    </td>
    
    <td width="508">
      <p>
        <span style="font-size: 13px;">执行命令模块，ansible命令执行默认模块</span>
      </p>
    </td>
  </tr>
  
  <tr>
    <td width="189">
      <p>
        <span style="font-size: 13px;">shell &nbsp;&nbsp;&nbsp;(重要模块)&nbsp; </span>
      </p>
    </td>
    
    <td width="508">
      <p>
        <span style="font-size: 13px;">行shell脚本模块</span>
      </p>
    </td>
  </tr>
  
  <tr>
    <td width="189">
      <p>
        <span style="font-size: 13px;">script &nbsp;&nbsp;(重要模块) </span>
      </p>
    </td>
    
    <td width="508">
      <p>
        <span style="font-size: 13px;">把脚本发到客户端，然后执行；执行脚本命令在远端服务器上</span>
      </p>
    </td>
  </tr>
  
  <tr>
    <td width="189">
      <p>
        <span style="font-size: 13px;">copy &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(重要模块)&nbsp;&nbsp; </span>
      </p>
    </td>
    
    <td width="508">
      <p>
        <span style="font-size: 13px;">把本地文件发送到远端</span>
      </p>
    </td>
  </tr>
  
  <tr>
    <td width="189">
      <p>
        <span style="font-size: 13px;">file&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>
      </p>
    </td>
    
    <td width="508">
      <p>
        <span style="font-size: 13px;">设定文件属性模块</span>
      </p>
    </td>
  </tr>
  
  <tr>
    <td width="189">
      <p>
        <span style="font-size: 13px;">services&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>
      </p>
    </td>
    
    <td width="508">
      <p>
        <span style="font-size: 13px;">系统服务管理模块</span>
      </p>
    </td>
  </tr>
  
  <tr>
    <td width="189">
      <p>
        <span style="font-size: 13px;">cron&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>
      </p>
    </td>
    
    <td width="508">
      <p>
        <span style="font-size: 13px;">计划任务管理模块</span>
      </p>
    </td>
  </tr>
  
  <tr>
    <td width="189">
      <p>
        <span style="font-size: 13px;">yum&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>
      </p>
    </td>
    
    <td width="508">
      <p>
        <span style="font-size: 13px;">yum软件包安装管理模块</span>
      </p>
    </td>
  </tr>
  
  <tr>
    <td width="189">
      <p>
        <span style="font-size: 13px;">synchronize&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>
      </p>
    </td>
    
    <td width="508">
      <p>
        <span style="font-size: 13px;">使用rsync同步文件模块</span>
      </p>
    </td>
  </tr>
  
  <tr>
    <td width="189">
      <p>
        <span style="font-size: 13px;">mount&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>
      </p>
    </td>
    
    <td width="508">
      <p>
        <span style="font-size: 13px;">挂载模块</span>
      </p>
    </td>
  </tr>
</table>

## <span id="313">3.13 其他模块补充</span>

### <span id="3131_hostname">3.13.1 hostname 修改主机名模块</span>

<div>
  <div class="cnblogs_code">
    <pre>[root@m01 ~]# ansible <span style="color: #800080;">172.16</span>.<span style="color: #800080;">1.8</span> -m <span style="color: #0000ff;">hostname</span> -a <span style="color: #800000;">"</span><span style="color: #800000;">name=web01</span><span style="color: #800000;">"</span>
<span style="color: #800080;">172.16</span>.<span style="color: #800080;">1.8</span> | SUCCESS =><span style="color: #000000;"> {
    </span><span style="color: #800000;">"</span><span style="color: #800000;">ansible_facts</span><span style="color: #800000;">"</span><span style="color: #000000;">: {
        </span><span style="color: #800000;">"</span><span style="color: #800000;">ansible_domain</span><span style="color: #800000;">"</span>: <span style="color: #800000;">"</span><span style="color: #800000;">etiantian.org</span><span style="color: #800000;">"</span><span style="color: #000000;">,
        </span><span style="color: #800000;">"</span><span style="color: #800000;">ansible_fqdn</span><span style="color: #800000;">"</span>: <span style="color: #800000;">"</span><span style="color: #800000;">www.etiantian.org</span><span style="color: #800000;">"</span><span style="color: #000000;">,
       </span><span style="color: #800000;">"</span><span style="color: #800000;">ansible_hostname</span><span style="color: #800000;">"</span>: <span style="color: #800000;">"</span><span style="color: #800000;">web01</span><span style="color: #800000;">"</span><span style="color: #000000;">,
        </span><span style="color: #800000;">"</span><span style="color: #800000;">ansible_nodename</span><span style="color: #800000;">"</span>: <span style="color: #800000;">"</span><span style="color: #800000;">web01</span><span style="color: #800000;">"</span><span style="color: #000000;">
    },
    </span><span style="color: #800000;">"</span><span style="color: #800000;">changed</span><span style="color: #800000;">"</span>: <span style="color: #0000ff;">false</span><span style="color: #000000;">,
    </span><span style="color: #800000;">"</span><span style="color: #800000;">name</span><span style="color: #800000;">"</span>: <span style="color: #800000;">"</span><span style="color: #800000;">web01</span><span style="color: #800000;">"</span><span style="color: #000000;">
}</span></pre>
  </div>
</div>

### <span id="3132_selinux">3.13.2 selinux 管理模块</span>

<div>
  <div class="cnblogs_code">
    <pre>[root@m01 ~]# ansible <span style="color: #800080;">172.16</span>.<span style="color: #800080;">1.8</span> -m selinux -a <span style="color: #800000;">"</span><span style="color: #800000;">state=disabled</span><span style="color: #800000;">"</span>
<span style="color: #800080;">172.16</span>.<span style="color: #800080;">1.8</span> | SUCCESS =><span style="color: #000000;"> {
    </span><span style="color: #800000;">"</span><span style="color: #800000;">changed</span><span style="color: #800000;">"</span>: <span style="color: #0000ff;">false</span><span style="color: #000000;">,
    </span><span style="color: #800000;">"</span><span style="color: #800000;">configfile</span><span style="color: #800000;">"</span>: <span style="color: #800000;">"</span><span style="color: #800000;">/etc/selinux/config</span><span style="color: #800000;">"</span><span style="color: #000000;">,
    </span><span style="color: #800000;">"</span><span style="color: #800000;">msg</span><span style="color: #800000;">"</span>: <span style="color: #800000;">""</span><span style="color: #000000;">,
    </span><span style="color: #800000;">"</span><span style="color: #800000;">policy</span><span style="color: #800000;">"</span>: <span style="color: #800000;">"</span><span style="color: #800000;">targeted</span><span style="color: #800000;">"</span><span style="color: #000000;">,
    </span><span style="color: #800000;">"</span><span style="color: #800000;">state</span><span style="color: #800000;">"</span>: <span style="color: #800000;">"</span><span style="color: #800000;">disabled</span><span style="color: #800000;">"</span><span style="color: #000000;">
}</span></pre>
  </div>
</div>

### <span id="3133_get_url__wget">3.13.3 get_url 模块 == 【wget】</span>

<div>
  <div class="cnblogs_code">
    <pre>[root@m01 ~]# ansible <span style="color: #800080;">172.16</span>.<span style="color: #800080;">1.8</span> -m get_url -a <span style="color: #800000;">"</span><span style="color: #800000;">url=http://lan.znix.top/RDPWrap-v1.6.1.zip dest=/tmp/</span><span style="color: #800000;">"</span>
<span style="color: #800080;">172.16</span>.<span style="color: #800080;">1.8</span> | SUCCESS =><span style="color: #000000;"> {
    </span><span style="color: #800000;">"</span><span style="color: #800000;">changed</span><span style="color: #800000;">"</span>: <span style="color: #0000ff;">true</span><span style="color: #000000;">,
    </span><span style="color: #800000;">"</span><span style="color: #800000;">checksum_dest</span><span style="color: #800000;">"</span>: <span style="color: #0000ff;">null</span><span style="color: #000000;">,
    </span><span style="color: #800000;">"</span><span style="color: #800000;">checksum_src</span><span style="color: #800000;">"</span>: <span style="color: #800000;">"</span><span style="color: #800000;">ad402705624d06a6ff4b5a6a98c55fc2453b3a70</span><span style="color: #800000;">"</span><span style="color: #000000;">,
    </span><span style="color: #800000;">"</span><span style="color: #800000;">dest</span><span style="color: #800000;">"</span>: <span style="color: #800000;">"</span><span style="color: #800000;">/tmp/RDPWrap-v1.6.1.zip</span><span style="color: #800000;">"</span><span style="color: #000000;">,
    </span><span style="color: #800000;">"</span><span style="color: #800000;">gid</span><span style="color: #800000;">"</span>: <span style="color: #800080;"></span><span style="color: #000000;">,
    </span><span style="color: #800000;">"</span><span style="color: #800000;">group</span><span style="color: #800000;">"</span>: <span style="color: #800000;">"</span><span style="color: #800000;">root</span><span style="color: #800000;">"</span><span style="color: #000000;">,
    </span><span style="color: #800000;">"</span><span style="color: #800000;">md5sum</span><span style="color: #800000;">"</span>: <span style="color: #800000;">"</span><span style="color: #800000;">b04dde546293ade71287071d187ed92d</span><span style="color: #800000;">"</span><span style="color: #000000;">,
    </span><span style="color: #800000;">"</span><span style="color: #800000;">mode</span><span style="color: #800000;">"</span>: <span style="color: #800000;">"</span><span style="color: #800000;">0644</span><span style="color: #800000;">"</span><span style="color: #000000;">,
    </span><span style="color: #800000;">"</span><span style="color: #800000;">msg</span><span style="color: #800000;">"</span>: <span style="color: #800000;">"</span><span style="color: #800000;">OK (1567232 bytes)</span><span style="color: #800000;">"</span><span style="color: #000000;">,
    </span><span style="color: #800000;">"</span><span style="color: #800000;">owner</span><span style="color: #800000;">"</span>: <span style="color: #800000;">"</span><span style="color: #800000;">root</span><span style="color: #800000;">"</span><span style="color: #000000;">,
    </span><span style="color: #800000;">"</span><span style="color: #800000;">size</span><span style="color: #800000;">"</span>: <span style="color: #800080;">1567232</span><span style="color: #000000;">,
    </span><span style="color: #800000;">"</span><span style="color: #800000;">src</span><span style="color: #800000;">"</span>: <span style="color: #800000;">"</span><span style="color: #800000;">/tmp/tmp4X4Von</span><span style="color: #800000;">"</span><span style="color: #000000;">,
    </span><span style="color: #800000;">"</span><span style="color: #800000;">state</span><span style="color: #800000;">"</span>: <span style="color: #800000;">"</span><span style="color: #800000;">file</span><span style="color: #800000;">"</span><span style="color: #000000;">,
    </span><span style="color: #800000;">"</span><span style="color: #800000;">status_code</span><span style="color: #800000;">"</span>: <span style="color: #800080;">200</span><span style="color: #000000;">,
    </span><span style="color: #800000;">"</span><span style="color: #800000;">uid</span><span style="color: #800000;">"</span>: <span style="color: #800080;"></span><span style="color: #000000;">,
    </span><span style="color: #800000;">"</span><span style="color: #800000;">url</span><span style="color: #800000;">"</span>: <span style="color: #800000;">"</span><span style="color: #800000;">http://lan.znix.top/RDPWrap-v1.6.1.zip</span><span style="color: #800000;">"</span><span style="color: #000000;">
}</span></pre>
  </div>
</div>

&nbsp;&nbsp; url= 下载文件的地址 dest 下载到哪里

&nbsp;&nbsp; timeout 超时时间

&nbsp;&nbsp; url_password&nbsp; &nbsp;密码

&nbsp;&nbsp; url_username &nbsp;用户名

# <span id="4_ansible-playbook">第4章 ansible-playbook 剧本</span>

## <span id="41_ansible">4.1 ansible基础知识部分补充</span>

### <span id="411_ansible">4.1.1 ansible软件特点：</span>

&middot; 可以实现批量管理

&middot; 可以实现批量部署

&middot; ad-hoc(批量执行命令)\---针对临时性的操作

<div>
  <p class="ac">
    &nbsp; 　　ansible clsn -m command -a "hostname"&nbsp;&nbsp; <- 批量执行命令举例
  </p>
</div>

&middot; 编写剧本-脚本(playbook)\---针对重复性的操作

### <span id="412_ansible">4.1.2 ansible核心功能：</span>

pyYAML\-----用于ansible编写剧本所使用的语言格式（saltstack\---python）&nbsp;

<div>
  <p class="a3">
    rsync-ini语法&nbsp; sersync-xml语法 &nbsp;ansible-pyYAML语法
  </p>
</div>

paramiko\---远程连接与数据传输&nbsp;&nbsp;

Jinja2\-----用于编写ansible的模板信息&nbsp;

&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;

## <span id="42_ansible">4.2 ansible剧本编写规则说明</span>

### <span id="421_pyYAML">4.2.1 pyYAML语法规则：</span>

&nbsp;&nbsp; 规则一：缩进

<div>
  <p class="a3">
    &nbsp;&nbsp;&nbsp; yaml使用一个固定的缩进风格表示数据层结构关系，Saltstack需要每个缩进级别由两个空格组成。一定不能使用tab键
  </p>
  
  <p class="a3">
    &nbsp;&nbsp;&nbsp; 注意：编写yaml文件，就忘记键盘有tab
  </p>
</div>

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;

&nbsp;&nbsp;&nbsp; 规则二：冒号

<div>
  <p class="a3">
    &nbsp;&nbsp;&nbsp; CMD="echo"
  </p>
  
  <p class="a3">
    &nbsp;&nbsp;&nbsp; yaml:
  </p>
  
  <p class="a3">
    &nbsp;&nbsp;&nbsp; mykey:
  </p>
  
  <p class="a3">
    &nbsp;&nbsp;&nbsp; 每个冒号后面一定要有一个空格（以冒号结尾不需要空格，表示文件路径的模版可以不需要空格）
  </p>
</div>

&nbsp;&nbsp;&nbsp;

&nbsp;&nbsp;&nbsp; 规则三：短横线

<div>
  <p class="a3">
    &nbsp;&nbsp;&nbsp; 想要表示列表项，使用一个短横杠加一个空格。多个项使用同样的缩进级别作为同一个列表的一部分
  </p>
</div>

&nbsp;&nbsp; **&nbsp;****核心规则：有效的利用空格进行剧本的编写，剧本编写是不支持tab****的**

## <span id="43">4.3 剧本书写格式</span>

<div>
  <div class="cnblogs_code">
    <pre><span style="color: #000000;">### 剧本的开头，可以不写
</span>- hosts: all         &lt;- 处理所有服务器，找到所有服务器;  -<span style="color: #000000;">(空格)hosts:(空格)all
tasks:             </span>&lt;-<span style="color: #000000;"> 剧本所要干的事情;                (空格)(空格)task:
</span>- command: <span style="color: #0000ff;">echo</span><span style="color: #000000;"> hello clsn linux.  
  (空格)(空格)空格)(空格)</span>-<span style="color: #000000;">(空格)模块名称:(空格)模块中对应的功能<br /> ansible all -m command -a "echo hello clsn linux"&nbsp; &nbsp; &nbsp;</span></pre>
  </div>
</div>

<div>
  <p class="ac">
    &nbsp;&nbsp;&nbsp; 剧本编写内容扩展：剧本任务定义名称
  </p>
  
  <div class="cnblogs_code">
    <pre>- hosts: <span style="color: #800080;">172.16</span>.<span style="color: #800080;">1.7</span>  &lt;- 处理指定服务器                   -<span style="color: #000000;">(空格)hosts:(空格)all
task:                </span>&lt;-<span style="color: #000000;"> 剧本所要干的事情;                (空格)(空格)task:
</span>-<span style="color: #000000;"> name:
command: </span><span style="color: #0000ff;">echo</span><span style="color: #000000;"> hello clsn linux.                   
(空格)(空格)空格)(空格)</span>-(空格)模块名称:(空格)模块中对应的功能</pre>
  </div>
</div>

### <span id="431">4.3.1 剧本格式示例</span>

<div>
  <div class="cnblogs_code">
    <pre>[root@m01 ansible-<span style="color: #000000;">playbook]# vim rsync_sever.yml
</span>- hosts: <span style="color: #800080;">172.16</span>.<span style="color: #800080;">1.41</span><span style="color: #000000;">
  tasks:
    </span>- name: <span style="color: #0000ff;">install</span><span style="color: #000000;"> rsync
      </span><span style="color: #0000ff;">yum</span>: name=rsync state=installed</pre>
  </div>
</div>

## <span id="44">4.4 剧本编写后检查方法</span>

<div>
  <p class="ac">
    01：ansible-playbook<strong> --syntax-check </strong>01.yml&nbsp;
  </p>
</div>

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;　　 \--- 进行剧本配置信息语法检查

<div>
  <p class="ac">
    02：ansible-playbook<strong> -C</strong><strong> 0</strong>1.yml&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
  </p>
</div>

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;　　&nbsp; \--- 模拟剧本执行（彩排）

### <span id="441">4.4.1 语法检查</span>

<div>
  <div class="cnblogs_code">
    <pre>[root@m01 ansible-playbook]# ansible-playbook --syntax-check <span style="color: #800080;">01</span><span style="color: #000000;">.yml
playbook: </span><span style="color: #800080;">01</span><span style="color: #000000;">.yml</span></pre>
  </div>
</div>

### <span id="442">4.4.2 模拟剧本执行</span>

<div>
  <div class="cnblogs_code">
    <pre>[root@m01 ansible-playbook]# ansible-playbook -C <span style="color: #800080;">01</span><span style="color: #000000;">.yml
PLAY [all] </span>****************************************************************<span style="color: #000000;">

TASK [Gathering Facts] </span>****************************************************<span style="color: #000000;">
ok: [</span><span style="color: #800080;">172.16</span>.<span style="color: #800080;">1.41</span><span style="color: #000000;">]
ok: [</span><span style="color: #800080;">172.16</span>.<span style="color: #800080;">1.8</span><span style="color: #000000;">]
ok: [</span><span style="color: #800080;">172.16</span>.<span style="color: #800080;">1.31</span><span style="color: #000000;">]

TASK [cron] </span>***************************************************************<span style="color: #000000;">
ok: [</span><span style="color: #800080;">172.16</span>.<span style="color: #800080;">1.8</span><span style="color: #000000;">]
ok: [</span><span style="color: #800080;">172.16</span>.<span style="color: #800080;">1.41</span><span style="color: #000000;">]
ok: [</span><span style="color: #800080;">172.16</span>.<span style="color: #800080;">1.31</span><span style="color: #000000;">]

PLAY RECAP </span>****************************************************************
<span style="color: #800080;">172.16</span>.<span style="color: #800080;">1.31</span>                : ok=<span style="color: #800080;">2</span>    changed=<span style="color: #800080;"></span>    unreachable=<span style="color: #800080;"></span>    failed=<span style="color: #800080;"></span>
<span style="color: #800080;">172.16</span>.<span style="color: #800080;">1.41</span>                : ok=<span style="color: #800080;">2</span>    changed=<span style="color: #800080;"></span>    unreachable=<span style="color: #800080;"></span>    failed=<span style="color: #800080;"></span>
<span style="color: #800080;">172.16</span>.<span style="color: #800080;">1.8</span>                 : ok=<span style="color: #800080;">2</span>    changed=<span style="color: #800080;"></span>    unreachable=<span style="color: #800080;"></span>    failed=<span style="color: #800080;"></span></pre>
  </div>
</div>

## <span id="45">4.5 剧本示例</span>

### <span id="451">4.5.1 剧本编写内容扩展：剧本任务编写多个任务</span>

<div>
  <div class="cnblogs_code">
    <pre>-<span style="color: #000000;"> hosts: all
  tasks:
    </span>- name: restart-<span style="color: #000000;">network
      cron: name</span>=<span style="color: #800000;">'</span><span style="color: #800000;">restart network</span><span style="color: #800000;">'</span> minute=<span style="color: #800080;">00</span> hour=<span style="color: #800080;">00</span> job=<span style="color: #800000;">'</span><span style="color: #800000;">/usr/sbin/ntpdate time.nist.gov >/dev/null 2>&1</span><span style="color: #800000;">'</span>
    - name: <span style="color: #0000ff;">sync</span> <span style="color: #0000ff;">time</span><span style="color: #000000;">
      cron: name</span>=<span style="color: #800000;">'</span><span style="color: #800000;">sync time</span><span style="color: #800000;">'</span> minute=*/<span style="color: #800080;">5</span> job=<span style="color: #800000;">"</span><span style="color: #800000;">/usr/sbin/ntpdate pool.ntp.com >/dev/null 2>&1</span><span style="color: #800000;">"</span></pre>
  </div>
</div>

### <span id="452">4.5.2 剧本编写内容扩展：剧本任务编写多个主机</span>

<div>
  <div class="cnblogs_code">
    <pre>- hosts: <span style="color: #800080;">172.16</span>.<span style="color: #800080;">1.7</span><span style="color: #000000;">
  tasks:
    </span>- name: restart-<span style="color: #000000;">network
      cron: name</span>=<span style="color: #800000;">'</span><span style="color: #800000;">restart network</span><span style="color: #800000;">'</span> minute=<span style="color: #800080;">00</span> hour=<span style="color: #800080;">00</span> job=<span style="color: #800000;">'</span><span style="color: #800000;">/usr/sbin/ntpdate time.nist.gov >/dev/null 2>&1</span><span style="color: #800000;">'</span>
    - name: <span style="color: #0000ff;">sync</span> <span style="color: #0000ff;">time</span><span style="color: #000000;">
      cron: name</span>=<span style="color: #800000;">'</span><span style="color: #800000;">sync time</span><span style="color: #800000;">'</span> minute=*/<span style="color: #800080;">5</span> job=<span style="color: #800000;">"</span><span style="color: #800000;">/usr/sbin/ntpdate pool.ntp.com >/dev/null 2>&1</span><span style="color: #800000;">"</span>
- hosts: <span style="color: #800080;">172.16</span>.<span style="color: #800080;">1.31</span><span style="color: #000000;">
  tasks:
    </span>- name: show ip addr to <span style="color: #0000ff;">file</span><span style="color: #000000;">
      shell: </span><span style="color: #0000ff;">echo</span> $(<span style="color: #0000ff;">hostname</span> -i) >> /tmp/ip.txt</pre>
  </div>
</div>

## <span id="46">4.6 剧本编写方式</span>

01 多主机单任务编写方式

02 多主机多任务编写方式

03 不同主机多任务编写方式

# <span id="5">第5章 常见错误</span>

## <span id="51_ansible">5.1 ansible编写剧本排错思路</span>

1. ansible-playbook编写完，检査语法和模拟测试运行

2. 打开剧本，定位异常问題原因，将剧本中的内容转换命令执行一次

<div>
  <div class="cnblogs_Highlighter">
    <pre class="brush:bash;gutter:true;">cron: name=clsn64 minute=ee hour=03 job='/bin/sh /server/scripts/test.sh &>/dev/null'
ansible clsn -m cron -a "name=clsn64 minute=00 hour=03 job='/bin/sh /server/scripts/test.sh &>/dev/null</pre>
  </div>
</div>

<div>
  &nbsp;
</div>

3. 将参数中的脚本文件推送到远程屎务器，在远程服务器本地执行脚本 sh -x test.sh

说明：ansible执行时，加1上-vvvv显示ansible详细执行过程，也可以定位异常原因！

### <span id="511">5.1.1 排错逻辑</span>

01. 剧本执行中的错误

02. 把剧本中的内容转换为ansible命令执行

<div>
  <p class="ac">
    &nbsp;&nbsp;&nbsp; ansible clsn -m yum -a "name=rsync state=installed"
  </p>
</div>

03. 把ansible服务器上执行的命令放在被管理主机上执行

<div>
  <p class="ac">
    &nbsp;&nbsp;&nbsp; yum install -y rsync
  </p>
</div>

## <span id="52_ansible">5.2 ansible 无法正常使用</span>

### <span id="521_rootnotty">5.2.1 在被控端上 root@notty 进程一直存在</span>

<div>
  <div class="cnblogs_code">
    <pre>[root@backup ~]# <span style="color: #0000ff;">ps</span> -ef|<span style="color: #0000ff;">grep</span><span style="color: #000000;"> sshd
root      </span><span style="color: #800080;">35274</span>      <span style="color: #800080;">1</span>  <span style="color: #800080;"></span> <span style="color: #800080;">15</span>:<span style="color: #800080;">25</span> ?        <span style="color: #800080;">00</span>:<span style="color: #800080;">00</span>:<span style="color: #800080;">00</span> /usr/sbin/<span style="color: #000000;">sshd
root      </span><span style="color: #800080;">37004</span>  <span style="color: #800080;">35274</span>  <span style="color: #800080;"></span> <span style="color: #800080;">16</span>:<span style="color: #800080;">23</span> ?        <span style="color: #800080;">00</span>:<span style="color: #800080;">00</span>:<span style="color: #800080;">00</span> sshd: root@pts/<span style="color: #800080;">2</span><span style="color: #000000;"> 
root      </span><span style="color: #800080;">37062</span>  <span style="color: #800080;">35274</span>  <span style="color: #800080;"></span> <span style="color: #800080;">16</span>:<span style="color: #800080;">55</span> ?        <span style="color: #800080;">00</span>:<span style="color: #800080;">00</span>:<span style="color: #800080;">00</span><span style="color: #000000;"> sshd: root@notty 
root      </span><span style="color: #800080;">37154</span>  <span style="color: #800080;">37006</span>  <span style="color: #800080;"></span> <span style="color: #800080;">16</span>:<span style="color: #800080;">55</span> pts/<span style="color: #800080;">2</span>    <span style="color: #800080;">00</span>:<span style="color: #800080;">00</span>:<span style="color: #800080;">00</span> <span style="color: #0000ff;">grep</span> --color=auto sshd</pre>
  </div>
</div>

### <span id="522">5.2.2 解决办法</span>

首先，将该进程干掉

<div>
  <p class="ac">
    kill pid
  </p>
</div>

### <span id="523_ansible_-vvvv">5.2.3 然后使用ansible的 -vvvv 参数查看执行的错误信息</span>

<div>
  <div class="cnblogs_code">
    <pre>Loading callback plugin minimal of type stdout, v2.<span style="color: #800080;"></span> from /usr/lib/python2.<span style="color: #800080;">6</span>/site-packages/ansible/plugins/callback/<span style="color: #000000;">__init__.pyc
META: ran handlers
Using module </span><span style="color: #0000ff;">file</span> /usr/lib/python2.<span style="color: #800080;">6</span>/site-packages/ansible/modules/system/<span style="color: #0000ff;">ping</span><span style="color: #000000;">.py
</span>&lt;<span style="color: #800080;">172.16</span>.<span style="color: #800080;">1.8</span>><span style="color: #000000;"> ESTABLISH SSH CONNECTION FOR USER: None
</span>&lt;<span style="color: #800080;">172.16</span>.<span style="color: #800080;">1.8</span>> SSH: EXEC <span style="color: #0000ff;">ssh</span> -vvv -C -o ControlMaster=auto -o ControlPersist=60s -o KbdInteractiveAuthentication=no -o PreferredAuthentications=gssapi-with-mic,gssapi-keyex,hostbased,publickey -o PasswordAuthentication=no -o ConnectTimeout=<span style="color: #800080;">10</span> -o ControlPath=/root/.ansible/<span style="color: #0000ff;">cp</span>/923ebeb605 <span style="color: #800080;">172.16</span>.<span style="color: #800080;">1.8</span> <span style="color: #800000;">'</span><span style="color: #800000;">/bin/sh -c </span><span style="color: #800000;">'"</span><span style="color: #800000;">'</span><span style="color: #800000;">"'</span><span style="color: #800000;">echo ~ && sleep 0</span><span style="color: #800000;">'"</span><span style="color: #800000;">'</span><span style="color: #800000;">"''</span><span style="color: #000000;">
&hellip;&hellip;</span></pre>
  </div>
  
  <p>
    &nbsp;
  </p>
</div>

找到在哪里出错。

### <span id="524">5.2.4 可能的错误</span>

在 /etc/ssh/sshd_config 文件中的第132行为空，导致sftp 无法连接，出错~

<div>
  <div class="cnblogs_Highlighter">
    <pre class="brush:bash;gutter:true;">133 Subsystem       sftp    /usr/libexec/openssh/sftp-server</pre>
  </div>
</div>

## <span id="53_nbspnbsp">5.3 常见问题二：&nbsp;&nbsp;</span>

<div>
  <div class="cnblogs_Highlighter">
    <pre class="brush:bash;gutter:true;">[root@m01 ~]# ansible  -k 172.16.1.51 -m ping 
SSH password:
[WARNING]: No hosts matched, nothing to do</pre>
  </div>
</div>

原因分析：

在ansible的hosts文件中，没有配置相应主机地址信息

### <span id="531_nbspnbspnbspnbspnbspnbspnbsp">5.3.1 常见问题三：&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>

<div>
  <div class="cnblogs_Highlighter">
    <pre class="brush:bash;gutter:true;"># ansible -k 172.16.1.51 -m ping
SSH password:
172.16.1.51|FAILED! => {
"failed": true,
"msg": "Using a SSH password instead of a key is not possible because Host Key checking is enabled and sshpass does not support this.  Please add this host's fingerprint to your known_hosts file to manage this host."
}</pre>
  </div>
</div>

原因分析：

因为没有受控端的指纹信息，在known_hosts文件中

&nbsp;

<div id="toc_container" class="toc_white have_bullets">
  <ul class="toc_list">
    <li>
      <a href="#1_sshkeyansible">第1章 ssh+key实现基于密钥连接（ansible使用前提）</a><ul>
        <li>
          <a href="#11_ssh_key">1.1 部署ssh key</a><ul>
            <li>
              <a href="#111">1.1.1 第一个里程碑： 创建密钥对</a>
            </li>
            <li>
              <a href="#112">1.1.2 第二个里程碑： 分发公钥文件</a>
            </li>
            <li>
              <a href="#113">1.1.3 第三个里程碑： 基于密钥登陆测试</a>
            </li>
            <li>
              <a href="#114_ssh">1.1.4 ssh服务分发公钥实质执行过程</a>
            </li>
          </ul>
        </li>
        
        <li>
          <a href="#12_22">1.2 默认端口号不是22，如何分发公钥</a><ul>
            <li>
              <a href="#121_ssh-copy-id">1.2.1 查询ssh-copy-id命令可以得知这是个脚本文件</a>
            </li>
            <li>
              <a href="#122_22">1.2.2 实现非22端口的分发</a>
            </li>
            <li>
              <a href="#123_usrbinssh-copy-id_1">1.2.3 关于 /usr/bin/ssh-copy-id 脚本中 $1的说明</a><ul>
                <li>
                  <a href="#1231nbsp_shift">1.2.3.1&nbsp; 编写脚本shift</a>
                </li>
              </ul>
            </li>
          </ul>
        </li>
        
        <li>
          <a href="#13">1.3 实现自动分发公钥，远程管理多台主机</a><ul>
            <li>
              <a href="#131_shell">1.3.1 【预备知识】shell中三种循环</a>
            </li>
            <li>
              <a href="#132">1.3.2 实现自动分发公钥，远程管理多台主机的阻碍因素？</a>
            </li>
            <li>
              <a href="#133">1.3.3 解决阻碍因素</a>
            </li>
            <li>
              <a href="#134">1.3.4 最终批量分发脚本内容</a>
            </li>
            <li>
              <a href="#135">1.3.5 实现基于密钥的批量管理脚本</a>
            </li>
          </ul>
        </li>
      </ul>
    </li>
    
    <li>
      <a href="#2_ansible">第2章 ansible软件介绍</a><ul>
        <li>
          <a href="#21">2.1 自动化批量管理方式说明</a><ul>
            <li>
              <a href="#211_sshkey">2.1.1 ssh+key方式的说明</a>
            </li>
            <li>
              <a href="#212">2.1.2 企业级生产场景批量管理-自动化管理方案</a>
            </li>
            <li>
              <a href="#213">2.1.3 如何完成成集群规模架构一键自动化实现（步骤说明）</a>
            </li>
          </ul>
        </li>
        
        <li>
          <a href="#22_ansible">2.2 ansible软件特点概述</a><ul>
            <li>
              <a href="#221_ansible">2.2.1 ansible软件中查看模块相关信息方法</a>
            </li>
          </ul>
        </li>
        
        <li>
          <a href="#23_ansible">2.3 部署ansible软件</a><ul>
            <li>
              <a href="#231_sshkey">2.3.1 第一个里里程碑：部署ssh+key免密码登录方式</a>
            </li>
            <li>
              <a href="#232_ansible">2.3.2 第二个里程碑：被管理端安装ansible相关管理软件</a>
            </li>
            <li>
              <a href="#233_ansiblehosts">2.3.3 第三个里程碑：管理端安装ansible软件，配置hosts文件</a>
            </li>
          </ul>
        </li>
        
        <li>
          <a href="#24_ansible">2.4 查看ansible软件相关信息</a><ul>
            <li>
              <a href="#241_ansible">2.4.1 ansible实践部署地址规划</a>
            </li>
            <li>
              <a href="#242_ansible">2.4.2 ansible软件的版本信息</a>
            </li>
            <li>
              <a href="#243">2.4.3 软件目前主要会用到的文件</a>
            </li>
            <li>
              <a href="#244_etcansible">2.4.4 /etc/ansible下的文件</a>
            </li>
          </ul>
        </li>
        
        <li>
          <a href="#25_ansible">2.5 ansible软件的使用/参数</a><ul>
            <li>
              <a href="#251_ansible">2.5.1 ansible远程批量执行命令</a>
            </li>
            <li>
              <a href="#252_ansible">2.5.2 未分发公钥如何实现远程管理主机及指定ansible端口信息</a>
            </li>
          </ul>
        </li>
        
        <li>
          <a href="#26_ansible">2.6 ansible软件常用参数表</a><ul>
            <li>
              <a href="#261_ansible">2.6.1 ansible命令执行结果色彩说明：</a>
            </li>
          </ul>
        </li>
      </ul>
    </li>
    
    <li>
      <a href="#3_ansible">第3章 ansible中的模块说明</a><ul>
        <li>
          <a href="#31_ping">3.1 ping 模块：测试连通性</a>
        </li>
        <li>
          <a href="#32_command">3.2 command 模块 默认模块</a><ul>
            <li>
              <a href="#321_command">3.2.1 command命令常用参数说明</a>
            </li>
          </ul>
        </li>
        
        <li>
          <a href="#33_shell">3.3 shell模块 万能模块</a>
        </li>
        <li>
          <a href="#34_script">3.4 script 模块 执行脚本模块</a>
        </li>
        <li>
          <a href="#35_copy">3.5 copy模块 把本地文件发送到远端</a><ul>
            <li>
              <a href="#351_copy">3.5.1 copy模块常用参数</a>
            </li>
            <li>
              <a href="#352_copy">3.5.2 copy常用命令参数测试</a>
            </li>
          </ul>
        </li>
        
        <li>
          <a href="#36_file">3.6 file模块 设置文件属性</a><ul>
            <li>
              <a href="#361_file">3.6.1 file模块常用参数</a>
            </li>
            <li>
              <a href="#362">3.6.2 常用参数测试</a>
            </li>
          </ul>
        </li>
        
        <li>
          <a href="#37_fetch_nbsp">3.7 fetch 模块&nbsp; 拉取文件</a><ul>
            <li>
              <a href="#371_fetch">3.7.1 fetch常用参数说明</a>
            </li>
            <li>
              <a href="#372">3.7.2 常用参数实例</a>
            </li>
          </ul>
        </li>
        
        <li>
          <a href="#38_mount">3.8 mount模块 配置挂载点模块</a><ul>
            <li>
              <a href="#381_mount">3.8.1 mount模块常用参数</a>
            </li>
            <li>
              <a href="#382_mount">3.8.2 mount参数实例</a>
            </li>
          </ul>
        </li>
        
        <li>
          <a href="#39_cron">3.9 cron模块 定时任务</a><ul>
            <li>
              <a href="#391_cron">3.9.1 cron模块常用参数</a>
            </li>
            <li>
              <a href="#392_cron">3.9.2 cron模块参数实践</a>
            </li>
            <li>
              <a href="#3101_yum">3.10.1 yum 模块常用参数</a>
            </li>
            <li>
              <a href="#3102_yum">3.10.2 yum模块参数实践</a>
            </li>
          </ul>
        </li>
        
        <li>
          <a href="#311_service">3.11 service模块 服务管理</a><ul>
            <li>
              <a href="#3111_service">3.11.1 service模块常用参数说明</a>
            </li>
            <li>
              <a href="#3112_service">3.11.2 service 模块参数实践</a>
            </li>
          </ul>
        </li>
        
        <li>
          <a href="#312_ansible">3.12 ansible中的常用模块</a>
        </li>
        <li>
          <a href="#313">3.13 其他模块补充</a><ul>
            <li>
              <a href="#3131_hostname">3.13.1 hostname 修改主机名模块</a>
            </li>
            <li>
              <a href="#3132_selinux">3.13.2 selinux 管理模块</a>
            </li>
            <li>
              <a href="#3133_get_url__wget">3.13.3 get_url 模块 == 【wget】</a>
            </li>
          </ul>
        </li>
      </ul>
    </li>
    
    <li>
      <a href="#4_ansible-playbook">第4章 ansible-playbook 剧本</a><ul>
        <li>
          <a href="#41_ansible">4.1 ansible基础知识部分补充</a><ul>
            <li>
              <a href="#411_ansible">4.1.1 ansible软件特点：</a>
            </li>
            <li>
              <a href="#412_ansible">4.1.2 ansible核心功能：</a>
            </li>
          </ul>
        </li>
        
        <li>
          <a href="#42_ansible">4.2 ansible剧本编写规则说明</a><ul>
            <li>
              <a href="#421_pyYAML">4.2.1 pyYAML语法规则：</a>
            </li>
          </ul>
        </li>
        
        <li>
          <a href="#43">4.3 剧本书写格式</a><ul>
            <li>
              <a href="#431">4.3.1 剧本格式示例</a>
            </li>
          </ul>
        </li>
        
        <li>
          <a href="#44">4.4 剧本编写后检查方法</a><ul>
            <li>
              <a href="#441">4.4.1 语法检查</a>
            </li>
            <li>
              <a href="#442">4.4.2 模拟剧本执行</a>
            </li>
          </ul>
        </li>
        
        <li>
          <a href="#45">4.5 剧本示例</a><ul>
            <li>
              <a href="#451">4.5.1 剧本编写内容扩展：剧本任务编写多个任务</a>
            </li>
            <li>
              <a href="#452">4.5.2 剧本编写内容扩展：剧本任务编写多个主机</a>
            </li>
          </ul>
        </li>
        
        <li>
          <a href="#46">4.6 剧本编写方式</a>
        </li>
      </ul>
    </li>
    
    <li>
      <a href="#5">第5章 常见错误</a><ul>
        <li>
          <a href="#51_ansible">5.1 ansible编写剧本排错思路</a><ul>
            <li>
              <a href="#511">5.1.1 排错逻辑</a>
            </li>
          </ul>
        </li>
        
        <li>
          <a href="#52_ansible">5.2 ansible 无法正常使用</a><ul>
            <li>
              <a href="#521_rootnotty">5.2.1 在被控端上 root@notty 进程一直存在</a>
            </li>
            <li>
              <a href="#522">5.2.2 解决办法</a>
            </li>
            <li>
              <a href="#523_ansible_-vvvv">5.2.3 然后使用ansible的 -vvvv 参数查看执行的错误信息</a>
            </li>
            <li>
              <a href="#524">5.2.4 可能的错误</a>
            </li>
          </ul>
        </li>
        
        <li>
          <a href="#53_nbspnbsp">5.3 常见问题二：&nbsp;&nbsp;</a><ul>
            <li>
              <a href="#531_nbspnbspnbspnbspnbspnbspnbsp">5.3.1 常见问题三：&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</a>
            </li>
          </ul>
        </li>
      </ul>
    </li>
  </ul>
</div>

 [1]: /wp-content/themes/clsn-003/inc/go.php?url=file:///I:/Desktop/%E8%AF%BE%E5%90%8E%E6%80%BB%E7%BB%93/%E7%AC%AC10%E5%91%A8/day44,45-ansible%E6%9C%8D%E5%8A%A1%E9%83%A8%E7%BD%B2-ssh+key%20%E5%AF%86%E9%92%A5%E5%88%86%E5%8F%91+ansible%E6%A8%A1%E5%9D%97%E8%AF%B4%E6%98%8E.docx#_ssh+key实现基于密钥连接