---
title: Nginx的反向代理与负载均衡
author: 惨绿少年
type: post
date: 2017-12-16T18:40:00+00:00
url: /clsn/lx429.html
Baidusubmit:
  - 1
views:
  - 356
specs_zan:
  - 1
categories:
  - Linux运维
  - Web应用
  - 玩转Linux
  - 运维基本功

---
## <span id="11">1.1 集群是什么</span>

　　简单地说，集群就是指一组（若干个）相互独立的计算机，利用高速通信网络组成的一个较大的计算机服务系统，每个集群节点（即集群中的每台计算机）都是运行各自服务的独立服器。这些服务器之间可以彼此通信，协同向用户提供应用程序、系统资源和数据，并以单一系统的模式加以管理。当用户客户机请求集群系统时，集群给用户的感觉就是一个单一独立的服务器，而实际上用户请求的是一组集群服务器。

　　打开谷歌、百度的页面，看起来好简单，也许你觉得用几分钟就可以制作出相似的网页，而实际上，这个页面的背后是由成千上万台服务器集群协同工作的结果。而这么多的服务器维护和管理，以及相互协调工作也许就是读者你未来的工作职责了。

　　若要用一句话描述集群，即一堆服务器合作做同一件事，这些机器可能需要整个技术团队架构、设计和统一协调管理，这些机器可以分布在一个机房，也可以分布在全国全球各个地区的多个机房。

## <span id="12">1.2 为什么要有集群</span>

<div>
  <p class="a">
    　　高性能、价格有效性、可伸缩性、高可用性
  </p>
  
  <p class="a">
    　　透明性、可管理性、可编辑性
  </p>
</div>

### <span id="121">1.2.1 集群种类</span>

**　　负载均衡集群 LB** **解决调度问题**

**　　高可用集群&nbsp; HA** **解决单点故障问题（keeplived****）**

　　高性能计算集群&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; HP 、网络计算集群 GC

### <span id="122">1.2.2 硬件设备</span>

<div>
  <p class="a">
    　　F5 设备&nbsp; &nbsp;A10
  </p>
</div>

### <span id="123">1.2.3 软件</span>

<div>
  <p class="a">
    　　nginx （7层&nbsp; 1.9版本之后支持4层）、LVS （4层）、HAproxy （4层 7层）
  </p>
</div>

### <span id="124">1.2.4 负载均衡概念说明</span>

　　对用户的访问请求进行调度管理

　　对用户的访问请求进行压力分担

<p align="center">
  &nbsp;<img data-original="https://clsn.io/wp-content/uploads/2018/03/1190037-20171217102011343-1991514696.jpg" src="/wp-content/themes/clsn-003/img/blank.gif" alt="Nginx的反向代理与负载均衡" alt="" />
</p>

### <span id="125">1.2.5 反向代理</span>

　　接收用户请求代替用户向后端访问

　　反向代理与数据转发的区别

### <span id="126">1.2.6 压力测试的方式</span>

　　ab （apache里的命令）&nbsp;

　　通过&nbsp;&nbsp;&nbsp;<span class="cnblogs_code"><span style="color: #0000ff;">yum</span> <span style="color: #0000ff;">install</span> httpd-tools</span>&nbsp;&nbsp; 获得

## <span id="13_nginx">1.3 nginx反向代理实践</span>

### <span id="131">1.3.1 地址规划说明</span>

<div align="center">
  <div align="center">
    <table class="MsoTableGrid" style="border-width: initial; border-style: none; border-color: initial;" border="1" cellspacing="0" cellpadding="0">
      <tr>
        <td style="width: 174.25pt; border-width: 1pt; border-color: windowtext; background: #a6a6a6; padding: 0cm 5.4pt;" width="232">
          <p class="MsoNormal" style="margin-bottom: .0001pt; text-align: justify; text-justify: inter-ideograph;">
            <strong><span style="font-size: 10.0pt; font-family: 'Times New Roman',serif; mso-fareast-font-family: 宋体;" lang="EN-US">HOSTNAME</span></strong>
          </p>
        </td>
        
        <td style="width: 174.25pt; border-top-width: 1pt; border-right-width: 1pt; border-bottom-width: 1pt; border-top-color: windowtext; border-right-color: windowtext; border-bottom-color: windowtext; border-left: none; background: #a6a6a6; padding: 0cm 5.4pt;" width="232">
          <p class="MsoNormal" style="margin-bottom: .0001pt; text-align: justify; text-justify: inter-ideograph;">
            <strong><span style="font-size: 10.0pt; font-family: 'Times New Roman',serif; mso-fareast-font-family: 宋体;" lang="EN-US">IP</span></strong>
          </p>
        </td>
        
        <td style="width: 174.3pt; border-top-width: 1pt; border-right-width: 1pt; border-bottom-width: 1pt; border-top-color: windowtext; border-right-color: windowtext; border-bottom-color: windowtext; border-left: none; background: #a6a6a6; padding: 0cm 5.4pt;" width="232">
          <p class="MsoNormal" style="margin-bottom: .0001pt; text-align: justify; text-justify: inter-ideograph;">
            <strong><span style="font-size: 10.0pt; font-family: 宋体; mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman'; mso-bidi-font-family: 'Times New Roman';">说明</span></strong>
          </p>
        </td>
      </tr>
      
      <tr>
        <td style="width: 174.25pt; border-right-width: 1pt; border-bottom-width: 1pt; border-left-width: 1pt; border-right-color: windowtext; border-bottom-color: windowtext; border-left-color: windowtext; border-top: none; padding: 0cm 5.4pt;" width="232">
          <p class="MsoNormal" style="margin-bottom: .0001pt; text-align: justify; text-justify: inter-ideograph;">
            <span style="font-size: 10.0pt; font-family: 'Times New Roman',serif; mso-fareast-font-family: 宋体;" lang="EN-US">lb01</span>
          </p>
        </td>
        
        <td style="width: 174.25pt; border-top: none; border-left: none; border-bottom-width: 1pt; border-bottom-color: windowtext; border-right-width: 1pt; border-right-color: windowtext; padding: 0cm 5.4pt;" width="232">
          <p class="MsoNormal" style="margin-bottom: .0001pt; text-align: justify; text-justify: inter-ideograph;">
            <span style="font-size: 10.0pt; font-family: 'Times New Roman',serif; mso-fareast-font-family: 宋体;" lang="EN-US">10.0.0.5</span>
          </p>
        </td>
        
        <td style="width: 174.3pt; border-top: none; border-left: none; border-bottom-width: 1pt; border-bottom-color: windowtext; border-right-width: 1pt; border-right-color: windowtext; padding: 0cm 5.4pt;" width="232">
          <p class="MsoNormal" style="margin-bottom: .0001pt; text-align: justify; text-justify: inter-ideograph;">
            <span style="font-size: 10.0pt; font-family: 'Times New Roman',serif; mso-fareast-font-family: 宋体;" lang="EN-US">Nginx </span><span style="font-size: 10.0pt; font-family: 宋体; mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman'; mso-bidi-font-family: 'Times New Roman';">主负载服务器</span>
          </p>
        </td>
      </tr>
      
      <tr>
        <td style="width: 174.25pt; border-right-width: 1pt; border-bottom-width: 1pt; border-left-width: 1pt; border-right-color: windowtext; border-bottom-color: windowtext; border-left-color: windowtext; border-top: none; padding: 0cm 5.4pt;" width="232">
          <p class="MsoNormal" style="margin-bottom: .0001pt; text-align: justify; text-justify: inter-ideograph;">
            <span style="font-size: 10.0pt; font-family: 'Times New Roman',serif; mso-fareast-font-family: 宋体;" lang="EN-US">lb02</span>
          </p>
        </td>
        
        <td style="width: 174.25pt; border-top: none; border-left: none; border-bottom-width: 1pt; border-bottom-color: windowtext; border-right-width: 1pt; border-right-color: windowtext; padding: 0cm 5.4pt;" width="232">
          <p class="MsoNormal" style="margin-bottom: .0001pt; text-align: justify; text-justify: inter-ideograph;">
            <span style="font-size: 10.0pt; font-family: 'Times New Roman',serif; mso-fareast-font-family: 宋体;" lang="EN-US">10.0.0.6</span>
          </p>
        </td>
        
        <td style="width: 174.3pt; border-top: none; border-left: none; border-bottom-width: 1pt; border-bottom-color: windowtext; border-right-width: 1pt; border-right-color: windowtext; padding: 0cm 5.4pt;" width="232">
          <p class="MsoNormal" style="margin-bottom: .0001pt; text-align: justify; text-justify: inter-ideograph;">
            <span style="font-size: 10.0pt; font-family: 'Times New Roman',serif; mso-fareast-font-family: 宋体;" lang="EN-US">nginx </span><span style="font-size: 10.0pt; font-family: 宋体; mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman'; mso-bidi-font-family: 'Times New Roman';">辅负载服务器</span>
          </p>
        </td>
      </tr>
      
      <tr>
        <td style="width: 174.25pt; border-right-width: 1pt; border-bottom-width: 1pt; border-left-width: 1pt; border-right-color: windowtext; border-bottom-color: windowtext; border-left-color: windowtext; border-top: none; padding: 0cm 5.4pt;" width="232">
          <p class="MsoNormal" style="margin-bottom: .0001pt; text-align: justify; text-justify: inter-ideograph;">
            <span style="font-size: 10.0pt; font-family: 'Times New Roman',serif; mso-fareast-font-family: 宋体;" lang="EN-US">web01</span>
          </p>
        </td>
        
        <td style="width: 174.25pt; border-top: none; border-left: none; border-bottom-width: 1pt; border-bottom-color: windowtext; border-right-width: 1pt; border-right-color: windowtext; padding: 0cm 5.4pt;" width="232">
          <p class="MsoNormal" style="margin-bottom: .0001pt; text-align: justify; text-justify: inter-ideograph;">
            <span style="font-size: 10.0pt; font-family: 'Times New Roman',serif; mso-fareast-font-family: 宋体;" lang="EN-US">10.0.0.8</span>
          </p>
        </td>
        
        <td style="width: 174.3pt; border-top: none; border-left: none; border-bottom-width: 1pt; border-bottom-color: windowtext; border-right-width: 1pt; border-right-color: windowtext; padding: 0cm 5.4pt;" width="232">
          <p class="MsoNormal" style="margin-bottom: .0001pt; text-align: justify; text-justify: inter-ideograph;">
            <span style="font-size: 10.0pt; font-family: 'Times New Roman',serif; mso-fareast-font-family: 宋体;" lang="EN-US">web01</span><span style="font-size: 10.0pt; font-family: 宋体; mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman'; mso-bidi-font-family: 'Times New Roman';">服务器</span>
          </p>
        </td>
      </tr>
      
      <tr>
        <td style="width: 174.25pt; border-right-width: 1pt; border-bottom-width: 1pt; border-left-width: 1pt; border-right-color: windowtext; border-bottom-color: windowtext; border-left-color: windowtext; border-top: none; padding: 0cm 5.4pt;" width="232">
          <p class="MsoNormal" style="margin-bottom: .0001pt; text-align: justify; text-justify: inter-ideograph;">
            <span style="font-size: 10.0pt; font-family: 'Times New Roman',serif; mso-fareast-font-family: 宋体;" lang="EN-US">web02</span>
          </p>
        </td>
        
        <td style="width: 174.25pt; border-top: none; border-left: none; border-bottom-width: 1pt; border-bottom-color: windowtext; border-right-width: 1pt; border-right-color: windowtext; padding: 0cm 5.4pt;" width="232">
          <p class="MsoNormal" style="margin-bottom: .0001pt; text-align: justify; text-justify: inter-ideograph;">
            <span style="font-size: 10.0pt; font-family: 'Times New Roman',serif; mso-fareast-font-family: 宋体;" lang="EN-US">10.0.0.7</span>
          </p>
        </td>
        
        <td style="width: 174.3pt; border-top: none; border-left: none; border-bottom-width: 1pt; border-bottom-color: windowtext; border-right-width: 1pt; border-right-color: windowtext; padding: 0cm 5.4pt;" width="232">
          <p class="MsoNormal" style="margin-bottom: .0001pt; text-align: justify; text-justify: inter-ideograph;">
            <span style="font-size: 10.0pt; font-family: 'Times New Roman',serif; mso-fareast-font-family: 宋体;" lang="EN-US">web02</span><span style="font-size: 10.0pt; font-family: 宋体; mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman'; mso-bidi-font-family: 'Times New Roman';">服务器</span>
          </p>
        </td>
      </tr>
      
      <tr>
        <td style="width: 174.25pt; border-right-width: 1pt; border-bottom-width: 1pt; border-left-width: 1pt; border-right-color: windowtext; border-bottom-color: windowtext; border-left-color: windowtext; border-top: none; padding: 0cm 5.4pt;" width="232">
          <p class="MsoNormal" style="margin-bottom: .0001pt; text-align: justify; text-justify: inter-ideograph;">
            <span style="font-size: 10.0pt; font-family: 'Times New Roman',serif; mso-fareast-font-family: 宋体;" lang="EN-US">web03</span>
          </p>
        </td>
        
        <td style="width: 174.25pt; border-top: none; border-left: none; border-bottom-width: 1pt; border-bottom-color: windowtext; border-right-width: 1pt; border-right-color: windowtext; padding: 0cm 5.4pt;" width="232">
          <p class="MsoNormal" style="margin-bottom: .0001pt; text-align: justify; text-justify: inter-ideograph;">
            <span style="font-size: 10.0pt; font-family: 'Times New Roman',serif; mso-fareast-font-family: 宋体;" lang="EN-US">10.0.0.9</span>
          </p>
        </td>
        
        <td style="width: 174.3pt; border-top: none; border-left: none; border-bottom-width: 1pt; border-bottom-color: windowtext; border-right-width: 1pt; border-right-color: windowtext; padding: 0cm 5.4pt;" width="232">
          <p class="MsoNormal" style="margin-bottom: .0001pt; text-align: justify; text-justify: inter-ideograph;">
            <span style="font-size: 10.0pt; font-family: 'Times New Roman',serif; mso-fareast-font-family: 宋体;" lang="EN-US">web03</span><span style="font-size: 10.0pt; font-family: 宋体; mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman'; mso-bidi-font-family: 'Times New Roman';">服务器</span>
          </p>
        </td>
      </tr>
      
      <tr>
        <td style="width: 522.8pt; border-right-width: 1pt; border-bottom-width: 1pt; border-left-width: 1pt; border-right-color: windowtext; border-bottom-color: windowtext; border-left-color: windowtext; border-top: none; background: #92d050; padding: 0cm 5.4pt;" colspan="3" width="697">
          <p class="MsoNormal" style="margin-bottom: .0001pt; text-align: justify; text-justify: inter-ideograph;">
            <span style="font-size: 10.0pt; font-family: 宋体; mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman'; mso-bidi-font-family: 'Times New Roman';">说明：</span><span style="font-size: 10.0pt; font-family: 宋体; mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman'; mso-bidi-font-family: 'Times New Roman';">以上为实际生产架构负载实现规划内容</span>
          </p>
        </td>
      </tr>
    </table>
  </div>
</div>

<div>
  <p class="a">
    <strong>ip</strong><strong>命令说明</strong>
  </p>
  
  <div class="cnblogs_code">
    <pre><span style="color: #000000;">ip address show  查看ip地址
ip route show  查看路由信息</span></pre>
  </div>
</div>

### <span id="132">1.3.2 反向代理与数据转发的区别</span>

<p align="center">
  <img data-original="https://clsn.io/wp-content/uploads/2018/03/1190037-20171217102349374-1087598674.jpg" src="/wp-content/themes/clsn-003/img/blank.gif" alt="Nginx的反向代理与负载均衡" alt="" />&nbsp;
</p>

### <span id="133_nginx">1.3.3 安装部署nginx过程（安装命令集）</span>

<div>
  <div class="cnblogs_code">
    <pre><span style="color: #0000ff;">yum</span> <span style="color: #0000ff;">install</span> -y pcre-devel openssl-<span style="color: #000000;">devel
</span><span style="color: #0000ff;">mkdir</span> -p /server/<span style="color: #000000;">tools
cd </span>/server/<span style="color: #000000;">tools
</span><span style="color: #0000ff;">wget</span> -q http:<span style="color: #008000;">//</span><span style="color: #008000;">nginx.org/download/nginx-1.10.3.tar.gz</span>
<span style="color: #0000ff;">ls</span> -l nginx-<span style="color: #800080;">1.10</span>.<span style="color: #800080;">3</span>.<span style="color: #0000ff;">tar</span><span style="color: #000000;">.gz
useradd www </span>-s /sbin/nologin -<span style="color: #000000;">M
</span><span style="color: #0000ff;">tar</span> xf nginx-<span style="color: #800080;">1.10</span>.<span style="color: #800080;">3</span>.<span style="color: #0000ff;">tar</span><span style="color: #000000;">.gz
cd nginx</span>-<span style="color: #800080;">1.10</span>.<span style="color: #800080;">3</span><span style="color: #000000;">
.</span>/configure  --user=nginx --group=nginx --prefix=/application/nginx-<span style="color: #800080;">1.10</span>.<span style="color: #800080;">3</span> --with-http_stub_status_module  --with-<span style="color: #000000;">http_ssl_module
</span><span style="color: #0000ff;">make</span>
<span style="color: #0000ff;">make</span> <span style="color: #0000ff;">install</span>
<span style="color: #0000ff;">ln</span> -s /application/nginx-<span style="color: #800080;">1.10</span>.<span style="color: #800080;">3</span> /application/ngin</pre>
  </div>
</div>

### <span id="134_nginxweb">1.3.4 编写nginx配置文件（统一web服务器配置）</span>

<div>
  <div class="cnblogs_code">
    <pre>worker_processes  <span style="color: #800080;">1</span><span style="color: #000000;">;
events {
    worker_connections  </span><span style="color: #800080;">1024</span><span style="color: #000000;">;
}
http {
    include       mime.types;
    default_type  application</span>/octet-<span style="color: #000000;">stream;
    sendfile        on;
    keepalive_timeout  </span><span style="color: #800080;">65</span><span style="color: #000000;">;
    log_format  main  </span><span style="color: #800000;">'</span><span style="color: #800000;">$remote_addr - $remote_user [$time_local] "$request" </span><span style="color: #800000;">'</span>
                      <span style="color: #800000;">'</span><span style="color: #800000;">$status $body_bytes_sent "$http_referer" </span><span style="color: #800000;">'</span>
                      <span style="color: #800000;">'</span><span style="color: #800000;">"$http_user_agent" "$http_x_forwarded_for"</span><span style="color: #800000;">'</span><span style="color: #000000;">;
    server {
        listen       </span><span style="color: #800080;">80</span><span style="color: #000000;">;
        server_name  bbs.etiantian.org;
        location </span>/<span style="color: #000000;"> {
            root   html</span>/<span style="color: #000000;">bbs;
            index  index.html index.htm;
        }
      access_log  logs</span>/<span style="color: #000000;">access_bbs.log  main;
    }        
    server {
        listen       </span><span style="color: #800080;">80</span><span style="color: #000000;">;
        server_name  www.etiantian.org;
        location </span>/<span style="color: #000000;"> {
            root   html</span>/<span style="color: #000000;">www;
            index  index.html index.htm;
        }
        access_log  logs</span>/<span style="color: #000000;">access_www.log  main;
    }
}</span></pre>
  </div>
</div>

### <span id="135_nginx_web">1.3.5 统一nginx测试环境 （web文件）</span>

<div>
  <div class="cnblogs_code">
    <pre><span style="color: #0000ff;">mkdir</span> -p /application/nginx/html/<span style="color: #000000;">{www,bbs}
</span><span style="color: #0000ff;">for</span> name <span style="color: #0000ff;">in</span> www bbs; <span style="color: #0000ff;">do</span> <span style="color: #0000ff;">echo</span> $name `<span style="color: #0000ff;">hostname</span>` >/application/nginx/html/$name/xiaoxinxin.html;<span style="color: #0000ff;">done</span>
<span style="color: #0000ff;">for</span> name <span style="color: #0000ff;">in</span> www bbs; <span style="color: #0000ff;">do</span> <span style="color: #0000ff;">cat</span> /application/nginx/html/$name/xiaoxinxin.html;<span style="color: #0000ff;">done</span></pre>
  </div>
</div>

### <span id="136">1.3.6 测试</span>

<div>
  <div class="cnblogs_code">
    <pre>[root@lb01 ~]# curl -H host:bbs.etiantian.org  <span style="color: #800080;">10.0</span>.<span style="color: #800080;">0.8</span>/<span style="color: #000000;">xiaoxinxin.html
bbs web01
[root@lb01 </span>~]# curl -H host:bbs.etiantian.org  <span style="color: #800080;">10.0</span>.<span style="color: #800080;">0.7</span>/<span style="color: #000000;">xiaoxinxin.html
bbs web02
[root@lb01 </span>~]# curl -H host:bbs.etiantian.org  <span style="color: #800080;">10.0</span>.<span style="color: #800080;">0.9</span>/<span style="color: #000000;">xiaoxinxin.html
bbs web03
[root@lb01 </span>~]# curl -H host:www.etiantian.org  <span style="color: #800080;">10.0</span>.<span style="color: #800080;">0.8</span>/<span style="color: #000000;">xiaoxinxin.html
www web01
[root@lb01 </span>~]# curl -H host:www.etiantian.org  <span style="color: #800080;">10.0</span>.<span style="color: #800080;">0.7</span>/<span style="color: #000000;">xiaoxinxin.html
www web02
[root@lb01 </span>~]# curl -H host:www.etiantian.org  <span style="color: #800080;">10.0</span>.<span style="color: #800080;">0.9</span>/<span style="color: #000000;">xiaoxinxin.html
www web03</span></pre>
  </div>
</div>

### <span id="137">1.3.7 配置负载服务文件</span>

<div>
  <div class="cnblogs_code">
    <pre>worker_processes  <span style="color: #800080;">1</span><span style="color: #000000;">;
events {
    worker_connections  </span><span style="color: #800080;">1024</span><span style="color: #000000;">;
}
http {
    include       mime.types;
    default_type  application</span>/octet-<span style="color: #000000;">stream;
    sendfile        on;
    keepalive_timeout  </span><span style="color: #800080;">65</span><span style="color: #000000;">;                                  
    upstream server_pools {
        server </span><span style="color: #800080;">10.0</span>.<span style="color: #800080;">0.7</span>:<span style="color: #800080;">80</span><span style="color: #000000;">;
        server </span><span style="color: #800080;">10.0</span>.<span style="color: #800080;">0.8</span>:<span style="color: #800080;">80</span><span style="color: #000000;">;
        server </span><span style="color: #800080;">10.0</span>.<span style="color: #800080;">0.9</span>:<span style="color: #800080;">80</span><span style="color: #000000;">;
    } 
    server {
        listen </span><span style="color: #800080;">80</span><span style="color: #000000;">;
        server_name bbs.etiantian.org;
        location </span>/<span style="color: #000000;"> {
            proxy_pass http:</span><span style="color: #008000;">//</span><span style="color: #008000;">server_pools;</span>
<span style="color: #000000;">        }
    }</span></pre>
  </div>
</div>

### <span id="138">1.3.8 测试访问</span>

<div>
  <div class="cnblogs_code">
    <pre>[root@lb01 conf]# curl -H host:bbs.etiantian.org <span style="color: #800080;">10.0</span>.<span style="color: #800080;">0.5</span>/<span style="color: #000000;">xiaoxinxin.html
bbs web03
[root@lb01 conf]# curl </span>-H host:bbs.etiantian.org <span style="color: #800080;">10.0</span>.<span style="color: #800080;">0.5</span>/<span style="color: #000000;">xiaoxinxin.html
bbs web02
[root@lb01 conf]# curl </span>-H host:bbs.etiantian.org <span style="color: #800080;">10.0</span>.<span style="color: #800080;">0.5</span>/<span style="color: #000000;">xiaoxinxin.html
bbs web01</span></pre>
  </div>
</div>

## <span id="14_nginx">1.4 nginx中常用模块说明</span>

<div>
  <div class="cnblogs_code">
    <pre><span style="color: #000000;">ngx_http_status_module
ngx_http_ssl_module
ngx_http_log_module
ngx_http_upstream_module
ngx_http_proxy_module</span></pre>
  </div>
</div>

### <span id="141">1.4.1 模块调度算法</span>

<div>
  <p class="a">
    &nbsp;　　&nbsp;&nbsp; ①. 定义轮询调度算法-rr-默认调度算法
  </p>
  
  <p class="a">
    　　&nbsp;&nbsp;&nbsp; ②. 定义权重调度算法-wrr
  </p>
  
  <p class="a">
    &nbsp;&nbsp;　　&nbsp; ③. 定义静态调度算法-ip_hash
  </p>
  
  <p class="a">
    &nbsp;&nbsp;　　&nbsp; ④. 定义最小的连接数-least_conn
  </p>
</div>

### <span id="142_nginx">1.4.2 nginx反向代理相关两个模块</span>

　　　　upstream 模块 类似与一个池塘，将nginx节点放置到池塘中

　　　　proxy模块&nbsp; 用池塘里面的nginx节点，利用pr oxy进行调用

### <span id="143_upstream">1.4.3 upstream模块核心参数简介</span>

　　　　weight 权重

　　　　max_fails 抛得次数

　　　　fail_timeout 失败的超时时间

　　　　backup&nbsp; 备份

### <span id="144_weight">1.4.4 weight 参数实践 （权重）</span>

　　upstream 模块只能在http区块里

<div>
  <div class="cnblogs_code">
    <pre>worker_processes  <span style="color: #800080;">1</span><span style="color: #000000;">;
events {
    worker_connections  </span><span style="color: #800080;">1024</span><span style="color: #000000;">;
}
http {
    include       mime.types;
    default_type  application</span>/octet-<span style="color: #000000;">stream;
    sendfile        on;
    keepalive_timeout  </span><span style="color: #800080;">65</span><span style="color: #000000;">;
    upstream server_pools{
         server </span><span style="color: #800080;">10.0</span>.<span style="color: #800080;">0.7</span>:<span style="color: #800080;">80</span> weight=<span style="color: #800080;">1</span><span style="color: #000000;">;
         server </span><span style="color: #800080;">10.0</span>.<span style="color: #800080;">0.8</span>:<span style="color: #800080;">80</span> weight=<span style="color: #800080;">2</span><span style="color: #000000;">;
    }
    server{
       listen </span><span style="color: #800080;">80</span><span style="color: #000000;">;
       server_name bbs.etiantian.org;
       location </span>/<span style="color: #000000;"> {
          proxy_pass http:</span><span style="color: #008000;">//</span><span style="color: #008000;">server_pools;</span>
<span style="color: #000000;">       }
    }
}</span></pre>
  </div>
</div>

测试

<div>
  <div class="cnblogs_code">
    <pre>[root@test tools]# curl <span style="color: #800080;">10.0</span>.<span style="color: #800080;">0.5</span><span style="color: #000000;">
web01 www
[root@test tools]# curl </span><span style="color: #800080;">10.0</span>.<span style="color: #800080;">0.5</span><span style="color: #000000;">
web01 www
[root@test tools]# curl </span><span style="color: #800080;">10.0</span>.<span style="color: #800080;">0.5</span><span style="color: #000000;">
web02 www
[root@test tools]# curl </span><span style="color: #800080;">10.0</span>.<span style="color: #800080;">0.5</span><span style="color: #000000;">
web01 www
[root@test tools]# curl </span><span style="color: #800080;">10.0</span>.<span style="color: #800080;">0.5</span><span style="color: #000000;">
web01 www
[root@test tools]# curl </span><span style="color: #800080;">10.0</span>.<span style="color: #800080;">0.5</span><span style="color: #000000;">
web02 www</span></pre>
  </div>
</div>

### <span id="145">1.4.5 其他的参数说明</span>

　　max_fails&nbsp;&nbsp;&nbsp; 失败的尝试次数

　　fail_timeout 失败后的再次尝试时间

　　backup 备份节点：所有的节点都挂掉后数据才会请求web01

<div>
  <div class="cnblogs_code">
    <pre>server <span style="color: #800080;">10.0</span>.<span style="color: #800080;">0.7</span>:<span style="color: #800080;">80</span> weight=<span style="color: #800080;">1</span> max_fails=<span style="color: #800080;">3</span> fail_timeout=<span style="color: #800080;">10</span><span style="color: #000000;"> ;
server </span><span style="color: #800080;">10.0</span>.<span style="color: #800080;">0.8</span>:<span style="color: #800080;">80</span> weight=<span style="color: #800080;">2</span> max_fails=<span style="color: #800080;">3</span> fail_timeout=<span style="color: #800080;">10</span> backup;</pre>
  </div>
</div>

测试，将web02停掉

<div>
  <div class="cnblogs_code">
    <pre>[root@test tools]# curl <span style="color: #800080;">10.0</span>.<span style="color: #800080;">0.5</span><span style="color: #000000;">
web02 www
[root@test tools]# curl </span><span style="color: #800080;">10.0</span>.<span style="color: #800080;">0.5</span><span style="color: #000000;">
web02 www</span></pre>
  </div>
</div>

停掉web02后

<div>
  <div class="cnblogs_code">
    <pre>[root@test tools]# curl <span style="color: #800080;">10.0</span>.<span style="color: #800080;">0.5</span><span style="color: #000000;">
web01 www
[root@test tools]# curl </span><span style="color: #800080;">10.0</span>.<span style="color: #800080;">0.5</span><span style="color: #000000;">
web01 www
[root@test tools]# curl </span><span style="color: #800080;">10.0</span>.<span style="color: #800080;">0.5</span></pre>
  </div>
</div>

### <span id="146">1.4.6 访问抓包</span>

用户请求报文

<p align="center">
  <img data-original="https://clsn.io/wp-content/uploads/2018/03/1190037-20171217102759389-1917826599.png" src="/wp-content/themes/clsn-003/img/blank.gif" alt="Nginx的反向代理与负载均衡" alt="" />&nbsp;
</p>

负载均衡请求报文

<p align="center">
  &nbsp;<img data-original="https://clsn.io/wp-content/uploads/2018/03/1190037-20171217102839827-407799546.png" src="/wp-content/themes/clsn-003/img/blank.gif" alt="Nginx的反向代理与负载均衡" alt="" />
</p>

<div>
  <p class="a">
    说明：
  </p>
  
  <p class="a">
    &nbsp;&nbsp;&nbsp; hosts 主机头不同，未配置proxy_set_header Host $host 参数，在负载均衡访问的时候会不带hosts信息。
  </p>
</div>

### <span id="147_upsrteam">1.4.7 upsrteam参数详细说明</span>

<table class="MsoTable15Grid4Accent5" style="width: 100%; border-width: initial; border-style: none; border-color: initial;" border="1" cellspacing="0" cellpadding="0">
  <tr>
    <td style="width: 11.8%; border-top-width: 1pt; border-bottom-width: 1pt; border-left-width: 1pt; border-top-color: #4472c4; border-bottom-color: #4472c4; border-left-color: #4472c4; border-right: none; background: #4472c4; padding: 0cm 5.4pt;" valign="top" width="11%">
      <p class="MsoNormal" style="margin-bottom: .0001pt; mso-yfti-cnfc: 5;">
        <strong><span style="font-size: 10.0pt; font-family: 'Times New Roman',serif; mso-fareast-font-family: 宋体; color: white; mso-themecolor: background1;" lang="EN-US">upstream</span></strong><strong><span style="font-size: 10.0pt; font-family: 宋体; mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman'; mso-bidi-font-family: 'Times New Roman'; color: white; mso-themecolor: background1;">模块内参数</span></strong>
      </p>
    </td>
    
    <td style="width: 88.2%; border-top-width: 1pt; border-right-width: 1pt; border-bottom-width: 1pt; border-top-color: #4472c4; border-right-color: #4472c4; border-bottom-color: #4472c4; border-left: none; background: #4472c4; padding: 0cm 5.4pt;" valign="top" width="88%">
      <p class="MsoNormal" style="margin-bottom: .0001pt; mso-yfti-cnfc: 1;">
        <strong><span style="font-size: 10.0pt; font-family: 宋体; mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman'; mso-bidi-font-family: 'Times New Roman'; color: white; mso-themecolor: background1;">参数说明</span></strong>
      </p>
    </td>
  </tr>
  
  <tr>
    <td style="width: 11.8%; border-right-width: 1pt; border-bottom-width: 1pt; border-left-width: 1pt; border-right-color: #8eaadb; border-bottom-color: #8eaadb; border-left-color: #8eaadb; border-top: none; background: #d9e2f3; padding: 0cm 5.4pt;" valign="top" width="11%">
      <p class="MsoNormal" style="margin-bottom: .0001pt; mso-yfti-cnfc: 68;">
        <strong><span style="font-size: 10.0pt; font-family: 'Times New Roman',serif; mso-fareast-font-family: 宋体;" lang="EN-US">server 10.0.10.8:80</span></strong>
      </p>
    </td>
    
    <td style="width: 88.2%; border-top: none; border-left: none; border-bottom-width: 1pt; border-bottom-color: #8eaadb; border-right-width: 1pt; border-right-color: #8eaadb; background: #d9e2f3; padding: 0cm 5.4pt;" valign="top" width="88%">
      <p class="MsoNormal" style="margin-bottom: .0001pt; mso-yfti-cnfc: 64;">
        <span style="font-size: 10.0pt; font-family: 宋体; mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman'; mso-bidi-font-family: 'Times New Roman';">负载均衡后面的</span><span style="font-size: 10.0pt; font-family: 'Times New Roman',serif; mso-fareast-font-family: 宋体;" lang="EN-US">RS</span><span style="font-size: 10.0pt; font-family: 宋体; mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman'; mso-bidi-font-family: 'Times New Roman';">配置，可以是</span><span style="font-size: 10.0pt; font-family: 'Times New Roman',serif; mso-fareast-font-family: 宋体;" lang="EN-US">IP</span><span style="font-size: 10.0pt; font-family: 宋体; mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman'; mso-bidi-font-family: 'Times New Roman';">或域名，如果端口不写，默认是</span><span style="font-size: 10.0pt; font-family: 'Times New Roman',serif; mso-fareast-font-family: 宋体;" lang="EN-US">80</span><span style="font-size: 10.0pt; font-family: 宋体; mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman'; mso-bidi-font-family: 'Times New Roman';">端口。</span>
      </p>
      
      <p class="MsoNormal" style="margin-bottom: .0001pt; mso-yfti-cnfc: 64;">
        <span style="font-size: 10.0pt; font-family: 宋体; mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman'; mso-bidi-font-family: 'Times New Roman';">高并发场景下，</span><span style="font-size: 10.0pt; font-family: 'Times New Roman',serif; mso-fareast-font-family: 宋体;" lang="EN-US"> IP</span><span style="font-size: 10.0pt; font-family: 宋体; mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman'; mso-bidi-font-family: 'Times New Roman';">可换成域名，通过</span><span style="font-size: 10.0pt; font-family: 'Times New Roman',serif; mso-fareast-font-family: 宋体;" lang="EN-US"> DNS</span><span style="font-size: 10.0pt; font-family: 宋体; mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman'; mso-bidi-font-family: 'Times New Roman';">做负载均衡。</span>
      </p>
    </td>
  </tr>
  
  <tr>
    <td style="width: 11.8%; border-right-width: 1pt; border-bottom-width: 1pt; border-left-width: 1pt; border-right-color: #8eaadb; border-bottom-color: #8eaadb; border-left-color: #8eaadb; border-top: none; padding: 0cm 5.4pt;" valign="top" width="11%">
      <p class="MsoNormal" style="margin-bottom: .0001pt; mso-yfti-cnfc: 4;">
        <strong><span style="font-size: 10.0pt; font-family: 'Times New Roman',serif; mso-fareast-font-family: 宋体;" lang="EN-US">weigth=1</span></strong>
      </p>
    </td>
    
    <td style="width: 88.2%; border-top: none; border-left: none; border-bottom-width: 1pt; border-bottom-color: #8eaadb; border-right-width: 1pt; border-right-color: #8eaadb; padding: 0cm 5.4pt;" valign="top" width="88%">
      <p class="MsoNormal" style="margin-bottom: .0001pt;">
        <span style="font-size: 10.0pt; font-family: 宋体; mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman'; mso-bidi-font-family: 'Times New Roman';">代表服务器的权重，默认值是</span><span style="font-size: 10.0pt; font-family: 'Times New Roman',serif; mso-fareast-font-family: 宋体;" lang="EN-US">1</span><span style="font-size: 10.0pt; font-family: 宋体; mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman'; mso-bidi-font-family: 'Times New Roman';">。权重数字越大表示接受的请求比例越大。</span>
      </p>
    </td>
  </tr>
  
  <tr>
    <td style="width: 11.8%; border-right-width: 1pt; border-bottom-width: 1pt; border-left-width: 1pt; border-right-color: #8eaadb; border-bottom-color: #8eaadb; border-left-color: #8eaadb; border-top: none; background: #d9e2f3; padding: 0cm 5.4pt;" valign="top" width="11%">
      <p class="MsoNormal" style="margin-bottom: .0001pt; mso-yfti-cnfc: 68;">
        <strong><span style="font-size: 10.0pt; font-family: 'Times New Roman',serif; mso-fareast-font-family: 宋体;" lang="EN-US">max_fails=3</span></strong>
      </p>
    </td>
    
    <td style="width: 88.2%; border-top: none; border-left: none; border-bottom-width: 1pt; border-bottom-color: #8eaadb; border-right-width: 1pt; border-right-color: #8eaadb; background: #d9e2f3; padding: 0cm 5.4pt;" valign="top" width="88%">
      <p class="MsoNormal" style="margin-bottom: .0001pt; mso-yfti-cnfc: 64;">
        <span style="font-size: 10.0pt; font-family: 'Times New Roman',serif; mso-fareast-font-family: 宋体;" lang="EN-US">Nginx</span><span style="font-size: 10.0pt; font-family: 宋体; mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman'; mso-bidi-font-family: 'Times New Roman';">尝试连接后端主机失败的次数，这个值是配合</span><span style="font-size: 10.0pt; font-family: 'Times New Roman',serif; mso-fareast-font-family: 宋体;" lang="EN-US"> proxy_next_upstream</span><span style="font-size: 10.0pt; font-family: 宋体; mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman'; mso-bidi-font-family: 'Times New Roman';">、</span><span style="font-size: 10.0pt; font-family: 'Times New Roman',serif; mso-fareast-font-family: 宋体;" lang="EN-US">fastcgi_next_upstream</span><span style="font-size: 10.0pt; font-family: 宋体; mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman'; mso-bidi-font-family: 'Times New Roman';">和</span><span style="font-size: 10.0pt; font-family: 'Times New Roman',serif; mso-fareast-font-family: 宋体;" lang="EN-US">memcached_next_upstream </span><span style="font-size: 10.0pt; font-family: 宋体; mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman'; mso-bidi-font-family: 'Times New Roman';">这三个参数来使用的。当</span><span style="font-size: 10.0pt; font-family: 'Times New Roman',serif; mso-fareast-font-family: 宋体;" lang="EN-US">nginx</span><span style="font-size: 10.0pt; font-family: 宋体; mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman'; mso-bidi-font-family: 'Times New Roman';">接收后端服务器返回这三个参数定义的状态码时，会将这个请求转发给正常工作的后端服务器，例如</span><span style="font-size: 10.0pt; font-family: 'Times New Roman',serif; mso-fareast-font-family: 宋体;" lang="EN-US">404</span><span style="font-size: 10.0pt; font-family: 宋体; mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman'; mso-bidi-font-family: 'Times New Roman';">、</span><span style="font-size: 10.0pt; font-family: 'Times New Roman',serif; mso-fareast-font-family: 宋体;" lang="EN-US">502</span><span style="font-size: 10.0pt; font-family: 宋体; mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman'; mso-bidi-font-family: 'Times New Roman';">、</span><span style="font-size: 10.0pt; font-family: 'Times New Roman',serif; mso-fareast-font-family: 宋体;" lang="EN-US">503</span><span style="font-size: 10.0pt; font-family: 宋体; mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman'; mso-bidi-font-family: 'Times New Roman';">、</span><span style="font-size: 10.0pt; font-family: 'Times New Roman',serif; mso-fareast-font-family: 宋体;" lang="EN-US"> Max_fails</span><span style="font-size: 10.0pt; font-family: 宋体; mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman'; mso-bidi-font-family: 'Times New Roman';">的默认值是</span><span style="font-size: 10.0pt; font-family: 'Times New Roman',serif; mso-fareast-font-family: 宋体;" lang="EN-US">1 ; </span>
      </p>
      
      <p class="MsoNormal" style="margin-bottom: .0001pt; mso-yfti-cnfc: 64;">
        <span style="font-size: 10.0pt; font-family: 宋体; mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman'; mso-bidi-font-family: 'Times New Roman';">企业场景下建议</span><span style="font-size: 10.0pt; font-family: 'Times New Roman',serif; mso-fareast-font-family: 宋体;" lang="EN-US">2-3</span><span style="font-size: 10.0pt; font-family: 宋体; mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman'; mso-bidi-font-family: 'Times New Roman';">次。如京东</span><span style="font-size: 10.0pt; font-family: 'Times New Roman',serif; mso-fareast-font-family: 宋体;" lang="EN-US">1</span><span style="font-size: 10.0pt; font-family: 宋体; mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman'; mso-bidi-font-family: 'Times New Roman';">次，蓝汛</span><span style="font-size: 10.0pt; font-family: 'Times New Roman',serif; mso-fareast-font-family: 宋体;" lang="EN-US">10</span><span style="font-size: 10.0pt; font-family: 宋体; mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman'; mso-bidi-font-family: 'Times New Roman';">次，根据业务需求去配置</span>
      </p>
    </td>
  </tr>
  
  <tr>
    <td style="width: 11.8%; border-right-width: 1pt; border-bottom-width: 1pt; border-left-width: 1pt; border-right-color: #8eaadb; border-bottom-color: #8eaadb; border-left-color: #8eaadb; border-top: none; padding: 0cm 5.4pt;" valign="top" width="11%">
      <p class="MsoNormal" style="margin-bottom: .0001pt; mso-yfti-cnfc: 4;">
        <strong><span style="font-size: 10.0pt; font-family: 'Times New Roman',serif; mso-fareast-font-family: 宋体;" lang="EN-US">fail_timeout=10s</span></strong>
      </p>
    </td>
    
    <td style="width: 88.2%; border-top: none; border-left: none; border-bottom-width: 1pt; border-bottom-color: #8eaadb; border-right-width: 1pt; border-right-color: #8eaadb; padding: 0cm 5.4pt;" valign="top" width="88%">
      <p class="MsoNormal" style="margin-bottom: .0001pt;">
        <span style="font-size: 10.0pt; font-family: 宋体; mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman'; mso-bidi-font-family: 'Times New Roman';">在</span><span style="font-size: 10.0pt; font-family: 'Times New Roman',serif; mso-fareast-font-family: 宋体;" lang="EN-US">max_fails</span><span style="font-size: 10.0pt; font-family: 宋体; mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman'; mso-bidi-font-family: 'Times New Roman';">定义的失败次数后，距离下次检查的间隔时间，默认是</span><span style="font-size: 10.0pt; font-family: 'Times New Roman',serif; mso-fareast-font-family: 宋体;" lang="EN-US">10s ;</span><span style="font-size: 10.0pt; font-family: 宋体; mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman'; mso-bidi-font-family: 'Times New Roman';">如果</span><span style="font-size: 10.0pt; font-family: 'Times New Roman',serif; mso-fareast-font-family: 宋体;" lang="EN-US">max_fails</span><span style="font-size: 10.0pt; font-family: 宋体; mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman'; mso-bidi-font-family: 'Times New Roman';">是</span><span style="font-size: 10.0pt; font-family: 'Times New Roman',serif; mso-fareast-font-family: 宋体;" lang="EN-US">5 ,</span><span style="font-size: 10.0pt; font-family: 宋体; mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman'; mso-bidi-font-family: 'Times New Roman';">它就检测</span><span style="font-size: 10.0pt; font-family: 'Times New Roman',serif; mso-fareast-font-family: 宋体;" lang="EN-US">5</span><span style="font-size: 10.0pt; font-family: 宋体; mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman'; mso-bidi-font-family: 'Times New Roman';">次，如果</span><span style="font-size: 10.0pt; font-family: 'Times New Roman',serif; mso-fareast-font-family: 宋体;" lang="EN-US">5</span><span style="font-size: 10.0pt; font-family: 宋体; mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman'; mso-bidi-font-family: 'Times New Roman';">次都是</span><span style="font-size: 10.0pt; font-family: 'Times New Roman',serif; mso-fareast-font-family: 宋体;" lang="EN-US">502,</span><span style="font-size: 10.0pt; font-family: 宋体; mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman'; mso-bidi-font-family: 'Times New Roman';">那么，它就会根据</span><span style="font-size: 10.0pt; font-family: 'Times New Roman',serif; mso-fareast-font-family: 宋体;" lang="EN-US">fail_timeout</span><span style="font-size: 10.0pt; font-family: 宋体; mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman'; mso-bidi-font-family: 'Times New Roman';">的值，等待</span><span style="font-size: 10.0pt; font-family: 'Times New Roman',serif; mso-fareast-font-family: 宋体;" lang="EN-US">10s</span><span style="font-size: 10.0pt; font-family: 宋体; mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman'; mso-bidi-font-family: 'Times New Roman';">再去检查，还是只检查一次，如果持续</span><span style="font-size: 10.0pt; font-family: 'Times New Roman',serif; mso-fareast-font-family: 宋体;" lang="EN-US">502,</span><span style="font-size: 10.0pt; font-family: 宋体; mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman'; mso-bidi-font-family: 'Times New Roman';">在不重新加载</span><span style="font-size: 10.0pt; font-family: 'Times New Roman',serif; mso-fareast-font-family: 宋体;" lang="EN-US"> Nginx</span><span style="font-size: 10.0pt; font-family: 宋体; mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman'; mso-bidi-font-family: 'Times New Roman';">配置的情况下，每隔</span><span style="font-size: 10.0pt; font-family: 'Times New Roman',serif; mso-fareast-font-family: 宋体;" lang="EN-US">10s</span><span style="font-size: 10.0pt; font-family: 宋体; mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman'; mso-bidi-font-family: 'Times New Roman';">都只检查一次。常规业务</span><span style="font-size: 10.0pt; font-family: 'Times New Roman',serif; mso-fareast-font-family: 宋体;" lang="EN-US">2~3</span><span style="font-size: 10.0pt; font-family: 宋体; mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman'; mso-bidi-font-family: 'Times New Roman';">秒比较合理，比如京东</span><span style="font-size: 10.0pt; font-family: 'Times New Roman',serif; mso-fareast-font-family: 宋体;" lang="EN-US">3</span><span style="font-size: 10.0pt; font-family: 宋体; mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman'; mso-bidi-font-family: 'Times New Roman';">秒，蓝汛</span><span style="font-size: 10.0pt; font-family: 'Times New Roman',serif; mso-fareast-font-family: 宋体;" lang="EN-US">3</span><span style="font-size: 10.0pt; font-family: 宋体; mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman'; mso-bidi-font-family: 'Times New Roman';">秒，可根据业务需求去配置。</span>
      </p>
    </td>
  </tr>
  
  <tr>
    <td style="width: 11.8%; border-right-width: 1pt; border-bottom-width: 1pt; border-left-width: 1pt; border-right-color: #8eaadb; border-bottom-color: #8eaadb; border-left-color: #8eaadb; border-top: none; background: #d9e2f3; padding: 0cm 5.4pt;" valign="top" width="11%">
      <p class="MsoNormal" style="margin-bottom: .0001pt; mso-yfti-cnfc: 68;">
        <strong><span style="font-size: 10.0pt; font-family: 'Times New Roman',serif; mso-fareast-font-family: 宋体;" lang="EN-US">backup</span></strong>
      </p>
    </td>
    
    <td style="width: 88.2%; border-top: none; border-left: none; border-bottom-width: 1pt; border-bottom-color: #8eaadb; border-right-width: 1pt; border-right-color: #8eaadb; background: #d9e2f3; padding: 0cm 5.4pt;" valign="top" width="88%">
      <p class="MsoNormal" style="margin-bottom: .0001pt; mso-yfti-cnfc: 64;">
        <span style="font-size: 10.0pt; font-family: 宋体; mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman'; mso-bidi-font-family: 'Times New Roman';">热备配置（</span><span style="font-size: 10.0pt; font-family: 'Times New Roman',serif; mso-fareast-font-family: 宋体;" lang="EN-US">RS</span><span style="font-size: 10.0pt; font-family: 宋体; mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman'; mso-bidi-font-family: 'Times New Roman';">节点的高可用），当前面激活的</span><span style="font-size: 10.0pt; font-family: 'Times New Roman',serif; mso-fareast-font-family: 宋体;" lang="EN-US">RS</span><span style="font-size: 10.0pt; font-family: 宋体; mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman'; mso-bidi-font-family: 'Times New Roman';">都失败后会自动启用热备</span><span style="font-size: 10.0pt; font-family: 'Times New Roman',serif; mso-fareast-font-family: 宋体;" lang="EN-US">RS</span><span style="font-size: 10.0pt; font-family: 宋体; mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman'; mso-bidi-font-family: 'Times New Roman';">这标志看这个服务器作为备份服务器，若主服务器全部宕机了，就会向它转发请求。</span>
      </p>
      
      <p class="MsoNormal" style="margin-bottom: .0001pt; mso-yfti-cnfc: 64;">
        <span style="font-size: 10.0pt; font-family: 宋体; mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman'; mso-bidi-font-family: 'Times New Roman';">注意：当负载调度算法为</span><span style="font-size: 10.0pt; font-family: 'Times New Roman',serif; mso-fareast-font-family: 宋体;" lang="EN-US">ip_hash</span><span style="font-size: 10.0pt; font-family: 宋体; mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman'; mso-bidi-font-family: 'Times New Roman';">时，后端服务器在负载均衡调度中的状态不能是</span><span style="font-size: 10.0pt; font-family: 'Times New Roman',serif; mso-fareast-font-family: 宋体;" lang="EN-US">weight</span><span style="font-size: 10.0pt; font-family: 宋体; mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman'; mso-bidi-font-family: 'Times New Roman';">和</span><span style="font-size: 10.0pt; font-family: 'Times New Roman',serif; mso-fareast-font-family: 宋体;" lang="EN-US">backup</span><span style="font-size: 10.0pt; font-family: 宋体; mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman'; mso-bidi-font-family: 'Times New Roman';">。</span>
      </p>
    </td>
  </tr>
  
  <tr>
    <td style="width: 11.8%; border-right-width: 1pt; border-bottom-width: 1pt; border-left-width: 1pt; border-right-color: #8eaadb; border-bottom-color: #8eaadb; border-left-color: #8eaadb; border-top: none; padding: 0cm 5.4pt;" valign="top" width="11%">
      <p class="MsoNormal" style="margin-bottom: .0001pt; mso-yfti-cnfc: 4;">
        <strong><span style="font-size: 10.0pt; font-family: 'Times New Roman',serif; mso-fareast-font-family: 宋体;" lang="EN-US">down</span></strong>
      </p>
    </td>
    
    <td style="width: 88.2%; border-top: none; border-left: none; border-bottom-width: 1pt; border-bottom-color: #8eaadb; border-right-width: 1pt; border-right-color: #8eaadb; padding: 0cm 5.4pt;" valign="top" width="88%">
      <p class="MsoNormal" style="margin-bottom: .0001pt;">
        <span style="font-size: 10.0pt; font-family: 宋体; mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman'; mso-bidi-font-family: 'Times New Roman';">这标志着服务器永远不可用，这个参数可配合</span><span style="font-size: 10.0pt; font-family: 'Times New Roman',serif; mso-fareast-font-family: 宋体;" lang="EN-US">ip_hash</span><span style="font-size: 10.0pt; font-family: 宋体; mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman'; mso-bidi-font-family: 'Times New Roman';">使用；类似与注释。</span>
      </p>
    </td>
  </tr>
</table>

### <span id="weight_148"><span style="font-size: 14px;">　　weight :调节服务器的请求分配权重。</span>1.4.8 上述命令的说明如下：</span>

　　　　?check :开启对该服务器健康检查。

　　　　?inter:设置连续两次的健康检查间隔时间，单位毫秒，默认值2000。

　　　　?rise :指定多少次连续成功的健康检查后，即可认定该服务器处于可用状态。

　　　　?fall :指定多少次不成功的健康检查后，即认为服务器为宕机状态，默认值3。

　　　　? maxconn :指定可被发送到该服务器的最大并发连接数。

<div>
  <div style="mso-element: para-border-div; border: solid windowtext 2.0pt; padding: 1.0pt 4.0pt 1.0pt 4.0pt; mso-border-shadow: yes; background: #F2F2F2; mso-shading: windowtext; mso-pattern: gray-5 auto; margin-left: 38.95pt; margin-right: 76.8pt;">
    <p class="a" style="margin: 1pt 0cm; background-image: initial; background-position: initial; background-size: initial; background-repeat: initial; background-attachment: initial; background-origin: initial; background-clip: initial;">
      <span style="font-family: '微软雅黑',sans-serif; mso-ascii-font-family: 宋体; mso-hansi-font-family: 宋体;">虽然</span><span lang="EN-US">Nginx</span><span style="font-family: '微软雅黑',sans-serif; mso-ascii-font-family: 宋体; mso-hansi-font-family: 宋体;">本身不支持一致性</span><span lang="EN-US">hash</span><span style="font-family: '微软雅黑',sans-serif; mso-ascii-font-family: 宋体; mso-hansi-font-family: 宋体;">算法，但</span><span lang="EN-US">Nginx</span><span style="font-family: '微软雅黑',sans-serif; mso-ascii-font-family: 宋体; mso-hansi-font-family: 宋体;">的分支</span><span lang="EN-US">Tengine</span><span style="font-family: '微软雅黑',sans-serif; mso-ascii-font-family: 宋体; mso-hansi-font-family: 宋体;">支持。详细可见</span><span lang="EN-US">http://tengine.taobao.org/document_cn/http_upstream_consistent_hash_cn.html</span>
    </p>
  </div>
</div>

### <span id="149_ip_hash">1.4.9 ip_hash 参数实践</span>

　　每个访问的用户都会生成一个hash值。

&nbsp;&nbsp;&nbsp; &nbsp; 每个请求按客户端 IP的 hash结果分配，当新的请求到达时，先将其客户端 IP通过哈希算法哈希出一个值，在随后的客户端请求中，客户IP的咍希值只要相同，就会被分配至同一台服务器，该调度算法可以解决动态网页的session共享问题，但有时会导致请求分配不均，即无法保证1:1的负载均衡，因为在国内大多数公司都是NAT上网横式，多个客户端会对应_个外部IP ,所以，这些客户端都会被分配到同一节点服务器，从而导致请求分配不均。

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; LVS负载均衡的-p参数、Keepalived配置里的 persistence jimeout 50参数都类似这个 Nginx里的ip_hash参数，其功能都可以解决动态网页的session共享问题。

<div>
  <div class="cnblogs_code">
    <pre>worker_processes  <span style="color: #800080;">1</span><span style="color: #000000;">;
events {
    worker_connections  </span><span style="color: #800080;">1024</span><span style="color: #000000;">;
}
http {
    include       mime.types;
    default_type  application</span>/octet-<span style="color: #000000;">stream;
    sendfile        on;
    keepalive_timeout  </span><span style="color: #800080;">65</span><span style="color: #000000;">;
    upstream server_pools{
            ip_hash;
         server </span><span style="color: #800080;">10.0</span>.<span style="color: #800080;">0.7</span>:<span style="color: #800080;">80</span><span style="color: #000000;">;
         server </span><span style="color: #800080;">10.0</span>.<span style="color: #800080;">0.8</span>:<span style="color: #800080;">80</span><span style="color: #000000;">;
    }
    server{
       listen </span><span style="color: #800080;">80</span><span style="color: #000000;">;
       server_name bbs.etiantian.org;
       location </span>/<span style="color: #000000;"> {
          proxy_pass http:</span><span style="color: #008000;">//</span><span style="color: #008000;">server_pools;</span>
<span style="color: #000000;">       }
    }
}</span></pre>
  </div>
</div>

### <span id="1410_least_conn">1.4.10 least_conn 参数</span>

　　看谁闲，谁闲发送给谁

　　least_conn算法会根据后端节点的连接数来决定分配情况，哪个机器连接数少就分发。

### <span id="1411_fair">1.4.11 fair 参数</span>

　　看谁响应的快

　　此算法会根据后端节点服务器的响应时间来分配请求,响应时间短的优先分配。这是更加智能的调度算法。此种算法可以依据页面大小和加载时间长短智能地进行负载均衝，也就是根据后端服务器的响应时间来分配请求，响应时间短的优先分配。Nginx本身不支持fair调度算法，如果需要使用这种调度算法，必须下载Nginx的相关模块upstream_fair。

示例如下：

<div>
  <div class="cnblogs_code">
    <pre><span style="color: #000000;">upstream name {
server </span><span style="color: #800080;">192.168</span>.<span style="color: #800080;">1.1</span><span style="color: #000000;">;
server </span><span style="color: #800080;">192.168</span>.<span style="color: #800080;">1.2</span><span style="color: #000000;">;
fair;
}</span></pre>
  </div>
  
  <p>
    　　除了上面这些算法外，还有一些第三方调度算法，例如：url_hash、一致性hash算法等.
  </p>
</div>

### <span id="1412">1.4.12 调度算法</span>

　　定义轮询调度算法 rr 默认调度算法&nbsp;&nbsp; 平均分配

　　定义权重调度算法 wrr

　　定义静态调度算法 ip-hash

　　定义最小的连接数-least_conn

### <span id="1413_nginx">1.4.13 nginx负载均衡相关重要参数</span>

<table class="MsoTableGrid" style="width: 100%; border-width: initial; border-style: none; border-color: initial;" border="1" cellspacing="0" cellpadding="0">
  <tr>
    <td style="width: 24.66%; border-width: 1pt; border-color: windowtext; background: #a6a6a6; padding: 0cm 5.4pt;" width="24%">
      <p class="MsoNormal" style="margin-bottom: .0001pt; text-align: center;" align="center">
        <strong><span style="font-size: 10.0pt; font-family: 'Times New Roman',serif; mso-fareast-font-family: 宋体;" lang="EN-US">Nginx</span></strong><strong><span style="font-size: 10.0pt; font-family: 宋体; mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman'; mso-bidi-font-family: 'Times New Roman';">反向代理重要参敎</span></strong>
      </p>
    </td>
    
    <td style="width: 75.34%; border-top-width: 1pt; border-right-width: 1pt; border-bottom-width: 1pt; border-top-color: windowtext; border-right-color: windowtext; border-bottom-color: windowtext; border-left: none; background: #a6a6a6; padding: 0cm 5.4pt;" width="75%">
      <p class="MsoNormal" style="margin-bottom: .0001pt; text-align: center;" align="center">
        <strong><span style="font-size: 10.0pt; font-family: 宋体; mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman'; mso-bidi-font-family: 'Times New Roman';">解释说明</span></strong>
      </p>
    </td>
  </tr>
  
  <tr>
    <td style="width: 24.66%; border-right-width: 1pt; border-bottom-width: 1pt; border-left-width: 1pt; border-right-color: windowtext; border-bottom-color: windowtext; border-left-color: windowtext; border-top: none; padding: 0cm 5.4pt;" width="24%">
      <p class="MsoNormal" style="margin-bottom: .0001pt; text-align: justify; text-justify: inter-ideograph;">
        <span style="font-size: 10.0pt; font-family: 'Times New Roman',serif; mso-fareast-font-family: 宋体;" lang="EN-US">proxy.pass http://server_pools;&nbsp; </span>
      </p>
    </td>
    
    <td style="width: 75.34%; border-top: none; border-left: none; border-bottom-width: 1pt; border-bottom-color: windowtext; border-right-width: 1pt; border-right-color: windowtext; padding: 0cm 5.4pt;" width="75%">
      <p class="MsoNormal" style="margin-bottom: .0001pt; text-align: justify; text-justify: inter-ideograph;">
        <span style="font-size: 10.0pt; font-family: 宋体; mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman'; mso-bidi-font-family: 'Times New Roman';">通过</span><span style="font-size: 10.0pt; font-family: 'Times New Roman',serif; mso-fareast-font-family: 宋体;" lang="EN-US">proxy_pass</span><span style="font-size: 10.0pt; font-family: 宋体; mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman'; mso-bidi-font-family: 'Times New Roman';">功能把用户的清求转向到反向代理定义的</span><span style="font-size: 10.0pt; font-family: 'Times New Roman',serif; mso-fareast-font-family: 宋体;" lang="EN-US">upstream</span><span style="font-size: 10.0pt; font-family: 宋体; mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman'; mso-bidi-font-family: 'Times New Roman';">服务器池</span>
      </p>
    </td>
  </tr>
  
  <tr>
    <td style="width: 24.66%; border-right-width: 1pt; border-bottom-width: 1pt; border-left-width: 1pt; border-right-color: windowtext; border-bottom-color: windowtext; border-left-color: windowtext; border-top: none; padding: 0cm 5.4pt;" width="24%">
      <p class="MsoNormal" style="margin-bottom: .0001pt; text-align: justify; text-justify: inter-ideograph;">
        <span style="font-size: 10.0pt; font-family: 'Times New Roman',serif; mso-fareast-font-family: 宋体;" lang="EN-US">proxy_set_header Host $host</span>
      </p>
    </td>
    
    <td style="width: 75.34%; border-top: none; border-left: none; border-bottom-width: 1pt; border-bottom-color: windowtext; border-right-width: 1pt; border-right-color: windowtext; padding: 0cm 5.4pt;" width="75%">
      <p class="MsoNormal" style="margin-bottom: .0001pt; text-align: justify; text-justify: inter-ideograph;">
        <span style="font-size: 10.0pt; font-family: 宋体; mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman'; mso-bidi-font-family: 'Times New Roman';">在代理向后端服务器发送的</span><span style="font-size: 10.0pt; font-family: 'Times New Roman',serif; mso-fareast-font-family: 宋体;" lang="EN-US"> http</span><span style="font-size: 10.0pt; font-family: 宋体; mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman'; mso-bidi-font-family: 'Times New Roman';">请求头中加入</span><span style="font-size: 10.0pt; font-family: 'Times New Roman',serif; mso-fareast-font-family: 宋体;" lang="EN-US"> host</span><span style="font-size: 10.0pt; font-family: 宋体; mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman'; mso-bidi-font-family: 'Times New Roman';">字段信息，用于当后端服务器配置有多个虚拟主机时，可以识别代理的是哪个虚拟主机。这是节点服务器多虚拟主机时的关键配置</span>
      </p>
    </td>
  </tr>
  
  <tr>
    <td style="width: 24.66%; border-right-width: 1pt; border-bottom-width: 1pt; border-left-width: 1pt; border-right-color: windowtext; border-bottom-color: windowtext; border-left-color: windowtext; border-top: none; padding: 0cm 5.4pt;" width="24%">
      <p class="MsoNormal" style="margin-bottom: .0001pt; text-align: justify; text-justify: inter-ideograph;">
        <span style="font-size: 10.0pt; font-family: 'Times New Roman',serif; mso-fareast-font-family: 宋体;" lang="EN-US">proxy_set_header X-ForwardedFor</span>
      </p>
      
      <p class="MsoNormal" style="margin-bottom: .0001pt; text-align: justify; text-justify: inter-ideograph;">
        <span style="font-size: 10.0pt; font-family: 'Times New Roman',serif; mso-fareast-font-family: 宋体;" lang="EN-US">$remote_addr;</span>
      </p>
    </td>
    
    <td style="width: 75.34%; border-top: none; border-left: none; border-bottom-width: 1pt; border-bottom-color: windowtext; border-right-width: 1pt; border-right-color: windowtext; padding: 0cm 5.4pt;" width="75%">
      <p class="MsoNormal" style="margin-bottom: .0001pt; text-align: justify; text-justify: inter-ideograph;">
        <span style="font-size: 10.0pt; font-family: 宋体; mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman'; mso-bidi-font-family: 'Times New Roman';">在代理向后端服务器发送的</span><span style="font-size: 10.0pt; font-family: 'Times New Roman',serif; mso-fareast-font-family: 宋体;" lang="EN-US"> http</span><span style="font-size: 10.0pt; font-family: 宋体; mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman'; mso-bidi-font-family: 'Times New Roman';">请求头中加入</span><span style="font-size: 10.0pt; font-family: 'Times New Roman',serif; mso-fareast-font-family: 宋体;" lang="EN-US"> X-Forward-For</span><span style="font-size: 10.0pt; font-family: 宋体; mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman'; mso-bidi-font-family: 'Times New Roman';">字段信息，用于后端服务器程序、日志等接收记录真实用户的</span><span style="font-size: 10.0pt; font-family: 'Times New Roman',serif; mso-fareast-font-family: 宋体;" lang="EN-US"> IP ,</span><span style="font-size: 10.0pt; font-family: 宋体; mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman'; mso-bidi-font-family: 'Times New Roman';">而不是代理服务器的</span><span style="font-size: 10.0pt; font-family: 'Times New Roman',serif; mso-fareast-font-family: 宋体;" lang="EN-US"> IP</span><span style="font-size: 10.0pt; font-family: 宋体; mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman'; mso-bidi-font-family: 'Times New Roman';">这是反向代理时，节点服务器获取用户真实</span><span style="font-size: 10.0pt; font-family: 'Times New Roman',serif; mso-fareast-font-family: 宋体;" lang="EN-US"> IP</span><span style="font-size: 10.0pt; font-family: 宋体; mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman'; mso-bidi-font-family: 'Times New Roman';">的必要功能配置</span>
      </p>
    </td>
  </tr>
</table>

### <span id="1414">1.4.14 反向代理排错思路</span>

<span style="font-size: 14px;">　　01.先在lb01上访问后端节点进行测试</span>

　　02.在lb01上访问本地地址进行测试

　　03.在浏览器上进行测试

&nbsp;&nbsp;&nbsp;　　&nbsp;&nbsp;&nbsp;&nbsp; 缓存、域名解析

### <span id="1415_proxy_next_uptream">1.4.15 proxy_next_uptream 参数</span>

　　当nginx接收后端服务器返回proxy\_next\_upstream 参数定义的状态码时，会将这个请求转发给正常工作的后端服务器，例如500，502，503，504，此参数可以提升用户的访问体验。

## <span id="15">1.5 定义多个虚拟主机标签信息</span>

### <span id="151_proxy_set_header">1.5.1 proxy_set_header 参数</span>

**配置文件**

<div>
  <div class="cnblogs_code">
    <pre>[root@lb01 conf]# <span style="color: #0000ff;">cat</span><span style="color: #000000;"> nginx.conf
worker_processes  </span><span style="color: #800080;">1</span><span style="color: #000000;">;
events {
    worker_connections  </span><span style="color: #800080;">1024</span><span style="color: #000000;">;
}
http {
    include       mime.types;
    default_type  application</span>/octet-<span style="color: #000000;">stream;
    sendfile        on;
    keepalive_timeout  </span><span style="color: #800080;">65</span><span style="color: #000000;">;
    upstream server_pools{
         server </span><span style="color: #800080;">10.0</span>.<span style="color: #800080;">0.7</span>:<span style="color: #800080;">80</span><span style="color: #000000;">;
         server </span><span style="color: #800080;">10.0</span>.<span style="color: #800080;">0.8</span>:<span style="color: #800080;">80</span><span style="color: #000000;">;
    }
    server{
       listen </span><span style="color: #800080;">80</span><span style="color: #000000;">;
       server_name bbs.etiantian.org;
       location </span>/<span style="color: #000000;"> {
          proxy_pass http:</span><span style="color: #008000;">//</span><span style="color: #008000;">server_pools;</span>
<span style="color: #000000;">              proxy_set_header Host $host;
       }
    }
    server{
       listen </span><span style="color: #800080;">80</span><span style="color: #000000;">;
       server_name www.etiantian.org;
       location </span>/<span style="color: #000000;"> {
          proxy_pass http:</span><span style="color: #008000;">//</span><span style="color: #008000;">server_pools;</span>
<span style="color: #000000;">               proxy_set_header Host $host;
       }
    }

}</span></pre>
  </div>
</div>

**访问抓包**

<div>
  <p class="a">
    &nbsp;&nbsp;&nbsp; 该参数在负载服务器在访问后端服务器的时候 会带上hosts信息。
  </p>
</div>

<p align="center">
  <img data-original="https://clsn.io/wp-content/uploads/2018/03/1190037-20171217103232155-575135425.png" src="/wp-content/themes/clsn-003/img/blank.gif" alt="Nginx的反向代理与负载均衡" alt="" />&nbsp;
</p>

### <span id="152_X-Forwarded-For">1.5.2 X-Forwarded-For 参数</span>

　　<span style="background-color: #00ff00;">proxy_set_header X-Forwarded-For $remote_addr;</span>

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 代理的啥时候在后面显示真实的IP地址

<div>
  <div class="cnblogs_code">
    <pre>[root@lb01 conf]# <span style="color: #0000ff;">cat</span><span style="color: #000000;"> nginx.conf
worker_processes  </span><span style="color: #800080;">1</span><span style="color: #000000;">;
events {
    worker_connections  </span><span style="color: #800080;">1024</span><span style="color: #000000;">;
}
http {
    include       mime.types;
    default_type  application</span>/octet-<span style="color: #000000;">stream;
    sendfile        on;
    keepalive_timeout  </span><span style="color: #800080;">65</span><span style="color: #000000;">;
    upstream server_pools{
         server </span><span style="color: #800080;">10.0</span>.<span style="color: #800080;">0.8</span>:<span style="color: #800080;">80</span><span style="color: #000000;">;
         server </span><span style="color: #800080;">10.0</span>.<span style="color: #800080;">0.7</span>:<span style="color: #800080;">80</span><span style="color: #000000;">;
         server </span><span style="color: #800080;">10.0</span>.<span style="color: #800080;">0.9</span>:<span style="color: #800080;">80</span><span style="color: #000000;">;
    }
    server{
       listen </span><span style="color: #800080;">80</span><span style="color: #000000;">;
       server_name bbs.etiantian.org;
       location </span>/<span style="color: #000000;"> {
          proxy_pass http:</span><span style="color: #008000;">//</span><span style="color: #008000;">server_pools;</span>
<span style="color: #000000;">             proxy_set_header Host $host; 
          proxy_set_header X</span>-Forwarded-<span style="color: #000000;">For $remote_addr;
       }
    }
    server{
       listen </span><span style="color: #800080;">80</span><span style="color: #000000;">;
       server_name www.etiantian.org;
       location </span>/<span style="color: #000000;"> {
          proxy_pass http:</span><span style="color: #008000;">//</span><span style="color: #008000;">server_pools;</span>
<span style="color: #000000;">             proxy_set_header Host $host;
             proxy_set_header X</span>-Forwarded-<span style="color: #000000;">For $remote_addr;
       }
    }
    server{
       listen </span><span style="color: #800080;">80</span><span style="color: #000000;">;
       server_name blog.etiantian.org;
       location </span>/<span style="color: #000000;"> {
          proxy_pass http:</span><span style="color: #008000;">//</span><span style="color: #008000;">server_pools;</span>
<span style="color: #000000;">             proxy_set_header Host $host;
             proxy_set_header X</span>-Forwarded-<span style="color: #000000;">For $remote_addr;
       }
    }

}</span></pre>
  </div>
</div>

**参看日志信息**

<div>
  <div class="cnblogs_code">
    <pre><span style="color: #008080;">1</span> <span style="color: #800080;">10.0</span>.<span style="color: #800080;">0.5</span> - - [<span style="color: #800080;">30</span>/Oct/<span style="color: #800080;">2017</span>:<span style="color: #800080;">12</span>:<span style="color: #800080;">36</span>:<span style="color: #800080;">10</span> +<span style="color: #800080;">0800</span>] <span style="color: #800000;">"</span><span style="color: #800000;">GET / HTTP/1.0</span><span style="color: #800000;">"</span> <span style="color: #800080;">200</span> <span style="color: #800080;">10</span> <span style="color: #800000;">"</span><span style="color: #800000;">-</span><span style="color: #800000;">"</span> <span style="color: #800000;">"</span><span style="color: #800000;">Mozilla/5.0 (Windows NT 10.0; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/61.0.3163.100 Safari/537.36</span><span style="color: #800000;">"</span> <span style="color: #800000;">"</span><span style="color: #800000;">10.0.0.1</span><span style="color: #800000;">"</span>
<span style="color: #008080;">2</span> <span style="color: #800080;">10.0</span>.<span style="color: #800080;">0.5</span> - - [<span style="color: #800080;">30</span>/Oct/<span style="color: #800080;">2017</span>:<span style="color: #800080;">12</span>:<span style="color: #800080;">36</span>:<span style="color: #800080;">10</span> +<span style="color: #800080;">0800</span>] <span style="color: #800000;">"</span><span style="color: #800000;">GET /favicon.ico HTTP/1.0</span><span style="color: #800000;">"</span> <span style="color: #800080;">404</span> <span style="color: #800080;">571</span> <span style="color: #800000;">"</span><span style="color: #800000;">http://www.etiantian.org/</span><span style="color: #800000;">"</span> <span style="color: #800000;">"</span><span style="color: #800000;">Mozilla/5.0 (Windows NT 10.0; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/61.0.3163.100 Safari/537.36</span><span style="color: #800000;">"</span> <span style="color: #800000;">"</span><span style="color: #800000;">10.0.0.1</span><span style="color: #800000;">"</span></pre>
  </div>
</div>

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 该参数配置，会在访问日志的后面加上真正的访问用户ip

### <span id="153_http_proxy">1.5.3 http proxy 模块相关参数说明</span>

<table class="MsoTableGrid" style="width: 100%; border-width: initial; border-style: none; border-color: initial;" border="1" cellspacing="0" cellpadding="0">
  <tr>
    <td style="width: 20.04%; border-width: 1pt; border-color: windowtext; background: #a6a6a6; padding: 0cm 5.4pt;" width="20%">
      <p class="MsoNormal" style="margin-bottom: .0001pt; text-align: center;" align="center">
        <strong><span style="font-size: 10.0pt; font-family: 'Times New Roman',serif; mso-fareast-font-family: 宋体;" lang="EN-US">http proxy </span></strong><strong><span style="font-size: 10.0pt; font-family: 宋体; mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman'; mso-bidi-font-family: 'Times New Roman';">模块相关参数</span></strong>
      </p>
    </td>
    
    <td style="width: 79.96%; border-top-width: 1pt; border-right-width: 1pt; border-bottom-width: 1pt; border-top-color: windowtext; border-right-color: windowtext; border-bottom-color: windowtext; border-left: none; background: #a6a6a6; padding: 0cm 5.4pt;" width="79%">
      <p class="MsoNormal" style="margin-bottom: .0001pt; text-align: center;" align="center">
        <strong><span style="font-size: 10.0pt; font-family: 'Times New Roman',serif; mso-fareast-font-family: 宋体;" lang="EN-US">&nbsp;</span></strong><strong><span style="font-size: 10.0pt; font-family: 宋体; mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman'; mso-bidi-font-family: 'Times New Roman';">说明</span></strong>
      </p>
    </td>
  </tr>
  
  <tr>
    <td style="width: 20.04%; border-right-width: 1pt; border-bottom-width: 1pt; border-left-width: 1pt; border-right-color: windowtext; border-bottom-color: windowtext; border-left-color: windowtext; border-top: none; padding: 0cm 5.4pt;" width="20%">
      <p class="MsoNormal" style="margin-bottom: .0001pt; text-align: justify; text-justify: inter-ideograph;">
        <span style="font-size: 10.0pt; font-family: 'Times New Roman',serif; mso-fareast-font-family: 宋体;" lang="EN-US">proxy_set_header</span>
      </p>
    </td>
    
    <td style="width: 79.96%; border-top: none; border-left: none; border-bottom-width: 1pt; border-bottom-color: windowtext; border-right-width: 1pt; border-right-color: windowtext; padding: 0cm 5.4pt;" width="79%">
      <p class="MsoNormal" style="margin-bottom: .0001pt; text-align: justify; text-justify: inter-ideograph;">
        <span style="font-size: 10.0pt; font-family: 宋体; mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman'; mso-bidi-font-family: 'Times New Roman';">设置</span><span style="font-size: 10.0pt; font-family: 'Times New Roman',serif; mso-fareast-font-family: 宋体;" lang="EN-US">http</span><span style="font-size: 10.0pt; font-family: 宋体; mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman'; mso-bidi-font-family: 'Times New Roman';">请求</span><span style="font-size: 10.0pt; font-family: 'Times New Roman',serif; mso-fareast-font-family: 宋体;" lang="EN-US">header</span><span style="font-size: 10.0pt; font-family: 宋体; mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman'; mso-bidi-font-family: 'Times New Roman';">项传给后端服务器节点，例如：可实现让代理后端的服务器节点获取访问客户端用户的真实</span><span style="font-size: 10.0pt; font-family: 'Times New Roman',serif; mso-fareast-font-family: 宋体;" lang="EN-US">IP</span><span style="font-size: 10.0pt; font-family: 宋体; mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman'; mso-bidi-font-family: 'Times New Roman';">地址</span>
      </p>
    </td>
  </tr>
  
  <tr>
    <td style="width: 20.04%; border-right-width: 1pt; border-bottom-width: 1pt; border-left-width: 1pt; border-right-color: windowtext; border-bottom-color: windowtext; border-left-color: windowtext; border-top: none; padding: 0cm 5.4pt;" width="20%">
      <p class="MsoNormal" style="margin-bottom: .0001pt; text-align: justify; text-justify: inter-ideograph;">
        <span style="font-size: 10.0pt; font-family: 'Times New Roman',serif; mso-fareast-font-family: 宋体;" lang="EN-US">client_body_buffer_size</span>
      </p>
    </td>
    
    <td style="width: 79.96%; border-top: none; border-left: none; border-bottom-width: 1pt; border-bottom-color: windowtext; border-right-width: 1pt; border-right-color: windowtext; padding: 0cm 5.4pt;" width="79%">
      <p class="MsoNormal" style="margin-bottom: .0001pt; text-align: justify; text-justify: inter-ideograph;">
        <span style="font-size: 10.0pt; font-family: 宋体; mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman'; mso-bidi-font-family: 'Times New Roman';">用于指定客户端请求主体缓冲区大小</span>
      </p>
    </td>
  </tr>
  
  <tr>
    <td style="width: 20.04%; border-right-width: 1pt; border-bottom-width: 1pt; border-left-width: 1pt; border-right-color: windowtext; border-bottom-color: windowtext; border-left-color: windowtext; border-top: none; padding: 0cm 5.4pt;" width="20%">
      <p class="MsoNormal" style="margin-bottom: .0001pt; text-align: justify; text-justify: inter-ideograph;">
        <span style="font-size: 10.0pt; font-family: 'Times New Roman',serif; mso-fareast-font-family: 宋体;" lang="EN-US">proxy_connect_timeout</span>
      </p>
    </td>
    
    <td style="width: 79.96%; border-top: none; border-left: none; border-bottom-width: 1pt; border-bottom-color: windowtext; border-right-width: 1pt; border-right-color: windowtext; padding: 0cm 5.4pt;" width="79%">
      <p class="MsoNormal" style="margin-bottom: .0001pt; text-align: justify; text-justify: inter-ideograph;">
        <span style="font-size: 10.0pt; font-family: 宋体; mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman'; mso-bidi-font-family: 'Times New Roman';">表示反向代理后端节点服务器连接的超时时间，即发起握手等候响应的超时时间</span>
      </p>
    </td>
  </tr>
  
  <tr>
    <td style="width: 20.04%; border-right-width: 1pt; border-bottom-width: 1pt; border-left-width: 1pt; border-right-color: windowtext; border-bottom-color: windowtext; border-left-color: windowtext; border-top: none; padding: 0cm 5.4pt;" width="20%">
      <p class="MsoNormal" style="margin-bottom: .0001pt; text-align: justify; text-justify: inter-ideograph;">
        <span style="font-size: 10.0pt; font-family: 'Times New Roman',serif; mso-fareast-font-family: 宋体;" lang="EN-US">proxy_send_timeout</span>
      </p>
    </td>
    
    <td style="width: 79.96%; border-top: none; border-left: none; border-bottom-width: 1pt; border-bottom-color: windowtext; border-right-width: 1pt; border-right-color: windowtext; padding: 0cm 5.4pt;" width="79%">
      <p class="MsoNormal" style="margin-bottom: .0001pt; text-align: justify; text-justify: inter-ideograph;">
        <span style="font-size: 10.0pt; font-family: 宋体; mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman'; mso-bidi-font-family: 'Times New Roman';">表示代理后端服务器的数据回传时间，即在规定时间内后端服务器必须传完所有数据，否则</span><span style="font-size: 10.0pt; font-family: 'Times New Roman',serif; mso-fareast-font-family: 宋体;" lang="EN-US">nginx</span><span style="font-size: 10.0pt; font-family: 宋体; mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman'; mso-bidi-font-family: 'Times New Roman';">将断开这个连接</span>
      </p>
    </td>
  </tr>
  
  <tr>
    <td style="width: 20.04%; border-right-width: 1pt; border-bottom-width: 1pt; border-left-width: 1pt; border-right-color: windowtext; border-bottom-color: windowtext; border-left-color: windowtext; border-top: none; padding: 0cm 5.4pt;" width="20%">
      <p class="MsoNormal" style="margin-bottom: .0001pt; text-align: justify; text-justify: inter-ideograph;">
        <span style="font-size: 10.0pt; font-family: 'Times New Roman',serif; mso-fareast-font-family: 宋体;" lang="EN-US">proxy_read_timeout</span>
      </p>
    </td>
    
    <td style="width: 79.96%; border-top: none; border-left: none; border-bottom-width: 1pt; border-bottom-color: windowtext; border-right-width: 1pt; border-right-color: windowtext; padding: 0cm 5.4pt;" width="79%">
      <p class="MsoNormal" style="margin-bottom: .0001pt; text-align: justify; text-justify: inter-ideograph;">
        <span style="font-size: 10.0pt; font-family: 宋体; mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman'; mso-bidi-font-family: 'Times New Roman';">设置</span><span style="font-size: 10.0pt; font-family: 'Times New Roman',serif; mso-fareast-font-family: 宋体;" lang="EN-US">nginx</span><span style="font-size: 10.0pt; font-family: 宋体; mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman'; mso-bidi-font-family: 'Times New Roman';">从代理的后端服务器获取信息的时间，表示连接建立成功后，</span><span style="font-size: 10.0pt; font-family: 'Times New Roman',serif; mso-fareast-font-family: 宋体;" lang="EN-US">nginx</span><span style="font-size: 10.0pt; font-family: 宋体; mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman'; mso-bidi-font-family: 'Times New Roman';">等待后端服务器的响应时间，其实是</span><span style="font-size: 10.0pt; font-family: 'Times New Roman',serif; mso-fareast-font-family: 宋体;" lang="EN-US">nginx</span><span style="font-size: 10.0pt; font-family: 宋体; mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman'; mso-bidi-font-family: 'Times New Roman';">已经进入后端的排队之中等候处理的时间</span>
      </p>
    </td>
  </tr>
  
  <tr>
    <td style="width: 20.04%; border-right-width: 1pt; border-bottom-width: 1pt; border-left-width: 1pt; border-right-color: windowtext; border-bottom-color: windowtext; border-left-color: windowtext; border-top: none; padding: 0cm 5.4pt;" width="20%">
      <p class="MsoNormal" style="margin-bottom: .0001pt; text-align: justify; text-justify: inter-ideograph;">
        <span style="font-size: 10.0pt; font-family: 'Times New Roman',serif; mso-fareast-font-family: 宋体;" lang="EN-US">proxy_buffer_size</span>
      </p>
    </td>
    
    <td style="width: 79.96%; border-top: none; border-left: none; border-bottom-width: 1pt; border-bottom-color: windowtext; border-right-width: 1pt; border-right-color: windowtext; padding: 0cm 5.4pt;" valign="top" width="79%">
      <p class="MsoNormal" style="margin-bottom: .0001pt;">
        <span style="font-size: 10.0pt; font-family: 宋体; mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman'; mso-bidi-font-family: 'Times New Roman';">设置缓冲区大小，默认该缓冲区大小等于指令</span><span style="font-size: 10.0pt; font-family: 'Times New Roman',serif; mso-fareast-font-family: 宋体;" lang="EN-US">proxy_buffers</span><span style="font-size: 10.0pt; font-family: 宋体; mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman'; mso-bidi-font-family: 'Times New Roman';">设置的大小</span>
      </p>
    </td>
  </tr>
  
  <tr>
    <td style="width: 20.04%; border-right-width: 1pt; border-bottom-width: 1pt; border-left-width: 1pt; border-right-color: windowtext; border-bottom-color: windowtext; border-left-color: windowtext; border-top: none; padding: 0cm 5.4pt;" width="20%">
      <p class="MsoNormal" style="margin-bottom: .0001pt; text-align: justify; text-justify: inter-ideograph;">
        <span style="font-size: 10.0pt; font-family: 'Times New Roman',serif; mso-fareast-font-family: 宋体;" lang="EN-US">proxy_buffers</span>
      </p>
    </td>
    
    <td style="width: 79.96%; border-top: none; border-left: none; border-bottom-width: 1pt; border-bottom-color: windowtext; border-right-width: 1pt; border-right-color: windowtext; padding: 0cm 5.4pt;" width="79%">
      <p class="MsoNormal" style="margin-bottom: .0001pt; text-align: justify; text-justify: inter-ideograph;">
        <span style="font-size: 10.0pt; font-family: 宋体; mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman'; mso-bidi-font-family: 'Times New Roman';">设置缓冲区的数量和大小，</span><span style="font-size: 10.0pt; font-family: 'Times New Roman',serif; mso-fareast-font-family: 宋体;" lang="EN-US">nginx</span><span style="font-size: 10.0pt; font-family: 宋体; mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman'; mso-bidi-font-family: 'Times New Roman';">从代理的后端服务器获取的响应信息，会设置到缓冲区</span>
      </p>
    </td>
  </tr>
  
  <tr>
    <td style="width: 20.04%; border-right-width: 1pt; border-bottom-width: 1pt; border-left-width: 1pt; border-right-color: windowtext; border-bottom-color: windowtext; border-left-color: windowtext; border-top: none; padding: 0cm 5.4pt;" width="20%">
      <p class="MsoNormal" style="margin-bottom: .0001pt; text-align: justify; text-justify: inter-ideograph;">
        <span style="font-size: 10.0pt; font-family: 'Times New Roman',serif; mso-fareast-font-family: 宋体;" lang="EN-US">proxy_busy_buffers_size</span>
      </p>
    </td>
    
    <td style="width: 79.96%; border-top: none; border-left: none; border-bottom-width: 1pt; border-bottom-color: windowtext; border-right-width: 1pt; border-right-color: windowtext; padding: 0cm 5.4pt;" width="79%">
      <p class="MsoNormal" style="margin-bottom: .0001pt; text-align: justify; text-justify: inter-ideograph;">
        <span style="font-size: 10.0pt; font-family: 宋体; mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman'; mso-bidi-font-family: 'Times New Roman';">用于设置相同很忙时可以使用的</span><span style="font-size: 10.0pt; font-family: 'Times New Roman',serif; mso-fareast-font-family: 宋体;" lang="EN-US">proxy_buffers</span><span style="font-size: 10.0pt; font-family: 宋体; mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman'; mso-bidi-font-family: 'Times New Roman';">大小，官方推荐的大小为</span><span style="font-size: 10.0pt; font-family: 'Times New Roman',serif; mso-fareast-font-family: 宋体;" lang="EN-US"> proxy_buffers * 2</span>
      </p>
    </td>
  </tr>
  
  <tr>
    <td style="width: 20.04%; border-right-width: 1pt; border-bottom-width: 1pt; border-left-width: 1pt; border-right-color: windowtext; border-bottom-color: windowtext; border-left-color: windowtext; border-top: none; padding: 0cm 5.4pt;" width="20%">
      <p class="MsoNormal" style="margin-bottom: .0001pt; text-align: justify; text-justify: inter-ideograph;">
        <span style="font-size: 10.0pt; font-family: 'Times New Roman',serif; mso-fareast-font-family: 宋体;" lang="EN-US">proxy_trmp_file_write_size</span>
      </p>
    </td>
    
    <td style="width: 79.96%; border-top: none; border-left: none; border-bottom-width: 1pt; border-bottom-color: windowtext; border-right-width: 1pt; border-right-color: windowtext; padding: 0cm 5.4pt;" width="79%">
      <p class="MsoNormal" style="margin-bottom: .0001pt; text-align: justify; text-justify: inter-ideograph;">
        <span style="font-size: 10.0pt; font-family: 宋体; mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman'; mso-bidi-font-family: 'Times New Roman';">指定</span><span style="font-size: 10.0pt; font-family: 'Times New Roman',serif; mso-fareast-font-family: 宋体;" lang="EN-US">proxy</span><span style="font-size: 10.0pt; font-family: 宋体; mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman'; mso-bidi-font-family: 'Times New Roman';">缓存临时文件的大小</span>
      </p>
    </td>
  </tr>
</table>

## <span id="161_URL16_uri"><span style="font-size: 1.17em;">1.6.1 相据URL目录地址转发的应用场景</span>1.6 基于目录（uri）进行转发--网站动静分离</span>

　　根据HTTP的URL进行转发的应用情况，被称为第7层（应用层）的负载均衡，而LVS的负载均衡一般用于TCP等的转发，因此被称为第4层（传输层）的负载均衡。

　　在企业中，有时希望只用一个域名对外提供服务，不希望使用多个域名对应同一个产品业务，此时就需要在代理服务器上通过配置规则，使得匹配不同规则的请求会交给不同的服务器池处理。这类业务有：

　　? 业务的域名没有拆分或者不希望拆分，但希望实现动静分离、多业务分离，

　　?&nbsp;不同的客户端设备（例如：手机和 PC端）使用同一个域名访问同一个业务网站，就需要根 据规则将不同设备的用户请求交给后端不同的服务器处理，以便得到最佳用户体验。

<p style="text-align: center;">
  &nbsp;&nbsp;<img data-original="https://clsn.io/wp-content/uploads/2018/03/1190037-20171217103438604-1718117592.png" src="/wp-content/themes/clsn-003/img/blank.gif" alt="Nginx的反向代理与负载均衡" alt="" />
</p>

### <span id="162">1.6.2 第一个里程碑： 服务器规划</span>

<div align="center">
  <div align="center">
    <table class="MsoTable15Grid4Accent5" style="border-width: initial; border-style: none; border-color: initial;" border="1" cellspacing="0" cellpadding="0">
      <tr>
        <td style="width: 139.65pt; border-top-width: 1pt; border-bottom-width: 1pt; border-left-width: 1pt; border-top-color: #4472c4; border-bottom-color: #4472c4; border-left-color: #4472c4; border-right: none; background: #4472c4; padding: 0cm 5.4pt;" valign="top" width="186">
          <p class="MsoNormal" style="margin-bottom: .0001pt; mso-yfti-cnfc: 5;">
            <strong><span style="font-size: 10.0pt; font-family: 宋体; mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman'; mso-bidi-font-family: 'Times New Roman'; color: white; mso-themecolor: background1;">目录（</span></strong><strong><span style="font-size: 10.0pt; font-family: 'Times New Roman',serif; mso-fareast-font-family: 宋体; color: white; mso-themecolor: background1;" lang="EN-US">uri</span></strong><strong><span style="font-size: 10.0pt; font-family: 宋体; mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman'; mso-bidi-font-family: 'Times New Roman'; color: white; mso-themecolor: background1;">）</span></strong>
          </p>
        </td>
        
        <td style="width: 130.45pt; border-top-width: 1pt; border-top-color: #4472c4; border-left: none; border-bottom-width: 1pt; border-bottom-color: #4472c4; border-right: none; background: #4472c4; padding: 0cm 5.4pt;" valign="top" width="174">
          <p class="MsoNormal" style="margin-bottom: .0001pt; mso-yfti-cnfc: 1;">
            <strong><span style="font-size: 10.0pt; font-family: 'Times New Roman',serif; mso-fareast-font-family: 宋体; color: white; mso-themecolor: background1;" lang="EN-US">ip</span></strong>
          </p>
        </td>
        
        <td style="width: 126.35pt; border-top-width: 1pt; border-top-color: #4472c4; border-left: none; border-bottom-width: 1pt; border-bottom-color: #4472c4; border-right: none; background: #4472c4; padding: 0cm 5.4pt;" valign="top" width="168">
          <p class="MsoNormal" style="margin-bottom: .0001pt; mso-yfti-cnfc: 1;">
            <strong><span style="font-size: 10.0pt; font-family: 宋体; mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman'; mso-bidi-font-family: 'Times New Roman'; color: white; mso-themecolor: background1;">服务器目录</span></strong>
          </p>
        </td>
        
        <td style="width: 126.35pt; border-top-width: 1pt; border-right-width: 1pt; border-bottom-width: 1pt; border-top-color: #4472c4; border-right-color: #4472c4; border-bottom-color: #4472c4; border-left: none; background: #4472c4; padding: 0cm 5.4pt;" valign="top" width="168">
          <p class="MsoNormal" style="margin-bottom: .0001pt; mso-yfti-cnfc: 1;">
            <strong><span style="font-size: 10.0pt; font-family: 宋体; mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman'; mso-bidi-font-family: 'Times New Roman'; color: white; mso-themecolor: background1;">类型</span></strong>
          </p>
        </td>
      </tr>
      
      <tr>
        <td style="width: 139.65pt; border-right-width: 1pt; border-bottom-width: 1pt; border-left-width: 1pt; border-right-color: #8eaadb; border-bottom-color: #8eaadb; border-left-color: #8eaadb; border-top: none; background: #d9e2f3; padding: 0cm 5.4pt;" valign="top" width="186">
          <p class="MsoNormal" style="margin-bottom: .0001pt; mso-yfti-cnfc: 68;">
            <strong><span style="font-size: 10.0pt; font-family: 'Times New Roman',serif; mso-fareast-font-family: 宋体;" lang="EN-US">/upload</span></strong>
          </p>
        </td>
        
        <td style="width: 130.45pt; border-top: none; border-left: none; border-bottom-width: 1pt; border-bottom-color: #8eaadb; border-right-width: 1pt; border-right-color: #8eaadb; background: #d9e2f3; padding: 0cm 5.4pt;" valign="top" width="174">
          <p class="MsoNormal" style="margin-bottom: .0001pt; mso-yfti-cnfc: 64;">
            <span style="font-size: 10.0pt; font-family: 'Times New Roman',serif; mso-fareast-font-family: 宋体;" lang="EN-US">10.0.0.8:80</span>
          </p>
        </td>
        
        <td style="width: 126.35pt; border-top: none; border-left: none; border-bottom-width: 1pt; border-bottom-color: #8eaadb; border-right-width: 1pt; border-right-color: #8eaadb; background: #d9e2f3; padding: 0cm 5.4pt;" valign="top" width="168">
          <p class="MsoNormal" style="margin-bottom: .0001pt; mso-yfti-cnfc: 64;">
            <span style="font-size: 10.0pt; font-family: 'Times New Roman',serif; mso-fareast-font-family: 宋体;" lang="EN-US">html/www/upload</span>
          </p>
        </td>
        
        <td style="width: 126.35pt; border-top: none; border-left: none; border-bottom-width: 1pt; border-bottom-color: #8eaadb; border-right-width: 1pt; border-right-color: #8eaadb; background: #d9e2f3; padding: 0cm 5.4pt;" valign="top" width="168">
          <p class="MsoNormal" style="margin-bottom: .0001pt; mso-yfti-cnfc: 64;">
            <span style="font-size: 10.0pt; font-family: 'Times New Roman',serif; mso-fareast-font-family: 宋体;" lang="EN-US">upload</span><span style="font-size: 10.0pt; font-family: 宋体; mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman'; mso-bidi-font-family: 'Times New Roman';">服务器</span>
          </p>
        </td>
      </tr>
      
      <tr>
        <td style="width: 139.65pt; border-right-width: 1pt; border-bottom-width: 1pt; border-left-width: 1pt; border-right-color: #8eaadb; border-bottom-color: #8eaadb; border-left-color: #8eaadb; border-top: none; padding: 0cm 5.4pt;" valign="top" width="186">
          <p class="MsoNormal" style="margin-bottom: .0001pt; mso-yfti-cnfc: 4;">
            <strong><span style="font-size: 10.0pt; font-family: 'Times New Roman',serif; mso-fareast-font-family: 宋体;" lang="EN-US">/static</span></strong>
          </p>
        </td>
        
        <td style="width: 130.45pt; border-top: none; border-left: none; border-bottom-width: 1pt; border-bottom-color: #8eaadb; border-right-width: 1pt; border-right-color: #8eaadb; padding: 0cm 5.4pt;" valign="top" width="174">
          <p class="MsoNormal" style="margin-bottom: .0001pt;">
            <span style="font-size: 10.0pt; font-family: 'Times New Roman',serif; mso-fareast-font-family: 宋体;" lang="EN-US">10.0.0.7:80</span>
          </p>
        </td>
        
        <td style="width: 126.35pt; border-top: none; border-left: none; border-bottom-width: 1pt; border-bottom-color: #8eaadb; border-right-width: 1pt; border-right-color: #8eaadb; padding: 0cm 5.4pt;" valign="top" width="168">
          <p class="MsoNormal" style="margin-bottom: .0001pt;">
            <span style="font-size: 10.0pt; font-family: 'Times New Roman',serif; mso-fareast-font-family: 宋体;" lang="EN-US">html/www/static</span>
          </p>
        </td>
        
        <td style="width: 126.35pt; border-top: none; border-left: none; border-bottom-width: 1pt; border-bottom-color: #8eaadb; border-right-width: 1pt; border-right-color: #8eaadb; padding: 0cm 5.4pt;" valign="top" width="168">
          <p class="MsoNormal" style="margin-bottom: .0001pt;">
            <span style="font-size: 10.0pt; font-family: 'Times New Roman',serif; mso-fareast-font-family: 宋体;" lang="EN-US">static</span><span style="font-size: 10.0pt; font-family: 宋体; mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman'; mso-bidi-font-family: 'Times New Roman';">静态服务器</span>
          </p>
        </td>
      </tr>
      
      <tr>
        <td style="width: 139.65pt; border-right-width: 1pt; border-bottom-width: 1pt; border-left-width: 1pt; border-right-color: #8eaadb; border-bottom-color: #8eaadb; border-left-color: #8eaadb; border-top: none; background: #d9e2f3; padding: 0cm 5.4pt;" valign="top" width="186">
          <p class="MsoNormal" style="margin-bottom: .0001pt; mso-yfti-cnfc: 68;">
            <strong><span style="font-size: 10.0pt; font-family: 'Times New Roman',serif; mso-fareast-font-family: 宋体;" lang="EN-US">/</span></strong>
          </p>
        </td>
        
        <td style="width: 130.45pt; border-top: none; border-left: none; border-bottom-width: 1pt; border-bottom-color: #8eaadb; border-right-width: 1pt; border-right-color: #8eaadb; background: #d9e2f3; padding: 0cm 5.4pt;" valign="top" width="174">
          <p class="MsoNormal" style="margin-bottom: .0001pt; mso-yfti-cnfc: 64;">
            <span style="font-size: 10.0pt; font-family: 'Times New Roman',serif; mso-fareast-font-family: 宋体;" lang="EN-US">10.0.0.9:80</span>
          </p>
        </td>
        
        <td style="width: 126.35pt; border-top: none; border-left: none; border-bottom-width: 1pt; border-bottom-color: #8eaadb; border-right-width: 1pt; border-right-color: #8eaadb; background: #d9e2f3; padding: 0cm 5.4pt;" valign="top" width="168">
          <p class="MsoNormal" style="margin-bottom: .0001pt; mso-yfti-cnfc: 64;">
            <span style="font-size: 10.0pt; font-family: 'Times New Roman',serif; mso-fareast-font-family: 宋体;" lang="EN-US">html/www</span>
          </p>
        </td>
        
        <td style="width: 126.35pt; border-top: none; border-left: none; border-bottom-width: 1pt; border-bottom-color: #8eaadb; border-right-width: 1pt; border-right-color: #8eaadb; background: #d9e2f3; padding: 0cm 5.4pt;" valign="top" width="168">
          <p class="MsoNormal" style="margin-bottom: .0001pt; mso-yfti-cnfc: 64;">
            <span style="font-size: 10.0pt; font-family: 宋体; mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman'; mso-bidi-font-family: 'Times New Roman';">默认</span>
          </p>
        </td>
      </tr>
    </table>
  </div>
</div>

### <span id="163_upstream">1.6.3 第二个里程碑：创建/设置upstream负载信息</span>

<div>
  <div class="cnblogs_code">
    <pre><span style="color: #000000;">upstream upload_pools {
  server </span><span style="color: #800080;">10.0</span>.<span style="color: #800080;">0.8</span>:<span style="color: #800080;">80</span><span style="color: #000000;">;
}
upstream static_pools {
  server </span><span style="color: #800080;">10.0</span>.<span style="color: #800080;">0.7</span>:<span style="color: #800080;">80</span><span style="color: #000000;">;
}
upstream default_pools {
  server </span><span style="color: #800080;">10.0</span>.<span style="color: #800080;">0.9</span>:<span style="color: #800080;">80</span><span style="color: #000000;">;
}</span></pre>
  </div>
</div>

### <span id="164_upstream">1.6.4 第三个里程碑：如何调用upstream信息</span>

<div>
  <div class="cnblogs_code">
    <pre>location /static/<span style="color: #000000;"> { 
    proxy_pass http:</span><span style="color: #008000;">//</span><span style="color: #008000;">static_pools;</span>
<span style="color: #000000;">    proxy_set_header Host $host;
    proxy_set_header X</span>-Forwarded-<span style="color: #000000;">For $remote_addr;
}
 location </span>/upload/<span style="color: #000000;"> { 
    proxy_pass http:</span><span style="color: #008000;">//</span><span style="color: #008000;">upload_pools;</span>
<span style="color: #000000;">    proxy_set_header Host $host;
    proxy_set_header X</span>-Forwarded-<span style="color: #000000;">For $remote_addr;
}
 location </span>/<span style="color: #000000;"> { 
    proxy_pass http:</span><span style="color: #008000;">//</span><span style="color: #008000;">default_pools;</span>
<span style="color: #000000;">    proxy_set_header Host $host;
    proxy_set_header X</span>-Forwarded-<span style="color: #000000;">For $remote_addr;
}</span></pre>
  </div>
</div>

### <span id="165_lb01">1.6.5 第四个里程碑： 编写配置文件lb01</span>

<div>
  <div class="cnblogs_code">
    <pre>worker_processes  <span style="color: #800080;">1</span><span style="color: #000000;">;
events {
    worker_connections  </span><span style="color: #800080;">1024</span><span style="color: #000000;">;
}
http {
    include       mime.types;
    default_type  application</span>/octet-<span style="color: #000000;">stream;
    sendfile        on;
    keepalive_timeout  </span><span style="color: #800080;">65</span><span style="color: #000000;">;
    log_format  main  </span><span style="color: #800000;">'</span><span style="color: #800000;">$remote_addr - $remote_user [$time_local] "$request" </span><span style="color: #800000;">'</span>
                      <span style="color: #800000;">'</span><span style="color: #800000;">$status $body_bytes_sent "$http_referer" </span><span style="color: #800000;">'</span>
                      <span style="color: #800000;">'</span><span style="color: #800000;">"$http_user_agent" "$http_x_forwarded_for"</span><span style="color: #800000;">'</span><span style="color: #000000;">;                      
    upstream upload_pools {
      server </span><span style="color: #800080;">10.0</span>.<span style="color: #800080;">0.8</span>:<span style="color: #800080;">80</span><span style="color: #000000;">;
    }

    upstream static_pools {
      server </span><span style="color: #800080;">10.0</span>.<span style="color: #800080;">0.7</span>:<span style="color: #800080;">80</span><span style="color: #000000;">;
    }

    upstream default_pools {
      server </span><span style="color: #800080;">10.0</span>.<span style="color: #800080;">0.9</span>:<span style="color: #800080;">80</span><span style="color: #000000;">;
    }

    server {
        listen </span><span style="color: #800080;">80</span><span style="color: #000000;">;
        server_name www.etiantian.org;
    location </span>/static/<span style="color: #000000;"> { 
        proxy_pass http:</span><span style="color: #008000;">//</span><span style="color: #008000;">static_pools;</span>
<span style="color: #000000;">        proxy_set_header Host $host;
        proxy_set_header X</span>-Forwarded-<span style="color: #000000;">For $remote_addr;
    }

        location </span>/upload/<span style="color: #000000;"> { 
            proxy_pass http:</span><span style="color: #008000;">//</span><span style="color: #008000;">upload_pools;</span>
<span style="color: #000000;">        proxy_set_header Host $host;
        proxy_set_header X</span>-Forwarded-<span style="color: #000000;">For $remote_addr;
    }

     location </span>/<span style="color: #000000;"> { 
            proxy_pass http:</span><span style="color: #008000;">//</span><span style="color: #008000;">default_pools;</span>
<span style="color: #000000;">        proxy_set_header Host $host;
        proxy_set_header X</span>-Forwarded-<span style="color: #000000;">For $remote_addr;
    }
         access_log  logs</span>/<span style="color: #000000;">access_www.log  main;
    }
}</span></pre>
  </div>
</div>

### <span id="166">1.6.6 第五个里程碑： 创建环境</span>

<div>
  <div class="cnblogs_code">
    <pre>www.etiantian.org/<span style="color: #000000;">xxx.html
www.etiantian.org</span>/upload/<span style="color: #000000;">xxx.html
www.etiantian.org</span>/static/xxx.html </pre>
  </div>
</div>

##web01

<div>
  <div class="cnblogs_code">
    <pre><span style="color: #0000ff;">mkdir</span> -p /application/nginx/html/www/<span style="color: #000000;">upload
</span><span style="color: #0000ff;">echo</span>  <span style="color: #800000;">"</span><span style="color: #800000;">web01 upload</span><span style="color: #800000;">"</span> >/application/nginx/html/www/upload/xxx.html </pre>
  </div>
</div>

##web02

<div>
  <div class="cnblogs_code">
    <pre><span style="color: #0000ff;">mkdir</span> -p /application/nginx/html/www/<span style="color: #000000;">static
</span><span style="color: #0000ff;">echo</span>  <span style="color: #800000;">"</span><span style="color: #800000;">web02 static</span><span style="color: #800000;">"</span> >/application/nginx/html/www/static/xxx.html </pre>
  </div>
</div>

##web03

<div>
  <div class="cnblogs_code">
    <pre><span style="color: #0000ff;">echo</span>  <span style="color: #800000;">"</span><span style="color: #800000;">web03 default</span><span style="color: #800000;">"</span> >/application/nginx/html/www/xxx.html</pre>
  </div>
</div>

### <span id="167">1.6.7 第六个里程碑： 进行测试</span>

<div class="cnblogs_code">
  <pre>[root@lb01 conf]# curl -H  host:www.etiantian.org  <span style="color: #800080;">10.0</span>.<span style="color: #800080;">0.5</span>/upload/<span style="color: #000000;">
web01 upload:</span>/application/nginx/html/www/<span style="color: #000000;">upload
[root@lb01 conf]# curl </span>-H  host:www.etiantian.org  <span style="color: #800080;">10.0</span>.<span style="color: #800080;">0.5</span>/static/<span style="color: #000000;">
web02,</span>/application/nginx/html/www/<span style="color: #000000;">static
[root@lb01 conf]# curl </span>-H  host:www.etiantian.org  <span style="color: #800080;">10.0</span>.<span style="color: #800080;">0.5</span>/<span style="color: #000000;">
web03 www</span></pre>
</div>

浏览器进行访问测试

<p align="center">
  &nbsp;<img src="https://clsn.io/wp-content/uploads/2018/03/1190037-20171217103639149-1325863413.png" alt="Nginx的反向代理与负载均衡" alt="" /><img src="https://clsn.io/wp-content/uploads/2018/03/1190037-20171217103643054-1900020321.png" alt="Nginx的反向代理与负载均衡" alt="" /><img data-original="https://clsn.io/wp-content/uploads/2018/03/1190037-20171217103646349-563920899.png" src="/wp-content/themes/clsn-003/img/blank.gif" alt="Nginx的反向代理与负载均衡" alt="" />&nbsp;
</p>

## <span id="17_user_agent">1.7 根据客户端的设备实现转发（user_agent）</span>

### <span id="171_user_agent">1.7.1 user_agent的应用</span>

<p align="center">
  &nbsp;<img data-original="https://clsn.io/wp-content/uploads/2018/03/1190037-20171217103720922-20796782.png" src="/wp-content/themes/clsn-003/img/blank.gif" alt="Nginx的反向代理与负载均衡" alt="" />
</p>

### <span id="172_lb01nbsp">1.7.2 修改lb01配置文件&nbsp;</span>

<div>
  <div class="cnblogs_code" onclick="cnblogs_code_show('a5fab604-162f-4ee1-b327-47a219d21cc2')">
    <img id="code_img_closed_a5fab604-162f-4ee1-b327-47a219d21cc2" class="code_img_closed" src="https://clsn.io/wp-content/uploads/2018/03/ContractedBlock-7.gif" alt="Nginx的反向代理与负载均衡" alt="" /><img id="code_img_opened_a5fab604-162f-4ee1-b327-47a219d21cc2" class="code_img_opened" style="display: none;" onclick="cnblogs_code_hide('a5fab604-162f-4ee1-b327-47a219d21cc2',event)" data-original="https://clsn.io/wp-content/uploads/2018/03/ExpandedBlockStart-7.gif" src="/wp-content/themes/clsn-003/img/blank.gif" alt="Nginx的反向代理与负载均衡" alt="" /></p> 
    
    <div id="cnblogs_code_open_a5fab604-162f-4ee1-b327-47a219d21cc2" class="cnblogs_code_hide">
      <pre><span style="color: #008080;"> 1</span> worker_processes  <span style="color: #800080;">1</span><span style="color: #000000;">;
</span><span style="color: #008080;"> 2</span> <span style="color: #000000;">events {
</span><span style="color: #008080;"> 3</span>     worker_connections  <span style="color: #800080;">1024</span><span style="color: #000000;">;
</span><span style="color: #008080;"> 4</span> <span style="color: #000000;">}
</span><span style="color: #008080;"> 5</span> <span style="color: #000000;">http {
</span><span style="color: #008080;"> 6</span> <span style="color: #000000;">    include       mime.types;
</span><span style="color: #008080;"> 7</span>     default_type  application/octet-<span style="color: #000000;">stream;
</span><span style="color: #008080;"> 8</span> <span style="color: #000000;">    sendfile        on;
</span><span style="color: #008080;"> 9</span>     keepalive_timeout  <span style="color: #800080;">65</span><span style="color: #000000;">;
</span><span style="color: #008080;">10</span>     log_format  main  <span style="color: #800000;">'</span><span style="color: #800000;">$remote_addr - $remote_user [$time_local] "$request" </span><span style="color: #800000;">'</span>
<span style="color: #008080;">11</span>                       <span style="color: #800000;">'</span><span style="color: #800000;">$status $body_bytes_sent "$http_referer" </span><span style="color: #800000;">'</span>
<span style="color: #008080;">12</span>                       <span style="color: #800000;">'</span><span style="color: #800000;">"$http_user_agent" "$http_x_forwarded_for"</span><span style="color: #800000;">'</span><span style="color: #000000;">;
</span><span style="color: #008080;">13</span>                                     
<span style="color: #008080;">14</span> <span style="color: #000000;">    upstream upload_pools {
</span><span style="color: #008080;">15</span>       server <span style="color: #800080;">10.0</span>.<span style="color: #800080;">0.8</span>:<span style="color: #800080;">80</span><span style="color: #000000;">;
</span><span style="color: #008080;">16</span> <span style="color: #000000;">    }
</span><span style="color: #008080;">17</span> 
<span style="color: #008080;">18</span> <span style="color: #000000;">    upstream static_pools {
</span><span style="color: #008080;">19</span>       server <span style="color: #800080;">10.0</span>.<span style="color: #800080;">0.7</span>:<span style="color: #800080;">80</span><span style="color: #000000;">;
</span><span style="color: #008080;">20</span> <span style="color: #000000;">    }
</span><span style="color: #008080;">21</span> 
<span style="color: #008080;">22</span> <span style="color: #000000;">    upstream default_pools {
</span><span style="color: #008080;">23</span>       server <span style="color: #800080;">10.0</span>.<span style="color: #800080;">0.9</span>:<span style="color: #800080;">80</span><span style="color: #000000;">;
</span><span style="color: #008080;">24</span> <span style="color: #000000;">    }
</span><span style="color: #008080;">25</span> 
<span style="color: #008080;">26</span> <span style="color: #000000;">    server {
</span><span style="color: #008080;">27</span>         listen <span style="color: #800080;">80</span><span style="color: #000000;">;
</span><span style="color: #008080;">28</span> <span style="color: #000000;">        server_name www.etiantian.org;
</span><span style="color: #008080;">29</span>         location /<span style="color: #000000;"> {
</span><span style="color: #008080;">30</span>          <span style="color: #0000ff;">if</span> ($http_user_agent ~* <span style="color: #800000;">"</span><span style="color: #800000;">MSIE</span><span style="color: #800000;">"</span><span style="color: #000000;">)
</span><span style="color: #008080;">31</span> <span style="color: #000000;">          {
</span><span style="color: #008080;">32</span>             proxy_pass http:<span style="color: #008000;">//</span><span style="color: #008000;">static_pools;</span>
<span style="color: #008080;">33</span> <span style="color: #000000;">          }
</span><span style="color: #008080;">34</span>          <span style="color: #0000ff;">if</span> ($http_user_agent ~* <span style="color: #800000;">"</span><span style="color: #800000;">Chrome</span><span style="color: #800000;">"</span><span style="color: #000000;">)
</span><span style="color: #008080;">35</span> <span style="color: #000000;">          {
</span><span style="color: #008080;">36</span>             proxy_pass http:<span style="color: #008000;">//</span><span style="color: #008000;">upload_pools;</span>
<span style="color: #008080;">37</span> <span style="color: #000000;">          }
</span><span style="color: #008080;">38</span>         proxy_pass http:<span style="color: #008000;">//</span><span style="color: #008000;">default_pools;</span>
<span style="color: #008080;">39</span> <span style="color: #000000;">           proxy_set_header Host $host;
</span><span style="color: #008080;">40</span> <span style="color: #000000;">               }
</span><span style="color: #008080;">41</span>          access_log  logs/<span style="color: #000000;">access_www.log  main;
</span><span style="color: #008080;">42</span> <span style="color: #000000;">    }
</span><span style="color: #008080;">43</span> }</pre>
    </div>
    
    <p>
      <span class="cnblogs_code_collapse">View Code lb01配置文件</span></div> </div> 
      
      <h3>
        <span id="173">1.7.3 进行测试</span>
      </h3>
      
      <div>
        <p class="a">
          　　基于上一步的操作，现在可以之间的进行访问测试
        </p>
      </div>
      
      <p>
        curl -A 指定访问类型
      </p>
      
      <div>
        <div class="cnblogs_code">
          <pre>[root@lb01 conf]# curl -A MSIE -H host:www.etiantian.org <span style="color: #800080;">10.0</span>.<span style="color: #800080;">0.5</span><span style="color: #000000;">
web02 www
[root@lb01 conf]# curl </span>-A Chrome -H host:www.etiantian.org <span style="color: #800080;">10.0</span>.<span style="color: #800080;">0.5</span><span style="color: #000000;">
web01 www
[root@lb01 conf]# curl </span>-A xx -H host:www.etiantian.org <span style="color: #800080;">10.0</span>.<span style="color: #800080;">0.5</span><span style="color: #000000;">
web03 www</span></pre>
        </div>
      </div>
      
      <h2>
        <span id="18">1.8 利用扩展名进行转发</span>
      </h2>
      
      <p>
        利用后缀名进行转发与nginx中的基于后缀的转跳一样实现。
      </p>
      
      <div>
        <div class="cnblogs_code">
          <pre>location ~.*.(gif|ipg|jpeg|png|bmp|swf|css|<span style="color: #000000;">js)$ {
        peoxy_pass http:</span><span style="color: #008000;">//</span><span style="color: #008000;">static_pools;</span>
<span style="color: #000000;">           include proxy.conf
}</span></pre>
        </div>
        
        <p style="text-align: right;">
          &nbsp;<strong>本文出自&ldquo;惨绿少年&rdquo;，欢迎转载，转载请注明出处！http://blog.znix.top</strong>
        </p>
      </div>
      
      <p>
        &nbsp;
      </p>
      
      <div id="toc_container" class="toc_white have_bullets">
        <ul class="toc_list">
          <li>
            <a href="#11">1.1 集群是什么</a>
          </li>
          <li>
            <a href="#12">1.2 为什么要有集群</a><ul>
              <li>
                <a href="#121">1.2.1 集群种类</a>
              </li>
              <li>
                <a href="#122">1.2.2 硬件设备</a>
              </li>
              <li>
                <a href="#123">1.2.3 软件</a>
              </li>
              <li>
                <a href="#124">1.2.4 负载均衡概念说明</a>
              </li>
              <li>
                <a href="#125">1.2.5 反向代理</a>
              </li>
              <li>
                <a href="#126">1.2.6 压力测试的方式</a>
              </li>
            </ul>
          </li>
          
          <li>
            <a href="#13_nginx">1.3 nginx反向代理实践</a><ul>
              <li>
                <a href="#131">1.3.1 地址规划说明</a>
              </li>
              <li>
                <a href="#132">1.3.2 反向代理与数据转发的区别</a>
              </li>
              <li>
                <a href="#133_nginx">1.3.3 安装部署nginx过程（安装命令集）</a>
              </li>
              <li>
                <a href="#134_nginxweb">1.3.4 编写nginx配置文件（统一web服务器配置）</a>
              </li>
              <li>
                <a href="#135_nginx_web">1.3.5 统一nginx测试环境 （web文件）</a>
              </li>
              <li>
                <a href="#136">1.3.6 测试</a>
              </li>
              <li>
                <a href="#137">1.3.7 配置负载服务文件</a>
              </li>
              <li>
                <a href="#138">1.3.8 测试访问</a>
              </li>
            </ul>
          </li>
          
          <li>
            <a href="#14_nginx">1.4 nginx中常用模块说明</a><ul>
              <li>
                <a href="#141">1.4.1 模块调度算法</a>
              </li>
              <li>
                <a href="#142_nginx">1.4.2 nginx反向代理相关两个模块</a>
              </li>
              <li>
                <a href="#143_upstream">1.4.3 upstream模块核心参数简介</a>
              </li>
              <li>
                <a href="#144_weight">1.4.4 weight 参数实践 （权重）</a>
              </li>
              <li>
                <a href="#145">1.4.5 其他的参数说明</a>
              </li>
              <li>
                <a href="#146">1.4.6 访问抓包</a>
              </li>
              <li>
                <a href="#147_upsrteam">1.4.7 upsrteam参数详细说明</a>
              </li>
              <li>
                <a href="#weight_148">　　weight :调节服务器的请求分配权重。1.4.8 上述命令的说明如下：</a>
              </li>
              <li>
                <a href="#149_ip_hash">1.4.9 ip_hash 参数实践</a>
              </li>
              <li>
                <a href="#1410_least_conn">1.4.10 least_conn 参数</a>
              </li>
              <li>
                <a href="#1411_fair">1.4.11 fair 参数</a>
              </li>
              <li>
                <a href="#1412">1.4.12 调度算法</a>
              </li>
              <li>
                <a href="#1413_nginx">1.4.13 nginx负载均衡相关重要参数</a>
              </li>
              <li>
                <a href="#1414">1.4.14 反向代理排错思路</a>
              </li>
              <li>
                <a href="#1415_proxy_next_uptream">1.4.15 proxy_next_uptream 参数</a>
              </li>
            </ul>
          </li>
          
          <li>
            <a href="#15">1.5 定义多个虚拟主机标签信息</a><ul>
              <li>
                <a href="#151_proxy_set_header">1.5.1 proxy_set_header 参数</a>
              </li>
              <li>
                <a href="#152_X-Forwarded-For">1.5.2 X-Forwarded-For 参数</a>
              </li>
              <li>
                <a href="#153_http_proxy">1.5.3 http proxy 模块相关参数说明</a>
              </li>
            </ul>
          </li>
          
          <li>
            <a href="#161_URL16_uri">1.6.1 相据URL目录地址转发的应用场景1.6 基于目录（uri）进行转发--网站动静分离</a><ul>
              <li>
                <a href="#162">1.6.2 第一个里程碑： 服务器规划</a>
              </li>
              <li>
                <a href="#163_upstream">1.6.3 第二个里程碑：创建/设置upstream负载信息</a>
              </li>
              <li>
                <a href="#164_upstream">1.6.4 第三个里程碑：如何调用upstream信息</a>
              </li>
              <li>
                <a href="#165_lb01">1.6.5 第四个里程碑： 编写配置文件lb01</a>
              </li>
              <li>
                <a href="#166">1.6.6 第五个里程碑： 创建环境</a>
              </li>
              <li>
                <a href="#167">1.6.7 第六个里程碑： 进行测试</a>
              </li>
            </ul>
          </li>
          
          <li>
            <a href="#17_user_agent">1.7 根据客户端的设备实现转发（user_agent）</a><ul>
              <li>
                <a href="#171_user_agent">1.7.1 user_agent的应用</a>
              </li>
              <li>
                <a href="#172_lb01nbsp">1.7.2 修改lb01配置文件&nbsp;</a>
              </li>
              <li>
                <a href="#173">1.7.3 进行测试</a>
              </li>
            </ul>
          </li>
          
          <li>
            <a href="#18">1.8 利用扩展名进行转发</a>
          </li>
        </ul>
      </div>